<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Detayı - PUFEMO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f8f9fa; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
        .footer { background-color: #343a40; color: white; padding: 30px 0; margin-top: auto; }
        .product-image-gallery img {
            width: 100%;
            max-height: 500px;
            object-fit: contain; /* Resmi kutuya sığdırırken oranlarını korur */
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: zoom-in;
        }
        .product-thumbnails img, .product-thumbnails video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .product-thumbnails img:hover, .product-thumbnails video:hover,
        .product-thumbnails img.active, .product-thumbnails video.active {
            opacity: 1;
            border-color: #007bff;
        }
        .product-info h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        .product-price { font-size: 2rem; font-weight: bold; color: #007bff; margin-bottom: 1.5rem; }
        .product-description p { line-height: 1.8; color: #555; }
        .variant-option label {
            border: 1px solid #ced4da;
            padding: 8px 15px;
            border-radius: 5px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .variant-option input:checked + label {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .variant-option input { display: none; } /* Gizli radio butonları */
        .alert-info-badge { font-size: 0.85em; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">PUFEMO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Ürünler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Kategoriler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">İletişim</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Hesabım
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarAccountDropdown">
                            <li><a class="dropdown-item" href="admin-login.html" id="menu-login-link">Giriş Yap</a></li>
                            <li><a class="dropdown-item" href="kayit-ol.html" id="menu-register-link">Kayıt Ol</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sepet.html"><i class="bi bi-cart-fill"></i> Sepet <span class="badge bg-primary rounded-pill" id="cart-item-count">0</span></a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle currency-language-selector" href="#" id="currencyLanguageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="selected-country-display"></span> / <span id="selected-language-display"></span> / <span id="selected-currency-display"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="currencyLanguageDropdown">
                            <li><h6 class="dropdown-header">Ülke Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-country-select">
                                    </select>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Dil Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-language-select">
                                    </select>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Para Birimi Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-currency-select">
                                    </select>
                            </li>
                            <li><button class="btn btn-primary btn-sm w-75 mx-auto d-block mt-2" id="save-header-selections">Uygula</button></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4 flex-grow-1">
        <div id="product-detail-container" class="card shadow-sm p-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="product-image-gallery mb-3">
                        <img src="https://via.placeholder.com/600x400?text=Ürün+Görseli" id="main-product-image" alt="Ana Ürün Görseli">
                    </div>
                    <div class="d-flex flex-wrap gap-2 product-thumbnails" id="product-thumbnails">
                        </div>
                </div>
                <div class="col-md-6 product-info">
                    <h1 id="product-name">Ürün Yükleniyor...</h1>
                    <p class="text-muted"><small>SKU: <span id="product-sku"></span></small></p>
                    <p class="product-price" id="product-price">0.00 ₺</p>

                    <div id="product-variants">
                        </div>

                    <div class="mb-3 d-flex align-items-center">
                        <label for="quantity" class="form-label me-2 mb-0">Adet:</label>
                        <input type="number" id="quantity" class="form-control" value="1" min="1" style="width: 80px;">
                        <span class="ms-3 text-success" id="stock-status">Stokta Var</span> </div>

                    <button class="btn btn-primary btn-lg w-100" id="add-to-cart-btn"><i class="bi bi-cart-plus me-2"></i>Sepete Ekle</button>
                    
                    <div class="d-flex gap-2 mt-3" id="product-badges">
                        <span class="badge bg-info alert-info-badge d-none" id="free-shipping-badge"><i class="bi bi-truck"></i> Ücretsiz Kargo</span>
                    </div>

                </div>
            </div>

            <hr class="my-4">

            <div class="row">
                <div class="col-12">
                    <h2>Ürün Açıklaması</h2>
                    <div id="product-description">
                        <p>Açıklama yükleniyor...</p>
                    </div>

                    <h3 class="mt-4">Ek Bilgiler</h3>
                    <div class="accordion" id="productAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Kargo Bilgileri
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#productAccordion">
                                <div class="accordion-body">
                                    Ürünleriniz genellikle 1-3 iş günü içinde kargoya verilir. Kargo süresi bulunduğunuz ülkeye göre değişiklik gösterebilir.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    İade ve Değişim
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#productAccordion">
                                <div class="accordion-body">
                                    Satın aldığınız ürünleri, teslim tarihinden itibaren 14 gün içinde iade veya değişim yapabilirsiniz. Detaylı bilgi için iade politikamızı inceleyiniz.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">

            <div class="row mt-5">
                <div class="col-12">
                    <h2 class="text-center mb-4">İlgili Ürünler</h2>
                    <div class="row row-cols-1 row-cols-md-4 g-4" id="related-products-container">
                        <div class="col">
                            <div class="card product-card">
                                <img src="https://via.placeholder.com/300x200?text=İlgili+Ürün+1" class="card-img-top" alt="İlgili Ürün 1">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Benzer Ürün Adı</h5>
                                    <p class="card-text fw-bold">499.00 ₺</p>
                                    <a href="#" class="btn btn-primary btn-sm">İncele</a>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card product-card">
                                <img src="https://via.placeholder.com/300x200?text=İlgili+Ürün+2" class="card-img-top" alt="İlgili Ürün 2">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Benzer Ürün Adı</h5>
                                    <p class="card-text fw-bold">650.00 ₺</p>
                                    <a href="#" class="btn btn-primary btn-sm">İncele</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> </main>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">PUFEMO</h5>
                    <p>Kalite ve şıklığın adresi.</p>
                    <p id="footer-company-address">Adres bilgisi yüklenecek...</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">Hızlı Linkler</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white text-decoration-none">Hakkımızda</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Gizlilik Politikası</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Mesafeli Satış Sözleşmesi</a></li>
                        <li><a href="siparis-takip.html" class="text-white text-decoration-none">Sipariş Takip</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">Bize Ulaşın</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-envelope-fill me-2"></i> <span id="footer-contact-email">info@pufemo.com</span></li>
                        <li><i class="bi bi-whatsapp me-2"></i> <span id="footer-whatsapp-number">+90 5XX XXX XX XX</span></li>
                    </ul>
                    <div class="social-icons mt-3">
                        <a href="#" class="text-white me-3"><i class="bi bi-facebook fs-4"></i></a>
                        <a href="#" class="text-white me-3"><i class="bi bi-instagram fs-4"></i></a>
                        <a href="#" class="text-white"><i class="bi bi-twitter fs-4"></i></a>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4 border-top pt-3">
                <p class="mb-0">&copy; 2025 PUFEMO. Tüm Hakları Saklıdır.</p>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Yapılandırması (admin panelinizden kopyalandı)
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.firebasestorage.app",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
            measurementId: "G-RH8XHC7P91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Ortak Dil ve Para Birimi Metinleri (index.html'den kopyalandı)
        const appTexts = {
            'tr': {
                menuLogin: 'Giriş Yap',
                menuRegister: 'Kayıt Ol',
                settingsSaved: 'Ayarlar güncellendi!',
                footerAddressNotFound: 'Adres bilgisi bulunamadı.',
                productDetailTitle: 'Ürün Açıklaması',
                productDetailSku: 'SKU:',
                productDetailQuantity: 'Adet:',
                productDetailInStock: 'Stokta Var',
                productDetailOutOfStock: 'Stokta Yok',
                productDetailAddToCart: 'Sepete Ekle',
                productDetailFreeShipping: 'Ücretsiz Kargo',
                productDetailDescription: 'Açıklama yükleniyor...',
                productDetailRelatedProducts: 'İlgili Ürünler',
                productDetailExplore: 'İncele',
                productDetailShippingInfo: 'Kargo Bilgileri',
                productDetailReturnExchange: 'İade ve Değişim',
                productDetailAdditionalInfo: 'Ek Bilgiler',
                productDetailNoVariants: 'Varyant seçeneği yok.',
                productNotFound: 'Ürün bulunamadı!',
                productNotFoundMessage: 'Aradığınız ürün mevcut değil veya silinmiş olabilir.',
                pleaseSelectVariant: 'Lütfen bir varyant seçin.',
                itemAddedToCart: 'Ürün sepete eklendi.'
            },
            'en': {
                menuLogin: 'Login',
                menuRegister: 'Register',
                settingsSaved: 'Settings updated!',
                footerAddressNotFound: 'Address not found.',
                productDetailTitle: 'Product Description',
                productDetailSku: 'SKU:',
                productDetailQuantity: 'Quantity:',
                productDetailInStock: 'In Stock',
                productDetailOutOfStock: 'Out of Stock',
                productDetailAddToCart: 'Add to Cart',
                productDetailFreeShipping: 'Free Shipping',
                productDetailDescription: 'Description loading...',
                productDetailRelatedProducts: 'Related Products',
                productDetailExplore: 'Explore',
                productDetailShippingInfo: 'Shipping Information',
                productDetailReturnExchange: 'Return and Exchange',
                productDetailAdditionalInfo: 'Additional Information',
                productDetailNoVariants: 'No variant options.',
                productNotFound: 'Product not found!',
                productNotFoundMessage: 'The product you are looking for may not exist or may have been deleted.',
                pleaseSelectVariant: 'Please select a variant.',
                itemAddedToCart: 'Item added to cart.'
            }
            // Diğer diller buraya eklenebilir
        };

        // Local Storage Anahtarları (index.html'den kopyalandı)
        const LS_SELECTED_COUNTRY_CODE = 'pufemo_selected_country_code';
        const LS_SELECTED_LANGUAGE_CODE = 'pufemo_selected_language_code';
        const LS_SELECTED_CURRENCY_CODE = 'pufemo_selected_currency_code';

        let allCountries = [];
        let allLanguages = [];
        let allCurrencies = [];
        let siteSettings = {};
        let currentProduct = null; // Mevcut ürün detaylarını tutar

        // DOM Elementleri
        const productNameEl = document.getElementById('product-name');
        const productSkuEl = document.getElementById('product-sku');
        const productPriceEl = document.getElementById('product-price');
        const mainProductImageEl = document.getElementById('main-product-image');
        const productThumbnailsEl = document.getElementById('product-thumbnails');
        const productVariantsEl = document.getElementById('product-variants');
        const quantityInput = document.getElementById('quantity');
        const stockStatusEl = document.getElementById('stock-status');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const freeShippingBadge = document.getElementById('free-shipping-badge');
        const productDescriptionEl = document.getElementById('product-description');
        const relatedProductsContainer = document.getElementById('related-products-container');

        // Header ve Footer Elementleri (index.html'den kopyalandı)
        const selectedCountryDisplay = document.getElementById('selected-country-display');
        const selectedLanguageDisplay = document.getElementById('selected-language-display');
        const selectedCurrencyDisplay = document.getElementById('selected-currency-display');
        const headerCountrySelect = document.getElementById('header-country-select');
        const headerLanguageSelect = document.getElementById('header-language-select');
        const headerCurrencySelect = document.getElementById('header-currency-select');
        const saveHeaderSelectionsBtn = document.getElementById('save-header-selections');
        const footerCompanyAddress = document.getElementById('footer-company-address');
        const footerContactEmail = document.getElementById('footer-contact-email');
        const footerWhatsappNumber = document.getElementById('footer-whatsapp-number');
        const menuLoginLink = document.getElementById('menu-login-link');
        const menuRegisterLink = document.getElementById('menu-register-link');

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCommonData();
            await populateHeaderSelectors();
            updateHeaderDisplays();
            updateStaticContent(); // Ortak metinler için footer vb. güncelle
            updateCartItemCount();

            // Ürün ID'sini URL'den al
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (productId) {
                await loadProductDetails(productId);
            } else {
                console.error("Ürün ID'si bulunamadı.");
                // Ürün bulunamadı mesajı gösterilebilir
                displayProductNotFound();
            }

            // Anonim kullanıcı oturumu aç (index.html'deki gibi)
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    try {
                        await auth.signInAnonymously();
                        console.log("Anonim kullanıcı oturum açtı.");
                    } catch (error) {
                        console.error("Anonim oturum açılırken hata:", error);
                    }
                }
            });
        });

        async function loadCommonData() {
            try {
                const [countriesSnapshot, languagesSnapshot, currenciesSnapshot, settingsDoc] = await Promise.all([
                    db.collection('countries').get(),
                    db.collection('languages').get(),
                    db.collection('currencies').get(),
                    db.collection('settings').doc('siteConfig').get()
                ]);

                allCountries = countriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allLanguages = languagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allCurrencies = currenciesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                siteSettings = settingsDoc.exists ? settingsDoc.data() : {};
            } catch (error) {
                console.error("Ortak Firebase verileri yüklenirken hata:", error);
                alert("Site temel verileri yüklenirken bir sorun oluştu.");
                // Hata durumunda varsayılan değerler
                allCountries = []; allLanguages = []; allCurrencies = []; siteSettings = {};
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'en');
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'USD');
            }
        }

        async function loadProductDetails(productId) {
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const currentCurrencyCode = localStorage.getItem(LS_SELECTED_CURRENCY_CODE) || 'TRY';
            const currentCountryCode = localStorage.getItem(LS_SELECTED_COUNTRY_CODE) || 'TR';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];

            try {
                const productDoc = await db.collection('products').doc(productId).get();

                if (!productDoc.exists || productDoc.data().isActive === false) {
                    displayProductNotFound();
                    return;
                }

                currentProduct = productDoc.data();
                const product = currentProduct;

                // Ürün Adı, SKU ve Açıklama
                productNameEl.textContent = product[`name_${currentLanguageCode}`] || product.name_tr || 'Ürün Adı Yok';
                productSkuEl.textContent = product.sku || 'N/A';
                productDescriptionEl.innerHTML = product[`description_${currentLanguageCode}`] || product.description_tr || texts.productDetailDescription;

                // Fiyat
                const selectedCountryData = allCountries.find(c => c.code === currentCountryCode);
                const priceMultiplier = selectedCountryData ? (selectedCountryData.multiplier || 1) : 1;
                const calculatedPrice = (product.basePriceTRY * priceMultiplier).toFixed(2);
                const currencySymbol = allCurrencies.find(c => c.code === currentCurrencyCode)?.symbol || '₺';
                productPriceEl.textContent = `${calculatedPrice} ${currencySymbol}`;

                // Görsel Galerisi
                productThumbnailsEl.innerHTML = '';
                if (product.mediaUrls && product.mediaUrls.length > 0) {
                    mainProductImageEl.src = product.mediaUrls[0]; // Ana görseli ayarla
                    product.mediaUrls.forEach((url, index) => {
                        const isVideo = url.match(/\.(mp4|webm|ogg)$/i) || url.includes('youtube.com') || url.includes('vimeo.com');
                        const thumbEl = document.createElement(isVideo ? 'video' : 'img');
                        thumbEl.src = url;
                        if (isVideo) {
                            thumbEl.controls = false; // Thumbnail olarak kullanılacağı için kontrolleri gizle
                            thumbEl.muted = true; // Otomatik oynatma için sessiz olsun
                            thumbEl.setAttribute('preload', 'metadata');
                            thumbEl.poster = `https://via.placeholder.com/80x80?text=Video`; // Video thumbnaili için placeholder
                        }
                        thumbEl.classList.add('img-fluid');
                        if (index === 0) thumbEl.classList.add('active'); // İlk thumbnail aktif olsun
                        thumbEl.addEventListener('click', () => {
                            mainProductImageEl.src = url;
                            // Aktif sınıfını diğerlerinden kaldırıp tıklanana ekle
                            productThumbnailsEl.querySelectorAll('.active').forEach(img => img.classList.remove('active'));
                            thumbEl.classList.add('active');
                        });
                        productThumbnailsEl.appendChild(thumbEl);
                    });
                } else {
                    mainProductImageEl.src = 'https://via.placeholder.com/600x400?text=Görsel+Yok';
                }

                // Varyantlar (basit örnek)
                productVariantsEl.innerHTML = '';
                if (product.variants && (product.variants.colors.length > 0 || product.variants.sizes.length > 0 || product.variants.fabrics.length > 0)) {
                    // Renkler
                    if (product.variants.colors && product.variants.colors.length > 0) {
                        const colorDiv = document.createElement('div');
                        colorDiv.className = 'mb-3';
                        colorDiv.innerHTML = `<label class="form-label">Renk:</label><div class="d-flex flex-wrap gap-2" id="color-options"></div>`;
                        product.variants.colors.forEach(color => {
                            const translatedColorName = color.translations[currentLanguageCode] || color.name;
                            const inputId = `color-${color.name}`;
                            colorDiv.querySelector('#color-options').innerHTML += `
                                <div class="form-check variant-option">
                                    <input type="radio" class="form-check-input" name="color" id="${inputId}" value="${color.name}">
                                    <label class="form-check-label" for="${inputId}">${translatedColorName}</label>
                                </div>`;
                        });
                        productVariantsEl.appendChild(colorDiv);
                    }
                    // Boyutlar
                    if (product.variants.sizes && product.variants.sizes.length > 0) {
                        const sizeDiv = document.createElement('div');
                        sizeDiv.className = 'mb-3';
                        sizeDiv.innerHTML = `<label class="form-label">Boyut:</label><div class="d-flex flex-wrap gap-2" id="size-options"></div>`;
                        product.variants.sizes.forEach(size => {
                            const inputId = `size-${size}`;
                            sizeDiv.querySelector('#size-options').innerHTML += `
                                <div class="form-check variant-option">
                                    <input type="radio" class="form-check-input" name="size" id="${inputId}" value="${size}">
                                    <label class="form-check-label" for="${inputId}">${size}</label>
                                </div>`;
                        });
                        productVariantsEl.appendChild(sizeDiv);
                    }
                    // Kumaşlar
                    if (product.variants.fabrics && product.variants.fabrics.length > 0) {
                        const fabricDiv = document.createElement('div');
                        fabricDiv.className = 'mb-3';
                        fabricDiv.innerHTML = `<label class="form-label">Kumaş:</label><div class="d-flex flex-wrap gap-2" id="fabric-options"></div>`;
                        product.variants.fabrics.forEach(fabric => {
                            const inputId = `fabric-${fabric}`;
                            fabricDiv.querySelector('#fabric-options').innerHTML += `
                                <div class="form-check variant-option">
                                    <input type="radio" class="form-check-input" name="fabric" id="${inputId}" value="${fabric}">
                                    <label class="form-check-label" for="${inputId}">${fabric}</label>
                                </div>`;
                        });
                        productVariantsEl.appendChild(fabricDiv);
                    }
                } else {
                    productVariantsEl.innerHTML = `<p class="text-muted">${texts.productDetailNoVariants}</p>`;
                }


                // Stok durumu
                if (product.stock > 0) {
                    stockStatusEl.textContent = texts.productDetailInStock;
                    stockStatusEl.classList.remove('text-danger');
                    stockStatusEl.classList.add('text-success');
                    addToCartBtn.disabled = false;
                } else {
                    stockStatusEl.textContent = texts.productDetailOutOfStock;
                    stockStatusEl.classList.remove('text-success');
                    stockStatusEl.classList.add('text-danger');
                    addToCartBtn.disabled = true;
                }

                // Ücretsiz Kargo Rozeti
                if (product.freeShipping) {
                    freeShippingBadge.classList.remove('d-none');
                    freeShippingBadge.textContent = texts.productDetailFreeShipping;
                } else {
                    freeShippingBadge.classList.add('d-none');
                }

            } catch (error) {
                console.error("Ürün detayları yüklenirken hata:", error);
                displayProductNotFound();
            }
        }

        function displayProductNotFound() {
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];
            
            document.getElementById('product-detail-container').innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle-fill text-danger display-4 mb-3"></i>
                    <h2>${texts.productNotFound}</h2>
                    <p>${texts.productNotFoundMessage}</p>
                    <a href="index.html" class="btn btn-primary mt-3">Ana Sayfaya Dön</a>
                </div>
            `;
        }


        // Sepete Ekle Fonksiyonu (Geçici)
        addToCartBtn.addEventListener('click', () => {
            if (!currentProduct) return;

            const selectedQuantity = parseInt(quantityInput.value);
            if (isNaN(selectedQuantity) || selectedQuantity <= 0) {
                alert('Geçerli bir adet giriniz.');
                return;
            }

            // Seçilen varyantları al
            const selectedVariants = {};
            productVariantsEl.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                selectedVariants[radio.name] = radio.value;
            });

            // Eğer varyantlar varsa ve seçilmemişse uyarı ver
            const hasColorVariants = currentProduct.variants && currentProduct.variants.colors && currentProduct.variants.colors.length > 0;
            const hasSizeVariants = currentProduct.variants && currentProduct.variants.sizes && currentProduct.variants.sizes.length > 0;
            const hasFabricVariants = currentProduct.variants && currentProduct.variants.fabrics && currentProduct.variants.fabrics.length > 0;
            
            if ((hasColorVariants && !selectedVariants.color) ||
                (hasSizeVariants && !selectedVariants.size) ||
                (hasFabricVariants && !selectedVariants.fabric)) {
                
                const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
                const texts = appTexts[currentLanguageCode] || appTexts['en'];
                alert(texts.pleaseSelectVariant);
                return;
            }


            let cart = JSON.parse(localStorage.getItem('pufemo_cart_items') || '[]');
            
            // Sepette aynı ürün ve varyant kombinasyonu varsa adeti artır
            const existingItemIndex = cart.findIndex(item => 
                item.productId === currentProduct.id && 
                JSON.stringify(item.selectedVariants || {}) === JSON.stringify(selectedVariants || {})
            );

            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += selectedQuantity;
            } else {
                cart.push({
                    productId: currentProduct.id,
                    name: productNameEl.textContent, // Sepet görünümünde kolaylık için
                    price: parseFloat(productPriceEl.textContent.replace(/[^\d.]/g, '')), // Sadece sayısal kısım
                    currency: localStorage.getItem(LS_SELECTED_CURRENCY_CODE) || 'TRY',
                    imageUrl: mainProductImageEl.src, // Sepet görünümünde kolaylık için
                    quantity: selectedQuantity,
                    selectedVariants: selectedVariants
                });
            }

            localStorage.setItem('pufemo_cart_items', JSON.stringify(cart));
            updateCartItemCount();
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];
            alert(texts.itemAddedToCart);
        });


        // Sepet sayacını güncelle (index.html'deki ile aynı)
        function updateCartItemCount() {
            const cartItems = JSON.parse(localStorage.getItem('pufemo_cart_items') || '[]');
            document.getElementById('cart-item-count').textContent = cartItems.length;
        }

        // --- Header ve Footer İçin Ortak Fonksiyonlar (index.html'den kopyalandı) ---

        async function populateHeaderSelectors() {
            const currentLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            headerCountrySelect.innerHTML = '';
            allCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country[`name_${currentLangCode}`] || country.name_tr || country.name;
                headerCountrySelect.appendChild(option);
            });

            headerLanguageSelect.innerHTML = '';
            allLanguages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.code;
                option.textContent = lang.name; 
                headerLanguageSelect.appendChild(option);
            });

            headerCurrencySelect.innerHTML = '';
            allCurrencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.code;
                option.textContent = `${currency.symbol} (${currency.code})`;
                headerCurrencySelect.appendChild(option);
            });

            headerCountrySelect.value = localStorage.getItem(LS_SELECTED_COUNTRY_CODE) || '';
            headerLanguageSelect.value = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || '';
            headerCurrencySelect.value = localStorage.getItem(LS_SELECTED_CURRENCY_CODE) || '';
        }

        function updateHeaderDisplays() {
            const currentCountryCode = localStorage.getItem(LS_SELECTED_COUNTRY_CODE);
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE);
            const currentCurrencyCode = localStorage.getItem(LS_SELECTED_CURRENCY_CODE);

            const selectedCountry = allCountries.find(c => c.code === currentCountryCode);
            const selectedLanguage = allLanguages.find(l => l.code === currentLanguageCode);
            const selectedCurrency = allCurrencies.find(c => c.code === currentCurrencyCode);

            selectedCountryDisplay.textContent = selectedCountry ? selectedCountry.code.toUpperCase() : 'TR';
            selectedLanguageDisplay.textContent = selectedLanguage ? selectedLanguage.code.toUpperCase() : 'TR';
            selectedCurrencyDisplay.textContent = selectedCurrency ? selectedCurrency.symbol : '₺';
        }

        function updateStaticContent() {
            const currentLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr'; 
            const texts = appTexts[currentLangCode] || appTexts['en']; 

            footerCompanyAddress.textContent = siteSettings[`companyAddress_${currentLangCode}`] || texts.footerAddressNotFound;
            footerContactEmail.textContent = siteSettings.contactEmail || 'info@pufemo.com';
            footerWhatsappNumber.textContent = siteSettings.whatsappNumber || '+90 5XX XXX XX XX';
            // Ana sayfadaki promo banner'ı burada olmadığı için güncellenmiyor
            
            // Menüdeki login/register linklerini güncelle
            if (menuLoginLink) menuLoginLink.textContent = texts.menuLogin;
            if (menuRegisterLink) menuRegisterLink.textContent = texts.menuRegister;
        }

        // Headerdaki ülke/dil/para birimi değiştiğinde tüm sayfayı güncelleyen event listener
        saveHeaderSelectionsBtn.addEventListener('click', () => {
            localStorage.setItem(LS_SELECTED_COUNTRY_CODE, headerCountrySelect.value);
            localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, headerLanguageSelect.value);
            localStorage.setItem(LS_SELECTED_CURRENCY_CODE, headerCurrencySelect.value);
            updateHeaderDisplays();
            updateStaticContent(); 
            
            // Ürün detaylarını yeni dile/para birimine göre yeniden yükle
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            if (productId) {
                loadProductDetails(productId);
            }
            alert(appTexts[localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr']?.settingsSaved || appTexts['en'].settingsSaved); 
        });

    </script>
</body>
</html>
