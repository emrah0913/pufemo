<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme - PUFEMO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f8f9fa; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
        .footer { background-color: #343a40; color: white; padding: 30px 0; margin-top: auto; }
        /* Diğer stiller aynı... */
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light">
        </nav>

    <main class="container my-4 flex-grow-1">
        <h1 class="mb-4">Ödeme</h1>
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">Adres Bilgileri</div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <h4 class="mb-3">Gönderim Adresi</h4>
                            <div class="row g-3">
                                <div class="col-sm-6"><label for="firstName" class="form-label">Ad</label><input type="text" class="form-control" id="firstName" name="firstName" required></div>
                                <div class="col-sm-6"><label for="lastName" class="form-label">Soyad</label><input type="text" class="form-control" id="lastName" name="lastName" required></div>
                                <div class="col-12"><label for="email" class="form-label">E-posta</label><input type="email" class="form-control" id="email" name="email" required></div>
                                
                                <div class="col-12">
                                    <label for="phone-number" class="form-label">Telefon</label>
                                    <div class="input-group">
                                        <select class="form-select" id="phone-country-code" name="phoneCountryCode" style="max-width: 120px;"></select>
                                        <input type="tel" class="form-control" id="phone-number" name="phoneNumber" placeholder="5XX XXX XX XX" required>
                                    </div>
                                </div>
                                <div class="col-12"><label for="address1" class="form-label">Adres 1</label><input type="text" class="form-control" id="address1" name="address1" required></div>
                                <div class="col-12"><label for="address2" class="form-label">Adres 2 (Opsiyonel)</label><input type="text" class="form-control" id="address2" name="address2"></div>
                                <div class="col-md-5"><label for="country" class="form-label">Ülke</label><select class="form-select" id="country" name="country" required></select></div>
                                <div class="col-md-4"><label for="city" class="form-label">Şehir</label><input type="text" class="form-control" id="city" name="city" required></div>
                                <div class="col-md-3"><label for="zip" class="form-label">Posta Kodu</label><input type="text" class="form-control" id="zip" name="zip" required></div>
                            </div>

                            <hr class="my-4">

                            <h4 class="mb-3">Fatura Adresi</h4>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="same-address" name="sameAddress" checked>
                                <label class="form-check-label" for="same-address">Gönderim adresi ile aynı</label>
                            </div>
                            <div id="billing-address-fields" class="row g-3 d-none">
                                <div class="col-sm-6"><label for="billingFirstName" class="form-label">Ad</label><input type="text" class="form-control" id="billingFirstName" name="billingFirstName"></div>
                                <div class="col-sm-6"><label for="billingLastName" class="form-label">Soyad</label><input type="text" class="form-control" id="billingLastName" name="billingLastName"></div>
                                
                                <div class="col-12">
                                    <label for="billing-phone-number" class="form-label">Telefon</label>
                                    <div class="input-group">
                                        <select class="form-select" id="billing-phone-country-code" name="billingPhoneCountryCode" style="max-width: 120px;"></select>
                                        <input type="tel" class="form-control" id="billing-phone-number" name="billingPhoneNumber" placeholder="5XX XXX XX XX">
                                    </div>
                                </div>
                                </div>

                            <hr class="my-4">
                            <button class="w-100 btn btn-primary btn-lg" type="submit" id="complete-order-button">Siparişi Tamamla</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                </div>
        </div>
    </main>

    <div class="modal fade" id="orderSuccessModal" ... >
        </div>
    
    <footer class="footer">
        </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Yapılandırması ve Global Değişkenler
        const firebaseConfig = { /* ... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let allCountries = [];
        // ... diğer değişkenler

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCommonDataAndPopulateHeader();
            // ... diğer başlangıç fonksiyonları
            
            // Ülke seçimi değiştiğinde telefon kodunu da güncelle
            document.getElementById('country').addEventListener('change', (e) => {
                const selectedCountry = allCountries.find(c => c.code === e.target.value);
                if (selectedCountry && selectedCountry.dial_code) {
                    document.getElementById('phone-country-code').value = selectedCountry.dial_code;
                }
            });
        });

        async function loadCommonDataAndPopulateHeader() {
            try {
                const countriesSnapshot = await db.collection('countries').get();
                allCountries = countriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                populateCountrySelectors();
                populatePhoneCodeSelectors(); // YENİ FONKSİYONU ÇAĞIR

                // ...diğer işlemler...
            } catch (error) {
                console.error("Ortak veriler yüklenirken hata:", error);
            }
        }

        function populateCountrySelectors() {
            const countrySelect = document.getElementById('country');
            // ... (bu fonksiyon aynı kalabilir) ...
        }

        // ==================================================
        // YENİ FONKSİYON: Telefon Kodu Seçicisini Doldurur
        // ==================================================
        function populatePhoneCodeSelectors() {
            const phoneSelect = document.getElementById('phone-country-code');
            const billingPhoneSelect = document.getElementById('billing-phone-country-code');
            phoneSelect.innerHTML = '';
            billingPhoneSelect.innerHTML = '';

            allCountries.sort((a, b) => a.name_tr.localeCompare(b.name_tr)).forEach(country => {
                // NOT: Firestore'daki 'countries' koleksiyonunuzda telefon kodunu tutan alanın adının 'dial_code' olduğunu varsayıyorum.
                // Eğer farklı bir isimde (örn: 'phoneCode') tutuyorsanız, lütfen aşağıdaki 'country.dial_code' kısmını güncelleyin.
                const dialCode = country.dial_code; 
                
                if (dialCode) {
                    const optionHTML = `<option value="${dialCode}">${country.code.toUpperCase()} (${dialCode})</option>`;
                    phoneSelect.innerHTML += optionHTML;
                    billingPhoneSelect.innerHTML += optionHTML;
                }
            });

            // Varsayılan olarak ana ülke seçimine göre ayarla
            const defaultCountryCode = document.getElementById('country').value || 'TR';
            const defaultCountry = allCountries.find(c => c.code === defaultCountryCode);
            if (defaultCountry && defaultCountry.dial_code) {
                phoneSelect.value = defaultCountry.dial_code;
                billingPhoneSelect.value = defaultCountry.dial_code;
            }
        }

        // ==================================================
        // GÜNCELLENMİŞ FONKSİYON: Siparişi Kaydeder
        // ==================================================
        async function handleCheckoutSubmit(event) {
            event.preventDefault();
            // ... (fonksiyonun başı aynı) ...

            const formData = new FormData(event.target);
            
            // Telefon numarasını birleştir
            const fullPhoneNumber = formData.get('phoneCountryCode') + formData.get('phoneNumber');

            const customerInfo = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: fullPhoneNumber // BİRLEŞTİRİLMİŞ TELEFON NO
            };
            
            // ... (siparişin geri kalanı aynı) ...

            // veritabanına kaydetme kısmı...
            try {
                // ... (await newOrderRef.set(orderData)) ...
            } catch (error) {
                // ...
            }
        }

        // Diğer tüm fonksiyonlar (toggleBillingAddressFields, modal gösterme vb.) aynı kalabilir.
    </script>
</body>
</html>
