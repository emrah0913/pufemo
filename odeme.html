<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme - PUFEMO</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { display: flex; flex-direction: column; min-height: 100vh; background-color: #f8f9fa; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
        .footer { background-color: #343a40; color: white; padding: 30px 0; margin-top: auto; }
        .cart-item-image { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .order-summary-item { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .currency-language-selector { cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: background-color 0.2s; }
        .currency-language-selector:hover { background-color: #e9ecef; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">PUFEMO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Ana Sayfa</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Ürünler</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Kategoriler</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">İletişim</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Hesabım
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarAccountDropdown">
                            <li><a class="dropdown-item" href="admin-login.html" id="menu-login-link">Giriş Yap</a></li>
                            <li><a class="dropdown-item" href="kayit-ol.html" id="menu-register-link">Kayıt Ol</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="siparis-takip.html">Sipariş Takibi</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sepet.html"><i class="bi bi-cart-fill"></i> Sepet <span class="badge bg-primary rounded-pill" id="cart-item-count">0</span></a>
                    </li>
                    <li class="nav-item dropdown">
                         </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4 flex-grow-1">
        <h1 class="mb-4" id="checkout-page-title">Ödeme</h1>
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header" id="address-section-header">Adres Bilgileri</div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <h4 class="mb-3" id="shipping-address-title">Gönderim Adresi</h4>
                            <div class="row g-3">
                                <div class="col-sm-6"><label for="firstName" class="form-label" id="firstNameLabel">Ad</label><input type="text" class="form-control" id="firstName" name="firstName" required></div>
                                <div class="col-sm-6"><label for="lastName" class="form-label" id="lastNameLabel">Soyad</label><input type="text" class="form-control" id="lastName" name="lastName" required></div>
                                <div class="col-12"><label for="email" class="form-label" id="emailLabel">E-posta</label><input type="email" class="form-control" id="email" name="email" required></div>
                                <div class="col-12"><label for="phone" class="form-label" id="phoneLabel">Telefon</label><input type="tel" class="form-control" id="phone" name="phone" placeholder="+90 5XX XXX XX XX" required></div>
                                <div class="col-12"><label for="address1" class="form-label" id="address1Label">Adres 1</label><input type="text" class="form-control" id="address1" name="address1" placeholder="Cadde, Sokak, No" required></div>
                                <div class="col-12"><label for="address2" class="form-label" id="address2Label">Adres 2 (Opsiyonel)</label><input type="text" class="form-control" id="address2" name="address2" placeholder="Bina, Daire, Kat"></div>
                                <div class="col-md-5"><label for="country" class="form-label" id="countryLabel">Ülke</label><select class="form-select" id="country" name="country" required><option value="">Seçiniz...</option></select></div>
                                <div class="col-md-4"><label for="city" class="form-label" id="cityLabel">Şehir</label><input type="text" class="form-control" id="city" name="city" required></div>
                                <div class="col-md-3"><label for="zip" class="form-label" id="zipLabel">Posta Kodu</label><input type="text" class="form-control" id="zip" name="zip" required></div>
                            </div>

                            <hr class="my-4">

                            <h4 class="mb-3" id="billing-address-title">Fatura Adresi</h4>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="same-address" name="sameAddress" checked>
                                <label class="form-check-label" for="same-address" id="same-address-label">Gönderim adresi ile aynı</label>
                            </div>
                            <hr class="my-4">

                            <h4 class="mb-3" id="payment-method-title">Ödeme Yöntemi</h4>
                            <hr class="my-4">
                            <h4 class="mb-3" id="agreements-title">Onaylar</h4>
                             <hr class="my-4">

                            <button class="w-100 btn btn-primary btn-lg" type="submit" id="complete-order-button">Siparişi Tamamla</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header" id="order-summary-header">Sipariş Özeti</div>
                    <div class="card-body">
                         </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-labelledby="orderSuccessModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="orderSuccessModalLabel">
                <i class="bi bi-check-circle-fill text-success me-2"></i>Siparişiniz Başarıyla Alındı!
            </h5>
          </div>
          <div class="modal-body text-center">
            <p>Siparişinizi takip etmek için lütfen aşağıdaki numarayı kaydedin.</p>
            
            <div class="bg-light p-3 my-3 rounded border">
                <p class="mb-1 text-muted">Sipariş Takip Numaranız:</p>
                <h3 class="fw-bold" id="modal-order-number" style="letter-spacing: 2px;"></h3>
            </div>
    
            <button class="btn btn-outline-primary" id="copy-order-number-btn">
                <i class="bi bi-clipboard me-2"></i>Numarayı Kopyala
            </button>
    
          </div>
          <div class="modal-footer justify-content-center">
            <a href="siparis-takip.html" id="go-to-tracking-btn" class="btn btn-primary">Sipariş Detaylarını Gör</a>
          </div>
        </div>
      </div>
    </div>
    <footer class="footer">
         </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Yapılandırması ve diğer scriptler aynı kalabilir...
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae2157776e2e1d2",
            measurementId: "G-RH8XHC7P91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Diğer global değişkenler ve event listener'lar aynı kalabilir...
        let cartItems = [];
        let finalOrderTotal = 0;
        // ...

        document.addEventListener('DOMContentLoaded', () => {
             // ... sayfa yükleme fonksiyonları ...
             document.getElementById('checkout-form').addEventListener('submit', handleCheckoutSubmit);
        });
        
        // Diğer yardımcı fonksiyonlar (loadCommonData, toggleBillingAddressFields vb.) aynı kalabilir...


        // ===============================================================
        // GÜNCELLENMİŞ handleCheckoutSubmit FONKSİYONU
        // ===============================================================
        async function handleCheckoutSubmit(event) {
            event.preventDefault();
            document.getElementById('complete-order-button').disabled = true;

            const texts = { /* ... dil metinleri ... */ }; // Kısaltıldı
            cartItems = JSON.parse(localStorage.getItem('pufemo_cart_items') || '[]');
            if (cartItems.length === 0) {
                alert('Sepetiniz boş.');
                document.getElementById('complete-order-button').disabled = false;
                return;
            }
            if (!document.getElementById('agreement1').checked || !document.getElementById('agreement2').checked) {
                alert('Lütfen tüm sözleşmeleri onaylayınız.');
                document.getElementById('complete-order-button').disabled = false;
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            const customerInfo = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone')
            };
            const shippingAddress = {
                address1: formData.get('address1'),
                address2: formData.get('address2'),
                country: formData.get('country'),
                city: formData.get('city'),
                zip: formData.get('zip')
            };
            const billingAddress = document.getElementById('same-address').checked ? { ...shippingAddress } : { /* ... */ };

            const user = auth.currentUser;
            const newOrderRef = db.collection('orders').doc();
            const fullOrderId = newOrderRef.id;
            const shortOrderId = fullOrderId.substring(0, 8).toUpperCase();

            const orderData = {
                userId: user ? user.uid : 'anonymous',
                shortOrderId: shortOrderId,
                customerInfo,
                shippingAddress,
                billingAddress,
                products: cartItems,
                totalAmount: finalOrderTotal, // Bu değişkenin doğru hesaplandığından emin olun
                currency: '₺', // Bu değişkenin doğru hesaplandığından emin olun
                paymentMethod: formData.get('paymentMethod'),
                status: formData.get('paymentMethod') === 'Bank Transfer / EFT' ? 'Pending Payment' : 'New',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await newOrderRef.set(orderData);
                localStorage.removeItem('pufemo_cart_items');
                // updateCartItemCount(); // Bu fonksiyonu çağırabilirsiniz

                // ------ ALERT YERİNE YENİ MODAL KODU ------
                
                // 1. Modal içindeki bilgileri doldur
                document.getElementById('modal-order-number').textContent = shortOrderId;
                const trackingUrl = `siparis-takip.html?orderId=${fullOrderId}&email=${customerInfo.email}`;
                document.getElementById('go-to-tracking-btn').href = trackingUrl;

                // 2. Kopyala butonunu ayarla
                const copyBtn = document.getElementById('copy-order-number-btn');
                const originalBtnText = copyBtn.innerHTML;
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(shortOrderId).then(() => {
                        copyBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Kopyalandı!';
                        copyBtn.classList.add('btn-success');
                        copyBtn.classList.remove('btn-outline-primary');
                        setTimeout(() => {
                           copyBtn.innerHTML = originalBtnText;
                           copyBtn.classList.remove('btn-success');
                           copyBtn.classList.add('btn-outline-primary');
                        }, 2000);
                    });
                });

                // 3. Modalı göster
                const successModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
                successModal.show();
                
                // 4. Modal'daki yönlendirme butonuna basıldığında yönlendir (isteğe bağlı, zaten link var)
                // İsterseniz pencere kapatılınca otomatik yönlendirme de ekleyebilirsiniz:
                document.getElementById('orderSuccessModal').addEventListener('hidden.bs.modal', () => {
                    window.location.href = trackingUrl;
                });

            } catch (error) {
                console.error("Sipariş kaydedilirken hata:", error);
                alert('Siparişiniz kaydedilirken bir hata oluştu.');
                document.getElementById('complete-order-button').disabled = false;
            }
        }
    </script>
</body>
</html>
