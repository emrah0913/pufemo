<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Malzeme Y√∂netimi - PUFEMO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
      authDomain: "pufemo-com.firebaseapp.com",
      projectId: "pufemo-com",
      storageBucket: "pufemo-com.appspot.com",
      messagingSenderId: "983352837227",
      appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
      measurementId: "G-RH8XHC7P91"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const tableBody = document.getElementById("materialList");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("Giri≈ü yapƒ±lmamƒ±≈ü.");
        window.location.href = "index.html";
      } else {
        loadMaterials();
      }
    });

    document.getElementById("addPropertyBtn").addEventListener("click", () => {
      const container = document.getElementById("properties");
      const div = document.createElement("div");
      div.className = "flex gap-2 mb-2";
      div.innerHTML = `
        <input type="text" placeholder="√ñzellik Adƒ±" class="border p-1 rounded name w-1/2" />
        <input type="text" placeholder="Deƒüer" class="border p-1 rounded value w-1/2" />
        <button type="button" class="text-red-500" onclick="this.parentElement.remove()">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    });

    document.getElementById("materialForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const type = document.getElementById("type").value.trim();
      const stock = parseInt(document.getElementById("stock").value);
      const price = parseFloat(document.getElementById("price").value);
      const imageUrlInput = document.getElementById("imageUrl").value.trim();
      const fileInput = document.getElementById("imageFile").files[0];

      const attributes = {};
      document.querySelectorAll("#properties > div").forEach((div) => {
        const key = div.querySelector(".name").value.trim();
        const val = div.querySelector(".value").value.trim();
        if (key && val) {
          attributes[key] = val;
        }
      });

      let imageUrl = "";

      if (fileInput) {
        const ext = fileInput.name.split('.').pop().toLowerCase();
        if (!['jpg', 'jpeg', 'png'].includes(ext)) {
          alert("Yalnƒ±zca .jpg, .jpeg, .png dosyalarƒ± kabul edilir.");
          return;
        }
        const storageRef = ref(storage, `material-images/${Date.now()}_${fileInput.name}`);
        await uploadBytes(storageRef, fileInput);
        imageUrl = await getDownloadURL(storageRef);
      } else if (imageUrlInput) {
        imageUrl = imageUrlInput;
      }

      await addDoc(collection(db, "materials"), {
        name,
        type,
        stock,
        price,
        attributes,
        imageUrl
      });

      e.target.reset();
      document.getElementById("properties").innerHTML = "";
      loadMaterials();
    });

    async function loadMaterials() {
      tableBody.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "materials"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const props = Object.entries(data.attributes || {})
          .map(([key, value]) => `<div><strong>${key}</strong>: ${value}</div>`)
          .join("");
        const image = data.imageUrl
          ? `<img src="${data.imageUrl}" class="w-16 h-16 object-cover rounded" />`
          : "-";
        const row = `
          <tr class="border-b">
            <td class="p-2">${data.name}</td>
            <td class="p-2">${data.type}</td>
            <td class="p-2">${data.stock}</td>
            <td class="p-2">${data.price} ‚Ç∫</td>
            <td class="p-2 text-sm">${props}</td>
            <td class="p-2">${image}</td>
            <td class="p-2">
              <button onclick="deleteMaterial('${docSnap.id}')" class="text-red-600 hover:underline">Sil</button>
            </td>
          </tr>
        `;
        tableBody.innerHTML += row;
      });
    }

    window.deleteMaterial = async (id) => {
      if (confirm("Bu malzemeyi silmek istiyor musunuz?")) {
        await deleteDoc(doc(db, "materials", id));
        loadMaterials();
      }
    };
  </script>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="bg-white shadow p-6 flex justify-between items-center">
    <h1 class="text-xl font-bold">Malzeme Y√∂netimi</h1>
    <a href="index.html" class="text-blue-600 hover:underline">Ana Sayfa</a>
  </header>

  <main class="max-w-6xl mx-auto p-6">
    <form id="materialForm" class="bg-white p-6 rounded shadow mb-10 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <input id="name" type="text" placeholder="Malzeme Adƒ±" class="border p-2 rounded" required />
        <input id="type" type="text" placeholder="Malzeme T√ºr√º" class="border p-2 rounded" required />
        <input id="stock" type="number" placeholder="Stok" class="border p-2 rounded" required />
        <input id="price" type="number" placeholder="Fiyat (‚Ç∫)" step="0.01" class="border p-2 rounded" required />
      </div>
      <div>
        <h3 class="font-semibold mb-1">√ñzellikler</h3>
        <div id="properties" class="space-y-2"></div>
        <button type="button" id="addPropertyBtn" class="mt-2 text-blue-600 hover:underline">+ √ñzellik Ekle</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <input id="imageUrl" type="url" placeholder="G√∂rsel URL (isteƒüe baƒülƒ±)" class="border p-2 rounded" />
        <input id="imageFile" type="file" accept=".jpg,.jpeg,.png" class="border p-2 rounded bg-white" />
      </div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Malzeme Kaydet</button>
    </form>

    <table class="w-full bg-white rounded shadow text-sm overflow-x-auto">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">Ad</th>
          <th class="p-2 text-left">T√ºr</th>
          <th class="p-2 text-left">Stok</th>
          <th class="p-2 text-left">Fiyat</th>
          <th class="p-2 text-left">√ñzellikler</th>
          <th class="p-2 text-left">G√∂rsel</th>
          <th class="p-2 text-left">ƒ∞≈ülem</th>
        </tr>
      </thead>
      <tbody id="materialList"></tbody>
    </table>
  </main>
</body>
</html>
