<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Malzeme Yönetimi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
      authDomain: "pufemo-com.firebaseapp.com",
      projectId: "pufemo-com",
      storageBucket: "pufemo-com.appspot.com",
      messagingSenderId: "983352837227",
      appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
      measurementId: "G-RH8XHC7P91"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const tableBody = document.getElementById("materialList");
    const fieldContainer = document.getElementById("dynamicFields");
    const templateSelect = document.getElementById("templateSelect");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Giriş yapılmamış.");
        window.location.href = "index.html";
      } else {
        await ensureDefaultTemplates();
        loadTemplates();
        loadMaterials();
      }
    });

    async function ensureDefaultTemplates() {
      const snapshot = await getDocs(collection(db, "templates"));
      if (!snapshot.empty) return;

      const defaultTemplates = [
        {
          id: "mdflam",
          type: "mdflam",
          fields: [
            { name: "renk", type: "text", unit: "" },
            { name: "plakaBoy", type: "number", unit: "mm" },
            { name: "plakaEn", type: "number", unit: "mm" },
            { name: "birimFiyat", type: "number", unit: "₺" }
          ]
        },
        {
          id: "mentese",
          type: "menteşe",
          fields: [
            { name: "adet", type: "number", unit: "adet" },
            { name: "çap", type: "number", unit: "mm" },
            { name: "birimFiyat", type: "number", unit: "₺" }
          ]
        },
        {
          id: "kenarbandi",
          type: "kenarbandı",
          fields: [
            { name: "kalınlık", type: "number", unit: "mm" },
            { name: "renk", type: "text", unit: "" },
            { name: "metretülFiyat", type: "number", unit: "₺" }
          ]
        }
      ];

      for (const tmpl of defaultTemplates) {
        await setDoc(doc(db, "templates", tmpl.id), tmpl);
      }
    }

    async function loadTemplates() {
      const snapshot = await getDocs(collection(db, "templates"));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = data.type;
        templateSelect.appendChild(option);
      });
    }

    templateSelect.addEventListener("change", async () => {
      fieldContainer.innerHTML = "";
      if (!templateSelect.value) return;
      const refDoc = doc(db, "templates", templateSelect.value);
      const snap = await getDoc(refDoc);
      if (!snap.exists()) return;
      const template = snap.data();

      template.fields.forEach(field => {
        const div = document.createElement("div");
        div.className = "mb-2";
        div.innerHTML = `
          <label class="block text-sm font-medium">${field.name} ${field.unit ? `(${field.unit})` : ""}</label>
          <input type="${field.type}" name="${field.name}" class="border p-2 rounded w-full" />
        `;
        fieldContainer.appendChild(div);
      });
    });

    document.getElementById("materialForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const type = templateSelect.options[templateSelect.selectedIndex].text;
      const fields = fieldContainer.querySelectorAll("input");
      const fieldValues = {};

      fields.forEach(input => {
        fieldValues[input.name] = input.value;
      });

      let imageUrl = "";
      const imageFile = document.getElementById("imageFile").files[0];
      const imageUrlInput = document.getElementById("imageUrl").value.trim();

      if (imageFile) {
        const ext = imageFile.name.split('.').pop().toLowerCase();
        if (!['jpg', 'jpeg', 'png'].includes(ext)) {
          alert("Yalnızca .jpg, .jpeg, .png dosyaları kabul edilir.");
          return;
        }
        const storageRef = ref(storage, `material-images/${Date.now()}_${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        imageUrl = await getDownloadURL(storageRef);
      } else if (imageUrlInput) {
        imageUrl = imageUrlInput;
      }

      await addDoc(collection(db, "materials"), {
        type,
        fieldValues,
        imageUrl
      });

      e.target.reset();
      fieldContainer.innerHTML = "";
      loadMaterials();
    });

    async function loadMaterials() {
      tableBody.innerHTML = "";
      const snapshot = await getDocs(collection(db, "materials"));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const props = Object.entries(data.fieldValues || {})
          .map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join("");
        const image = data.imageUrl
          ? `<img src="${data.imageUrl}" class="w-16 h-16 object-cover rounded" />`
          : "-";
        const row = `
          <tr class="border-b">
            <td class="p-2">${data.type}</td>
            <td class="p-2 text-sm">${props}</td>
            <td class="p-2">${image}</td>
            <td class="p-2"><button onclick="deleteMaterial('${docSnap.id}')" class="text-red-600 hover:underline">Sil</button></td>
          </tr>`;
        tableBody.innerHTML += row;
      });
    }

    window.deleteMaterial = async (id) => {
      await deleteDoc(doc(db, "materials", id));
      loadMaterials();
    };
  </script>
</head>
<body class="bg-gray-100 text-gray-800">
  <main class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Malzeme Yönetimi</h1>
    <form id="materialForm" class="bg-white p-6 rounded shadow space-y-4">
      <div>
        <label class="block font-semibold mb-1">Malzeme Türü</label>
        <select id="templateSelect" class="border p-2 rounded w-full">
          <option value="">Malzeme Türü Seçin</option>
        </select>
      </div>
      <div id="dynamicFields"></div>
      <div class="grid md:grid-cols-2 gap-4">
        <input id="imageUrl" type="url" placeholder="Görsel URL (isteğe bağlı)" class="border p-2 rounded" />
        <input id="imageFile" type="file" accept=".jpg,.jpeg,.png" class="border p-2 rounded bg-white" />
      </div>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Malzeme Kaydet</button>
    </form>

    <table class="w-full bg-white mt-10 rounded shadow text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 text-left">Tür</th>
          <th class="p-2 text-left">Özellikler</th>
          <th class="p-2 text-left">Görsel</th>
          <th class="p-2 text-left">İşlem</th>
        </tr>
      </thead>
      <tbody id="materialList"></tbody>
    </table>
  </main>
</body>
</html>
