<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PUFEMO - Ürün Detay</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f6f8; }
  header { background: #27ae60; color: white; padding: 20px; text-align: center; font-size: 26px; font-weight: bold; }
  .container { max-width: 800px; margin: 20px auto; background: white; border-radius: 10px; padding: 20px; }
  .product-images { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; }
  .product-images img { height: 150px; border-radius: 10px; cursor: pointer; object-fit: cover; }
  .main-image { width: 100%; height: 400px; border-radius: 10px; object-fit: contain; margin-bottom: 20px; }
  .product-title { font-weight: 700; font-size: 24px; margin-bottom: 10px; }
  .product-price { font-size: 22px; color: #27ae60; margin-bottom: 20px; }
  .variant-select { margin-bottom: 15px; }
  label { font-weight: 600; display: block; margin-bottom: 5px; }
  select { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 100%; }
</style>
</head>
<body>

<header>PUFEMO - Ürün Detay</header>

<div class="container" id="product-container">
  <p>Yükleniyor...</p>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getFirestore, doc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
    authDomain: "pufemo-com.firebaseapp.com",
    projectId: "pufemo-com",
    storageBucket: "pufemo-com.firebasestorage.app",
    messagingSenderId: "983352837227",
    appId: "1:983352837227:web:defaa8dae215776e2e",
    measurementId: "G-RH8XHC7P91"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id');

  const container = document.getElementById('product-container');

  async function loadProduct() {
    if (!productId) {
      container.innerHTML = '<p>Ürün ID bulunamadı.</p>';
      return;
    }

    const docRef = doc(db, 'products', productId);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      container.innerHTML = '<p>Ürün bulunamadı.</p>';
      return;
    }

    const product = docSnap.data();

    // Varyantları çek
    const variantsQuery = query(collection(db, 'variants'), where('productId', '==', productId));
    const variantsSnapshot = await getDocs(variantsQuery);
    const variants = [];
    variantsSnapshot.forEach(d => variants.push({ id: d.id, ...d.data() }));

    // HTML Hazırla
    let imagesHTML = '';
    if (product.images && product.images.length > 0) {
      imagesHTML = product.images.map(url => `<img src="${url}" alt="Ürün Görseli" onclick="showMainImage('${url}')" />`).join('');
    } else {
      imagesHTML = '<img src="https://via.placeholder.com/400x400?text=No+Image" alt="No Image" />';
    }

    let variantsHTML = '';
    const variantTypes = [...new Set(variants.map(v => v.type))];
    variantTypes.forEach(type => {
      const filtered = variants.filter(v => v.type === type);
      variantsHTML += `<div class="variant-select"><label>${type}</label><select id="variant-${type}">`;
      filtered.forEach(v => {
        variantsHTML += `<option value="${v.id}" data-price-diff="${v.priceDifference || 0}">${v.value}</option>`;
      });
      variantsHTML += '</select></div>';
    });

    container.innerHTML = `
      <img src="${product.images && product.images[0] ? product.images[0] : 'https://via.placeholder.com/400x400?text=No+Image'}" alt="Ana Görsel" class="main-image" id="main-image" />
      <h1 class="product-title">${product.translations?.tr?.title || 'Ürün'}</h1>
      <p>${product.translations?.tr?.description || ''}</p>
      <p class="product-price" id="price">${product.basePrice.toFixed(2)} ₺</p>
      ${variantsHTML}
    `;

    // Variant seçim ve fiyat güncelleme
    variantTypes.forEach(type => {
      const sel = document.getElementById(`variant-${type}`);
      sel.addEventListener('change', updatePrice);
    });
  }

  function showMainImage(url) {
    document.getElementById('main-image').src = url;
  }

  function updatePrice() {
    let basePrice = 0;
    const priceEl = document.getElementById('price');
    if (!window.product) return;
    basePrice = window.product.basePrice;

    let totalDiff = 0;
    const selects = document.querySelectorAll('[id^=variant-]');
    selects.forEach(sel => {
      const selectedOption = sel.options[sel.selectedIndex];
      const diff = parseFloat(selectedOption.getAttribute('data-price-diff')) || 0;
      totalDiff += diff;
    });

    priceEl.textContent = (basePrice + totalDiff).toFixed(2) + ' ₺';
  }

  window.addEventListener('load', async () => {
    await loadProduct();
    window.product = await (async () => {
      const docRef = doc(db, 'products', productId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return null;
      return docSnap.data();
    })();
  });
</script>

</body>
</html>
