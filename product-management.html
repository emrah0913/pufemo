<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Yönetimi - PUFEMO Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* ... Önceki CSS kodları ... */
        .variant-option-row { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="sidebar"> </div>

    <div id="main-content">
        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog modal-xl"> <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title" id="productModalLabel">Yeni Ürün Ekle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <form id="product-form">
                            <input type="hidden" id="productId">
                            <ul class="nav nav-tabs" id="languageTabs"></ul>
                            <div class="tab-content p-3 border border-top-0 mb-3" id="languageTabContent"></div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="productCategory" class="form-label">Kategori</label><select class="form-select" id="productCategory" required></select></div>
                            </div>
                            <div id="media-url-section"> </div>

                            <fieldset class="mt-4 p-3 border rounded">
                                <legend class="h6">Varyant Yönetimi</legend>
                                <div class="input-group mb-3">
                                    <input type="text" id="new-option-name" class="form-control" placeholder="Yeni Varyant Tipi (örn: Renk, Beden)">
                                    <button class="btn btn-outline-success" type="button" id="add-option-btn">Varyant Tipi Ekle</button>
                                </div>
                                <div id="variant-options-container"></div>
                                <button class="btn btn-info mt-2 w-100" type="button" id="generate-variants-btn">Varyasyonları Oluştur</button>
                            </fieldset>

                            <div id="variant-table-container" class="mt-4"></div>
                            
                            </form>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button><button type="submit" form="product-form" class="btn btn-primary">Ürünü Kaydet</button></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script>
        // ... (Firebase config ve diğer başlangıç kodları) ...
        let variantOptions = []; // { name: "Renk", values: ["Mavi", "Kırmızı"] }

        // VARYANT TİPİ EKLEME
        document.getElementById('add-option-btn').addEventListener('click', () => {
            const optionNameInput = document.getElementById('new-option-name');
            const optionName = optionNameInput.value.trim();
            if (optionName && !variantOptions.some(opt => opt.name === optionName)) {
                variantOptions.push({ name: optionName, values: [] });
                renderVariantOptions();
                optionNameInput.value = '';
            }
        });
        
        // VARYANT TİPİ ARAYÜZÜNÜ OLUŞTURMA
        function renderVariantOptions() {
            const container = document.getElementById('variant-options-container');
            container.innerHTML = '';
            variantOptions.forEach((option, index) => {
                container.innerHTML += `
                    <div class="input-group mb-2 variant-option-row">
                        <span class="input-group-text">${option.name}</span>
                        <input type="text" class="form-control option-values-input" placeholder="Değerleri virgülle ayırın (örn: S,M,L)" value="${option.values.join(',')}">
                        <button class="btn btn-outline-danger" type="button" onclick="removeOption(${index})">&times;</button>
                    </div>`;
            });
        }
        
        function removeOption(index) {
            variantOptions.splice(index, 1);
            renderVariantOptions();
        }

        // VARYASYONLARI OLUŞTURMA BUTONU
        document.getElementById('generate-variants-btn').addEventListener('click', () => {
            // Önce değerleri input'lardan alıp güncelle
            document.querySelectorAll('.variant-option-row').forEach((row, index) => {
                const values = row.querySelector('.option-values-input').value.split(',').map(v => v.trim()).filter(Boolean);
                variantOptions[index].values = values;
            });

            const allCombinations = getCombinations(variantOptions.map(opt => opt.values));
            renderVariantTable(allCombinations);
        });
        
        function getCombinations(arrays) {
            if (!arrays || arrays.length === 0) return [];
            let result = arrays[0].map(item => [item]);
            for (let i = 1; i < arrays.length; i++) {
                const nextResult = [];
                for (const res of result) {
                    for (const item of arrays[i]) {
                        nextResult.push([...res, item]);
                    }
                }
                result = nextResult;
            }
            return result;
        }

        function renderVariantTable(combinations) {
            const container = document.getElementById('variant-table-container');
            if (combinations.length === 0) { container.innerHTML = ''; return; }
            let tableHTML = `<table class="table table-bordered mt-3"><thead><tr>`;
            variantOptions.forEach(opt => { tableHTML += `<th>${opt.name}</th>`; });
            tableHTML += `<th>Fiyat (TRY)</th><th>Stok</th><th>SKU</th></tr></thead><tbody>`;

            combinations.forEach((combo, index) => {
                tableHTML += `<tr>`;
                combo.forEach(value => { tableHTML += `<td>${value}</td>`; });
                tableHTML += `
                    <td><input type="number" class="form-control variant-price" value="0.00"></td>
                    <td><input type="number" class="form-control variant-stock" value="0"></td>
                    <td><input type="text" class="form-control variant-sku"></td>
                </tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }
        
        // FORMU KAYDETME (TAMAMEN YENİLENDİ)
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('productId').value;
            const productData = {
                // ... dil ve kategori gibi diğer veriler...
                variants: [] // Varyantları buraya ekleyeceğiz
            };
            
            // Tablodaki her bir satırdan varyant verisini topla
            const variantRows = document.querySelectorAll('#variant-table-container tbody tr');
            variantRows.forEach(row => {
                const attributes = {};
                const attributeNames = variantOptions.map(opt => opt.name);
                const attributeValues = Array.from(row.children).slice(0, attributeNames.length).map(td => td.textContent);
                
                attributeNames.forEach((name, i) => { attributes[name] = attributeValues[i]; });

                productData.variants.push({
                    attributes: attributes,
                    price: parseFloat(row.querySelector('.variant-price').value),
                    stock: parseInt(row.querySelector('.variant-stock').value),
                    sku: row.querySelector('.variant-sku').value
                });
            });

            // ... Firestore'a kaydetme/güncelleme mantığı...
        });

        // Ürünü düzenlerken formu doldurma (yenilendi)
        async function editProduct(id) {
            // ... ürün verisini çek ...
            const product = doc.data();

            // ... dil, kategori, medya url gibi alanları doldur ...

            // Varyantları işle
            if (product.variants && product.variants.length > 0) {
                // Kayıtlı varyantlardan seçenekleri ve değerleri yeniden oluştur
                const options = {};
                product.variants.forEach(variant => {
                    for (const [key, value] of Object.entries(variant.attributes)) {
                        if (!options[key]) options[key] = new Set();
                        options[key].add(value);
                    }
                });
                variantOptions = Object.keys(options).map(key => ({ name: key, values: Array.from(options[key]) }));
                renderVariantOptions();

                // Varyasyon tablosunu oluştur ve verileri doldur
                const combinations = product.variants.map(v => Object.values(v.attributes));
                renderVariantTable(combinations);
                
                // Kayıtlı verileri tabloya yazdır
                const variantRows = document.querySelectorAll('#variant-table-container tbody tr');
                variantRows.forEach((row, index) => {
                    row.querySelector('.variant-price').value = product.variants[index].price;
                    row.querySelector('.variant-stock').value = product.variants[index].stock;
                    row.querySelector('.variant-sku').value = product.variants[index].sku;
                });
            }
            productModal.show();
        }
    </script>
</body>
</html>
