<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepetim & Siparişlerim | Getir Kıbrıs</title>
    <meta name="description" content="Sepetinizi yönetin, siparişlerinizi verin ve geçmiş siparişlerinizi takip edin.">
    <link rel="icon" href="https://pufemo.netlify.app/favicon.ico?v=2" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

    <script>
        // Tailwind CSS Konfigürasyonu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5d3ebc',
                        secondary: '#ffd300',
                        status: {
                            pending: '#f59e0b', // Amber 500
                            processing: '#3b82f6', // Blue 500
                            shipped: '#10b981', // Emerald 500
                            delivered: '#22c55e', // Green 500
                            cancelled: '#ef4444'  // Red 500
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'button': '8px'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #5d3ebc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Toast Notification Styling */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            z-index: 1000;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="w-full max-w-screen-lg mx-auto relative min-h-screen">
    <header class="sticky top-0 w-full bg-white shadow-sm z-50 px-4 py-3 flex items-center justify-between">
        <a href="https://pufemo.netlify.app/index.html" class="flex items-center gap-2">
            <img src="https://placehold.co/100x40/5d3ebc/ffffff?text=GetirKıbrıs&font=inter" alt="Getir Kıbrıs Logo" class="h-10">
        </a>
        <div class="flex items-center gap-4">
            <a href="https://pufemo.netlify.app/index.html" class="text-gray-600 hover:text-primary transition-colors">
                <i class="ri-home-4-line ri-lg"></i>
            </a>
            <div id="auth-button-container" class="w-8 h-8 flex items-center justify-center">
                <div id="profile-container" class="hidden cursor-pointer">
                    <img id="profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full">
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="pt-8 pb-20 px-4 hidden">
        
        <div id="active-cart-wrapper">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Aktif Sepet</h1>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-2/3 space-y-8">
                    <div id="cart-items-container" class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2">Ürünler</h2>
                        <div id="cart-items-list" class="space-y-4"></div>
                        <div id="empty-cart-message" class="text-center py-10 hidden">
                            <i class="ri-shopping-cart-2-line text-6xl text-gray-300"></i>
                            <p class="mt-4 text-gray-500">Sepetinizde henüz ürün bulunmuyor.</p>
                        </div>
                    </div>
                    <div id="delivery-options-wrapper" class="bg-white p-6 rounded-lg shadow-md">
                           <h2 class="text-xl font-semibold mb-4 border-b pb-2">Teslimat</h2>
                           <div class="space-y-3">
                               <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-primary/10 has-[:checked]:border-primary transition-all">
                                   <input type="radio" name="delivery-type" value="warehouse" class="mr-3 h-4 w-4" checked>
                                   <div class="flex-grow">
                                       <span class="font-semibold">Depodan Teslim</span>
                                       <p class="text-xs text-gray-600">Siparişinizi Lefkoşa'daki depomuzdan kendiniz teslim alın.</p>
                                   </div>
                               </label>
                               <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-primary/10 has-[:checked]:border-primary transition-all">
                                   <input type="radio" name="delivery-type" value="home" class="mr-3 h-4 w-4">
                                   <div class="flex-grow">
                                       <span class="font-semibold">Eve Teslim</span>
                                       <p class="text-xs text-gray-600">Siparişinizi adresinize teslim edelim.</p>
                                   </div>
                               </label>
                           </div>
                           <div id="city-selection-section" class="mt-4 hidden space-y-4">
                               <h3 class="text-md font-semibold mt-4">Teslimat Bölgesi Seçin</h3>
                               <div id="city-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                               <div id="delivery-address-section" class="mt-4">
                                   <label for="delivery-address" class="block text-sm font-medium text-gray-700 mb-1">Teslimat Adresi</label>
                                   <textarea id="delivery-address" rows="3" placeholder="Lütfen tam ve açık adresinizi giriniz..." class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm"></textarea>
                               </div>
                           </div>
                    </div>
                </div>

                <div class="w-full lg:w-1/3">
                    <div class="bg-white p-6 rounded-lg shadow-md lg:sticky lg:top-24 space-y-6">
                        <div id="order-summary-container">
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Sipariş Özeti</h2>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm text-gray-600"><span>Ürünler Toplamı</span><span id="subtotal">0.00 ₺</span></div>
                                <div id="delivery-fee-row" class="flex justify-between text-sm text-gray-600 hidden"><span>Teslimat Ücreti</span><span id="delivery-fee">0.00 ₺</span></div>
                                <div class="flex justify-between font-bold text-lg text-gray-800 pt-3 mt-3 border-t"><span>Genel Toplam</span><span id="grand-total">0.00 ₺</span></div>
                            </div>
                            <button id="proceed-to-payment-btn" class="w-full mt-6 bg-primary text-white py-3 rounded-button font-semibold hover:bg-primary/90 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="ri-secure-payment-line"></i>
                                <span>Ödeme Adımına Geç</span>
                            </button>
                        </div>
                        
                        <div id="payment-selection-wrapper" class="hidden fade-in">
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Ödeme Yöntemi</h2>
                            <div class="space-y-3">
                                <label class="flex items-start p-3 border rounded-lg cursor-pointer has-[:checked]:bg-primary/10 has-[:checked]:border-primary transition-all">
                                    <input type="radio" name="payment-method" value="transfer" class="mt-1 mr-3 h-4 w-4" checked>
                                    <div class="flex-grow">
                                        <span class="font-semibold text-sm">Havale / EFT</span>
                                        <div id="transfer-details" class="mt-2 text-xs bg-gray-50 p-2 rounded-md border">
                                            <p><strong>Hesap Sahibi:</strong> [Banka Hesap Sahibinin Adı]</p>
                                            <p><strong>IBAN:</strong> [TRXX XXXX XXXX XXXX XXXX XXXX XX]</p>
                                            <p class="mt-1 font-semibold text-red-600">Lütfen ödeme dekontunu WhatsApp ile iletin.</p>
                                        </div>
                                    </div>
                                </label>
                                <label class="flex items-start p-3 border rounded-lg cursor-pointer has-[:checked]:bg-primary/10 has-[:checked]:border-primary transition-all">
                                    <input type="radio" name="payment-method" value="card" class="mt-1 mr-3 h-4 w-4">
                                    <div class="flex-grow">
                                        <span class="font-semibold text-sm">Kredi Kartı</span>
                                        <div id="card-details" class="hidden mt-2 space-y-2">
                                            <p class="text-xs font-semibold text-blue-600 bg-blue-50 p-2 rounded-md">Bu bölüm test amaçlıdır. Gerçek kart bilgisi girmeyiniz.</p>
                                            <input type="text" id="card-number" class="w-full p-1 border rounded-md text-sm" placeholder="Kart Numarası">
                                            <div class="grid grid-cols-2 gap-2">
                                                <input type="text" id="card-expiry" class="w-full p-1 border rounded-md text-sm" placeholder="AA/YY">
                                                <input type="text" id="card-cvc" class="w-full p-1 border rounded-md text-sm" placeholder="CVC">
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <button id="confirm-order-btn" class="w-full mt-6 bg-green-500 text-white py-3 rounded-button font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                                <i class="ri-check-double-line"></i>
                                <span>Siparişi Onayla</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="past-orders-wrapper" class="mt-12">
             <h1 class="text-3xl font-bold text-gray-800 mb-6 border-t pt-8">Geçmiş Siparişlerim</h1>
             <div id="no-orders-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                <i class="ri-file-list-3-line text-6xl text-gray-300"></i>
                <p class="mt-4 text-gray-500">Henüz hiç sipariş vermediniz.</p>
                <a href="https://pufemo.netlify.app/index.html" class="mt-4 inline-block bg-primary text-white px-6 py-2 rounded-button font-semibold hover:bg-primary/90">Alışverişe Başla</a>
            </div>
            <div id="orders-list" class="space-y-4"></div>
        </div>
        
        <div id="no-content-message" class="text-center py-16 hidden">
            <i class="ri-shopping-bag-3-line text-6xl text-gray-300"></i>
            <p class="mt-4 text-gray-500">Görüntülenecek sepet veya sipariş bilgisi yok.</p>
            <a href="https://pufemo.netlify.app/index.html" class="mt-4 inline-block bg-primary text-white px-6 py-2 rounded-button font-semibold hover:bg-primary/90">Alışverişe Başla</a>
        </div>
    </main>

    <div id="loader" class="flex justify-center items-center h-[calc(100vh-80px)]">
        <div class="loader"></div>
    </div>
</div>

<div id="order-success-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] hidden p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl text-center max-w-md w-full fade-in">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="ri-checkbox-circle-line ri-3x text-green-500"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Siparişiniz Başarıyla Alındı!</h1>
        <p class="text-gray-600 mt-2">Sipariş kodunuz: <strong id="success-order-id" class="text-primary"></strong></p>
        <div id="success-transfer-info" class="hidden mt-4 bg-yellow-50 border border-yellow-200 text-yellow-800 p-3 rounded-md text-sm">
            Siparişinizin işleme alınabilmesi için lütfen ödeme dekontunu WhatsApp üzerinden bize iletmeyi unutmayın.
        </div>
        <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
            <a href="https://pufemo.netlify.app/index.html" class="w-full bg-primary text-white px-6 py-2 rounded-button font-semibold hover:bg-primary/90 transition-colors">Ana Sayfaya Dön</a>
            <a href="https://pufemo.netlify.app/sepet.html" class="w-full bg-gray-200 text-gray-800 px-6 py-2 rounded-button font-semibold hover:bg-gray-300 transition-colors">Sayfayı Kapat</a>
        </div>
    </div>
</div>

<div id="toast" class="fixed bottom-24 right-6 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-[110] transform translate-y-4">
    <span id="toast-message"></span>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, updateDoc, deleteDoc, writeBatch, addDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase yapılandırma bilgileriniz
    const firebaseConfig = {
        apiKey: "AIzaSyB64tAKvCHeYnJ8-HNRLpzB7sQRng4FHyA",
  authDomain: "pufemo-2dc3a.firebaseapp.com",
  projectId: "pufemo-2dc3a",
  storageBucket: "pufemo-2dc3a.firebasestorage.app",
  messagingSenderId: "321284306570",
  appId: "1:321284306570:web:ca891826c3e4edde8edf73"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log("Firebase uygulaması başlatıldı."); // Hata ayıklama: Firebase uygulamasının başlatıldığını logla
    console.log("Auth objesi başlatıldı:", auth); // Hata ayıklama: Auth objesinin başlatıldığını logla

    // Global değişkenler (DOM öğeleri değil, veri kapsayıcıları)
    let cartItems = [];
    let pastOrders = [];
    let currentUser = null;
    let userProfile = null;
    let pricingSettings = {};
    const DEFAULT_SETTINGS = {
        categoryRates: { 'furniture': 0.70, 'electronics': 0.70, 'clothing': 0.45, 'cosmetics': 0.70, 'stationery': 0.40, 'default': 0.50 },
        cityFees: { 'Lefkoşa': 200, 'Girne': 350, 'Gazimağusa': 300, 'Güzelyurt': 400, 'İskele': 450, 'Diğer': 500 }
    };

    // --- DOMContentLoaded Wrapper ---
    // Bu kod, HTML belgesi tamamen yüklendikten ve ayrıştırıldıktan sonra çalışır.
    document.addEventListener('DOMContentLoaded', () => {
        // Tüm DOM öğe seçimleri burada yapılır
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const profileImg = document.getElementById('profile-img');
        const profileContainer = document.getElementById('profile-container');
        
        const proceedToPaymentBtn = document.getElementById('proceed-to-payment-btn');
        const paymentSelectionWrapper = document.getElementById('payment-selection-wrapper');
        const confirmOrderBtn = document.getElementById('confirm-order-btn');
        const successModal = document.getElementById('order-success-modal');
        const successOrderIdSpan = document.getElementById('success-order-id');
        const successTransferInfoDiv = document.getElementById('success-transfer-info');
        
        const cartItemsList = document.getElementById('cart-items-list'); 
        const citySelectionSection = document.getElementById('city-selection-section');
        const deliveryAddressSection = document.getElementById('delivery-address-section');
        const deliveryAddressInput = document.getElementById('delivery-address');
        const ordersList = document.getElementById('orders-list'); 
        const noOrdersMessage = document.getElementById('no-content-message'); 
        const activeCartWrapper = document.getElementById('active-cart-wrapper'); 
        const emptyCartMessage = document.getElementById('empty-cart-message'); 
        const pastOrdersWrapper = document.getElementById('past-orders-wrapper');
        const subtotalSpan = document.getElementById('subtotal');
        const deliveryFeeSpan = document.getElementById('delivery-fee');
        const grandTotalSpan = document.getElementById('grand-total');
        const deliveryFeeRow = document.getElementById('delivery-fee-row');
        const cityListContainer = document.getElementById('city-list');


        // Toast Bildirimi Fonksiyonu
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0', 'translate-y-4', 'hidden');
                toast.classList.add('opacity-100', 'translate-y-0', 'show');

                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0', 'show');
                    toast.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 300);
                }, duration);
            } else {
                console.warn("Toast öğeleri bulunamadı, bildirim gösterilemiyor:", message);
            }
        }

        // Firebase Kimlik Doğrulama Durumu Değişikliği İzleyici
        // Bu dinleyici, kullanıcının oturum açma/kapatma durumundaki değişiklikleri dinler.
        onAuthStateChanged(auth, async (user) => {
            console.log("onAuthStateChanged tetiklendi. Kullanıcı nesnesi:", user ? user.uid : "null (Kullanıcı giriş yapmamış)"); // Hata ayıklama: Kullanıcı nesnesinin durumunu logla

            if (loader) loader.classList.remove('hidden'); // Yükleyiciyi göster
            if (mainContent) mainContent.classList.add('hidden'); // Ana içeriği gizle

            if (user) {
                // Kullanıcı giriş yapmışsa
                currentUser = user;
                if (profileImg) profileImg.src = user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=P';
                if (profileContainer) profileContainer.classList.remove('hidden');
                console.log("Kullanıcı giriş yaptı:", user.uid); // Hata ayıklama: Giriş yapan kullanıcı ID'si

                try {
                    await loadPricingSettings();
                    await fetchUserProfile(user.uid);
                    listenToCart(user.uid); // Sepet verilerini dinlemeye başla
                    listenToOrders(user.uid); // Sipariş verilerini dinlemeye başla
                } catch (error) {
                    console.error("Başlatma hatası (kullanıcı girişi sonrası):", error);
                    if (loader) loader.innerHTML = `<p class="text-red-500">Veriler yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.</p>`;
                }
            } else {
                // Kullanıcı giriş yapmamışsa
                currentUser = null;
                userProfile = null;
                if (profileContainer) profileContainer.classList.add('hidden');
                console.log("Kullanıcı giriş yapmadı. Sepet içeriği gösterilmeyecek."); // Hata ayıklama: Kullanıcı giriş yapmadı
                showToast("Sepeti görüntülemek için giriş yapmanız gerekebilir."); // Kullanıcıya bilgilendirme
                
                // Loader'ı gizle ve ana içeriği göster (boş sepet/sipariş yok mesajı ile)
                if (loader) loader.classList.add('hidden');
                if (mainContent) mainContent.classList.remove('hidden'); 
                
                // Aktif sepet ve geçmiş sipariş wrapper'larını gizle
                if (activeCartWrapper) activeCartWrapper.classList.add('hidden');
                if (pastOrdersWrapper) pastOrdersWrapper.classList.add('hidden');
                
                // 'Hiçbir içerik yok' mesajını göster
                if (noOrdersMessage) noOrdersMessage.classList.remove('hidden'); 
                // emptyCartMessage da boş sepeti belirtir, burada gizli kalabilir eğer hiç giriş yapılmadıysa
                if (emptyCartMessage) emptyCartMessage.classList.add('hidden'); 
            }
        });

        // Sepet öğeleri listesi olay dinleyicisi (miktar ve silme düğmeleri için)
        if (cartItemsList) {
            cartItemsList.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const itemId = target.dataset.id;
                if (target.classList.contains('quantity-btn')) {
                    updateQuantity(itemId, target.classList.contains('increase-btn'));
                } else if (target.classList.contains('delete-btn')) {
                    deleteItem(itemId);
                }
            });
        }

        // "Ödeme Adımına Geç" butonu tıklama olayı
        if (proceedToPaymentBtn && paymentSelectionWrapper) { 
            proceedToPaymentBtn.addEventListener('click', () => {
                const deliveryTypeRadio = document.querySelector('input[name="delivery-type"]:checked');
                if (!deliveryTypeRadio) {
                    showToast('Lütfen bir teslimat türü seçiniz.'); 
                    return;
                }
                const deliveryType = deliveryTypeRadio.value;

                if (deliveryType === 'home') {
                    if (!document.querySelector('input[name="city"]:checked')) {
                        showToast('Lütfen teslimat için bir şehir seçiniz.');
                        return;
                    }
                    if (!deliveryAddressInput || !deliveryAddressInput.value.trim()) { 
                        showToast('Lütfen teslimat adresini giriniz.');
                        return;
                    }
                }
                
                proceedToPaymentBtn.classList.add('hidden');
                paymentSelectionWrapper.classList.remove('hidden');
                paymentSelectionWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }

        // Ödeme yöntemi radyo butonları değişim olayı
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isCard = e.target.value === 'card';
                const cardDetails = document.getElementById('card-details');
                const transferDetails = document.getElementById('transfer-details');

                if (cardDetails) cardDetails.classList.toggle('hidden', !isCard);
                if (transferDetails) transferDetails.classList.toggle('hidden', isCard);
            });
        });

        // "Siparişi Onayla" (Final) Butonu Tıklama Olayı
        if (confirmOrderBtn) {
            confirmOrderBtn.addEventListener('click', async () => {
                if (cartItems.length === 0) {
                    showToast("Sepetiniz boş. Sipariş oluşturulamaz.");
                    return;
                }

                const selectedPaymentMethodRadio = document.querySelector('input[name="payment-method"]:checked');
                if (!selectedPaymentMethodRadio) {
                    showToast("Lütfen bir ödeme yöntemi seçiniz.");
                    return;
                }
                const selectedPaymentMethod = selectedPaymentMethodRadio.value;

                const deliveryTypeRadio = document.querySelector('input[name="delivery-type"]:checked');
                if (!deliveryTypeRadio) {
                    showToast("Lütfen bir teslimat türü seçiniz.");
                    return;
                }
                const deliveryType = deliveryTypeRadio.value;
                
                let selectedCity = '';
                let finalDeliveryAddress = '';

                if (deliveryType === 'home') {
                    const cityRadio = document.querySelector('input[name="city"]:checked');
                    if (!cityRadio) {
                        showToast("Lütfen teslimat şehrinizi seçiniz.");
                        return;
                    }
                    selectedCity = cityRadio.value;
                    if (!deliveryAddressInput || !deliveryAddressInput.value.trim()) {
                        showToast("Lütfen tam teslimat adresini giriniz.");
                        return;
                    }
                    finalDeliveryAddress = deliveryAddressInput.value.trim();
                } else {
                    selectedCity = 'Lefkoşa'; 
                    finalDeliveryAddress = 'Getir Kıbrıs Depo, Şehit Mustafa Ruso Caddesi, No:86, Lefkoşa, KKTC'; 
                }

                // Kredi kartı ödemesi için bilgi doğrulama (sadece simülasyon amaçlı)
                if (selectedPaymentMethod === 'card') {
                    const cardNumber = document.getElementById('card-number')?.value.trim();
                    const cardExpiry = document.getElementById('card-expiry')?.value.trim();
                    const cardCvc = document.getElementById('card-cvc')?.value.trim();
                    if (!cardNumber || !cardExpiry || !cardCvc) {
                        showToast("Lütfen kredi kartı bilgilerini eksiksiz doldurun.");
                        return;
                    }
                    showToast("Kredi kartı ile ödeme simülasyonu yapılıyor...");
                }

                // Toplamları tekrar hesapla
                const categoryRates = pricingSettings.categoryRates || {};
                let subtotal = 0;
                let producerOrderIds = []; 

                cartItems.forEach(item => {
                    // NaN kontrolü ve varsayılan değer ataması eklendi
                    const itemProductPrice = parseFloat(item.productPrice) || 0; 
                    const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);

                    let itemServiceFee = 0;
                    if (item.type === 'custom_order') {
                        itemServiceFee = itemProductPrice * serviceRate;
                    }
                    const itemFinalPrice = item.orderMethod === 'service' ? itemProductPrice + itemServiceFee : itemProductPrice;
                    subtotal += (itemFinalPrice * item.quantity);

                    // Eğer ürün bir üreticiye aitse, producerId'sini ekle
                    if (item.producerId && !producerOrderIds.includes(item.producerId)) {
                        producerOrderIds.push(item.producerId);
                    }
                });

                const currentDeliveryFee = pricingSettings.cityFees?.[selectedCity] || pricingSettings.cityFees?.['Diğer'] || 0;
                let grandTotal = subtotal + (deliveryType === 'home' ? currentDeliveryFee : 0);

                // Sipariş verilerini oluştur ve undefined değerleri kontrol et
                const orderData = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userFullName: userProfile?.fullName || 'Bilinmiyor',
                    userPhone: userProfile?.phone || 'Bilinmiyor',
                    deliveryAddress: finalDeliveryAddress,
                    deliveryType: deliveryType,
                    selectedCity: selectedCity,
                    items: cartItems.map(item => ({ 
                        id: item.id, 
                        productLink: item.productLink || '', // undefined olmaması için boş string varsayılan
                        productPrice: parseFloat(item.productPrice) || 0, // undefined/NaN olmaması için 0 varsayılan
                        category: item.category || 'Diğer', // undefined olmaması için 'Diğer' varsayılan
                        orderMethod: item.orderMethod || 'service', // undefined olmaması için 'service' varsayılan
                        quantity: parseInt(item.quantity) || 1, // undefined/NaN olmaması için 1 varsayılan
                        serviceFeeRate: item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0),
                        type: item.type || 'custom_order', // undefined olmaması için 'custom_order' varsayılan
                        imageUrl: item.imageUrl || null,
                        producerId: item.producerId || null 
                    })),
                    subtotal: subtotal,
                    serviceFeeTotal: cartItems.reduce((acc, item) => {
                        const itemProductPrice = parseFloat(item.productPrice) || 0;
                        const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);
                        return acc + (item.type === 'custom_order' ? (itemProductPrice * serviceRate * (parseInt(item.quantity) || 1)) : 0);
                    }, 0),
                    deliveryFee: (deliveryType === 'home' ? currentDeliveryFee : 0),
                    grandTotal: grandTotal,
                    paymentMethod: selectedPaymentMethod,
                    orderDate: serverTimestamp(),
                    status: 'pending_payment', 
                    producerIds: producerOrderIds.length > 0 ? producerOrderIds : null, 
                    hasProducerItems: producerOrderIds.length > 0 
                };

                // Hata ayıklama için sipariş verilerini konsola yazdır
                console.log("Sipariş verileri:", orderData);

                try {
                    // Siparişi Firestore'a kaydet
                    const orderRef = await addDoc(collection(db, 'orders'), orderData);

                    // Sipariş başarıyla oluşturulduktan sonra sepeti temizle
                    const batch = writeBatch(db);
                    cartItems.forEach(item => {
                        const itemDocRef = doc(db, 'users', currentUser.uid, 'cart', item.id);
                        batch.delete(itemDocRef);
                    });
                    await batch.commit();

                    // Başarı modalını göster
                    if (successOrderIdSpan) successOrderIdSpan.textContent = orderRef.id.substring(0, 8).toUpperCase();
                    if (successTransferInfoDiv) {
                        if (selectedPaymentMethod === 'transfer') {
                            successTransferInfoDiv.classList.remove('hidden');
                        } else {
                            successTransferInfoDiv.classList.add('hidden');
                        }
                    }
                    if (successModal) successModal.classList.remove('hidden');

                    // Modal açıkken sayfanın kapanmasını engellemek için geri tuşunu devre dışı bırak
                    history.pushState(null, null, location.href);
                    window.addEventListener('popstate', function (event) {
                        history.pushState(null, null, location.href);
                    });

                } catch (error) {
                    console.error("Sipariş oluşturulurken hata:", error);
                    showToast("Sipariş oluşturulurken bir hata oluştu: " + error.message);
                }
            });
        }


        // --- Yardımcı Fonksiyonlar ---
        async function loadPricingSettings() {
            try {
                const docRef = doc(db, "settings", "pricing");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().categoryRates) {
                    pricingSettings = docSnap.data();
                } else {
                    pricingSettings = DEFAULT_SETTINGS;
                }
            } catch (error) {
                console.error("Fiyat ayarları yüklenirken hata oluştu:", error);
                pricingSettings = DEFAULT_SETTINGS;
            }
            populateCities();
        }

        async function fetchUserProfile(userId) {
            const userDocRef = doc(db, 'users', userId);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                userProfile = userDocSnap.data();
                if (!userProfile.fullName || !userProfile.phone || !userProfile.address) {
                    console.warn("Kullanıcı profil bilgileri eksik. Lütfen tamamlayın.");
                }
            } else {
                // Yeni kullanıcı profili oluşturulurken eksik alanları boş string olarak başlat
                await setDoc(userDocRef, {
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    role: 'customer',
                    fullName: '', // Boş string olarak başlat
                    phone: '',    // Boş string olarak başlat
                    address: '',  // Boş string olarak başlat
                    createdAt: serverTimestamp() 
                });
                // userProfile nesnesini de bu başlatılan değerlerle güncelle
                userProfile = { 
                    email: currentUser.email, 
                    photoURL: currentUser.photoURL, 
                    role: 'customer',
                    fullName: '',
                    phone: '',
                    address: ''
                };
                console.warn("Yeni kullanıcı profili oluşturuldu. Lütfen detayları tamamlayın.");
            }
        }

        function listenToCart(userId) {
            const cartRef = collection(db, 'users', userId, 'cart');
            onSnapshot(cartRef, (snapshot) => {
                cartItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore'dan alınan sepet öğeleri:", cartItems); // Hata ayıklama: Firebase'den gelen sepet içeriği
                renderCart();
                updateSummary();
                checkContentVisibility();
            }, (error) => {
                console.error("Sepet dinlenirken hata oluştu: ", error);
                showToast("Sepetiniz yüklenirken bir hata oluştu.");
                checkContentVisibility(); 
            });
        }

        function listenToOrders(userId) {
            const ordersRef = collection(db, 'orders');
            const q = query(ordersRef, where("userId", "==", userId), orderBy("orderDate", "desc"));
            onSnapshot(q, (snapshot) => {
                pastOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(pastOrders);
                checkContentVisibility();
            }, (error) => {
                console.error("Siparişler dinlenirken hata oluştu: ", error);
                showToast("Geçmiş siparişleriniz yüklenirken bir hata oluştu.");
                checkContentVisibility();
            });
        }

        function renderCart() {
            if (!emptyCartMessage || !activeCartWrapper || !paymentSelectionWrapper || !proceedToPaymentBtn || !cartItemsList) {
                console.error("Kritik sepet DOM öğeleri eksik.");
                return;
            }
            console.log("renderCart çağrıldı, sepet öğe sayısı:", cartItems.length); 

            if (cartItems.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                activeCartWrapper.classList.add('hidden'); 
                paymentSelectionWrapper.classList.add('hidden');
                proceedToPaymentBtn.classList.remove('hidden'); 
                proceedToPaymentBtn.disabled = true; 
                return;
            }

            activeCartWrapper.classList.remove('hidden'); 
            emptyCartMessage.classList.add('hidden');
            cartItemsList.innerHTML = '';
            proceedToPaymentBtn.disabled = false; 

            cartItems.forEach(item => {
                const categoryRates = pricingSettings.categoryRates || {};
                const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);

                let itemServiceFee = 0;
                if (item.type === 'custom_order') {
                    itemServiceFee = (parseFloat(item.productPrice) || 0) * serviceRate;
                }
                const itemFinalPrice = item.orderMethod === 'service' ? (parseFloat(item.productPrice) || 0) + itemServiceFee : (parseFloat(item.productPrice) || 0); 
                const lineTotal = itemFinalPrice * (parseInt(item.quantity) || 1);

                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-start sm:items-center gap-4 border-b pb-4 flex-col sm:flex-row last:border-b-0 last:pb-0'; 

                itemElement.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-base line-clamp-1">${item.productLink}</p>
                        <p class="text-xs text-gray-500">${item.category ? `Kategori: ${item.category}` : ''}</p>
                        <p class="text-xs text-gray-500">Birim Fiyatı: ${itemProductPrice.toFixed(2)} ₺</p>
                        ${item.type === 'custom_order' && itemServiceFee > 0 ? `<p class="text-xs text-gray-500">Hizmet Bedeli: ${itemServiceFee.toFixed(2)} ₺</p>` : ''}
                        <p class="text-xs text-gray-500">Hizmet Dahil Birim Fiyatı: ${itemFinalPrice.toFixed(2)} ₺</p>
                    </div>
                    <div class="flex items-center gap-2 border rounded-md p-1 self-start sm:self-center">
                        <button data-id="${item.id}" class="quantity-btn decrease-btn w-6 h-6 flex items-center justify-center text-lg font-bold hover:bg-gray-100 rounded">-</button>
                        <span class="w-6 text-center">${item.quantity}</span>
                        <button data-id="${item.id}" class="quantity-btn increase-btn w-6 h-6 flex items-center justify-center text-lg font-bold hover:bg-gray-100 rounded">+</button>
                    </div>
                    <p class="font-semibold w-24 text-right flex-shrink-0">${lineTotal.toFixed(2)} ₺</p>
                    <button data-id="${item.id}" class="delete-btn text-red-500 hover:text-red-700 flex-shrink-0">
                        <i class="ri-delete-bin-line ri-lg"></i>
                    </button>`;
                cartItemsList.appendChild(itemElement);
            });
        }
        
        async function updateQuantity(itemId, isIncrease) {
            const item = cartItems.find(i => i.id === itemId);
            if (!item) return;
            let newQuantity = isIncrease ? (parseInt(item.quantity) || 0) + 1 : (parseInt(item.quantity) || 0) - 1;
            if (newQuantity < 1) newQuantity = 1; 

            const itemRef = doc(db, 'users', currentUser.uid, 'cart', itemId);
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
            } catch (error) {
                console.error("Adet güncellenirken hata:", error);
                showToast("Ürün adedi güncellenemedi.");
            }
        }

        async function deleteItem(itemId) {
            // Confirm yerine custom modal kullanılması gerektiğini unutmayın
            if (confirm('Bu ürünü sepetten kaldırmak istediğinize emin misiniz?')) { 
                const itemRef = doc(db, 'users', currentUser.uid, 'cart', itemId);
                try {
                    await deleteDoc(itemRef);
                    showToast("Ürün sepetten kaldırıldı.");
                } catch (error) {
                    console.error("Ürün silinirken hata:", error);
                    showToast("Ürün sepetten silinemedi.");
                }
            }
        }
        
        function renderOrders(orders) {
            if (!pastOrdersWrapper || !noOrdersMessage || !ordersList) {
                console.error("Kritik sipariş DOM öğeleri eksik.");
                return;
            }

            if (orders.length === 0) {
                pastOrdersWrapper.classList.remove('hidden'); 
                noOrdersMessage.classList.remove('hidden'); 
                ordersList.innerHTML = '';
                return;
            }
            pastOrdersWrapper.classList.remove('hidden');
            noOrdersMessage.classList.add('hidden'); 
            ordersList.innerHTML = '';

            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-3';
                
                const statusStyles = {
                    pending_payment: { text: 'Ödeme Bekleniyor', bg: 'bg-yellow-500', text_color: 'text-white' },
                    processing: { text: 'İşleniyor', bg: 'bg-blue-500', text_color: 'text-white' }, 
                    shipped: { text: 'Kargoya Verildi', bg: 'bg-teal-500', text_color: 'text-white' },
                    delivered: { text: 'Teslim Edildi', bg: 'bg-green-500', text_color: 'text-white' },
                    cancelled: { text: 'İptal Edildi', bg: 'bg-red-500', text_color: 'text-white' }
                };
                const currentStatus = statusStyles[order.status] || { text: order.status, bg: 'bg-gray-400', text_color: 'text-white' };
                const orderDate = order.orderDate ? new Date(order.orderDate.seconds * 1000).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                
                const categoryRates = pricingSettings.categoryRates || {};
                const itemsHtml = (order.items ?? []).map(item => {
                    const itemProductPrice = parseFloat(item.productPrice) || 0;
                    const itemServiceFee = itemProductPrice * (categoryRates[item.category] || 0);
                    const itemFinalPrice = item.orderMethod === 'service' ? itemProductPrice + itemServiceFee : itemProductPrice;
                    return `
                        <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-2 first:border-t-0 first:pt-0">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-500">Ürün</p>
                                <a href="${item.productLink}" target="_blank" class="text-blue-600 hover:underline truncate block">${item.productLink}</a>
                                <p class="text-xs text-gray-500">${item.quantity} adet</p>
                            </div>
                            <div class="w-24 text-right">
                                <p class="text-xs text-gray-500">Fiyat</p>
                                <p class="font-medium">${(itemFinalPrice * (parseInt(item.quantity) || 1)).toFixed(2)} ₺</p>
                            </div>
                        </div>`;
                }).join('');
                
                const grandTotalDisplay = typeof order.grandTotal !== 'undefined' && !isNaN(order.grandTotal)
                    ? `${order.grandTotal.toFixed(2)} ₺`
                    : 'Hesaplanamadı';

                orderCard.innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 border-b pb-3">
                        <div><p class="text-xs text-gray-500">Sipariş Kodu</p><p class="font-mono text-primary font-semibold text-sm">${order.id.toUpperCase().substring(0, 8)}</p></div>
                        <div><p class="text-xs text-gray-500">Tarih</p><p class="font-semibold text-sm">${orderDate}</p></div>
                        <div><p class="text-xs text-gray-500">Teslimat</p><p class="font-semibold text-sm">${order.deliveryType === 'home' ? 'Eve Teslim' : 'Depodan Teslim'}</p></div>
                        <div><p class="text-xs text-gray-500">Durum</p><span class="px-3 py-1 text-xs font-semibold rounded-full ${currentStatus.bg} ${currentStatus.text_color}">${currentStatus.text}</span></div>
                    </div>
                    <div class="space-y-1">${itemsHtml}</div>
                    <div class="flex justify-end border-t pt-3 mt-2"><div class="text-right"><p class="text-sm text-gray-500">Genel Toplam</p><p class="font-bold text-lg">${grandTotalDisplay}</p></div></div>`;
                ordersList.appendChild(orderCard);
            });
        }

        function populateCities() {
            if (!cityListContainer) {
                console.error("Şehir listesi kabı bulunamadı.");
                return;
            }
            const cityFees = pricingSettings.cityFees || {};
            cityListContainer.innerHTML = '';
            for (const city in cityFees) {
                const fee = cityFees[city];
                const cityElement = document.createElement('label');
                cityElement.className = 'flex items-center p-3 border rounded-md cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 transition-all';
                cityElement.innerHTML = `<input type="radio" name="city" value="${city}" class="mr-2 h-4 w-4"><span class="flex-grow text-sm">${city}</span><span class="text-sm font-semibold">${fee} ₺</span>`;
                cityListContainer.appendChild(cityElement);
            }
            if (userProfile && userProfile.address) {
                const userCity = userProfile.address.split(',').pop()?.trim();
                const cityRadio = document.querySelector(`input[name="city"][value="${userCity}"]`);
                if (cityRadio) {
                    cityRadio.checked = true;
                    const deliveryTypeHome = document.querySelector('input[name="delivery-type"][value="home"]');
                    if (deliveryTypeHome && deliveryTypeHome.checked && citySelectionSection && deliveryAddressSection) {
                        citySelectionSection.classList.remove('hidden');
                        deliveryAddressSection.classList.remove('hidden');
                    }
                }
            }
        }
        
        document.body.addEventListener('change', (e) => {
            if (e.target.name === 'delivery-type' || e.target.name === 'city') {
                const deliveryTypeRadio = document.querySelector('input[name="delivery-type"]:checked');
                if (!deliveryTypeRadio) { 
                    console.error("Teslimat türü seçilmedi.");
                    return;
                }
                const deliveryType = deliveryTypeRadio.value;

                if (deliveryType === 'home') {
                    if (citySelectionSection) citySelectionSection.classList.remove('hidden');
                    if (deliveryAddressSection) deliveryAddressSection.classList.remove('hidden');
                    if (deliveryAddressInput && !deliveryAddressInput.value.trim() && userProfile?.address) {
                        deliveryAddressInput.value = userProfile.address;
                    }
                } else {
                    if (citySelectionSection) citySelectionSection.classList.add('hidden');
                    if (deliveryAddressSection) deliveryAddressSection.classList.add('hidden');
                }
                updateSummary();
            }
        });

        function updateSummary() {
            if (!subtotalSpan || !deliveryFeeSpan || !grandTotalSpan || !deliveryFeeRow || !proceedToPaymentBtn) {
                console.error("Özet DOM öğeleri eksik.");
                return;
            }

            if (cartItems.length === 0) {
                proceedToPaymentBtn.disabled = true;
                subtotalSpan.textContent = `0.00 ₺`;
                deliveryFeeSpan.textContent = `0.00 ₺`;
                grandTotalSpan.textContent = `0.00 ₺`;
                deliveryFeeRow.classList.add('hidden');
                return;
            }
            proceedToPaymentBtn.disabled = false;

            const categoryRates = pricingSettings.categoryRates || {};
            let subtotal = 0;
            cartItems.forEach(item => {
                const itemProductPrice = parseFloat(item.productPrice) || 0; // NaN kontrolü
                const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);
                let itemServiceFee = 0;
                if (item.type === 'custom_order') {
                    itemServiceFee = itemProductPrice * serviceRate;
                }
                const itemFinalPrice = item.orderMethod === 'service' ? itemProductPrice + itemServiceFee : itemProductPrice;
                subtotal += (itemFinalPrice * (parseInt(item.quantity) || 1)); // NaN kontrolü
            });
            
            let deliveryFee = 0;
            const deliveryTypeRadio = document.querySelector('input[name="delivery-type"]:checked');
            const deliveryType = deliveryTypeRadio ? deliveryTypeRadio.value : 'warehouse'; 

            if (deliveryType === 'home') {
                const selectedCityRadio = document.querySelector('input[name="city"]:checked');
                if(selectedCityRadio) deliveryFee = pricingSettings.cityFees?.[selectedCityRadio.value] || pricingSettings.cityFees?.['Diğer'] || 0;
                deliveryFeeRow.classList.remove('hidden');
            } else {
                deliveryFeeRow.classList.add('hidden');
            }

            const grandTotal = subtotal + deliveryFee;
            subtotalSpan.textContent = `${(isNaN(subtotal) ? 0 : subtotal).toFixed(2)} ₺`;
            deliveryFeeSpan.textContent = `${(isNaN(deliveryFee) ? 0 : deliveryFee).toFixed(2)} ₺`;
            grandTotalSpan.textContent = `${(isNaN(grandTotal) ? 0 : grandTotal).toFixed(2)} ₺`;
        }

        // İçerik Görünürlüğü Kontrolü
        function checkContentVisibility() {
            console.log("checkContentVisibility çağrıldı. Sepet öğe sayısı:", cartItems.length, "Geçmiş sipariş sayısı:", pastOrders.length, "Current User:", currentUser ? currentUser.uid : "None"); 

            if (!currentUser) {
                // Eğer kullanıcı giriş yapmamışsa, sadece 'içerik yok' mesajını göster.
                if (noOrdersMessage) noOrdersMessage.classList.remove('hidden');
                if (mainContent) mainContent.classList.remove('hidden');
                if (activeCartWrapper) activeCartWrapper.classList.add('hidden');
                if (pastOrdersWrapper) pastOrdersWrapper.classList.add('hidden');
                if (loader) loader.classList.add('hidden');
                return;
            }

            // Kullanıcı giriş yapmışsa, sepet ve sipariş durumuna göre içeriği göster/gizle
            if (!noOrdersMessage || !mainContent || !activeCartWrapper || !pastOrdersWrapper || !loader) {
                console.error("Kritik içerik görünürlüğü DOM öğeleri eksik.");
                return;
            }
            
            if (cartItems.length > 0 || pastOrders.length > 0) {
                noOrdersMessage.classList.add('hidden'); 
                mainContent.classList.remove('hidden'); 

                if (cartItems.length > 0) {
                    activeCartWrapper.classList.remove('hidden');
                } else {
                    activeCartWrapper.classList.add('hidden');
                }
                if (pastOrders.length > 0) {
                    pastOrdersWrapper.classList.remove('hidden');
                } else {
                    pastOrdersWrapper.classList.add('hidden');
                }
            } else {
                activeCartWrapper.classList.add('hidden');
                pastOrdersWrapper.classList.add('hidden');
                noOrdersMessage.classList.remove('hidden'); 
                mainContent.classList.remove('hidden'); 
            }
            loader.classList.add('hidden'); 
        }

    }); // DOMContentLoaded sonu
</script>
</body>
</html>
