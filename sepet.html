<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sepetim ve Siparişlerim - Getir Kıbrıs</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#5d3ebc',
                    secondary: '#ffd300',
                    'status-pending': '#FFC107', 'status-approved': '#4CAF50', 'status-tr_warehouse': '#2196F3',
                    'status-shipped': '#FF9800', 'status-cy_warehouse': '#03A9F4', 'status-delivered': '#8BC34A',
                    'status-cancelled': '#F44336'
                },
                borderRadius: { 'button': '8px' }
            }
        }
    }
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .status-badge { color: white; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
</style>
</head>
<body class="bg-gray-50">
    <div class="w-full max-w-screen-lg mx-auto relative min-h-screen pb-16">

        <header class="sticky top-0 w-full bg-primary shadow-sm z-40 px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="text-white flex items-center text-lg hover:opacity-80 transition-opacity"><i class="ri-arrow-left-s-line ri-xl mr-1"></i>Geri</a>
            <h1 class="text-xl font-semibold text-white">Sepetim & Siparişlerim</h1>
            <div class="w-12"></div>
        </header>

        <main class="pt-6 px-4">
            
            <div id="cart-checkout-section" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-2xl font-bold text-primary mb-4">Sepetim</h2>
                <div id="cart-items-container" class="space-y-4 border-b pb-4 mb-4"></div>
                
                <div id="checkout-details" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Teslimat Bilgileri</h3>
                    <form id="checkout-form" class="space-y-4">
                        <div id="user-info-display" class="space-y-2 p-4 bg-gray-50 rounded-lg"></div>
                        <button type="button" id="change-info-btn" class="text-sm text-primary hover:underline">Bilgileri Değiştir</button>
                        
                        <div>
                             <span class="block text-sm font-medium text-gray-700 mb-2">Teslimat Tipi<span class="text-red-500">*</span></span>
                             <div class="flex space-x-4">
                                <label class="flex items-center"><input type="radio" name="delivery-type" value="warehouse" class="h-4 w-4 text-primary focus:ring-primary border-gray-300" checked> <span class="ml-2 text-sm">Depodan Teslim</span></label>
                                <label class="flex items-center"><input type="radio" name="delivery-type" value="home" class="h-4 w-4 text-primary focus:ring-primary border-gray-300"> <span class="ml-2 text-sm">Eve Teslim</span></label>
                             </div>
                        </div>
                        <div id="city-selection" class="hidden">
                             <label for="city" class="block text-sm font-medium text-gray-700">Şehir</label>
                             <select id="city" class="w-full p-2 mt-1 border border-gray-300 rounded-md">
                                <option value="lefkosa">Lefkoşa</option><option value="girne">Girne</option><option value="magusa">Gazimağusa</option>
                                <option value="guzelyurt">Güzelyurt</option><option value="iskele">İskele</option>
                             </select>
                        </div>
                    </form>
                    
                    <div id="price-summary" class="mt-6 pt-4 border-t"></div>
                    <button id="confirm-order-btn" class="w-full mt-6 bg-green-500 text-white py-3 rounded-button font-bold text-lg hover:bg-green-600 transition-colors disabled:opacity-50" disabled>Siparişi Onayla</button>
                </div>
                 <div id="empty-cart-message" class="text-center py-6">
                    <i class="ri-shopping-cart-2-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Sepetiniz şu anda boş.</p>
                    <a href="index.html" class="mt-4 inline-block text-primary hover:underline">Alışverişe devam et</a>
                </div>
            </div>

            <h2 class="text-2xl font-bold text-primary mb-4 mt-12">Geçmiş Siparişlerim</h2>
            <div id="orders-container" class="space-y-6">
                <p class="text-center text-gray-500">Geçmiş siparişleriniz yükleniyor...</p>
            </div>
        </main>
    </div>

    <div id="review-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md relative">
            <button id="close-review-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="ri-close-line ri-lg"></i></button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Siparişi Değerlendir</h3>
            <form id="review-form">
                <input type="hidden" id="review-order-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Puanınız</label>
                    <div id="star-rating" class="flex items-center text-3xl text-gray-300">
                        <i data-value="1" class="ri-star-line cursor-pointer hover:text-yellow-400"></i><i data-value="2" class="ri-star-line cursor-pointer hover:text-yellow-400"></i>
                        <i data-value="3" class="ri-star-line cursor-pointer hover:text-yellow-400"></i><i data-value="4" class="ri-star-line cursor-pointer hover:text-yellow-400"></i>
                        <i data-value="5" class="ri-star-line cursor-pointer hover:text-yellow-400"></i>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="review-text" class="block text-sm font-medium text-gray-700">Yorumunuz</label>
                    <textarea id="review-text" rows="4" required class="mt-1 w-full p-2 border border-gray-300 rounded-button"></textarea>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2.5 rounded-button font-medium hover:bg-primary/90">Yorumu Gönder</button>
            </form>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 z-50"><span id="toast-message"></span></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
            authDomain: "kibris-6b4f7.firebaseapp.com",
            projectId: "kibris-6b4f7",
            storageBucket: "kibris-6b4f7.appspot.com",
            messagingSenderId: "141262926171",
            appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            let currentUserData = {};
            let pricingSettings = {};
            let currentCart = [];
            let currentRating = 0;
            let isEditingInfo = false;

            const cartCheckoutSection = document.getElementById('cart-checkout-section');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const checkoutDetails = document.getElementById('checkout-details');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const userInfoDisplay = document.getElementById('user-info-display');
            const changeInfoBtn = document.getElementById('change-info-btn');
            const priceSummary = document.getElementById('price-summary');
            const confirmOrderBtn = document.getElementById('confirm-order-btn');
            const ordersContainer = document.getElementById('orders-container');
            const reviewModal = document.getElementById('review-modal');
            const closeReviewModalBtn = document.getElementById('close-review-modal');
            const reviewForm = document.getElementById('review-form');
            const starRatingContainer = document.getElementById('star-rating');

            window.showToast = (message) => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.add('opacity-100');
                setTimeout(() => toast.classList.remove('opacity-100'), 3000);
            };

            const fetchData = async (uid) => {
                try {
                    const userDoc = await db.collection('users').doc(uid).get();
                    if (userDoc.exists) currentUserData = { id: userDoc.id, ...userDoc.data() };

                    const pricingDoc = await db.collection('settings').doc('pricing').get();
                    if (pricingDoc.exists) pricingSettings = pricingDoc.data();
                } catch (error) { console.error("Veri çekme hatası:", error); }
            };

            const renderCart = () => {
                currentCart = JSON.parse(sessionStorage.getItem('shoppingCart')) || [];
                cartItemsContainer.innerHTML = '';

                if (currentCart.length === 0) {
                    checkoutDetails.classList.add('hidden');
                    emptyCartMessage.classList.remove('hidden');
                    confirmOrderBtn.disabled = true;
                    return;
                }
                
                checkoutDetails.classList.remove('hidden');
                emptyCartMessage.classList.add('hidden');
                confirmOrderBtn.disabled = false;

                currentCart.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between border-b border-gray-100 py-2';
                    itemEl.innerHTML = `
                        <div class="flex-grow pr-4">
                            <a href="${item.productLink}" target="_blank" class="text-sm text-primary hover:underline break-all">${item.productLink}</a>
                            <p class="text-xs text-gray-600">${item.productPrice.toFixed(2)} ₺</p>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <button data-index="${index}" class="quantity-change-btn dec-btn bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center">-</button>
                            <span class="font-semibold w-6 text-center">${item.quantity}</span>
                            <button data-index="${index}" class="quantity-change-btn inc-btn bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center">+</button>
                            <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 ml-2"><i class="ri-delete-bin-line ri-lg"></i></button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
                renderPriceSummary();
            };

            const renderPriceSummary = () => {
                const subtotal = currentCart.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
                const totalCategoryFee = currentCart.reduce((sum, item) => sum + (item.calculatedCategoryFee * item.quantity), 0);
                
                let deliveryFee = 0;
                const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value;
                if (deliveryType === 'home') {
                    const city = document.getElementById('city')?.value;
                    deliveryFee = pricingSettings.cityFees ? (pricingSettings.cityFees[city] || 0) : 0;
                }

                let totalAmount = totalCategoryFee + deliveryFee;
                const serviceItemsTotal = currentCart.filter(i => i.orderMethod === 'service').reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
                totalAmount += serviceItemsTotal;

                priceSummary.innerHTML = `
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600">Ürünler Toplamı:</span><span>${subtotal.toFixed(2)} ₺</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Toplam Kategori Ücreti:</span><span>${totalCategoryFee.toFixed(2)} ₺</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Teslimat Ücreti:</span><span>${deliveryFee.toFixed(2)} ₺</span></div>
                        <div class="flex justify-between font-bold text-lg pt-2 border-t mt-2"><span class="text-gray-800">Genel Toplam:</span><span>${totalAmount.toFixed(2)} ₺</span></div>
                    </div>
                `;
            };

            const renderUserInfo = () => {
                if (isEditingInfo) {
                    userInfoDisplay.innerHTML = `
                        <div class="space-y-3">
                            <div><label class="text-xs font-medium">Ad Soyad</label><input type="text" id="fullname-input" value="${currentUserData.displayName}" class="w-full p-2 border rounded-md text-sm"></div>
                            <div><label class="text-xs font-medium">Telefon</label><input type="tel" id="phone-input" value="${currentUserData.phone}" class="w-full p-2 border rounded-md text-sm"></div>
                            <div><label class="text-xs font-medium">Adres</label><textarea id="address-input" class="w-full p-2 border rounded-md text-sm">${currentUserData.deliveryAddress}</textarea></div>
                        </div>
                    `;
                    changeInfoBtn.textContent = 'Kaydet ve Kapat';
                } else {
                    userInfoDisplay.innerHTML = `
                        <p class="text-sm"><strong>Ad Soyad:</strong> ${currentUserData.displayName || 'Girilmemiş'}</p>
                        <p class="text-sm"><strong>Telefon:</strong> ${currentUserData.phone || 'Girilmemiş'}</p>
                        <p class="text-sm"><strong>Adres:</strong> ${currentUserData.deliveryAddress || 'Girilmemiş'}</p>
                    `;
                    changeInfoBtn.textContent = 'Bilgileri Değiştir';
                }
            };
            
            const fetchOrders = async (uid) => {
                try {
                    const snapshot = await db.collection("orders").where("userId", "==", uid).orderBy("orderDate", "desc").get();
                    if (snapshot.empty) {
                        ordersContainer.innerHTML = '<p class="text-gray-500 text-center py-5">Henüz geçmiş siparişiniz bulunmamaktadır.</p>';
                        return;
                    }
                    ordersContainer.innerHTML = ''; 
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const card = document.createElement('div');
                        card.className = 'bg-white shadow-lg rounded-lg p-6 mb-6';
                        
                        let itemsHtml = order.items.map(item => `<li class="flex justify-between text-sm"><span>- ${item.productLink.substring(0,30)}... (x${item.quantity})</span><span>${(item.productPrice * item.quantity).toFixed(2)} ₺</span></li>`).join('');
                        const statusColor = tailwind.config.theme.extend.colors[`status-${order.status}`] || '#9E9E9E';

                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-4">
                                <div><h3 class="text-lg font-semibold text-gray-800">Sipariş No: ${doc.id.substring(0,8)}</h3><p class="text-sm text-gray-500">${new Date(order.orderDate.seconds * 1000).toLocaleDateString('tr-TR')}</p></div>
                                <span class="status-badge" style="background-color: ${statusColor}">${order.status.replace('_', ' ').toUpperCase()}</span>
                            </div>
                            <ul class="list-none space-y-1 my-4 border-t border-b py-2">${itemsHtml}</ul>
                            <div class="text-right font-bold">Toplam: ${order.totalAmount.toFixed(2)} ₺</div>
                            ${order.status === 'delivered' && !order.isReviewed ? `<button data-order-id="${doc.id}" class="review-btn mt-4 w-full bg-yellow-500 text-white py-2 rounded-md hover:bg-yellow-600">Yorum Yap</button>` : ''}
                        `;
                        ordersContainer.appendChild(card);
                    });
                } catch (error) { console.error("Geçmiş siparişler çekilirken hata:", error); }
            };

            const setupEventListeners = () => {
                cartCheckoutSection.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    if (button.classList.contains('quantity-change-btn')) {
                        const index = button.dataset.index;
                        if (button.classList.contains('inc-btn')) currentCart[index].quantity++;
                        else if (button.classList.contains('dec-btn') && currentCart[index].quantity > 1) currentCart[index].quantity--;
                        sessionStorage.setItem('shoppingCart', JSON.stringify(currentCart));
                        renderCart();
                    } else if (button.classList.contains('remove-item-btn')) {
                        const index = button.dataset.index;
                        currentCart.splice(index, 1);
                        sessionStorage.setItem('shoppingCart', JSON.stringify(currentCart));
                        renderCart();
                    }
                });

                changeInfoBtn.addEventListener('click', () => {
                    isEditingInfo = !isEditingInfo;
                    if (!isEditingInfo) {
                        currentUserData.displayName = document.getElementById('fullname-input').value;
                        currentUserData.phone = document.getElementById('phone-input').value;
                        currentUserData.deliveryAddress = document.getElementById('address-input').value;
                    }
                    renderUserInfo();
                });

                document.querySelectorAll('input[name="delivery-type"], #city').forEach(el => el.addEventListener('change', renderPriceSummary));

                confirmOrderBtn.addEventListener('click', async () => {
                    if (currentCart.length === 0) return;
                    confirmOrderBtn.disabled = true;
                    confirmOrderBtn.textContent = 'İşleniyor...';

                    const finalData = {
                        userId: auth.currentUser.uid,
                        userEmail: auth.currentUser.email,
                        fullName: currentUserData.displayName,
                        phone: currentUserData.phone,
                        deliveryAddress: document.querySelector('input[name="delivery-type"]:checked').value === 'home' ? currentUserData.deliveryAddress : 'Depodan Teslim',
                        deliveryType: document.querySelector('input[name="delivery-type"]:checked').value,
                        city: document.querySelector('input[name="delivery-type"]:checked').value === 'home' ? document.getElementById('city').value : null,
                        items: currentCart,
                        totalAmount: parseFloat(priceSummary.querySelector('div:last-child span:last-child').textContent),
                        status: 'pending',
                        isReviewed: false,
                        orderDate: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        await db.collection('orders').add(finalData);
                        window.showToast('Siparişiniz başarıyla alındı!');
                        sessionStorage.removeItem('shoppingCart');
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (error) {
                        window.showToast('Sipariş oluşturulurken hata oluştu.');
                        confirmOrderBtn.disabled = false;
                        confirmOrderBtn.textContent = 'Siparişi Onayla';
                    }
                });

                ordersContainer.addEventListener('click', e => {
                    const reviewBtn = e.target.closest('.review-btn');
                    if(reviewBtn) {
                        document.getElementById('review-order-id').value = reviewBtn.dataset.orderId;
                        reviewModal.classList.remove('hidden');
                    }
                });
                
                closeReviewModalBtn.addEventListener('click', () => reviewModal.classList.add('hidden'));

                starRatingContainer.addEventListener('click', e => {
                    if(e.target.matches('i')) {
                        currentRating = e.target.dataset.value;
                        Array.from(starRatingContainer.children).forEach((star, index) => {
                            star.className = `ri-star-${index < currentRating ? 'fill text-yellow-400' : 'line text-gray-300'} cursor-pointer hover:text-yellow-400`;
                        });
                    }
                });

                reviewForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const orderId = document.getElementById('review-order-id').value;
                    const reviewText = document.getElementById('review-text').value;

                    if(currentRating === 0 || !reviewText) {
                        window.showToast('Lütfen puan verin ve yorum yazın.');
                        return;
                    }

                    const reviewData = {
                        userId: auth.currentUser.uid,
                        userName: currentUserData.displayName,
                        orderId,
                        rating: currentRating,
                        reviewText,
                        isApproved: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        await db.collection('reviews').add(reviewData);
                        await db.collection('orders').doc(orderId).update({ isReviewed: true });
                        reviewModal.classList.add('hidden');
                        window.showToast('Yorumunuz için teşekkür ederiz!');
                        fetchOrders(auth.currentUser.uid);
                    } catch (error) {
                        window.showToast('Yorum gönderilirken hata oluştu.');
                    }
                });

            };

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    cartCheckoutSection.classList.remove('hidden');
                    await fetchData(user.uid);
                    renderUserInfo();
                    renderCart();
                    fetchOrders(user.uid);
                    setupEventListeners();
                } else {
                    cartCheckoutSection.classList.add('hidden');
                    ordersContainer.innerHTML = '<p class="text-gray-500 text-center py-10">Siparişlerinizi ve sepetinizi görmek için lütfen giriş yapın.</p>';
                }
            });
        });
    </script>
</body>
</html>
