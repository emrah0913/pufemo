<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepetim | Getir Kıbrıs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5d3ebc',
                        secondary: '#ffd300'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'button': '8px',
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
        }
        .item-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .item-card:last-child {
            border-bottom: none;
        }
        .quantity-btn {
            background-color: #eee;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quantity-btn:hover {
            background-color: #ddd;
        }
        /* Toast Notification Styling */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            z-index: 1000;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm px-4 py-3 fixed top-0 left-0 w-full z-50">
        <div class="max-w-screen-lg mx-auto flex items-center justify-between">
            <a href="https://pufemo.netlify.app/index.html" class="flex items-center gap-2 text-primary font-bold text-lg">
                <i class="ri-arrow-left-line"></i>
                <span>Sepetim</span>
            </a>
            <div id="auth-button" class="w-8 h-8 flex items-center justify-center">
                <button id="login-btn" class="text-xs text-primary font-medium cursor-pointer">
                    <i class="ri-google-fill ri-lg"></i>
                </button>
                <div id="profile-container" class="hidden">
                    <img id="profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full cursor-pointer">
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-screen-lg mx-auto py-20 px-4 w-full">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Sepetim</h1>

        <div id="cart-items-container" class="bg-white rounded-lg shadow-md mb-6">
            <!-- Sepet öğeleri buraya dinamik olarak eklenecek -->
            <div id="loading-cart-message" class="p-6 text-center text-gray-500">Sepetiniz yükleniyor...</div>
            <div id="empty-cart-message" class="hidden p-6 text-center text-gray-500">
                <i class="ri-shopping-cart-line text-6xl mb-4 text-gray-300"></i>
                <p class="text-lg">Sepetinizde ürün bulunmuyor.</p>
                <a href="https://pufemo.netlify.app/index.html" class="mt-4 inline-block bg-primary text-white px-6 py-2 rounded-button hover:bg-primary/90 transition-colors">Alışverişe Başla</a>
            </div>
        </div>

        <div id="cart-summary" class="bg-white rounded-lg shadow-md p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Sipariş Özeti</h2>
            <div class="space-y-2 text-sm text-gray-700 mb-4">
                <div class="flex justify-between">
                    <span>Ürünler Toplamı:</span>
                    <span id="subtotal">0.00 ₺</span>
                </div>
                <div class="flex justify-between">
                    <span>Hizmet Bedeli Toplamı:</span>
                    <span id="total-service-fee">0.00 ₺</span>
                </div>
                <div class="flex justify-between">
                    <span>Kargo Ücreti:</span>
                    <span id="shipping-fee">0.00 ₺</span>
                </div>
                <div class="flex justify-between font-bold text-lg text-primary pt-2 border-t border-gray-200">
                    <span>Toplam Tutar:</span>
                    <span id="grand-total">0.00 ₺</span>
                </div>
            </div>

            <h3 class="font-semibold text-gray-800 mb-3">Teslimat Bilgileri</h3>
            <div id="delivery-info" class="space-y-2 text-sm text-gray-700 mb-4">
                <p id="user-name"><span class="font-medium">Ad Soyad:</span> Yükleniyor...</p>
                <p id="user-phone"><span class="font-medium">Telefon:</span> Yükleniyor...</p>
                <p id="user-address"><span class="font-medium">Adres:</span> Yükleniyor...</p>
                <button id="edit-profile-btn" class="text-primary text-sm hover:underline mt-2">Bilgileri Düzenle</button>
            </div>

            <button id="create-order-btn" class="w-full bg-primary text-white py-3 rounded-button font-semibold hover:bg-primary/90 transition-colors">
                Siparişi Tamamla
            </button>
        </div>
    </main>

    <!-- Modals -->
    <div id="login-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm m-4 relative fade-in">
            <button id="close-login-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="ri-close-line ri-lg"></i></button>
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Hoş Geldiniz!</h3>
                <p class="text-sm text-gray-600 mt-1">Hizmetlerimizi kullanmak için giriş yapın.</p>
            </div>
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 border border-gray-300 rounded-button py-3 font-semibold text-gray-700 hover:bg-gray-50 transition-colors">
                <i class="ri-google-fill ri-lg text-red-500"></i>
                <span>Google ile Giriş Yap</span>
            </button>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm m-4 relative fade-in">
            <h3 class="text-2xl font-bold text-gray-800 text-center mb-2">Profilinizi Tamamlayın</h3>
            <p class="text-sm text-gray-600 mt-1 text-center mb-6">Size daha iyi hizmet verebilmemiz için bu bilgilere ihtiyacımız var.</p>
            <form id="profile-form" class="space-y-4">
                <div>
                    <label for="full-name-input" class="block text-sm font-medium text-gray-700 mb-1">Ad Soyad <span class="text-red-500">*</span></label>
                    <input type="text" id="full-name-input" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                <div>
                    <label for="phone-input" class="block text-sm font-medium text-gray-700 mb-1">Telefon Numarası <span class="text-red-500">*</span></label>
                    <input type="tel" id="phone-input" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="+90 5XX XXX XX XX">
                </div>
                <div>
                    <label for="address-input" class="block text-sm font-medium text-gray-700 mb-1">Varsayılan Teslimat Adresi <span class="text-red-500">*</span></label>
                    <textarea id="address-input" required rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Tam adresinizi girin (örn: Cadde, No, Daire, Şehir)"></textarea>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3 rounded-button font-semibold hover:bg-primary/90 transition-colors">Profili Kaydet</button>
            </form>
        </div>
    </div>

    <div id="auth-required-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-lg p-8 w-full max-w-sm m-4 text-center fade-in">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ri-lock-line ri-2x text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Giriş Gerekli</h3>
            <p class="text-sm text-gray-600 mt-2 mb-6">Bu özelliği kullanmak için lütfen giriş yapın.</p>
            <div class="space-y-2">
                <button id="auth-modal-login-btn" class="w-full bg-primary text-white py-2 rounded-button font-medium hover:bg-primary/90 transition-colors">Giriş Yap</button>
                <button id="close-auth-modal" class="w-full text-gray-600 py-2 font-medium hover:bg-gray-100 rounded-button transition-colors">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Element -->
    <div id="toast" class="fixed bottom-24 right-6 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-[110] transform translate-y-4">
        <span id="toast-message"></span>
    </div>

</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // KULLANICININ SAĞLADIĞI FİREBASE YAPILANDIRMASI
    const firebaseConfig = {
        apiKey: "AIzaSyB64tAKvCHeYnJ8-HNRLpzB7sQRng4FHyA",
        authDomain: "pufemo-2dc3a.firebaseapp.com",
        projectId: "pufemo-2dc3a",
        storageBucket: "pufemo-2dc3a.firebasestorage.app",
        messagingSenderId: "321284306570",
        appId: "1:321284306570:web:ca891826c3e4edde8edf73"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let userProfile = null;
    let cartItems = [];
    let pricingSettings = {};

    // --- DOM Elements ---
    const cartItemsContainer = document.getElementById('cart-items-container');
    const loadingCartMessage = document.getElementById('loading-cart-message');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const cartSummary = document.getElementById('cart-summary');
    const subtotalSpan = document.getElementById('subtotal');
    const totalServiceFeeSpan = document.getElementById('total-service-fee');
    const shippingFeeSpan = document.getElementById('shipping-fee');
    const grandTotalSpan = document.getElementById('grand-total');
    const userNameP = document.getElementById('user-name');
    const userPhoneP = document = document.getElementById('user-phone'); // Corrected typo here
    const userAddressP = document.getElementById('user-address');
    const createOrderBtn = document.getElementById('create-order-btn');
    const editProfileBtn = document.getElementById('edit-profile-btn');

    const loginBtn = document.getElementById('login-btn');
    const profileContainer = document.getElementById('profile-container');
    const profileImg = document = document.getElementById('profile-img'); // Corrected typo here
    const loginModal = document.getElementById('login-modal');
    const closeLoginModal = document.getElementById('close-login-modal');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const authRequiredModal = document.getElementById('auth-required-modal');
    const closeAuthModal = document.getElementById('close-auth-modal');
    const authModalLoginBtn = document.getElementById('auth-modal-login-btn');
    const profileModal = document.getElementById('profile-modal');
    const profileForm = document.getElementById('profile-form');

    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // --- TOAST NOTIFICATION ---
    function showToast(message, duration = 3000) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-4', 'hidden');
        toast.classList.add('opacity-100', 'translate-y-0', 'show');

        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0', 'show');
            toast.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }, duration);
    }

    // --- AUTHENTICATION & USER PROFILE ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            // Removed redundant `document =` assignments for profileImg
            profileImg.src = user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=P';
            profileContainer.classList.remove('hidden');
            loginBtn.classList.add('hidden');
            
            await fetchUserProfile(user.uid);
            await loadPricingSettings();
            listenToCart(user.uid);

        } else {
            currentUser = null;
            userProfile = null;
            profileContainer.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            loadingCartMessage.classList.add('hidden');
            emptyCartMessage.classList.remove('hidden');
            cartSummary.classList.add('hidden');
            showToast('Sepetinizi görmek için lütfen giriş yapın.');
            // Clear cart items visually
            cartItemsContainer.innerHTML = `<div id="loading-cart-message" class="p-6 text-center text-gray-500 hidden">Sepetiniz yükleniyor...</div>`;
            emptyCartMessage.classList.remove('hidden');
        }
    });

    loginBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
    closeLoginModal.addEventListener('click', () => loginModal.classList.add('hidden'));

    googleLoginBtn.addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            loginModal.classList.add('hidden');
        } catch (error) {
            console.error("Google giriş hatası:", error);
            showToast("Google ile giriş yaparken bir hata oluştu.");
        }
    });

    profileImg.addEventListener('click', async () => {
        if (currentUser) {
            await fetchUserProfile(currentUser.uid); // Refresh profile data
            if (confirm('Profilinizi güncellemek veya çıkış yapmak ister misiniz? \nTamam: Profili Düzenle \nİptal: Çıkış Yap')) {
                showProfileModal();
            } else {
                signOut(auth).then(() => {
                    showToast("Başarıyla çıkış yapıldı.");
                    window.location.href = 'https://pufemo.netlify.app/index.html'; // Ana sayfaya yönlendir
                }).catch((error) => {
                    console.error("Çıkış hatası:", error);
                    showToast("Çıkış yapılırken bir hata oluştu.");
                });
            }
        }
    });

    editProfileBtn.addEventListener('click', showProfileModal);

    function showProfileModal() {
        document.getElementById('full-name-input').value = userProfile?.fullName || '';
        document.getElementById('phone-input').value = userProfile?.phone || '';
        document.getElementById('address-input').value = userProfile?.address || '';
        profileModal.classList.remove('hidden');
    }

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;

        const fullName = document.getElementById('full-name-input').value.trim();
        const phone = document.getElementById('phone-input').value.trim();
        const address = document.getElementById('address-input').value.trim();

        if (!fullName || !phone || !address) {
            showToast("Lütfen tüm alanları doldurunuz.");
            return;
        }

        try {
            const userDocRef = doc(db, 'users', currentUser.uid);
            await setDoc(userDocRef, {
                fullName: fullName,
                phone: phone,
                address: address,
                email: currentUser.email,
                photoURL: currentUser.photoURL,
                lastUpdated: new Date()
            }, { merge: true });

            userProfile = { ...userProfile, fullName, phone, address };
            profileModal.classList.add('hidden');
            showToast("Profil bilgileriniz başarıyla kaydedildi!");
            updateDeliveryInfo(); // Update info on page
        } catch (error) {
            console.error("Profil kaydetme hatası:", error);
            showToast("Profil kaydedilirken bir hata oluştu.");
        }
    });

    closeAuthModal.addEventListener('click', () => authRequiredModal.classList.add('hidden'));
    authModalLoginBtn.addEventListener('click', () => {
        authRequiredModal.classList.add('hidden');
        loginModal.classList.remove('hidden');
    });

    // --- FETCH USER PROFILE ---
    async function fetchUserProfile(userId) {
        try {
            const userDocRef = doc(db, 'users', userId);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                userProfile = userDocSnap.data();
                if (!userProfile.fullName || !userProfile.phone || !userProfile.address) {
                    showProfileModal(); // Prompt to complete profile if incomplete
                }
            } else {
                // New user, create basic profile and prompt for details
                await setDoc(userDocRef, {
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    role: 'customer', // Default role
                    createdAt: new Date()
                });
                userProfile = { email: currentUser.email, photoURL: currentUser.photoURL, role: 'customer' };
                showProfileModal();
            }
            updateDeliveryInfo();
        } catch (error) {
            console.error("Kullanıcı profili yüklenirken hata:", error);
            showToast("Profil bilgileri yüklenirken bir hata oluştu.");
        }
    }

    function updateDeliveryInfo() {
        if (userProfile) {
            userNameP.innerHTML = `<span class="font-medium">Ad Soyad:</span> ${userProfile.fullName || 'Bilgi Yok'}`;
            userPhoneP.innerHTML = `<span class="font-medium">Telefon:</span> ${userProfile.phone || 'Bilgi Yok'}`;
            userAddressP.innerHTML = `<span class="font-medium">Adres:</span> ${userProfile.address || 'Bilgi Yok'}`;
        } else {
            userNameP.innerHTML = `<span class="font-medium">Ad Soyad:</span> Yükleniyor...`;
            userPhoneP.innerHTML = `<span class="font-medium">Telefon:</span> Yükleniyor...`;
            userAddressP.innerHTML = `<span class="font-medium">Adres:</span> Yükleniyor...`;
        }
    }

    // --- LOAD PRICING SETTINGS ---
    async function loadPricingSettings() {
        try {
            const pricingDocRef = doc(db, "settings", "pricing");
            const pricingDocSnap = await getDoc(pricingDocRef);
            if (pricingDocSnap.exists()) {
                pricingSettings = pricingDocSnap.data();
                console.log("Fiyat ayarları yüklendi:", pricingSettings);
            } else {
                console.warn("Pricing settings not found, using default.");
                pricingSettings = {
                    categoryRates: { 'furniture': 0.70, 'electronics': 0.70, 'clothing': 0.45, 'cosmetics': 0.70, 'stationery': 0.40, 'default': 0.50 },
                    cityFees: { 'Lefkoşa': 200, 'Girne': 350, 'Gazimağusa': 300, 'Güzelyurt': 400, 'İskele': 450, 'Diğer': 500 }
                };
            }
        } catch (error) {
            console.error("Fiyat ayarları yüklenirken hata oluştu:", error);
            showToast("Fiyat ayarları yüklenirken bir sorun oluştu.");
            pricingSettings = { /* Fallback to a safe default */ };
        }
    }

    // --- CART MANAGEMENT ---
    function listenToCart(userId) {
        const cartRef = collection(db, 'users', userId, 'cart');
        onSnapshot(query(cartRef), (snapshot) => {
            cartItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCartItems();
            calculateCartTotals();
        }, (error) => {
            console.error("Sepet dinlenirken hata oluştu:", error);
            showToast("Sepetiniz yüklenirken bir hata oluştu.");
            loadingCartMessage.classList.add('hidden');
            emptyCartMessage.classList.remove('hidden');
        });
    }

    function renderCartItems() {
        cartItemsContainer.innerHTML = ''; // Clear existing items
        loadingCartMessage.classList.add('hidden'); // Hide loading message

        if (cartItems.length === 0) {
            emptyCartMessage.classList.remove('hidden');
            cartSummary.classList.add('hidden');
        } else {
            emptyCartMessage.classList.add('hidden');
            cartSummary.classList.remove('hidden');

            cartItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card bg-white p-4 rounded-lg shadow-sm mb-3';
                itemCard.innerHTML = `
                    <img src="${item.imageUrl || 'https://placehold.co/80x80/e2e8f0/64748b?text=Ürün'}" alt="Ürün Resmi" class="w-20 h-20 object-cover rounded-md mr-4 flex-shrink-0">
                    <div class="flex-grow">
                        <h3 class="font-semibold text-gray-800 text-lg">${item.productLink}</h3>
                        <p class="text-gray-600 text-sm">Fiyat: ${item.productPrice.toFixed(2)} ₺</p>
                        ${item.type === 'custom_order' ? `<p class="text-gray-600 text-sm">Hizmet Bedeli: ${((item.productPrice || 0) * (item.serviceFeeRate || 0)).toFixed(2)} ₺</p>` : ''}
                        <div class="flex items-center mt-2">
                            <button class="quantity-btn decrease-quantity" data-id="${item.id}">-</button>
                            <span class="mx-3 text-lg font-medium">${item.quantity}</span>
                            <button class="quantity-btn increase-quantity" data-id="${item.id}">+</button>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 ml-4 delete-item" data-id="${item.id}">
                        <i class="ri-delete-bin-line ri-lg"></i>
                    </button>
                `;
                cartItemsContainer.appendChild(itemCard);
            });

            // Add event listeners for quantity buttons and delete button
            cartItemsContainer.querySelectorAll('.increase-quantity').forEach(btn => {
                btn.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.id, 1));
            });
            cartItemsContainer.querySelectorAll('.decrease-quantity').forEach(btn => {
                btn.addEventListener('click', (e) => updateQuantity(e.currentTarget.dataset.id, -1));
            });
            cartItemsContainer.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', (e) => deleteCartItem(e.currentTarget.dataset.id));
            });
        }
    }

    async function updateQuantity(itemId, change) {
        const itemRef = doc(db, 'users', currentUser.uid, 'cart', itemId);
        const item = cartItems.find(i => i.id === itemId);

        if (!item) return;

        let newQuantity = item.quantity + change;
        if (newQuantity < 1) newQuantity = 1; // Quantity cannot be less than 1

        try {
            await updateDoc(itemRef, { quantity: newQuantity });
        } catch (error) {
            console.error("Miktar güncellenirken hata:", error);
            showToast("Miktar güncellenirken bir sorun oluştu.");
        }
    }

    async function deleteCartItem(itemId) {
        // Use a custom modal or confirmation for deletion instead of `confirm()`
        if (confirm('Bu ürünü sepetinizden kaldırmak istediğinizden emin misiniz?')) { // Simple confirmation for now
            try {
                const itemRef = doc(db, 'users', currentUser.uid, 'cart', itemId);
                await deleteDoc(itemRef);
                showToast("Ürün sepetten kaldırıldı.");
            } catch (error) {
                console.error("Ürün silinirken hata:", error);
                showToast("Ürün kaldırılırken bir sorun oluştu.");
            }
        }
    }

    function calculateCartTotals() {
        let subtotal = 0;
        let totalServiceFee = 0;
        let shippingFee = 0; // Kargo ücreti sabit veya hesaplamaya göre değişebilir
        let grandTotal = 0;

        cartItems.forEach(item => {
            const itemPrice = item.productPrice || 0;
            const quantity = item.quantity || 1;
            const serviceRate = item.serviceFeeRate || (pricingSettings.categoryRates?.[item.category] || pricingSettings.categoryRates?.['default'] || 0);

            const itemSubtotal = itemPrice * quantity;
            let itemServiceFee = 0;

            if (item.type === 'custom_order') {
                itemServiceFee = itemSubtotal * serviceRate;
            }
            // Producer products already have their price set, no additional service fee from category rates
            // If there's a different fee for producer products, it should be defined elsewhere or handled by producerPrice.

            subtotal += itemSubtotal;
            totalServiceFee += itemServiceFee;
        });
        
        // Kargo ücretini burada belirleyin. Örneğin, toplam tutara göre veya sabit bir değer.
        // Basit bir örnek olarak: Eğer sepet doluysa sabit bir kargo ücreti ekleyelim.
        // Daha gelişmiş bir sistemde, adres bilgisine, ağırlığa vb. göre hesaplanabilir.
        if (cartItems.length > 0) {
             // Varsayılan bir şehir ücreti kullanabiliriz veya kullanıcı profili varsa şehrini alabiliriz.
             const userCity = userProfile?.address?.split(',').pop()?.trim() || 'Diğer'; // Adresin son kısmını şehir olarak al
             shippingFee = pricingSettings.cityFees?.[userCity] || pricingSettings.cityFees?.['Diğer'] || 0;
        }

        grandTotal = subtotal + totalServiceFee + shippingFee;

        subtotalSpan.textContent = `${subtotal.toFixed(2)} ₺`;
        totalServiceFeeSpan.textContent = `${totalServiceFee.toFixed(2)} ₺`;
        shippingFeeSpan.textContent = `${shippingFee.toFixed(2)} ₺`;
        grandTotalSpan.textContent = `${grandTotal.toFixed(2)} ₺`;
    }

    // --- CREATE ORDER ---
    createOrderBtn.addEventListener('click', async () => {
        if (!currentUser) {
            authRequiredModal.classList.remove('hidden');
            return;
        }
        if (!userProfile || !userProfile.fullName || !userProfile.phone || !userProfile.address) {
            showProfileModal();
            showToast("Siparişi tamamlamak için lütfen profil bilgilerinizi eksiksiz doldurun.");
            return;
        }
        if (cartItems.length === 0) {
            showToast("Sepetiniz boş! Sipariş oluşturulamaz.");
            return;
        }

        // Ödeme ve sipariş onay sürecini burada uygulayın (örneğin, bir ödeme ağ geçidi yönlendirmesi veya basit bir onay mesajı).
        if (!confirm('Siparişi tamamlamak istediğinizden emin misiniz?')) { // Simple confirmation for now
            return;
        }

        try {
            const orderItems = cartItems.map(item => ({
                productLink: item.productLink,
                productPrice: item.productPrice,
                category: item.category,
                orderMethod: item.orderMethod,
                quantity: item.quantity,
                serviceFeeRate: item.serviceFeeRate,
                type: item.type,
                producerId: item.producerId || null // Producer ürünleri için producerId'yi dahil et
            }));

            const calculatedSubtotal = cartItems.reduce((sum, item) => sum + (item.productPrice * item.quantity), 0);
            const calculatedServiceFee = cartItems.reduce((sum, item) => {
                const itemSubtotal = item.productPrice * item.quantity;
                const serviceRate = item.serviceFeeRate || (pricingSettings.categoryRates?.[item.category] || pricingSettings.categoryRates?.['default'] || 0);
                return sum + (item.type === 'custom_order' ? (itemSubtotal * serviceRate) : 0);
            }, 0);

            const userCity = userProfile.address?.split(',').pop()?.trim() || 'Diğer';
            const calculatedShippingFee = pricingSettings.cityFees?.[userCity] || pricingSettings.cityFees?.['Diğer'] || 0;
            const calculatedGrandTotal = calculatedSubtotal + calculatedServiceFee + calculatedShippingFee;

            await addDoc(collection(db, 'orders'), {
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userFullName: userProfile.fullName,
                userPhone: userProfile.phone,
                userAddress: userProfile.address,
                items: orderItems,
                subtotal: calculatedSubtotal,
                serviceFeeTotal: calculatedServiceFee,
                shippingFee: calculatedShippingFee,
                grandTotal: calculatedGrandTotal,
                orderDate: new Date(),
                status: 'pending_payment' // 'pending_payment', 'processing', 'shipped', 'delivered', 'cancelled'
            });

            // Sepeti boşaltma işlemi Firebase v9 uyumlu hale getirildi
            const cartRef = collection(db, 'users', currentUser.uid, 'cart');
            const cartSnapshot = await getDocs(cartRef); // getDocs kullanımı
            const batch = writeBatch(db); // writeBatch kullanımı
            cartSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            showToast("Siparişiniz başarıyla oluşturuldu! Ödeme bekleniyor.");
            setTimeout(() => {
                window.location.href = 'https://pufemo.netlify.app/index.html'; // Sipariş sonrası ana sayfaya yönlendir
            }, 2000);

        } catch (error) {
            console.error("Sipariş oluşturulurken hata:", error);
            showToast("Sipariş oluşturulurken bir hata oluştu.");
        }
    });

    // Sayfa yüklendiğinde yapılacaklar
    document.addEventListener('DOMContentLoaded', () => {
        // Firebase Auth listener already handles initial data load
    });

</script>
</html>
