<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Modern ve Konforlu Mobilyalar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Sizin CSS kodunuzun büyük bir kısmı buraya yapıştırılmıştır */
        :root { --primary-color: #2c3e50; --secondary-color: #e74c3c; --background-color: #ecf0f1; --text-color: #34495e; --light-text-color: #ffffff; --card-bg-color: #ffffff; --border-radius: 8px; --box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { text-decoration: none; color: inherit; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-overlay p { font-size: 1.5rem; margin-top: 1.5rem; color: var(--primary-color); }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }

        .promo-bar {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            text-align: center;
            padding: 8px 0;
            font-size: 0.95rem;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            z-index: 1001;
        }

        .promo-text {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-text 20s linear infinite;
        }

        @keyframes scroll-text {
            0% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        .main-header {
            background-color: var(--card-bg-color);
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding-bottom: 0.5rem;
        }
        
        .header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem 0;
        }

        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 20px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        .logo i {
            color: var(--secondary-color);
            margin-right: 5px;
        }
        .logo img {
            max-width: 100%;
            height: auto;
        }
        
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .control-select { background-color: #f8f9fa; border: 1px solid #ddd; padding: 5px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; }
        .cart-icon { font-size: 1.5rem; position: relative; }
        .cart-badge { position: absolute; top: -5px; right: -10px; background-color: var(--secondary-color); color: var(--light-text-color); border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; }
        .hamburger-menu { display: none; cursor: pointer; width: 30px; height: 25px; flex-direction: column; justify-content: space-between; background: transparent; border: none; z-index: 1003; }
        .hamburger-menu span { display: block; width: 100%; height: 3px; background-color: var(--primary-color); border-radius: 3px; transition: all 0.3s ease-in-out; }
        .hamburger-menu.open span { background-color: var(--light-text-color); }
        .hamburger-menu.open span:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        .hamburger-menu.open span:nth-child(2) { opacity: 0; }
        .hamburger-menu.open span:nth-child(3) { transform: translateY(-11px) rotate(-45deg); }
        .mobile-nav { position: fixed; top: 0; left: -100%; width: 300px; height: 100vh; background-color: var(--primary-color); color: var(--light-text-color); z-index: 1002; transition: left 0.4s ease-in-out; box-shadow: 5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; padding: 1.5rem; }
        .mobile-nav.open { left: 0; }
        .mobile-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; }
        .mobile-nav-overlay.open { opacity: 1; visibility: visible; }
        .mobile-nav .mobile-nav-header { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.5rem; font-weight: 600; color: var(--light-text-color); }
        .mobile-nav ul { list-style: none; }
        .mobile-nav ul a { display: block; padding: 15px 0; color: var(--light-text-color); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 500; transition: background-color 0.3s ease; }
        .mobile-nav ul a:hover { background-color: rgba(255,255,255,0.1); }
        .mobile-nav ul ul a { padding-left: 20px; font-size: 0.9em; }
        .mobile-nav ul ul ul a { padding-left: 40px; }
        .category-nav { background-color: var(--primary-color); padding: 0.8rem 0; }
        .category-nav ul { list-style: none; display: flex; justify-content: center; gap: 2.5rem; flex-wrap: wrap; }
        .category-nav a { color: var(--light-text-color); font-weight: 500; padding: 5px 10px; border-radius: 5px; transition: background-color 0.3s ease; }
        .category-nav a:hover { background-color: rgba(255,255,255,0.1); }
        .hero-banner { position: relative; width: 100%; height: 500px; overflow: hidden; background-color: #ccc; }
        .slide { position: absolute; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease-in-out; visibility: hidden; }
        .slide video, .slide .slide-bg-image { width: 100%; height: 100%; object-fit: cover; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; visibility: visible; }
        
        .slide-content {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            max-width: 80%;
        }

        .slide-content h2 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            color: white;
        }
        .slide-content p {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            text-shadow: 1px 1px 6px rgba(0,0,0,0.8);
            color: white;
        }
        .btn-shop {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: background-color 0.3s ease;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slide-nav { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; }
        .nav-dot.active { background-color: var(--light-text-color); }
        main { padding: 3rem 0; }
        .section { padding-top: 60px; margin-top: -60px; }
        .section-title { text-align: center; margin-bottom: 2.5rem; font-size: 2.2rem; font-weight: 600; color: var(--primary-color); }
        
        .product-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }

        @media (min-width: 1200px) {
            .product-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .product-card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .product-card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .product-image-link {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 250px;
            background-color: #f0f0f0;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 1.2rem;
        }
        .product-info-top { flex-grow: 1; }
        .product-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-description {
            display: none; /* Bu kısım index'te gösterilmiyor */
            margin-bottom: 1rem;
            color: #7f8c8d;
        }
        
        .price-container {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-top: 0.5rem;
        }
        .original-price {
            font-size: 1rem;
            color: #7f8c8d;
            text-decoration: line-through;
            font-weight: 400;
        }
        .discounted-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .free-shipping-tag {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #27ae60;
            color: var(--light-text-color);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 3rem 0 1rem 0; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem; text-align: center; }
        .footer-section { flex: 1; min-width: 200px; }
        .footer-section h4 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem; display: inline-block; }
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section a:hover { color: var(--secondary-color); }
        .footer-bottom { text-align: center; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        
        /* GÜNCELLENDİ: Ülke seçici için yeni stiller */
        .country-selector-container {
            text-align: center;
            padding: 2rem 0;
            margin: 2rem 0 0 0;
            border-top: 1px solid rgba(255,255,255,0.15);
        }

        .country-selector-container label {
            font-size: 1.1rem;
            color: var(--light-text-color); /* Footer ile uyumlu renk */
            margin-right: 10px;
            font-weight: 500;
        }

        .country-selector-container .control-select {
            padding: 8px 12px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            outline: none;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .country-selector-container .control-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        /* Yeni Karşılama Modalı Stilleri */
        .welcome-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Koyu arka plan */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001; /* Loading overlay'den de yüksek */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .welcome-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .welcome-modal-content {
            background-color: var(--card-bg-color); /* Beyaz kart arkaplanı */
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .welcome-modal-overlay.active .welcome-modal-content {
            transform: translateY(0);
        }

        .welcome-modal-content h2 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .welcome-modal-content p {
            font-size: 1.1rem;
            color: var(--text-color);
            margin-bottom: 25px;
        }

        .welcome-modal-content .control-select {
            width: 80%;
            max-width: 300px;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            outline: none;
            cursor: pointer;
        }

        .welcome-modal-content .control-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }

        .welcome-modal-content button {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 12px 30px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .welcome-modal-content button:hover {
            background-color: #c0392b; /* Slightly darker red */
            transform: translateY(-2px);
        }
        /* Sepet Sidebar Stilleri */
        .cart-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 100%; /* Mobil için tam genişlik */
            max-width: 400px; /* Masaüstü için maksimum genişlik */
            background-color: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            z-index: 10005; /* En üstte olmalı */
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .cart-sidebar.open {
            transform: translateX(0);
        }

        .cart-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .cart-sidebar-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .cart-sidebar-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

        .cart-items-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-details h4 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .cart-item-details p {
            font-size: 0.9rem;
            color: #777;
        }

        .cart-item-quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 0.5rem;
        }

        .cart-quantity-button {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .cart-quantity-button:hover {
            background-color: #e0e0e0;
        }

        .cart-quantity-text {
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }

        .cart-item-remove-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 1rem;
        }

        .cart-summary {
            padding: 1rem;
            border-top: 1px solid #eee;
            text-align: right;
        }

        .cart-summary h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .cart-checkout-button {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cart-checkout-button:hover {
            background-color: #c0392b;
        }

        .empty-cart-message {
            text-align: center;
            color: #777;
            padding: 2rem;
        }

        /* Gizli scrollbar için */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Ürün Detay Bölümü Stilleri */
        .product-detail-container {
            max-width: 1200px;
            margin: auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 0.8fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .image-gallery {
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 1;
            align-items: flex-start;
        }

        .image-gallery .main-media {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .thumbnail-row {
            display: grid;
            grid-template-columns: repeat(7, 60px); /* Her satırda 7 adet 60px genişliğinde resim */
            gap: 10px; /* Resimler arası boşluk */
            justify-content: start; /* Resimleri sola hizala */
            width: fit-content; /* İçeriğe göre genişle, taşmaları engelle */
            padding-top: 10px;
        }

        .thumbnail-row .thumbnail-item {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .thumbnail-row .thumbnail-item.active { border-color: var(--secondary-color); }
        .thumbnail-row .thumbnail-item img,
        .thumbnail-row .thumbnail-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .thumbnail-row .thumbnail-item.video-thumb::after {
            content: "\f04b";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            color: white;
            font-size: 1.5rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .details {
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 2;
        }

        .details h1 { font-size: 2rem; font-weight: 700; }
        .price { display: flex; align-items: baseline; gap: 10px; }
        .old-price { text-decoration: line-through; color: #888; font-size: 1.1rem; }
        .new-price { font-size: 1.6rem; font-weight: bold; color: var(--secondary-color); }

        /* Adet Seçici Stilleri */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-control .quantity-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 5px;
        }
        .quantity-button {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 8px;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        .quantity-button:hover {
            background-color: #1a242f;
        }
        .quantity-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .quantity-input {
            width: 60px;
            padding: 8px 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            -moz-appearance: textfield;
        }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Toplam Fiyat Stilleri */
        .total-price-display {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .total-price-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .calculated-total-price {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Yeni Varyant Bölümü Stilleri */
        .variant-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* sola hizalar */
            gap: 10px;
            padding-left: 0; /* Kaldırılan 10px padding, zaten genel padding'ler var */
        }

        .variant-title {
            font-size: 1.1rem; /* Önceki .variant-label font size'ına yakın */
            font-weight: 600;
            margin: 0;
            padding: 0;
            text-align: left;
            color: var(--primary-color); /* Metin rengi */
            margin-bottom: 5px; /* Başlık ile seçenekler arasında boşluk */
        }

        .variant-selectors {
            display: flex;
            gap: 8px; /* Varsayılan olarak 8px boşluk */
            flex-wrap: nowrap; /* Tek satırda kalmasını sağlar */
            overflow-x: auto; /* Yatay kaydırmayı etkinleştirir */
            justify-content: flex-start; /* Elemanları sola hizalar */
            width: 100%; /* Tam genişlik alır */
            padding-bottom: 10px; /* Kaydırma çubuğu için boşluk */
            -webkit-overflow-scrolling: touch; /* iOS'ta daha akıcı kaydırma */
        }

        /* Kaydırma çubuğunu gizle (isteğe bağlı) */
        .variant-selectors::-webkit-scrollbar {
            display: none;
        }
        .variant-selectors {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center; /* Resmi ve yazıyı dikeyde ortalar */
            gap: 5px; /* Daire ile isim arasındaki boşluk */
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease;
            flex: 0 0 auto; /* Esnemesini engeller, içeriğine göre boyutlanır */
            width: 80px; /* Her bir seçeneğin sabit genişliği */
            max-width: 80px; /* Her bir seçeneğin maksimum genişliği */
        }
        .color-option:hover {
            transform: translateY(-3px);
        }

        .color-circle {
            width: 70px; /* Ekran görüntüsündeki gibi daha büyük daire */
            height: 70px;
            border-radius: 50%;
            border: 2px solid #ccc;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .color-circle.active {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3);
        }
        .color-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Resmin daireye tam oturmasını sağlar */
            border-radius: 50%;
        }
        .color-name {
            font-size: 0.8rem; /* Renk isminin font boyutu */
            color: var(--text-color);
            font-weight: 500;
            white-space: normal; /* Metnin gerektiğinde yeni satıra geçmesini sağlar */
            word-break: break-word; /* Uzun kelimelerin kırılmasını sağlar */
        }

        .actions { display: flex; gap: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-cart { background: var(--primary-color); color: white; }
        .btn-cart:hover { background: #1a242f; }
        .btn-buy { background: var(--secondary-color); color: white; }
        .btn-buy:hover { background: #c0392b; }
        .free-shipping { background-color: #27ae60; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Ürün Açıklama Bölümü */
        .description-section {
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-width: 1100px;
        }
        .description-section h2 { margin-bottom: 15px; font-size: 1.5rem; border-bottom: 2px solid var(--secondary-color); display: inline-block; }

        /* Benzer Varyantlar Bölümü Stilleri */
        .related-variants-section {
            max-width: 1200px;
            margin: 40px auto 30px auto; /* Üstten ve alttan boşluk */
            padding: 30px 20px;
            background: var(--card-bg-color); /* Beyaz arka plan */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .related-variants-section h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            display: inline-block;
            padding-bottom: 5px;
            margin-left: auto;
            margin-right: auto;
        }

        .related-variants-grid {
            display: grid;
            /* Masaüstünde 4 adet etiket yan yana */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px; /* Kartlar arası boşluk */
            justify-content: center; /* Kartları ortala */
        }

        .related-variant-card {
            background-color: var(--background-color); /* Hafif gri arka plan */
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; /* padding kaldırıldı */
            padding-bottom: 15px; /* Alttan boşluk ekledik */
            text-align: center;
            position: relative; /* Ücretsiz kargo etiketi için gerekli */
        }
        .related-variant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        /* Resim boyutunu büyüt ve çerçeveyi kaldır */
        .related-variant-card img {
            width: 100%; /* Kartın tam genişliğini kaplasın */
            height: 200px; /* Daha büyük sabit yükseklik */
            object-fit: cover; /* Resmi orantılı olarak sığdırır ve kırpar */
            border-radius: 8px 8px 0 0; /* Üst köşeler yuvarlak, alt köşeler düz */
            margin-bottom: 10px; /* Resim ile yazı arasında boşluk */
            border: none; /* Çerçeveyi kaldır */
            padding: 0; /* İç dolguyu kaldır */
            background-color: #fff; /* Resmin arkası beyaz olsun */
        }

        .related-variant-card .variant-name { /* Sadece ürün adı gösterilecek */
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            padding: 0 10px; /* Kenarlardan boşluk */
        }

        /* Benzer ürünler fiyat gösterimi için stiller */
        .related-variant-card .price-container {
            display: flex;
            align-items: baseline;
            justify-content: center; /* Fiyatları ortala */
            gap: 8px; /* Fiyatlar arası boşluk */
            margin-top: 5px;
            flex-wrap: wrap; /* Küçük ekranlarda sığmazsa alt satıra geçsin */
            padding: 0 10px; /* Kenarlardan boşluk */
        }

        .related-variant-card .old-price {
            text-decoration: line-through;
            color: #888;
            font-size: 0.9em; /* Daha küçük */
        }

        .related-variant-card .new-price {
            font-size: 1.1em; /* Biraz daha büyük */
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Ücretsiz kargo etiketi stili */
        .related-variant-card .free-shipping-tag {
            display: inline-block; /* Kendi satırında olsun */
            background-color: #27ae60; /* Yeşil */
            color: white;
            padding: 4px 8px; /* Daha küçük padding */
            border-radius: 12px; /* Ovalimsi */
            font-size: 0.75rem; /* Küçük font boyutu */
            font-weight: 600;
            z-index: 10; /* Diğer içeriklerin üzerinde olsun */
            pointer-events: none; /* Tıklanabilir olmasın */
        }
        /* Etiketi ortalamak için Flexbox kullanıyoruz */
        .related-variant-card .free-shipping-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px; /* Fiyat ile ücretsiz kargo etiketi arasına boşluk */
        }


        /* Altbilgi (Footer) Stilleri */
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 3rem 0 1rem 0; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem; text-align: center; }
        .footer-section { flex: 1; min-width: 200px; }
        .footer-section h4 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem; display: inline-block; }
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section a:hover { color: var(--secondary-color); }
        .footer-bottom { text-align: center; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }

        /* Ülke Seçici Stilleri */
        .country-selector-container { text-align: center; padding: 2rem 0; margin: 2rem 0 0 0; border-top: 1px solid rgba(255,255,255,0.15); }
        .country-selector-container label { font-size: 1.1rem; color: var(--light-text-color); margin-right: 10px; font-weight: 500; }
        .country-selector-container .control-select { padding: 8px 12px; font-size: 1rem; border-radius: var(--border-radius); border: 1px solid #ccc; background-color: var(--card-bg-color); color: var(--text-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .country-selector-container .control-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }

        /* YENİ EKLENDİ: Siparişler Tablosu ve Detayları için Stil */
        .user-order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            overflow: hidden; /* Köşe yuvarlaklığı için */
            box-shadow: var(--box-shadow);
        }

        .user-order-table th,
        .user-order-table td {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        .user-order-table th {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .user-order-table tbody tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        .user-order-table tbody tr:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }

        .order-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            text-transform: capitalize;
        }

        .status-pending { background-color: orange; }
        .status-processing { background-color: blue; }
        .status-shipped { background-color: #27ae60; } /* green */
        .status-delivered { background-color: green; }
        .status-cancelled { background-color: red; }

        .order-detail-modal-content {
            background-color: var(--card-bg-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 600px;
            width: 90%;
            margin: auto;
            text-align: left;
            position: relative;
        }

        .order-detail-modal-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .order-detail-modal-content h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .order-detail-modal-content p {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .order-detail-modal-content h3 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .order-detail-modal-content ul {
            list-style: none;
            padding: 0;
        }

        .order-detail-modal-content ul li {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            border: 1px solid #eee;
            font-size: 0.95rem;
        }

        .order-detail-modal-content .modal-actions {
            margin-top: 25px;
            text-align: right;
        }
        /* YENİ EKLENEN KISIM SONU */

        @media (max-width: 600px) {
            .checkout-container {
                margin: 20px auto;
                padding: 20px;
            }
            .checkout-container h2 {
                font-size: 1.8rem;
            }
            .order-success-container {
                margin: 40px auto;
                padding: 20px;
            }
            .order-success-container h2 {
                font-size: 2rem;
            }
            .order-success-container i {
                font-size: 3rem;
            }
        }

    </style>
</head>
<body>
    <!-- Hoş Geldiniz Modalı -->
    <div id="welcomeModalOverlay" class="welcome-modal-overlay">
        <div class="welcome-modal-content">
            <h2 id="welcome-modal-title"></h2>
            <p id="welcome-modal-message"></p>
            <select id="welcomeCountrySelect" class="control-select"></select>
            <button id="welcomeModalConfirmButton"></button>
        </div>
    </div>

    <!-- Sepet Sidebar -->
    <div id="cartSidebar" class="cart-sidebar">
        <div class="cart-sidebar-header">
            <h2 id="cart-sidebar-title">Sepetiniz</h2>
            <button id="closeCartBtn" class="cart-sidebar-close-btn">&times;</button>
        </div>
        <div id="cartItemsContainer" class="cart-items-container no-scrollbar">
            <!-- Sepet öğeleri buraya dinamik olarak eklenecek -->
            <p id="emptyCartMessage" class="empty-cart-message">Sepetiniz boş.</p>
        </div>
        <div class="cart-summary">
            <h3 id="cartTotalText">Toplam: <span id="cartTotal">0.00 TL</span></h3>
            <button id="checkoutBtn" class="cart-checkout-button">Satın Al</button>
        </div>
    </div>

    <!-- Promosyon Çubuğu -->
    <div class="promo-bar">
        <span id="promo-text-content" class="promo-text"></span>
    </div>

    <!-- Yükleme Ekranı -->
    <div id="loading-overlay" class="loading-overlay">
        <i class="fa-solid fa-couch fa-bounce" style="font-size: 3rem;"></i>
        <p id="loading-text"></p>
    </div>

    <!-- Mobil Navigasyon Overlay -->
    <div id="mobile-nav-overlay" class="mobile-nav-overlay"></div>

    <!-- Ana Başlık (Header) -->
    <header class="main-header">
        <div class="header-top">
            <a href="index.html" class="logo" id="main-logo-link">
            </a>
        </div>
        <div class="container">
            <button class="hamburger-menu" id="hamburger-menu-btn" aria-label="Menüyü aç/kapat"><span></span><span></span><span></span></button>
            <div class="header-controls">
                <select id="language-selector" class="control-select"></select>
                <select id="currency-selector" class="control-select"></select>
                <!-- YENİ EKLENDİ: Siparişlerim linki -->
                <a href="#my-orders-view" class="cart-icon" id="my-orders-link" title="">
                    <i class="fa-solid fa-box-open"></i> <!-- Siparişlerim için ikon -->
                </a>
                <!-- YENİ EKLENDİ SONU -->
                <a href="#cart-view" class="cart-icon" id="cart-page-link" title="">
                    <i class="fa-solid fa-cart-shopping"></i><span class="cart-badge" id="cartItemCount">0</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Mobil Navigasyon Menüsü -->
    <nav id="mobile-nav" class="mobile-nav">
        <!-- YENİ EKLENDİ: Mobil menüye Siparişlerim linki -->
        <ul>
            <li><a href="index.html">Anasayfa</a></li> <!-- Anasayfa linki eklendi -->
            <li><a href="cart-orders.html">Sepetim & Siparişlerim</a></li> <!-- Sepetim ve Siparişlerim tek sayfada -->
            <!-- Dinamik kategori linkleri JS tarafından eklenecek -->
        </ul>
        <!-- YENİ EKLENDİ SONU -->
    </nav>

    <!-- Kategori Navigasyonu -->
    <nav class="category-nav"><div class="container"><ul id="category-menu-container"></ul></div></nav>

    <!-- DİNAMİK İÇERİK ALANI -->
    <div id="dynamic-content-area">

        <!-- Anasayfa Görünümü -->
        <div id="homepage-view" class="page-content active">
            <!-- Hero Banner (Slider) -->
            <section class="hero-banner" id="hero-banner-container">
                <div class="slide-nav"></div>
            </section>

            <!-- Ana İçerik - Ürünler -->
            <main class="container">
                <section id="main-product-section" class="section featured-products">
                    <h1 class="section-title" id="main-section-title"></h1>
                    <div class="product-grid" id="product-grid-container"></div>
                    <p id="noProductsMessage" class="text-center text-gray-500 mt-12 hidden">Gösterilecek ürün bulunmamaktadır.</p>
                </section>
                <div id="dynamic-product-sections"></div>
            </main>
        </div>

    </div> <!-- #dynamic-content-area sonu -->

    <!-- Alt Bilgi (Footer) -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 id="footer-title-pufemo"></h4>
                    <p id="footer-desc-pufemo"></p>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-fast-links"></h4>
                    <ul>
                        <li><a href="#" id="footer-link-about"></a></li>
                        <li><a href="#" id="footer-link-contact"></a></li>
                        <li><a href="#" id="footer-link-privacy"></a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-follow-us"></h4>
                    <ul>
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Instagram</a></li>
                        <li><a href="#">Pinterest</a></li>
                    </ul>
                </div>
            </div>

            <div class="country-selector-container">
                <label for="country-selector" id="country-selector-label"></label>
                <select id="country-selector" class="control-select"></select>
            </div>

            <div class="footer-bottom" id="footer-copyright"></div>
        </div>
    </footer>

    <!-- Firebase SDK'ları -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, onSnapshot, doc, getDoc, addDoc, serverTimestamp, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // EKLENDİ: 'where' ve 'orderBy' metotları

        // Firebase yapılandırması ve uygulama ID'si global değişkenlerden alınır
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
                authDomain: "pufemo-com.firebaseapp.com",
                projectId: "pufemo-com",
                storageBucket: "pufemo-com.appspot.com",
                messagingSenderId: "983352837227",
                appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
            };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = '';
        let isAuthReady = false;

        // siteData değişkenini burada global olarak tanımlayın
        let siteData = {
            settings: {
                languages: [],
                general: { logo: {}, promoBar: {} },
                countryPricing: {},
                currencySymbols: {},
                exchangeRates: {},
                banner: { slides: [] }
            },
            categories: { tree: [] }
        };

        let tempUserId = localStorage.getItem('tempUserId') || crypto.randomUUID();
        localStorage.setItem('tempUserId', tempUserId);

        let currentSettings = JSON.parse(localStorage.getItem('userSettings')) || {
            country: { id: 'TR', name_tr: 'Türkiye', name_en: 'Turkey', flag: '🇹🇷', currency: '₺', lang: 'tr' },
            language: { code: 'tr', name: 'Türkçe' },
            currency: { code: '₺', name: 'Türk Lirası' }
        };
        let currentLang = currentSettings.language.code;
        let currentCurrency = currentSettings.currency.code;
        let currentCountryCode = currentSettings.country.id;

        const welcomeModalOverlay = document.getElementById('welcomeModalOverlay');
        const welcomeCountrySelect = document.getElementById('welcomeCountrySelect');
        const welcomeModalConfirmButton = document.getElementById('welcomeModalConfirmButton');
        const welcomeModalTitle = document.getElementById('welcome-modal-title');
        const welcomeModalMessage = document.getElementById('welcome-modal-message');

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingTextP = document.getElementById('loading-text');

        const showLoading = () => {
            loadingOverlay.classList.remove('hidden');
            if (loadingTextP) loadingTextP.textContent = getStaticText('loading_text');
        };
        const hideLoading = () => {
            loadingOverlay.classList.add('hidden');
        };

        const mainSectionTitleEl = document.getElementById('main-section-title');
        const cartPageLinkEl = document.getElementById('cart-page-link');

        const productGrid = document.getElementById('product-grid-container');
        const noProductsMessage = document.getElementById('noProductsMessage');
        
        const cartSidebar = document.getElementById('cartSidebar');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const cartItemCountSpan = document.getElementById('cartItemCount');
        const cartTotalSpan = document.getElementById('cartTotal');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartTotalText = document.getElementById('cartTotalText');

        // Sabit veriler
        let allCountries = [];
        let allLanguages = [];
        let allCurrencies = [];
        let allProducts = [];
        
        let cart = JSON.parse(localStorage.getItem('cart')) || {};

        // YENİ EKLENDİ: Siparişlerim sayfası elementleri ve değişkenleri (sadece bu dosyada kullanılanlar)
        const myOrdersLink = document.getElementById('my-orders-link');
        const mobileMyOrdersLink = document.getElementById('mobile-my-orders-link');
        let userOrders = []; // Kullanıcının siparişlerini tutacak dizi
        // YENİ EKLENDİ SONU

        // Statik Çeviriler (yukarıda zaten tanımlı)
        const staticTranslations = { /* ... */ };

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            const anonymousUser = await signInAnonymously(auth);
                            userId = anonymousUser.user.uid;
                        } catch (error) {
                            console.error("Anonim oturum açma hatası:", error);
                        }
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Hazır. Kullanıcı ID:", userId);
                    await fetchInitialData();
                    updateUIBasedOnSettings();
                    renderCart();
                    // YENİ: Routing handleRouting içinde yapılacak
                    // handleRouting();
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Özel token ile oturum açıldı.");
                } else {
                    console.log("Özel token bulunamadı, anonim oturum bekleniyor.");
                }

            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                if (loadingTextP) loadingTextP.textContent = "Hata: Firebase başlatılamadı!";
            }
        }

        async function fetchInitialData() {
            while (!isAuthReady) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!db) {
                console.warn("Firestore veya Auth hazır değil, ürünler çekilemiyor.");
                currentLang = localStorage.getItem('pufemo-language') || 'en';
                if (loadingTextP) loadingTextP.textContent = staticTranslations['product_loading_error'][currentLang];
                return;
            }
            try {
                const [settingsDoc, categoriesDoc, productsSnapshot] = await Promise.all([
                    getDoc(doc(db, 'pufemo', 'settings')),
                    getDoc(doc(db, 'pufemo', 'categories')),
                    getDocs(collection(db, `pufemo-products`)) // Ürünleri burada da çekiyoruz
                ]);

                if (settingsDoc.exists()) {
                    siteData.settings = settingsDoc.data();
                } else {
                    console.log('Settings belgesi mevcut değil!');
                }
                if (categoriesDoc.exists()) {
                    siteData.categories = categoriesDoc.data();
                } else {
                    console.log('Kategoriler belgesi mevcut değil!');
                }
                
                allLanguages = siteData.settings.languages || [];
                allCurrencies = Object.keys(siteData.settings.currencySymbols || {}).map(code => ({
                    code: code,
                    name: code,
                    symbol: siteData.settings.currencySymbols[code]
                }));
                allCountries = Object.entries(siteData.settings.countryPricing || {}).map(([code, data]) => ({
                    id: code,
                    ...data
                }));

                const availableCountries = Object.keys(siteData.settings.countryPricing);
                const storedCountry = localStorage.getItem('pufemo-country');
                
                if (!storedCountry || !availableCountries.includes(storedCountry)) {
                    if (availableCountries.length > 0) {
                        currentCountryCode = availableCountries[0];
                    } else {
                        currentCountryCode = 'US';
                    }
                    localStorage.setItem('pufemo-country', currentCountryCode);
                } else {
                    currentCountryCode = storedCountry;
                }

                const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                if (selectedCountryData) {
                    currentLang = selectedCountryData.defaultLanguage || 'en';
                    const currencySymbol = selectedCountryData.currencySymbol || '$';
                    currentCurrency = Object.keys(siteData.settings.currencySymbols || {}).find(key => siteData.settings.currencySymbols[key] === currencySymbol) || 'USD';
                } else {
                    currentLang = 'en';
                    currentCurrency = 'USD';
                }
                localStorage.setItem('pufemo-language', currentLang);
                localStorage.setItem('pufemo-currency', currentCurrency);

                allProducts = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allProducts = allProducts.filter(p => p.isInShowcase);


            } catch (error) {
                console.error("Başlangıç verilerini çekme hatası:", error);
                currentLang = localStorage.getItem('pufemo-language') || 'en';
                if (loadingTextP) loadingTextP.textContent = staticTranslations['product_loading_error'][currentLang];
            }
        }

        function countryCodeToEmoji(code) {
            if (!code || code.length !== 2) {
                return '';
            }
            return code.toUpperCase().split('').map(char =>
                String.fromCodePoint(char.charCodeAt(0) + 127397)
            ).join('');
        }

        function showCountryModal() {
            welcomeCountrySelect.innerHTML = '';
            allCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.id;
                option.textContent = `${countryCodeToEmoji(country.flag)} ${country[`name_${currentLang}`] || country.name_en || country.name_tr || country.id.toUpperCase()}`;
                welcomeCountrySelect.appendChild(option);
            });
            welcomeCountrySelect.value = currentCountryCode;
            welcomeModalOverlay.classList.add('active');
        }

        window.applyCountryAndRender = (countryCode) => {
            currentCountryCode = countryCode;
            localStorage.setItem('pufemo-country', currentCountryCode);

            const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
            if (selectedCountryData) {
                currentLang = selectedCountryData.defaultLanguage || 'en';
                const currencySymbol = selectedCountryData.currencySymbol || '$';
                currentCurrency = Object.keys(siteData.settings.currencySymbols || {}).find(key => siteData.settings.currencySymbols[key] === currencySymbol) || 'USD';
            } else {
                currentLang = 'en';
                currentCurrency = 'USD';
            }
            localStorage.setItem('pufemo-language', currentLang);
            localStorage.setItem('pufemo-currency', currentCurrency);
            
            updateUIBasedOnSettings();
            renderAll();
            welcomeModalOverlay.classList.remove('active');
        };

        function updateUIBasedOnSettings() {
            setupControls();
            renderStaticText();
        }

        function populateDropdowns() {
            const languageSelector = document.getElementById('language-selector');
            const currencySelector = document.getElementById('currency-selector');
            const countrySelector = document.getElementById('country-selector');

            if (languageSelector) {
                languageSelector.innerHTML = allLanguages.map(l => 
                    `<option value="${l.code}" ${l.code === currentLang ? 'selected' : ''}>${countryCodeToEmoji(l.flag)} ${l.name}</option>`
                ).join('');
            }

            if (currencySelector) {
                currencySelector.innerHTML = allCurrencies.map(c => 
                    `<option value="${c.code}" ${c.code === currentCurrency ? 'selected' : ''}>${c.symbol} ${c.code}</option>`
                ).join('');
            }

            if (countrySelector) {
                const countryOptionsHtml = allCountries.map(c => 
                    `<option value="${c.id}" ${c.id === currentCountryCode ? 'selected' : ''}>${countryCodeToEmoji(c.flag)} ${c[`name_${currentLang}`] || c.name_en || c.id.toUpperCase()}</option>`
                ).join('');
                countrySelector.innerHTML = countryOptionsHtml;
                countrySelector.onchange = (e) => window.applyCountryAndRender(e.target.value);
            }
            
            if (welcomeCountrySelect) {
                const countryOptionsHtml = allCountries.map(c => 
                    `<option value="${c.id}" ${c.id === currentCountryCode ? 'selected' : ''}>${countryCodeToEmoji(c.flag)} ${c[`name_${currentLang}`] || c.name_en || c.id.toUpperCase()}</option>`
                ).join('');
                welcomeCountrySelect.innerHTML = countryOptionsHtml;
            }
        }

        function selectLanguage(langCode) {
            currentLang = langCode;
            localStorage.setItem('pufemo-language', currentLang);
            renderAll();
        }

        function selectCurrency(currencyCode) {
            currentCurrency = currencyCode;
            localStorage.setItem('pufemo-currency', currentCurrency);
            renderAll();
        }

        async function fetchProductsAndRenderGrid() {
            if (!db || !isAuthReady) {
                console.warn("Firestore veya Auth hazır değil, ürünler çekilemiyor.");
                return;
            }

            if (productGrid) {
                productGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Ürünler yükleniyor...</p>';
                noProductsMessage.classList.add('hidden');
            }

            try {
                renderProducts();
            } catch (error) {
                console.error("Ürünleri çekerken hata oluştu:", error);
                if (productGrid) productGrid.innerHTML = `<p class="col-span-full text-center text-red-500">${getStaticText('product_loading_error')}</p>`;
            }
        }

        function renderProducts() {
            if (!productGrid) return;
            productGrid.innerHTML = '';
            if (allProducts.length === 0) {
                noProductsMessage.classList.remove('hidden');
                return;
            }
            noProductsMessage.classList.add('hidden');

            allProducts.forEach(product => {
                let displayPrice = product.basePriceTL || 0;
                let displayDiscountedPrice = product.baseDiscountedPriceTL;
                let displayCurrencySymbol = siteData.settings.currencySymbols[currentCurrency] || currentCurrency;

                if (product.countryPricing && product.countryPricing[currentCountryCode]) {
                    const countryPriceData = product.countryPricing[currentCountryCode];
                    if (countryPriceData.price !== undefined) {
                        displayPrice = countryPriceData.price;
                    }
                    if (countryPriceData.discountedPrice !== undefined) {
                        displayDiscountedPrice = countryPriceData.discountedPrice;
                    }
                }

                const countryAdjustment = siteData.settings.countryPricing[currentCountryCode]?.adjustment;
                if (typeof countryAdjustment === 'number') {
                    const adjustmentFactor = (1 + countryAdjustment / 100);
                    displayPrice = displayPrice * adjustmentFactor;
                    if (displayDiscountedPrice !== undefined && displayDiscountedPrice !== null) {
                        displayDiscountedPrice = displayDiscountedPrice * adjustmentFactor;
                    }
                }

                const exchangeRate = siteData.settings.exchangeRates?.[currentCurrency] || 1;
                displayPrice = displayPrice * exchangeRate;
                if (displayDiscountedPrice !== undefined && displayDiscountedPrice !== null) {
                    displayDiscountedPrice = displayDiscountedPrice * exchangeRate;
                }

                const productName = product.content?.[currentLang]?.name || product.content?.tr?.name || getStaticText('untitled_product');

                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                const firstImage = product.variants?.[0]?.media?.[0]?.url || `https://placehold.co/400x300/ccc/fff?text=${getStaticText('no_image')}`;

                let priceHTML = '';
                if (displayDiscountedPrice !== null && typeof displayDiscountedPrice === 'number' && displayDiscountedPrice < displayPrice) {
                    priceHTML = `
                        <div class="price-container">
                            <span class="original-price">${formatPrice(displayPrice, null, displayCurrencySymbol)}</span>
                            <span class="discounted-price">${formatPrice(displayDiscountedPrice, null, displayCurrencySymbol)}</span>
                        </div>`;
                } else {
                    priceHTML = `<div class="price-container"><span class="discounted-price">${formatPrice(displayPrice, null, displayCurrencySymbol)}</span></div>`;
                }

                const freeShippingTag = product.isFreeShipping
                    ? `<div class="free-shipping-tag">${getStaticText('free_shipping_text')}</div>`
                    : '';

                productCard.innerHTML = `
                    <a href="product-detail.html?id=${product.id}" data-product-id="${product.id}" class="product-image-link product-link">
                        <img src="${firstImage}" alt="${productName}" class="product-image">
                    </a>
                    <div class="product-info">
                        <div class="product-info-top">
                            <h3 class="product-name"><a href="product-detail.html?id=${product.id}" data-product-id="${product.id}" class="product-link">${productName}</a></h3>
                        </div>
                        ${priceHTML}
                        <button data-product-id="${product.id}" class="btn btn-primary add-to-cart-btn" style="width: 100%; margin-top: 1rem;">
                            <i class="fa-solid fa-cart-plus"></i> ${getStaticText('add_to_cart')}
                        </button>
                    </div>
                    ${freeShippingTag}`;
                productGrid.appendChild(productCard);
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.onclick = (event) => {
                    const productId = event.currentTarget.dataset.productId;
                    addToCart(productId);
                };
            });
            // Product links will now directly link to product-detail.html
        }

        function formatPrice(value, customCurrencySymbol = null) {
            const symbols = siteData.settings?.currencySymbols || {};
            const symbol = customCurrencySymbol || symbols[currentCurrency] || currentCurrency;

            const numberFormatOptions = currentCurrency === 'TRY'
                ? { maximumFractionDigits: 0 }
                : { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            
            const numericValue = typeof value === 'number' ? value : 0;

            const formattedPrice = new Intl.NumberFormat(currentLang, numberFormatOptions).format(numericValue);
            
            return `${symbol} ${formattedPrice}`;
        }

        function addToCart(productId, quantity = 1, selectedVariant = null) {
            let productToAdd = allProducts.find(p => p.id === productId);
            if (!productToAdd) return;

            let itemPrice = productToAdd.basePriceTL || 0;
            let itemDiscountedPrice = productToAdd.baseDiscountedPriceTL;
            let itemImage = productToAdd.variants?.[0]?.media?.[0]?.url || `https://placehold.co/80x80/cccccc/333333?text=${getStaticText('no_image')}`;
            let itemName = productToAdd.content?.[currentLang]?.name || productToAdd.content?.tr?.name || getStaticText('untitled_product');

            if (selectedVariant) {
                itemPrice = selectedVariant.basePriceTL !== undefined ? selectedVariant.basePriceTL : productToAdd.basePriceTL;
                itemDiscountedPrice = selectedVariant.baseDiscountedPriceTL !== undefined ? selectedVariant.baseDiscountedPriceTL : productToAdd.baseDiscountedPriceTL;
                itemImage = selectedVariant.media?.[0]?.url || itemImage;
                itemName = itemName + ` (${selectedVariant.colorName?.[currentLang] || selectedVariant.colorName?.tr || getStaticText('unknown_color')})`;
            }

            let itemCurrencyCode = currentCurrency;
            let itemCurrencySymbol = siteData.settings.currencySymbols[currentCurrency] || currentCurrency;

            if (productToAdd.countryPricing && productToAdd.countryPricing[currentCountryCode]) {
                const countryPriceData = productToAdd.countryPricing[currentCountryCode];
                if (countryPriceData.price !== undefined) itemPrice = countryPriceData.price;
                if (countryPriceData.discountedPrice !== undefined) itemDiscountedPrice = countryPriceData.discountedPrice;
                itemCurrencySymbol = countryPriceData.currencySymbol || itemCurrencySymbol;
                itemCurrencyCode = Object.keys(siteData.settings.currencySymbols).find(key => siteData.settings.currencySymbols[key] === itemCurrencySymbol) || itemCurrencyCode;
            }

            const countryAdjustment = siteData.settings.countryPricing[currentCountryCode]?.adjustment;
            if (typeof countryAdjustment === 'number') {
                const adjustmentFactor = (1 + countryAdjustment / 100);
                itemPrice = itemPrice * adjustmentFactor;
                if (itemDiscountedPrice !== undefined && itemDiscountedPrice !== null) {
                    itemDiscountedPrice = itemDiscountedPrice * adjustmentFactor;
                }
            }

            const exchangeRate = siteData.settings.exchangeRates?.[itemCurrencyCode] || 1;
            itemPrice = itemPrice * exchangeRate;
            if (itemDiscountedPrice !== undefined && itemDiscountedPrice !== null) {
                itemDiscountedPrice = itemDiscountedPrice * exchangeRate;
            }

            const finalPrice = (itemDiscountedPrice !== undefined && itemDiscountedPrice !== null && itemDiscountedPrice < itemPrice) ? itemDiscountedPrice : itemPrice;

            const cartItemId = selectedVariant ? `${productId}-${selectedVariant.id || selectedVariant.colorName?.tr || 'no-variant'}` : productId;

            if (cart[cartItemId]) {
                cart[cartItemId].quantity += quantity;
            } else {
                cart[cartItemId] = {
                    id: productId,
                    variantId: selectedVariant ? (selectedVariant.id || selectedVariant.colorName?.tr || 'no-variant') : undefined,
                    name: itemName,
                    image: itemImage,
                    price: finalPrice,
                    currency: itemCurrencyCode,
                    currencySymbol: itemCurrencySymbol,
                    quantity: quantity
                };
            }
            saveCart();
            renderCart();
            console.log("Sepete eklendi:", cart);
            openCartSidebar();
        }

        function updateCartQuantity(cartItemId, change) {
            if (cart[cartItemId]) {
                cart[cartItemId].quantity += change;
                if (cart[cartItemId].quantity <= 0) {
                    delete cart[cartItemId];
                }
                saveCart();
                renderCart();
            }
        }

        function removeFromCart(cartItemId) {
            if (cart[cartItemId]) {
                delete cart[cartItemId];
                saveCart();
                renderCart();
            }
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let total = 0;
            let itemCount = 0;

            if (Object.keys(cart).length === 0) {
                emptyCartMessage.classList.remove('hidden');
                checkoutBtn.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                checkoutBtn.disabled = false;
                for (const cartItemId in cart) {
                    const item = cart[cartItemId];
                    itemCount += item.quantity;
                    total += item.price * item.quantity;

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';
                    cartItemDiv.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h4>${item.name}</h4>
                            <p>${item.currencySymbol} ${item.price.toFixed(2)}</p>
                            <div class="cart-item-quantity-control">
                                <button data-cart-item-id="${cartItemId}" data-action="decrease" class="cart-quantity-button">-</button>
                                <span class="cart-quantity-text">${item.quantity}</span>
                                <button data-cart-item-id="${cartItemId}" data-action="increase" class="cart-quantity-button">+</button>
                            </div>
                        </div>
                        <button data-cart-item-id="${cartItemId}" data-action="remove" class="cart-item-remove-btn">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                }
            }

            cartTotalSpan.textContent = formatPrice(total, siteData.settings.currencySymbols[currentCurrency] || currentCurrency);
            cartItemCountSpan.textContent = itemCount;
            if (cartTotalText) cartTotalText.textContent = getStaticText('total');

            cartItemsContainer.querySelectorAll('button[data-action]').forEach(button => {
                button.onclick = (event) => {
                    const cartItemId = event.currentTarget.dataset.cartItemId;
                    const action = event.currentTarget.dataset.action;
                    if (action === 'increase') {
                        updateCartQuantity(cartItemId, 1);
                    } else if (action === 'decrease') {
                        updateCartQuantity(cartItemId, -1);
                    } else if (action === 'remove') {
                        removeFromCart(cartItemId);
                    }
                };
            });
        }

        function openCartSidebar() {
            cartSidebar.classList.add('open');
        }

        function closeCartSidebar() {
            cartSidebar.classList.remove('open');
        }

        function getStaticText(key) {
            return staticTranslations[key]?.[currentLang] || staticTranslations[key]?.['en'] || key;
        }

        function renderStaticText() {
            document.documentElement.lang = currentLang;

            if (welcomeModalTitle) welcomeModalTitle.textContent = getStaticText('welcome_modal_title');
            if (welcomeModalMessage) welcomeModalMessage.textContent = getStaticText('welcome_modal_message');
            if (welcomeModalConfirmButton) welcomeModalConfirmButton.textContent = getStaticText('welcome_modal_confirm_button');

            if (document.getElementById('cart-sidebar-title')) document.getElementById('cart-sidebar-title').textContent = getStaticText('your_cart');
            if (document.getElementById('cartTotalText')) document.getElementById('cartTotalText').textContent = getStaticText('total');
            if (document.getElementById('checkoutBtn')) document.getElementById('checkoutBtn').textContent = getStaticText('checkout');
            if (document.getElementById('emptyCartMessage')) document.getElementById('emptyCartMessage').textContent = getStaticText('empty_cart_message');

            const promoTextContent = document.getElementById('promo-text-content');
            if (promoTextContent) promoTextContent.textContent = getStaticText('free_shipping_promo');
            
            const mainSectionTitle = document.getElementById('main-section-title');
            if (mainSectionTitle) mainSectionTitle.textContent = getStaticText('main_section_title');

            const footerTitlePufemo = document.getElementById('footer-title-pufemo');
            if (footerTitlePufemo) footerTitlePufemo.textContent = getStaticText('footer-title-pufemo');
            const footerDescPufemo = document.getElementById('footer-desc-pufemo');
            if (footerDescPufemo) footerDescPufemo.textContent = getStaticText('footer-desc-pufemo');
            const footerTitleFastLinks = document.getElementById('footer-title-fast-links');
            if (footerTitleFastLinks) footerTitleFastLinks.textContent = getStaticText('footer-title-fast-links');
            const footerLinkAbout = document.getElementById('footer-link-about');
            if (footerLinkAbout) footerLinkAbout.textContent = getStaticText('footer-link-about');
            const footerLinkContact = document.getElementById('footer-link-contact');
            if (footerLinkContact) footerLinkContact.textContent = getStaticText('footer-link-contact');
            const footerLinkPrivacy = document.getElementById('footer-link-privacy');
            if (footerLinkPrivacy) footerLinkPrivacy.textContent = getStaticText('footer-link-privacy');
            const footerTitleFollowUs = document.getElementById('footer-title-follow-us');
            if (footerTitleFollowUs) footerTitleFollowUs.textContent = getStaticText('footer-title-follow-us');
            const footerCopyright = document.getElementById('footer-copyright');
            if (footerCopyright) footerCopyright.innerHTML = getStaticText('footer-copyright');
            const countrySelectorLabel = document.getElementById('country-selector-label');
            if (countrySelectorLabel) countrySelectorLabel.textContent = getStaticText('country_selector_label');

            if (cartPageLinkEl) cartPageLinkEl.title = getStaticText('cart_page_link_title');
            if (myOrdersLink) myOrdersLink.title = getStaticText('my_orders_title');
            if (myOrdersTitle) myOrdersTitle.textContent = getStaticText('my_orders_title');
            if (noProductsMessage) noProductsMessage.textContent = getStaticText('no_orders_message'); // Bu aslında product grid için, düzeltilebilir.
            
            // Product Detail Page (bu dosya Product Detail içermediği için bu kısımlar yorumda kalmalı veya kaldırılmalı)
            // if (btnCartEl) btnCartEl.innerHTML = `<i class="fa-solid fa-cart-plus"></i> ${getStaticText('add_to_cart_button')}`;
            // if (btnBuyEl) btnBuyEl.textContent = getStaticText('buy_now_button');
            // if (productDetailsHeadingEl) productDetailsHeadingEl.textContent = getStaticText('product_details_heading');
            // if (variantTitleEl) variantTitleEl.textContent = getStaticText('variant_selection_label');
            // if (quantityLabelEl) quantityLabelEl.textContent = getStaticText('quantity_label');
            // if (totalPriceLabelEl) totalPriceLabelEl.textContent = getStaticText('total_price_label');
            // if (relatedVariantsTitleEl) relatedVariantsTitleEl.textContent = getStaticText('related_products_title');
            // if (freeShippingEl) freeShippingEl.textContent = getStaticText('free_shipping_tag');

            // Checkout Page (bu dosya Checkout içermediği için bu kısımlar yorumda kalmalı veya kaldırılmalı)
            // if (checkoutHeading) checkoutHeading.textContent = getStaticText('checkout_heading');
            // if (labelFullname) labelFullname.textContent = getStaticText('label-fullname');
            // if (labelEmail) labelEmail.textContent = getStaticText('label-email');
            // if (labelPhone) labelPhone.textContent = getStaticText('label-phone');
            // if (labelAddress) labelAddress.textContent = getStaticText('label-address');
            // if (labelCountry) labelCountry.textContent = getStaticText('label-country');
            // if (labelZipcode) labelZipcode.textContent = getStaticText('label-zipcode');
            // if (checkoutSummaryHeading) checkoutSummaryHeading.textContent = getStaticText('checkout-summary-heading');
            // if (checkoutSummaryTotalLabel) checkoutSummaryTotalLabel.textContent = getStaticText('checkout-summary-total-label');
            // if (paymentMethodHeading) paymentMethodHeading.textContent = getStaticText('payment-method-heading');
            // if (paymentMethodIbanInfo) paymentMethodIbanInfo.textContent = getStaticText('payment-method-iban-info');
            // if (placeOrderBtn) placeOrderBtn.textContent = getStaticText('place-order-btn');

            // Order Success Page (bu dosya Order Success içermediği için bu kısımlar yorumda kalmalı veya kaldırılmalı)
            // if (orderSuccessTitle) orderSuccessTitle.textContent = getStaticText('order-success-title');
            // if (orderSuccessMessage) orderSuccessMessage.textContent = getStaticText('order-success-message');
            // if (continueShoppingBtn) continueShoppingBtn.textContent = getStaticText('continue-shopping-btn');

            // YENİ EKLENDİ: Siparişlerim sayfası metinleri
            if (document.getElementById('my-orders-title')) document.getElementById('my-orders-title').textContent = getStaticText('my_orders_title');
            if (document.getElementById('no-user-orders-message')) document.getElementById('no-user-orders-message').textContent = getStaticText('no_orders_message');
            if (document.getElementById('modal-continue-shopping')) document.getElementById('modal-continue-shopping').textContent = getStaticText('continue_shopping_btn');
            // YENİ EKLENDİ SONU
        }

        const renderGeneralSiteElements = () => {
            const generalSettings = siteData.settings.general || {};
            const logoLink = document.getElementById('main-logo-link');

            if (logoLink) {
                logoLink.innerHTML = '';
                if (generalSettings.logo?.type === 'image' && generalSettings.logo.imageUrl) {
                    const img = document.createElement('img');
                    img.src = generalSettings.logo.imageUrl;
                    img.alt = generalSettings.logo.text || 'PUFEMO Logo';
                    if (generalSettings.logo.imageWidth) img.style.width = `${generalSettings.logo.imageWidth}px`;
                    if (generalSettings.logo.imageHeight) img.style.height = `${generalSettings.logo.imageHeight}px`;
                    logoLink.appendChild(img);
                } else {
                    const icon = document.createElement('i');
                    icon.className = generalSettings.logo?.icon || 'fa-solid fa-couch';
                    icon.style.color = generalSettings.logo?.iconColor || 'var(--secondary-color)';
                    logoLink.appendChild(icon);
                    const textNode = document.createTextNode(generalSettings.logo?.text ? ` ${generalSettings.logo.text}` : ' PUFEMO');
                    logoLink.appendChild(textNode);
                    logoLink.style.color = generalSettings.logo?.textColor || 'var(--primary-color)';
                }
            }

            const promoBar = document.querySelector('.promo-bar');
            const promoTextContent = document.getElementById('promo-text-content');
            if (promoBar && promoTextContent) {
                promoBar.style.backgroundColor = generalSettings.promoBar?.bgColor || 'var(--secondary-color)';
                promoBar.style.color = generalSettings.promoBar?.textColor || 'var(--light-text-color)';
                promoBar.style.fontSize = generalSettings.promoBar?.fontSize || '0.95rem';

                const scrollSpeed = generalSettings.promoBar?.scrollSpeed || '20s';
                promoTextContent.style.animationDuration = scrollSpeed;

                const promoText = generalSettings.promoBar?.text?.[currentLang] || staticTranslations['free_shipping_promo'][currentLang] || staticTranslations['free_shipping_promo']['tr'];
                promoTextContent.textContent = promoText;
                promoBar.style.display = generalSettings.promoBar?.enabled ? 'block' : 'none';
            }
        };

        const renderCategories = () => {
            const desktopContainer = document.getElementById('category-menu-container');
            const mobileContainer = document.getElementById('mobile-nav');
            const categories = siteData.categories?.tree || [];

            if (desktopContainer) desktopContainer.innerHTML = '';
            
            if (categories.length === 0) return;

            const createMenu = (categoryArray) => {
                const ul = document.createElement('ul');
                categoryArray.forEach(cat => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#">${cat.name[currentLang] || cat.name.tr}</a>`;
                    if (cat.children && cat.children.length > 0) li.appendChild(createMenu(cat.children));
                    ul.appendChild(li);
                });
                return ul;
            };

            categories.forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#">${cat.name[currentLang] || cat.name.tr}</a>`;
                if (desktopContainer) desktopContainer.appendChild(li);
            });

            // Mobil menüye dinamik kategorileri ekle (existing items are kept)
            if (mobileContainer) {
                const existingUl = mobileContainer.querySelector('ul');
                if (existingUl) {
                    // Mevcut statik linkleri tutarak dinamik kategorileri ekle
                    const dynamicCategoriesUl = createMenu(categories);
                    Array.from(dynamicCategoriesUl.children).forEach(child => existingUl.appendChild(child));
                } else {
                    mobileContainer.appendChild(createMenu(categories));
                }
            }
        };

        const renderBanner = () => {
            const bannerContainer = document.getElementById('hero-banner-container');
            const slides = siteData.settings?.banner?.slides || []; 

            if (!bannerContainer) return;

            bannerContainer.innerHTML = '';
            if (slides.length === 0) {
                bannerContainer.style.display = 'none';
                return;
            }
            bannerContainer.style.display = 'block';

            slides.forEach((slideData, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = 'slide' + (index === 0 ? ' active' : '');
                
                const content = slideData.content?.[currentLang] || slideData.content?.tr || {};
                const defaultButtonText = staticTranslations['default_button_text']?.[currentLang] || staticTranslations['default_button_text']?.['tr'];
                const buttonText = content.button_text || defaultButtonText;
                
                const slideStyle = slideData.style || {};

                if(slideData.image_url?.includes('.mp4')) {
                    slideEl.innerHTML = `<video src="${slideData.image_url}" autoplay muted loop playsinline></video>`;
                } else {
                    slideEl.innerHTML = `<div class="slide-bg-image" style="background-image: url('${slideData.image_url || ''}')"></div>`;
                }
                
                const titleStyle = `${slideStyle.title_color ? `color: ${slideStyle.title_color};` : ''} ${slideStyle.title_font_size ? `font-size: ${slideStyle.title_font_size};` : ''}`;
                const subtitleStyle = `${slideStyle.subtitle_color ? `color: ${slideStyle.subtitle_color};` : ''} ${slideStyle.subtitle_font_size ? `font-size: ${slideStyle.subtitle_font_size};` : ''}`;
                const buttonInlineStyle = `${slideStyle.button_bg_color ? `background-color: ${slideStyle.button_bg_color};` : ''} ${slideStyle.button_text_color ? `color: ${slideData.style.button_text_color};` : ''} ${slideStyle.button_border_radius ? `border-radius: ${slideStyle.button_border_radius};` : ''} ${slideData.style.button_padding ? `padding: ${slideData.style.button_padding};` : ''}`;

                slideEl.innerHTML += `
                    <div class="slide-content">
                        <h2 style="${titleStyle}">${content.title || ''}</h2>
                        <p style="${subtitleStyle}">${content.subtitle || ''}</p>
                        <a href="${slideData.link_url || '#'}" class="btn-shop" style="${buttonInlineStyle}">${buttonText}</a>
                    </div>`;
                bannerContainer.appendChild(slideEl);
            });

            const slideNav = document.createElement('div');
            slideNav.className = 'slide-nav';
            bannerContainer.appendChild(slideNav);

            startSlider();
        };
        
        const startSlider = () => {
            const slides = document.querySelectorAll('.slide');
            const navContainer = document.querySelector('.slide-nav');
            if (!navContainer) return;
            navContainer.innerHTML = '';
            if (slides.length <= 1) return;

            slides.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'nav-dot' + (index === 0 ? ' active' : '');
                dot.dataset.index = index;
                navContainer.appendChild(dot);
            });

            const dots = navContainer.querySelectorAll('.nav-dot');
            let currentSlide = 0;
            let slideInterval = setInterval(nextSlide, 5000);
            function setSlide(index) { slides.forEach((s, i) => s.classList.toggle('active', i === index)); dots.forEach((d, i) => d.classList.toggle('active', i === index)); currentSlide = index; }
            function nextSlide() { setSlide((currentSlide + 1) % slides.length); }
            dots.forEach(dot => dot.addEventListener('click', () => { setSlide(parseInt(dot.dataset.index)); clearInterval(slideInterval); slideInterval = setInterval(nextSlide, 5000); }));
        };

        const setupControls = () => {
            const languageSelector = document.getElementById('language-selector');
            const currencySelector = document.getElementById('currency-selector');
            const countrySelector = document.getElementById('country-selector');
            const hamburgerBtn = document.getElementById('hamburger-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const mobileNavOverlay = document.getElementById('mobile-nav-overlay');

            if (languageSelector) {
                languageSelector.innerHTML = allLanguages.map(l => `<option value="${l.code}" ${l.code === currentLang ? 'selected' : ''}>${countryCodeToEmoji(l.flag)} ${l.name}</option>`).join('');
                languageSelector.onchange = (e) => selectLanguage(e.target.value);
            }

            if (currencySelector) {
                currencySelector.innerHTML = allCurrencies.map(c => `<option value="${c.code}" ${c.code === currentCurrency ? 'selected' : ''}>${c.symbol} ${c.code}</option>`).join('');
                currencySelector.onchange = (e) => selectCurrency(e.target.value);
            }

            if (countrySelector) {
                const countryOptionsHtml = allCountries.map(c => 
                    `<option value="${c.id}" ${c.id === currentCountryCode ? 'selected' : ''}>${countryCodeToEmoji(c.flag)} ${c[`name_${currentLang}`] || c.name_en || c.id.toUpperCase()}</option>`
                ).join('');
                countrySelector.innerHTML = countryOptionsHtml;
                countrySelector.onchange = (e) => window.applyCountryAndRender(e.target.value);
            }

            if (welcomeCountrySelect) {
                const countryOptionsHtml = allCountries.map(c => 
                    `<option value="${c.id}" ${c.id === currentCountryCode ? 'selected' : ''}>${countryCodeToEmoji(c.flag)} ${c[`name_${currentLang}`] || c.name_en || c.id.toUpperCase()}</option>`
                ).join('');
                welcomeCountrySelect.innerHTML = countryOptionsHtml;
            }

            if (hamburgerBtn && mobileNav && mobileNavOverlay) {
                const toggleMenu = () => {
                    hamburgerBtn.classList.toggle('open');
                    mobileNav.classList.toggle('open');
                    mobileNavOverlay.classList.toggle('open');
                    document.body.classList.toggle('mobile-menu-open');
                };
                hamburgerBtn.onclick = toggleMenu;
                mobileNavOverlay.onclick = toggleMenu;
                // Mobil menüdeki linklere tıklandığında menüyü kapatma
                // Not: Kategori menüsü renderCategories tarafından dinamik olarak eklendiği için
                // bu event listener'ın renderCategories çağrısından sonra çalışması veya
                // event delegation kullanması daha uygun olur. Şimdilik doğrudan linklere ekliyoruz.
                mobileNav.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        toggleMenu(); // Menüyü kapat
                    });
                });
            }
        };

        const renderAll = () => {
            renderStaticText();
            renderGeneralSiteElements();
            renderCategories();
            renderBanner();
            fetchProductsAndRenderGrid();
            
            const availableCountries = Object.keys(siteData.settings.countryPricing);
            const storedCountry = localStorage.getItem('pufemo-country');
            
            if (availableCountries.length > 0 && (!storedCountry || !availableCountries.includes(storedCountry))) {
                showCountryModal();
            } else {
                welcomeModalOverlay.classList.remove('active');
            }
            renderCart();
            setupControls();
        };

        // YENİ EKLENDİ: Kullanıcının siparişlerini getirme ve render etme fonksiyonları
        async function fetchUserOrders() {
            if (!db || !isAuthReady || !userId) {
                console.warn("Firestore, Auth veya Kullanıcı ID'si hazır değil, siparişler çekilemiyor.");
                userOrdersContainer.innerHTML = `<p id="no-user-orders-message" style="text-align: center; color: #777;">Firebase başlatılıyor veya kimlik doğrulanıyor...</p>`;
                return;
            }
            userOrders = []; // Önceki siparişleri temizle
            userOrdersContainer.innerHTML = `<p id="no-user-orders-message" style="text-align: center; color: #777;">${getStaticText('loading_text')}</p>`;

            try {
                // Sadece mevcut kullanıcının siparişlerini çek
                // orderBy import edildiğinden artık kullanılabilir.
                const ordersQuery = query(collection(db, `pufemo-orders`), where("userId", "==", userId), orderBy("orderDate", "desc"));
                const querySnapshot = await getDocs(ordersQuery);
                userOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserOrders(); // Siparişleri ekrana yansıt
            } catch (error) {
                console.error("Kullanıcı siparişleri çekilirken hata:", error);
                userOrdersContainer.innerHTML = `<p style="text-align: center; color: red;">Siparişleriniz yüklenirken bir hata oluştu.</p>`;
            }
        }

        function renderUserOrders() {
            const userOrdersContainer = document.getElementById('user-orders-container');
            if (!userOrdersContainer) return;

            userOrdersContainer.innerHTML = ''; // İçeriği temizle

            if (userOrders.length === 0) {
                userOrdersContainer.innerHTML = `<p id="no-user-orders-message" style="text-align: center; color: #777;">${getStaticText('no_orders_message')}</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'user-order-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>${getStaticText('order_id_label')}</th>
                        <th>${getStaticText('order_date_label')}</th>
                        <th>${getStaticText('order_total_label')}</th>
                        <th>${getStaticText('order_status_label')}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            userOrders.forEach(order => {
                const row = tbody.insertRow();
                const orderDate = order.orderDate && order.orderDate.toDate ? order.orderDate.toDate().toLocaleString() : 'N/A';
                const totalAmount = formatPrice(order.totalAmount, siteData.settings.currencySymbols[order.currency] || order.currency);
                const orderStatus = order.status || 'unknown';

                row.innerHTML = `
                    <td>${(order.id || 'N/A').substring(0, 8)}...</td>
                    <td>${orderDate}</td>
                    <td>${totalAmount}</td>
                    <td><span class="order-status-badge status-${orderStatus.toLowerCase()}">${orderStatus}</span></td>
                    <td><button class="btn btn-info view-user-order-details" data-order-id="${order.id || ''}">${getStaticText('order_detail_button')}</button></td>
                `;
            });

            userOrdersContainer.appendChild(table);

            // Detay butonlarına event listener ekle
            userOrdersContainer.querySelectorAll('.view-user-order-details').forEach(button => {
                button.addEventListener('click', (e) => {
                    const orderId = e.target.dataset.orderId;
                    const selectedOrder = userOrders.find(o => o.id === orderId);
                    if (selectedOrder) {
                        showUserOrderDetailModal(selectedOrder);
                    }
                });
            });
        }

        function showUserOrderDetailModal(order) {
            const userOrderDetailModal = document.getElementById('userOrderDetailModal');
            const modalOrderId = document.getElementById('modal-order-id');
            const modalOrderDate = document.getElementById('modal-order-date');
            const modalOrderStatus = document.getElementById('modal-order-status');
            const modalOrderTotal = document.getElementById('modal-order-total');
            const modalOrderItems = document.getElementById('modal-order-items');


            if (!userOrderDetailModal) return;

            modalOrderId.textContent = order.id || 'N/A';
            modalOrderDate.textContent = order.orderDate && order.orderDate.toDate ? order.orderDate.toDate().toLocaleString() : 'N/A';
            modalOrderStatus.innerHTML = `<span class="order-status-badge status-${(order.status || 'unknown').toLowerCase()}">${order.status || 'N/A'}</span>`;
            modalOrderTotal.textContent = formatPrice(order.totalAmount, siteData.settings.currencySymbols[order.currency] || order.currency);
            
            modalOrderItems.innerHTML = '';
            (order.items || []).forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.name || 'N/A'}</strong> x ${item.quantity || 1} (${item.currencySymbol || ''} ${(item.price || 0).toFixed(2)})`;
                modalOrderItems.appendChild(li);
            });

            userOrderDetailModal.style.display = 'flex'; // Modalı göster
        }
        // YENİ EKLENDİ SONU: Kullanıcının siparişlerini getirme ve render etme fonksiyonları


        // --- Sayfa Yönlendirme ve Görünürlük Yönetimi ---
        const pageViews = document.querySelectorAll('.page-content'); // Tüm sayfa içeriklerini seç

        /**
         * Belirtilen ID'ye sahip sayfayı gösterir ve diğerlerini gizler.
         * @param {string} pageId - Gösterilecek sayfanın ID'si.
         */
        function showPage(pageId) {
            pageViews.forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Sayfayı en üste kaydır
        }

        /**
         * URL hash'ine veya query parametrelerine göre doğru sayfayı yükler.
         * Her sayfa artık kendi HTML dosyasına yönlendirme yapacak.
         */
        function handleRouting() {
            const hash = window.location.hash;
            // Bu ana index.html dosyası olduğu için, sadece ana sayfa görünümünü yönetir.
            // Diğer hash'ler için tam sayfa yenileme ile ilgili HTML dosyasına yönlendirir.
            if (hash === '' || hash === '#homepage-view') {
                showPage('homepage-view');
            } else if (hash.startsWith('#product-detail-view')) {
                window.location.href = `product-detail.html${hash}`; // Tam URL'ye yönlendir
            } else if (hash === '#checkout-view') {
                window.location.href = `checkout.html${hash}`; // Tam URL'ye yönlendir
            } else if (hash === '#order-success-view') {
                window.location.href = `order-success.html${hash}`; // Tam URL'ye yönlendir
            } else if (hash === '#my-orders-view') {
                window.location.href = `cart-orders.html${hash}`; // Tam URL'ye yönlendir
            } else if (hash === '#cart-view') {
                 window.location.href = `cart-orders.html${hash}`; // Tam URL'ye yönlendir
            }
            // loadingOverlay sadece başlangıç yüklemede gizlenir, sayfa geçişleri tarayıcı tarafından yapılır.
            loadingOverlay.classList.add('hidden');
        }

        // Olay Dinleyicileri
        document.getElementById('cart-page-link').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = `cart-orders.html#cart-view`; // Sepet sayfasına yönlendir
        });
        // closeCartBtn, checkoutBtn gibi sepet sidebar butonları artık cart-orders.html içinde yönetilecek

        welcomeModalConfirmButton.addEventListener('click', function() {
            const selectedCountry = welcomeCountrySelect.value;
            if (selectedCountry) {
                window.applyCountryAndRender(selectedCountry);
            } else {
                alert(getStaticText('welcome_modal_message'));
            }
        });

        // URL hash değiştiğinde yönlendirmeyi tekrar kontrol et
        // Artık sayfa yeniden yükleneceği için bu event listener çoğu zaman tetiklenmeyecek
        // Sadece tek sayfa uygulamalar için bu gereklidir.
        // window.addEventListener('hashchange', handleRouting);

        // Sayfa yüklendiğinde Firebase'i başlat ve yönlendirmeyi yap
        window.onload = () => {
            initializeFirebase();
            // window.location.hash = ''; // Sayfa ilk yüklendiğinde anasayfaya yönlendir
        };

        // YENİ EKLENDİ: Menüdeki Siparişlerim linkine tıklama olayı
        if (myOrdersLink) {
            myOrdersLink.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `cart-orders.html#my-orders-view`;
            });
        }
        if (mobileMyOrdersLink) {
             mobileMyOrdersLink.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `cart-orders.html#my-orders-view`;
            });
        }
        // YENİ EKLENDİ SONU
    </script>
</body>
</html>
