<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Yükleniyor...</title>
    <meta name="description" content="PUFEMO online mağazası. En yeni ürünler ve özel fırsatlar.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-color: #000000; /* Ana vurgu rengi: Siyah */
            --secondary-color: #333333; /* Koyu gri metinler */
            --text-color: #555555; /* Daha açık metinler */
            --light-bg: #F9F9F9; /* Çok açık gri arka plan */
            --dark-bg: #1A1A1A; /* Çok koyu footer arka planı */
            --border-color: #EEEEEE; /* Hafif kenarlık rengi */
            --accent-color: #B8860B; /* Altın rengi vurgu (isteğe bağlı, kullanılabilir) */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF; /* Temiz beyaz arka plan */
            line-height: 1.6;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif; /* Tüm başlıklar için Inter */
            font-weight: 600; /* Daha belirgin başlıklar */
            color: var(--secondary-color);
            line-height: 1.2;
        }

        /* Initial modal */
        .modal-backdrop.show {
            opacity: 0.7; 
            backdrop-filter: blur(10px); /* Daha fazla bulanıklık */
        }
        .modal-content {
            border-radius: 1rem; 
            border: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); /* Daha belirgin ve modern gölge */
        }
        .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        .modal-body {
            padding: 2.5rem; /* Daha fazla boşluk */
        }
        .country-list {
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
        }
        .country-list .list-group-item {
            border: none;
            padding: 1rem 1.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .country-list .list-group-item:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color); /* Hover'da koyu gri */
            border-color: var(--secondary-color);
            transform: translateY(-2px); 
        }
        .btn-secondary {
            background-color: #E0E0E0; /* Açık gri */
            border-color: #E0E0E0;
            color: var(--secondary-color);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #D0D0D0;
            border-color: #D0D0D0;
        }
        .btn-outline-secondary {
            color: var(--secondary-color);
            border-color: var(--border-color);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-outline-secondary:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
        }

        /* Main Content Wrapper */
        .main-content { 
            visibility: hidden; 
            opacity: 0; 
            transition: opacity 1s ease-in-out; /* Daha yavaş ve zarif geçiş */
            flex-grow: 1; 
        }
        .main-content.loaded { 
            visibility: visible; 
            opacity: 1; 
        }

        /* Header */
        #page-header {
            background-color: #FFFFFF; 
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            box-shadow: 0 1px 15px rgba(0,0,0,0.03); /* Çok hafif gölge */
        }
        .navbar-brand {
            font-family: 'Inter', sans-serif;
            font-size: 2.8rem !important; 
            font-weight: 700 !important;
            color: var(--primary-color) !important;
            letter-spacing: -0.05em; /* Hafif daraltılmış harf aralığı */
        }
        .navbar-nav .nav-link {
            color: var(--secondary-color) !important;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            transition: color 0.3s ease, background-color 0.3s ease;
            border-radius: 0.5rem;
        }
        .navbar-nav .nav-link:hover {
            color: var(--primary-color) !important;
            background-color: var(--light-bg);
        }
        .topbar-info {
            background-color: var(--light-bg); /* Üst çubuk için açık gri */
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0;
        }
        .topbar-info .dropdown-toggle {
            color: var(--text-color) !important;
            font-weight: 400;
            font-size: 0.85rem;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .topbar-info .dropdown-toggle:hover {
            color: var(--primary-color) !important;
        }
        .topbar-info .dropdown-menu {
            font-size: 0.85rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        .topbar-info .dropdown-item:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
        }

        /* Hero Carousel */
        #heroCarousel {
            margin-bottom: 5rem; /* Altında daha fazla boşluk */
        }
        #heroCarousel .carousel-item img {
            height: 650px; /* Daha da büyük hero alanı */
            object-fit: cover;
            filter: brightness(0.7); /* Hafif karartma */
        }
        #heroCarousel .carousel-caption {
            background: rgba(0, 0, 0, 0.45); 
            padding: 3rem 4rem;
            border-radius: 1.5rem; /* Daha yuvarlak köşeler */
            max-width: 60%; /* Daha dar caption alanı */
            left: 50%;
            transform: translateX(-50%);
            bottom: 18%; 
            color: #FFFFFF;
            text-align: center;
        }
        #heroCarousel .carousel-caption h5 {
            font-size: 3.5rem; 
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #FFFFFF;
            letter-spacing: -0.04em;
        }
        #heroCarousel .carousel-caption p {
            font-size: 1.3rem;
            line-height: 1.5;
            opacity: 0.9;
        }
        #heroCarousel .carousel-indicators button {
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            width: 12px;
            height: 12px;
            margin: 0 6px;
            transition: all 0.3s ease;
        }
        #heroCarousel .carousel-indicators button.active {
            background-color: var(--primary-color);
            width: 14px;
            height: 14px;
        }

        /* Product Cards */
        .product-card {
            border: 1px solid var(--border-color); /* Hafif kenarlık */
            box-shadow: none; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            overflow: hidden; 
        }
        .product-card:hover {
            transform: translateY(-8px); /* Daha belirgin yukarı kayma */
            box-shadow: 0 15px 35px rgba(0,0,0,0.08); /* Daha belirgin gölge */
        }
        .product-card img { 
            height: 350px; /* Daha büyük ürün görselleri */
            object-fit: cover; 
            border-radius: 0; 
        }
        .product-card .card-body {
            padding: 1.8rem; /* Daha fazla boşluk */
        }
        .product-card .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.6rem;
        }
        .product-card .card-text {
            font-size: 1rem;
            color: var(--text-color);
            line-height: 1.5;
            max-height: 4.5em; 
        }
        .product-card .fs-4 {
            color: var(--primary-color); 
            font-weight: 700;
        }
        .product-card .btn {
            border-radius: 0.5rem;
            padding: 0.7rem 1.4rem;
        }

        /* Footer */
        footer {
            background-color: var(--dark-bg); 
            color: #E0E0E0; 
            padding: 5rem 0; /* Daha fazla padding */
            font-size: 0.95rem;
        }
        footer h5 {
            color: #FFFFFF; 
            margin-bottom: 1.8rem; /* Daha fazla boşluk */
            font-weight: 600;
        }
        footer .list-unstyled li a {
            color: #B0B0B0; 
            text-decoration: none;
            transition: color 0.3s ease;
            margin-bottom: 0.6rem;
            display: block;
        }
        footer .list-unstyled li a:hover {
            color: #FFFFFF; /* Hover'da beyaz */
        }
        footer .text-white-50 {
            color: #B0B0B0 !important;
        }
        footer .dropdown-toggle {
            background-color: #2A2A2A; 
            border-color: #2A2A2A;
            color: #E0E0E0;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            padding: 0.7rem 1.2rem;
        }
        footer .dropdown-toggle:hover {
            background-color: #3A3A3A;
            border-color: #3A3A3A;
        }
        footer .dropdown-menu-dark {
            background-color: #2A2A2A;
            border: none;
            border-radius: 0.5rem;
        }
        footer .dropdown-menu-dark .dropdown-item {
            color: #E0E0E0;
            padding: 0.7rem 1.2rem;
        }
        footer .dropdown-menu-dark .dropdown-item:hover {
            background-color: #3A3A3A;
            color: #FFFFFF;
        }
    </style>
</head>
<body>

    <div class="modal fade" id="userPreferenceModal" tabindex="-1" aria-labelledby="userPreferenceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userPreferenceModalLabel">Tercihlerinizi Belirleyin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="step-country-modal">
                        <h4 class="fw-bold mb-3">Ülke Seçimi</h4>
                        <p class="text-muted mb-4">Lütfen doğru fiyat ve teslimat seçenekleri için ülkenizi seçin.</p>
                        <div class="list-group country-list" id="modal-country-list">
                            <div class="p-3 text-center">Ülkeler yükleniyor...</div>
                        </div>
                    </div>
                    <div id="step-auth-options-modal" style="display:none;">
                        <h4 class="fw-bold mb-3" id="modal-welcome-text">Hoş Geldiniz</h4>
                        <p class="text-muted mb-4" id="modal-selected-country-info"></p>
                        <div class="d-grid gap-3">
                            <button class="btn btn-primary btn-lg" id="modal-guest-btn">Misafir Olarak Devam Et</button>
                            <button class="btn btn-secondary" id="modal-show-login-btn">Giriş Yap</button>
                            <button class="btn btn-outline-secondary btn-sm" id="modal-show-register-btn">Kayıt Ol</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="main-content" id="main-content-wrapper">
        <header id="page-header" class="sticky-top">
            <div class="container-fluid py-2 topbar-info">
                <div class="container d-flex justify-content-end align-items-center">
                    <div class="dropdown me-3">
                        <a class="dropdown-toggle" href="#" role="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-translate me-1"></i> <span id="current-language-name">Türkçe</span>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown" id="language-options">
                            </ul>
                    </div>
                    <div class="dropdown">
                        <a class="dropdown-toggle" href="#" role="button" id="currencyDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-cash-stack me-1"></i> <span id="current-currency-symbol">₺</span> (<span id="current-currency-code">TRY</span>)
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="currencyDropdown" id="currency-options">
                            </ul>
                    </div>
                </div>
            </div>
            <nav class="navbar navbar-expand-lg navbar-light container">
                <a class="navbar-brand" href="#">PUFEMO</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="category-links">
                        </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-person-fill"></i> Hesabım</a></li>
                        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-heart-fill"></i> Favoriler</a></li>
                        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-cart-fill"></i> Sepet</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <main class="flex-grow-1"></main>
        <footer></footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4", authDomain: "pufemo-com.firebaseapp.com", projectId: "pufemo-com", storageBucket: "pufemo-com.firebasestorage.app", messagingSenderId: "983352837227", appId: "1:983352837227:web:defaa8dae215776e2e1d2e", measurementId: "G-RH8XHC7P91" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Varsayılan çeviriler (eğer Firebase'den gelmezse)
        const translations = { 
            'tr': { welcome: 'Hoş Geldiniz', info: 'için devam edin.', guest: 'Misafir Olarak Devam Et', login: 'Giriş Yap', register: 'Kayıt Ol', featuredProducts: 'Öne Çıkan Ürünler', noFeatured: 'Vitrinde gösterilecek ürün bulunmamaktadır.', addToCart: 'Sepete Ekle', contactUs: 'Bize Ulaşın', selectCountry: 'Ülke Seç', changeCountry: 'Ülke Değiştir' }, 
            'en': { welcome: 'Welcome', info: 'Continue for', guest: 'Continue as Guest', login: 'Sign In', register: 'Register', featuredProducts: 'Featured Products', noFeatured: 'No products to display on homepage.', addToCart: 'Add to Cart', contactUs: 'Contact Us', selectCountry: 'Select Country', changeCountry: 'Change Country' }, 
            'de': { welcome: 'Willkommen', info: 'Weiter für', guest: 'Als Gast fortfahren', login: 'Anmelden', register: 'Registrieren', featuredProducts: 'Ausgewählte Produkte', noFeatured: 'Keine Produkte auf der Startseite anzuzeigen.', addToCart: 'In den Warenkorb', contactUs: 'Kontakt', selectCountry: 'Land auswählen', changeCountry: 'Land ändern' }
        };
        
        let allCountries = [];
        let allCurrencies = [];
        let allLanguages = [];

        let currentUserSettings = {
            countryId: null,
            countryName: 'Türkiye', 
            countryCode: 'TR',      
            language: 'tr',         
            currencyCode: 'TRY',    
            currencySymbol: '₺',    
            currencyExchangeRate: 1.0 
        };

        const userPreferenceModalElement = document.getElementById('userPreferenceModal');
        const userPreferenceModal = new bootstrap.Modal(userPreferenceModalElement, {
            backdrop: 'static', // Kullanıcı modalı kapatmadan devam edemez
            keyboard: false // ESC tuşu ile kapatmayı engelle
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // SADECE GELİŞTİRME/TEST İÇİN: Her zaman modalın gelmesi için localStorage'ı temizle
            localStorage.removeItem('pufemo-user-settings'); // BU SATIRI DİKKAT! CANLIYA ALIRKEN SİL!

            await loadGlobalSettings(); // Tüm global ayarları yükle

            const storedSettings = localStorage.getItem('pufemo-user-settings');
            if (storedSettings) {
                try {
                    currentUserSettings = JSON.parse(storedSettings);
                    // Ayarlar varsa direkt başlat
                    initializeApp(currentUserSettings);
                } catch (e) {
                    console.error("Stored settings parse hatası, varsayılan ayarları kullan:", e);
                    // Hatalı JSON varsa temizleyip modalı göster
                    localStorage.removeItem('pufemo-user-settings');
                    showUserPreferenceModal('country');
                }
            } else {
                // Eğer ayar yoksa, modalı göster ve kullanıcı ayarlarını belirlemesini bekle
                showUserPreferenceModal('country'); 
            }
        });

        // Tüm ülke, dil ve para birimi verilerini Firebase'den çeken fonksiyon
        async function loadGlobalSettings() {
            try {
                const [countriesSnap, currenciesSnap, languagesSnap] = await Promise.all([
                    db.collection('countries').orderBy('name').get(),
                    db.collection('currencies').orderBy('code').get(),
                    db.collection('languages').orderBy('name').get()
                ]);
                allCountries = countriesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allCurrencies = currenciesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allLanguages = languagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("Genel ayarlar yüklenirken hata:", error);
                document.body.innerHTML = `<div class="alert alert-danger m-5">Site ayarları yüklenemedi. Lütfen internet bağlantınızı kontrol edin veya yönetim panelinden gerekli ayarları (ülkeler, para birimleri, diller) tanımlayın. Hata: ${error.message}</div>`;
            }
        }

        // Kullanıcı Tercih Modalını Göster (Sadece İlk Giriş için zorunlu)
        // `step` parametresi 'country' veya 'auth' olabilir
        function showUserPreferenceModal(step = 'country') {
            const t = translations[currentUserSettings.language] || translations['en'];
            
            // Modalı her açtığımızda başlığı ülkeye göre güncelleyelim
            document.getElementById('userPreferenceModalLabel').textContent = t.selectCountry;
            
            if (step === 'country') {
                document.getElementById('step-country-modal').style.display = 'block';
                document.getElementById('step-auth-options-modal').style.display = 'none';
                populateCountryListForModal(); // Modal içindeki liste için
            } else if (step === 'auth') {
                document.getElementById('step-country-modal').style.display = 'none';
                document.getElementById('step-auth-options-modal').style.display = 'block';
                document.getElementById('modal-welcome-text').textContent = t.welcome;
                document.getElementById('modal-selected-country-info').textContent = `${currentUserSettings.countryName} ${t.info}`;
                document.getElementById('modal-guest-btn').textContent = t.guest;
                document.getElementById('modal-show-login-btn').textContent = t.login;
                document.getElementById('modal-show-register-btn').textContent = t.register;
            }
            userPreferenceModal.show();
        }

        // Modal içindeki ülke listesini doldur (sadece modal açıldığında çağrılır)
        function populateCountryListForModal() {
            const countryListElement = document.getElementById('modal-country-list');
            countryListElement.innerHTML = ''; // Temizle

            if (allCountries.length === 0) {
                countryListElement.innerHTML = `<div class="p-3 text-center text-danger">Ülkeler yüklenemedi veya yönetim panelinden hiç ülke eklenmemiş.</div>`;
                return;
            }

            allCountries.forEach(country => {
                let flagUrl = 'https://via.placeholder.com/24x18?text=--';
                if (country.code) { flagUrl = `https://flagsapi.com/${country.code.toUpperCase()}/flat/24.png`; }
                const countryElement = document.createElement('a');
                countryElement.href = '#';
                countryElement.className = 'list-group-item list-group-item-action d-flex align-items-center';
                countryElement.innerHTML = `<img src="${flagUrl}" class="me-2" style="width:24px; border:1px solid #ddd;"> ${country.name}`;
                countryElement.onclick = (e) => { e.preventDefault(); selectCountryAndProceedFromModal(country); };
                countryListElement.appendChild(countryElement);
            });
        }

        // Modal'dan ülke seçimi ve ilerleme
        async function selectCountryAndProceedFromModal(country) {
            updateUserSettings(country.id, (country.language || 'en').toLowerCase(), country.currencyCode || 'TRY', false); // false = appInitialize'ı burada çağırma
            showUserPreferenceModal('auth'); // Auth seçeneklerine geç
        }
        
        // Ortak kullanıcı ayarlarını güncelleme fonksiyonu
        // shouldInitializeApp: true ise initializeApp'i çağırır (modal sonrası veya dropdown değişimi), false ise çağırmaz (modal içi adım değişimi)
        function updateUserSettings(selectedCountryId, selectedLanguageCode = currentUserSettings.language, selectedCurrencyCode = currentUserSettings.currencyCode, shouldInitializeApp = true) {
            const country = allCountries.find(c => c.id === selectedCountryId);
            if (!country) {
                console.error("Geçersiz ülke ID'si:", selectedCountryId);
                return;
            }

            currentUserSettings.countryId = country.id;
            currentUserSettings.countryName = country.name;
            currentUserSettings.countryCode = country.code;
            
            currentUserSettings.language = selectedLanguageCode;

            currentUserSettings.currencyCode = selectedCurrencyCode;
            const selectedCurrency = allCurrencies.find(c => c.code === currentUserSettings.currencyCode);
            currentUserSettings.currencySymbol = selectedCurrency ? selectedCurrency.symbol : '₺';
            currentUserSettings.currencyExchangeRate = selectedCurrency ? selectedCurrency.exchangeRate : 1.0;

            localStorage.setItem('pufemo-user-settings', JSON.stringify(currentUserSettings));
            
            if (shouldInitializeApp) {
                initializeApp(currentUserSettings); // Uygulamayı yeni ayarlarla yeniden yükle
            }
        }

        document.getElementById('modal-guest-btn').addEventListener('click', async () => {
            try {
                await auth.signInAnonymously(); 
                userPreferenceModal.hide(); // Modalı kapat
                initializeApp(currentUserSettings); // Uygulamayı başlat
            } catch (error) { 
                console.error("Anonim giriş hatası:", error); 
                alert("Giriş yapılırken bir hata oluştu: " + error.message);
            }
        });

        // Modal kapatıldığında çalışacak event listener
        userPreferenceModalElement.addEventListener('hidden.bs.modal', function () {
            // Eğer modal kapatıldığında hala currentUserSettings.countryId null ise, bu bir sorun demektir.
            // Bu durumda kullanıcı devam etmeden modalı kapatmış ve siteyi yükleyemiyoruz.
            if (!currentUserSettings.countryId) {
                console.warn("Kullanıcı ülke seçmeden veya misafir olarak devam etmeden modalı kapattı. Site yüklenemiyor.");
                document.body.innerHTML = `<div class="alert alert-warning m-5">Lütfen devam etmek için ülkenizi seçin veya misafir olarak devam edin.</div>`;
            }
        });


        async function initializeApp(settings) {
            console.log("1. initializeApp fonksiyonu başladı. Mevcut Ayarlar: ", settings);
            const langCode = settings.language.toLowerCase();
            const t = translations[langCode] || translations['en'];
            document.title = "PUFEMO - " + t.welcome; 

            try {
                console.log("2. try bloğuna girildi. Veri çekme işlemi başlıyor...");
                const [sliderDocs, categoryDocs, productDocs, appSettingsDoc, seoDoc] = await Promise.all([
                    db.collection('homepage_slider').where('isActive', '==', true).orderBy('order').get(),
                    db.collection('categories').get(),
                    db.collection('products').where('showOnHomepage', '==', true).limit(8).get(), 
                    db.collection('settings').doc('siteConfig').get(),
                    db.collection('seo_settings').doc('home').get()
                ]);
                console.log("3. Tüm veriler Firebase'den başarıyla çekildi.");
                
                const appSettings = appSettingsDoc.exists ? appSettingsDoc.data() : {};
                
                console.log("4. Sayfa içeriği oluşturuluyor (render ediliyor)...");
                renderHeader(categoryDocs, appSettings, settings, t);
                renderMainContent(sliderDocs, productDocs, settings, t);
                renderFooter(appSettings, settings, t);
                renderSeo(seoDoc, settings);
                
                console.log("5. Sayfa içeriği oluşturma tamamlandı.");
                document.getElementById('main-content-wrapper').classList.add('loaded'); // Sayfayı görünür yap
                console.log("6. Sayfa görünür hale getirildi. İşlem tamam!");

            } catch (error) {
                console.error("HATA! initializeApp fonksiyonunun catch bloğuna düşüldü.", error);
                document.body.innerHTML = `<div class="alert alert-danger m-5">Site yüklenirken bir hata oluştu. Hata: ${error.message}</div>`;
            }
        }
        
        function renderHeader(categoryDocs, appSettings, userSettings, t) {
            const headerElement = document.getElementById('page-header');
            const categories = categoryDocs.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const langCode = userSettings.language.toLowerCase();

            // Kategori linkleri
            let categoryLinks = '';
            categories.forEach(cat => {
                const catName = cat[`name_${langCode}`] || cat.name_tr || cat.id;
                categoryLinks += `<li class="nav-item"><a class="nav-link" href="#">${catName}</a></li>`;
            });

            // Dil seçeneklerini doldur
            let languageOptions = '';
            allLanguages.forEach(lang => {
                languageOptions += `<li><a class="dropdown-item" href="#" data-lang-code="${lang.code}">${lang.name}</a></li>`;
            });

            // Para birimi seçeneklerini doldur
            let currencyOptions = '';
            allCurrencies.forEach(curr => {
                currencyOptions += `<li><a class="dropdown-item" href="#" data-currency-code="${curr.code}">${curr.symbol} (${curr.code})</a></li>`;
            });

            headerElement.innerHTML = `
                <div class="container-fluid py-2 topbar-info">
                    <div class="container d-flex justify-content-end align-items-center">
                        <div class="dropdown me-3">
                            <a class="dropdown-toggle" href="#" role="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-translate me-1"></i> <span id="current-language-name">${allLanguages.find(l => l.code === userSettings.language)?.name || userSettings.language.toUpperCase()}</span>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="languageDropdown" id="language-options">
                                ${languageOptions}
                            </ul>
                        </div>
                        <div class="dropdown">
                            <a class="dropdown-toggle" href="#" role="button" id="currencyDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-cash-stack me-1"></i> <span id="current-currency-symbol">${userSettings.currencySymbol}</span> (<span id="current-currency-code">${userSettings.currencyCode}</span>)
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="currencyDropdown" id="currency-options">
                                ${currencyOptions}
                            </ul>
                        </div>
                    </div>
                </div>
                <nav class="navbar navbar-expand-lg navbar-light container">
                    <a class="navbar-brand" href="#">PUFEMO</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="category-links">
                            ${categoryLinks}
                        </ul>
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-person-fill"></i> Hesabım</a></li>
                            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-heart-fill"></i> Favoriler</a></li>
                            <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-cart-fill"></i> Sepet</a></li>
                        </ul>
                    </div>
                </nav>
            `;

            // Dil ve Para birimi seçimi için Event Listeners ekle
            document.getElementById('language-options').addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.dataset.langCode) {
                    const newLangCode = e.target.dataset.langCode;
                    if (userSettings.language !== newLangCode) {
                        updateUserSettings(userSettings.countryId, newLangCode, userSettings.currencyCode);
                    }
                }
            });

            document.getElementById('currency-options').addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.dataset.currencyCode) {
                    const newCurrencyCode = e.target.dataset.currencyCode;
                    if (userSettings.currencyCode !== newCurrencyCode) {
                        updateUserSettings(userSettings.countryId, userSettings.language, newCurrencyCode);
                    }
                }
            });
        }

        function renderMainContent(sliderDocs, productDocs, userSettings, t) {
            const mainElement = document.querySelector('main');
            mainElement.innerHTML = ''; // Ana içeriği temizle
            
            const langCode = userSettings.language.toLowerCase();

            // Slider kısmı
            const sliderData = sliderDocs.docs.map(doc => doc.data());
            if (sliderData.length > 0) {
                let carouselItems = '';
                let carouselIndicators = '';
                sliderData.forEach((slide, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const imageUrl = slide.imageUrl || 'https://via.placeholder.com/1920x650?text=Slider+Image';
                    carouselItems += `
                        <div class="carousel-item ${isActive}">
                            <img src="${imageUrl}" class="d-block w-100" alt="${slide[`title_${langCode}`] || slide.title_tr || 'Slider Başlığı'}">
                            <div class="carousel-caption d-none d-md-block">
                                <h5>${slide[`title_${langCode}`] || slide.title_tr || 'Slider Başlığı'}</h5>
                                <p>${slide[`description_${langCode}`] || slide.description_tr || 'Slider Açıklaması'}</p>
                            </div>
                        </div>
                    `;
                    carouselIndicators += `
                        <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="${index}" class="${isActive}" aria-current="${isActive ? 'true' : 'false'}" aria-label="Slide ${index + 1}"></button>
                    `;
                });

                mainElement.innerHTML += `
                    <section class="mb-5">
                        <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                ${carouselIndicators}
                            </div>
                            <div class="carousel-inner">
                                ${carouselItems}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </section>
                `;
            }

            // Ürünler kısmı
            const productsSection = document.createElement('section');
            productsSection.className = 'container my-5 py-4';
            productsSection.innerHTML = `
                <h2 class="text-center mb-5 fw-bold">${t.featuredProducts}</h2>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="featured-products-row">
                    </div>
            `;
            mainElement.appendChild(productsSection);

            const productsRow = document.getElementById('featured-products-row');
            if (productDocs.empty) {
                productsRow.innerHTML = `<div class="col-12 text-center text-muted">${t.noFeatured}</div>`;
                console.log("Vitrinde gösterilecek ürün bulunamadı.");
            } else {
                productDocs.forEach(doc => {
                    const product = doc.data();
                    console.log("Ana sayfada render edilen ürün:", product.name_tr, "showOnHomepage:", product.showOnHomepage); 
                    
                    const productPrice = (product.basePriceTRY * (userSettings.currencyExchangeRate || 1.0)).toFixed(2);
                    const currencySymbol = userSettings.currencySymbol || '₺';
                    
                    // İlk görseli çek veya placeholder göster
                    const imageUrl = product.mediaUrls && product.mediaUrls.length > 0 && product.mediaUrls[0].match(/\.(jpeg|jpg|gif|png|webp)$/i)
                                     ? product.mediaUrls[0]
                                     : 'https://via.placeholder.com/350x350?text=No+Image';
                    
                    const productCard = `
                        <div class="col">
                            <div class="card h-100 product-card">
                                <img src="${imageUrl}" class="card-img-top" alt="${product[`name_${langCode}`] || product.name_tr || 'Ürün Adı'}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-truncate">${product[`name_${langCode}`] || product.name_tr || 'Ürün Adı'}</h5>
                                    <p class="card-text flex-grow-1 mb-2 overflow-hidden">${product[`description_${langCode}`] || product.description_tr || 'Ürün açıklaması.'}</p>
                                    <div class="d-flex justify-content-between align-items-center mt-auto">
                                        <span class="fs-4 fw-bold">${productPrice} ${currencySymbol}</span>
                                        <button class="btn btn-primary btn-sm"><i class="bi bi-basket"></i> ${t.addToCart}</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    productsRow.innerHTML += productCard;
                });
            }
        }

        function renderFooter(appSettings, userSettings, t) {
            const footerElement = document.querySelector('footer');
            const langCode = userSettings.language.toLowerCase();
            
            // Ülke listesini footer içinde doldur
            let countryOptions = '';
            allCountries.forEach(country => {
                let flagUrl = 'https://via.placeholder.com/24x18?text=--';
                if (country.code) { flagUrl = `https://flagsapi.com/${country.code.toUpperCase()}/flat/24.png`; }
                countryOptions += `<li><a class="dropdown-item" href="#" data-country-id="${country.id}">${country.name} <img src="${flagUrl}" class="ms-2" style="width:20px; border:1px solid #ddd;"></a></li>`;
            });

            footerElement.innerHTML = `
                <div class="container">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <h5 class="fw-bold">PUFEMO</h5>
                            <p class="text-muted">
                                ${appSettings[`slogan_${langCode}`] || appSettings.slogan_tr || 'Online alışverişin yeni adresi.'}
                            </p>
                        </div>
                        <div class="col-md-4 mb-4">
                            <h5 class="fw-bold">Hızlı Erişim</h5>
                            <ul class="list-unstyled">
                                <li><a href="#" class="">Anasayfa</a></li>
                                <li><a href="#" class="">Hakkımızda</a></li>
                                <li><a href="#" class="">${t.contactUs}</a></li>
                                <li><a href="#" class="">Gizlilik Politikası</a></li>
                            </ul>
                        </div>
                        <div class="col-md-4 mb-4">
                            <h5 class="fw-bold">${t.contactUs}</h5>
                            <ul class="list-unstyled">
                                <li><i class="bi bi-geo-alt-fill me-2"></i> ${appSettings.address || 'Adres bilgisi yok'}</li>
                                <li><i class="bi bi-envelope-fill me-2"></i> ${appSettings.email || 'bilgi@pufemo.com'}</li>
                                <li><i class="bi bi-phone-fill me-2"></i> ${appSettings.phone || '+90 5XX XXX XX XX'}</li>
                            </ul>
                            <div class="dropdown mt-3">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="footerCountryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="https://flagsapi.com/${userSettings.countryCode.toUpperCase()}/flat/24.png" class="me-2" style="width:24px; border:1px solid #ddd;"> ${userSettings.countryName}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="footerCountryDropdown" id="footer-country-options">
                                    ${countryOptions}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr class="text-white-50">
                    <div class="text-center text-white-50">
                        &copy; ${new Date().getFullYear()} PUFEMO. Tüm hakları saklıdır.
                    </div>
                </div>
            `;

            // Footer'daki ülke seçim dropdownu için Event Listener
            document.getElementById('footer-country-options').addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.dataset.countryId) {
                    const newCountryId = e.target.dataset.countryId;
                    if (userSettings.countryId !== newCountryId) {
                        updateUserSettings(newCountryId, userSettings.language, userSettings.currencyCode); // shouldInitializeApp varsayılan true
                    }
                }
            });
        }

        function renderSeo(seoDoc, userSettings) {
            const seoData = seoDoc.exists ? seoDoc.data() : {};
            const langCode = userSettings.language.toLowerCase();
            
            document.title = seoData[`title_${langCode}`] || seoData.title_tr || "PUFEMO Online Mağaza";
            document.querySelector('meta[name="description"]').setAttribute('content', seoData[`description_${langCode}`] || seoData.description_tr || "PUFEMO online mağazası. En yeni ürünler ve özel fırsatlar.");
            // Diğer SEO meta etiketlerini de buraya ekleyebilirsiniz (keywords, og:title vb.)
        }

        // Giriş ve Kayıt butonları için event listenerlar (modal içindeki butonlar)
        document.getElementById('modal-show-login-btn').addEventListener('click', () => {
            alert('Giriş sayfası henüz entegre edilmedi.');
            // window.location.href = 'login.html'; 
        });

        document.getElementById('modal-show-register-btn').addEventListener('click', () => {
            alert('Kayıt sayfası henüz entegre edilmedi.');
            // window.location.href = 'register.html'; 
        });
    </script>
</body>
</html>
