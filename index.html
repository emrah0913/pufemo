<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PUFEMO - Anasayfa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; }
    select { width: 140px; }
    .banner-img { max-height: 400px; object-fit: cover; border-radius: 1rem; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-7xl mx-auto p-4">
    <!-- ÜST MENÜ -->
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 py-4">
      <h1 class="text-2xl font-bold text-primary">PUFEMO</h1>
      <div class="flex flex-wrap gap-4">
        <select id="languageSelect" class="border px-3 py-2 rounded"></select>
        <select id="currencySelect" class="border px-3 py-2 rounded"></select>
        <select id="countrySelect" class="border px-3 py-2 rounded"></select>
      </div>
    </header>

    <!-- BANNER -->
    <section class="my-8 text-center">
      <img id="bannerImage" class="w-full banner-img mx-auto" src="" alt="Banner" />
      <h2 id="bannerTitle" class="text-3xl font-bold mt-4">...</h2>
      <p id="bannerSubtitle" class="text-lg text-gray-600 mt-2">...</p>
      <a id="bannerButton" href="#" class="inline-block mt-4 px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">...</a>
    </section>

    <!-- ÜRÜNLER -->
    <section>
      <h3 class="text-2xl font-semibold mb-4">Öne Çıkan Ürünler</h3>
      <div id="productGrid" class="grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
    </section>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
      authDomain: "pufemo-com.firebaseapp.com",
      projectId: "pufemo-com",
      storageBucket: "pufemo-com.firebasestorage.app",
      messagingSenderId: "983352837227",
      appId: "1:983352837227:web:defaa8dae215776e2e1d2e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentLanguage = 'tr';
    let currentCurrency = 'TRY';
    let currencyRates = {
      TRY: 1,
      USD: 0.031,
      EUR: 0.029,
      GBP: 0.025
    };

    function convertCurrency(price) {
      const rate = currencyRates[currentCurrency] || 1;
      return (price * rate).toFixed(2);
    }

    async function loadHomepage() {
      const homepageRef = doc(db, "settings", "homepage");
      const homepageSnap = await getDoc(homepageRef);
      if (homepageSnap.exists()) {
        const data = homepageSnap.data();
        document.getElementById("bannerImage").src = data.bannerImage || "";
        document.getElementById("bannerTitle").textContent = data.title || "";
        document.getElementById("bannerSubtitle").textContent = data.subtitle || "";
        document.getElementById("bannerButton").textContent = data.buttonText || "Hemen İncele";
        document.getElementById("bannerButton").href = data.buttonLink || "#";
      }
    }

    async function loadSelectors() {
      const langs = ["tr", "en", "ru", "el"];
      const currs = ["TRY", "USD", "EUR", "GBP"];
      const countries = ["tr", "cy", "uk", "de", "us"];

      langs.forEach(l => {
        let o = document.createElement("option");
        o.value = l; o.textContent = l.toUpperCase();
        languageSelect.appendChild(o);
      });

      currs.forEach(c => {
        let o = document.createElement("option");
        o.value = c; o.textContent = c;
        currencySelect.appendChild(o);
      });

      countries.forEach(c => {
        let o = document.createElement("option");
        o.value = c; o.textContent = c.toUpperCase();
        countrySelect.appendChild(o);
      });

      languageSelect.addEventListener('change', e => { currentLanguage = e.target.value; loadProducts(); });
      currencySelect.addEventListener('change', e => { currentCurrency = e.target.value; loadProducts(); });
    }

    async function loadProducts() {
      const snap = await getDocs(collection(db, "pufemo-products"));
      const grid = document.getElementById("productGrid");
      grid.innerHTML = '';
      snap.forEach(doc => {
        const p = doc.data();
        const id = doc.id;
        const variant = p.variants?.[0];
        const content = p.content?.[currentLanguage] || p.content?.tr || {};
        const freeShipping = p.freeShipping === true;
        const div = document.createElement("div");
        div.className = "bg-white rounded shadow p-4 flex flex-col justify-between relative cursor-pointer hover:shadow-lg transition";
        div.onclick = () => window.location.href = `product.html?id=${id}`;
        div.innerHTML = `
          ${freeShipping && content.freeShippingText ? `<span class='absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded'>${content.freeShippingText}</span>` : ''}
          <img src="${variant?.media?.[0]?.url || 'https://placehold.co/400'}" class="w-full h-48 object-cover rounded">
          <h4 class="mt-3 font-semibold">${content.name || 'Ürün Adı'}</h4>
          <p class="text-sm text-gray-600">${content.description || ''}</p>
          <span class="text-red-600 text-xl font-bold mt-2">${convertCurrency(p.discountedPrice || p.price || 0)} ${currentCurrency}</span>
        `;
        grid.appendChild(div);
      });
    }

    loadHomepage();
    loadSelectors();
    loadProducts();
  </script>

</body>
</html>
