<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Ana Sayfa</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 30px 0;
            margin-top: auto;
        }
        .hero-slider {
            height: 500px; /* Adjust as needed */
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
            font-size: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .hero-slider .carousel-item img {
            width: 100%;
            height: 500px;
            object-fit: cover;
            filter: brightness(70%); /* Darken image for text readability */
        }
        .hero-slider .carousel-caption {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .product-card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            transition: transform 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-card img {
            height: 200px;
            object-fit: cover;
        }
        .modal-country-selection .modal-content,
        .modal-auth .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .modal-country-selection .modal-header,
        .modal-auth .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        .modal-country-selection .modal-footer,
        .modal-auth .modal-footer {
            border-top: none;
            padding-top: 0;
        }
        .currency-language-selector {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .currency-language-selector:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">PUFEMO</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Ürünler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Kategoriler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">İletişim</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-person-circle"></i> Hesabım</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sepet.html"><i class="bi bi-cart-fill"></i> Sepet <span class="badge bg-primary rounded-pill" id="cart-item-count">0</span></a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle currency-language-selector" href="#" id="currencyLanguageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="selected-country-display"></span> / <span id="selected-language-display"></span> / <span id="selected-currency-display"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="currencyLanguageDropdown">
                            <li><h6 class="dropdown-header">Ülke Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-country-select">
                                    </select>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Dil Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-language-select">
                                    </select>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Para Birimi Seçimi</h6></li>
                            <li>
                                <select class="form-select form-select-sm mx-3 mb-2" id="header-currency-select">
                                    </select>
                            </li>
                            <li><button class="btn btn-primary btn-sm w-75 mx-auto d-block mt-2" id="save-header-selections">Uygula</button></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-4 flex-grow-1">

        <div class="alert alert-info text-center" role="alert" id="promo-banner">
            Yükleniyor...
        </div>

        <section class="hero-slider rounded shadow-sm mb-4">
            <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    </div>
                <div class="carousel-inner" id="carousel-inner">
                    <div class="carousel-item active">
                        <img src="https://via.placeholder.com/1500x500/cccccc/ffffff?text=Slider+Görseli+1" class="d-block w-100" alt="Slider 1">
                        <div class="carousel-caption d-none d-md-block">
                            <h5>Yeni Sezon Ürünleri Keşfedin</h5>
                            <p>En güncel koleksiyonlarımızla tarzınızı yenileyin.</p>
                            <a href="#" class="btn btn-light btn-lg mt-3">Şimdi Keşfet</a>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </section>

        <section class="my-5">
            <h2 class="text-center mb-4">Öne Çıkan Kategoriler</h2>
            <div class="row row-cols-1 row-cols-md-3 g-4" id="featured-categories">
                <p class="text-center col-12">Kategoriler yükleniyor...</p>
            </div>
        </section>

        <section class="my-5">
            <h2 class="text-center mb-4">Yeni Gelen Ürünler</h2>
            <div class="row row-cols-1 row-cols-md-4 g-4" id="new-arrivals">
                <p class="text-center col-12">Ürünler yükleniyor...</p>
            </div>
        </section>

    </main>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">PUFEMO</h5>
                    <p>Kalite ve şıklığın adresi.</p>
                    <p id="footer-company-address">Adres bilgisi yüklenecek...</p>
                </div>
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">Hızlı Linkler</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-white text-decoration-none">Hakkımızda</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Gizlilik Politikası</a></li>
                        <li><a href="#" class="text-white text-decoration-none">Mesafeli Satış Sözleşmesi</a></li>
                        <li><a href="siparis-takip.html" class="text-white text-decoration-none">Sipariş Takip</a></li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h5 class="text-white">Bize Ulaşın</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-envelope-fill me-2"></i> <span id="footer-contact-email">info@pufemo.com</span></li>
                        <li><i class="bi bi-whatsapp me-2"></i> <span id="footer-whatsapp-number">+90 5XX XXX XX XX</span></li>
                    </ul>
                    <div class="social-icons mt-3">
                        <a href="#" class="text-white me-3"><i class="bi bi-facebook fs-4"></i></a>
                        <a href="#" class="text-white me-3"><i class="bi bi-instagram fs-4"></i></a>
                        <a href="#" class="text-white"><i class="bi bi-twitter fs-4"></i></a>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4 border-top pt-3">
                <p class="mb-0">&copy; 2025 PUFEMO. Tüm Hakları Saklıdır.</p>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="welcomeCountryModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="welcomeCountryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm modal-country-selection">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title w-100 text-center" id="welcomeCountryModalLabel">Hoş Geldiniz!</h5>
                </div>
                <div class="modal-body text-center">
                    <p id="welcome-country-prompt">Lütfen ülkenizi seçin:</p>
                    <select class="form-select mb-3" id="country-select-modal">
                        </select>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary" id="select-country-btn">Devam Et</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="authModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm modal-auth">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title w-100 text-center" id="authModalLabel">Nasıl Devam Etmek İstersiniz?</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="d-grid gap-2">
                        <a href="admin-login.html" class="btn btn-success btn-lg" id="auth-login-btn">Giriş Yap</a>
                        <a href="kayit-ol.html" class="btn btn-outline-primary btn-lg" id="auth-register-btn">Kayıt Ol</a>
                        <button type="button" class="btn btn-secondary btn-lg" id="continue-as-guest-btn">Misafir Olarak Devam Et</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase Yapılandırması (admin panelinizden kopyalandı)
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.firebasestorage.app",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
            measurementId: "G-RH8XHC7P91"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Modallar
        const welcomeCountryModal = new bootstrap.Modal(document.getElementById('welcomeCountryModal'));
        const authModal = new bootstrap.Modal(document.getElementById('authModal'));

        // Seçim Elementleri
        const countrySelectModal = document.getElementById('country-select-modal');
        const selectCountryBtn = document.getElementById('select-country-btn');
        const continueAsGuestBtn = document.getElementById('continue-as-guest-btn');

        // Welcome Country Modal Metin Elementleri
        const welcomeCountryModalLabel = document.getElementById('welcomeCountryModalLabel');
        const welcomeCountryPrompt = document.getElementById('welcome-country-prompt');
        // selectCountryBtn zaten tanımlı

        const selectedCountryDisplay = document.getElementById('selected-country-display');
        const selectedLanguageDisplay = document.getElementById('selected-language-display');
        const selectedCurrencyDisplay = document.getElementById('selected-currency-display');

        const headerCountrySelect = document.getElementById('header-country-select');
        const headerLanguageSelect = document.getElementById('header-language-select');
        const headerCurrencySelect = document.getElementById('header-currency-select');
        const saveHeaderSelectionsBtn = document.getElementById('save-header-selections');

        const promoBanner = document.getElementById('promo-banner');

        // Auth Modal Butonları ve Başlığı
        const authModalLabel = document.getElementById('authModalLabel');
        const authLoginBtn = document.getElementById('auth-login-btn');
        const authRegisterBtn = document.getElementById('auth-register-btn');
        // continueAsGuestBtn zaten tanımlı

        let allCountries = [];
        let allLanguages = [];
        let allCurrencies = [];
        let siteSettings = {}; // Genel site ayarları (IBAN, email vb.)

        // Local Storage Anahtarları
        const LS_SELECTED_COUNTRY_CODE = 'pufemo_selected_country_code';
        const LS_SELECTED_LANGUAGE_CODE = 'pufemo_selected_language_code';
        const LS_SELECTED_CURRENCY_CODE = 'pufemo_selected_currency_code';

        // TÜM UYGULAMA METİNLERİ (Çok Dilli)
        const appTexts = {
            'tr': {
                welcomeModalTitle: 'Hoş Geldiniz!',
                welcomeModalCountryPrompt: 'Lütfen ülkenizi seçin:',
                welcomeModalContinueBtn: 'Devam Et',
                countrySelectPlaceholder: 'Ülke Seçiniz...', 
                authModalTitle: 'Nasıl Devam Etmek İstersiniz?',
                authLoginBtn: 'Giriş Yap',
                authRegisterBtn: 'Kayıt Ol',
                authGuestBtn: 'Misafir Olarak Devam Et',
                settingsSaved: 'Ayarlar güncellendi!', 
                noSliders: 'Slider Mevcut Değil', 
                noSlidersMessage: 'Yönetici panelinden slider ekleyebilirsiniz.', 
                sliderLoadingError: 'Slider Yüklenirken Hata', 
                noCategories: 'Gösterilecek öne çıkan kategori bulunamadı.', 
                categoriesLoadingError: 'Kategoriler yükleniyor...', 
                productsLoading: 'Ürünler yükleniyor...', 
                noProducts: 'Gösterilecek yeni ürün bulunamadı.', 
                productsLoadingError: 'Ürünler yüklenemedi. Firebase kurallarınızı ve dizinlerinizi kontrol edin.', 
                footerAddressNotFound: 'Adres bilgisi bulunamadı.', 
                promoDefaultText: 'Harika fırsatlar için bizi takip edin!' 
            },
            'en': {
                welcomeModalTitle: 'Welcome!',
                welcomeModalCountryPrompt: 'Please select your country:',
                welcomeModalContinueBtn: 'Continue',
                countrySelectPlaceholder: 'Select your country...', 
                authModalTitle: 'How would you like to proceed?',
                authLoginBtn: 'Login',
                authRegisterBtn: 'Register',
                authGuestBtn: 'Continue as Guest',
                settingsSaved: 'Settings updated!',
                noSliders: 'No Sliders Available',
                noSlidersMessage: 'You can add sliders from the admin panel.',
                sliderLoadingError: 'Slider Loading Error',
                noCategories: 'No featured categories found.',
                categoriesLoadingError: 'Loading categories...',
                productsLoading: 'Loading products...',
                noProducts: 'No new products found.',
                productsLoadingError: 'Failed to load products. Check your Firebase rules and indexes.',
                footerAddressNotFound: 'Address not found.',
                promoDefaultText: 'Follow us for great offers!'
            },
            'de': { 
                welcomeModalTitle: 'Willkommen!',
                welcomeModalCountryPrompt: 'Bitte wählen Sie Ihr Land:',
                welcomeModalContinueBtn: 'Weiter',
                countrySelectPlaceholder: 'Land auswählen...', 
                authModalTitle: 'Wie möchten Sie fortfahren?',
                authLoginBtn: 'Anmelden',
                authRegisterBtn: 'Registrieren',
                authGuestBtn: 'Als Gast fortfahren',
                settingsSaved: 'Einstellungen aktualisiert!',
                noSliders: 'Keine Slider verfügbar',
                noSlidersMessage: 'Sie können Slider über das Admin-Panel hinzufügen.',
                sliderLoadingError: 'Slider Ladefehler',
                noCategories: 'Keine vorgestellten Kategorien gefunden.',
                categoriesLoadingError: 'Kategorien werden geladen...',
                productsLoading: 'Produkte werden geladen...',
                noProducts: 'Keine neuen Produkte gefunden.',
                productsLoadingError: 'Produkte konnten nicht geladen werden. Überprüfen Sie Ihre Firebase-Regeln und -Indizes.',
                footerAddressNotFound: 'Adresse nicht gefunden.',
                promoDefaultText: 'Folgen Sie uns für tolle Angebote!'
            },
            'el': { // Yunanca eklendi
                welcomeModalTitle: 'Καλώς ορίσατε!',
                welcomeModalCountryPrompt: 'Παρακαλώ επιλέξτε τη χώρα σας:',
                welcomeModalContinueBtn: 'Συνέχεια',
                countrySelectPlaceholder: 'Επιλέξτε τη χώρα σας...',
                authModalTitle: 'Πώς θα θέλατε να συνεχίσετε;',
                authLoginBtn: 'Σύνδεση',
                authRegisterBtn: 'Εγγραφή',
                authGuestBtn: 'Συνέχιση ως Επισκέπτης',
                settingsSaved: 'Οι ρυθμίσεις ενημερώθηκαν!',
                noSliders: 'Δεν υπάρχουν διαθέσιμα slider',
                noSlidersMessage: 'Μπορείτε να προσθέσετε slider από τον πίνακα διαχείρισης.',
                sliderLoadingError: 'Σφάλμα φόρτωσης slider',
                noCategories: 'Δεν βρέθηκαν επιλεγμένες κατηγορίες.',
                categoriesLoadingError: 'Φόρτωση κατηγοριών...',
                productsLoading: 'Φόρτωση προϊόντων...',
                noProducts: 'Δεν βρέθηκαν νέα προϊόντα.',
                productsLoadingError: 'Αδυναμία φόρτωσης προϊόντων. Ελέγξτε τους κανόνες και τους δείκτες του Firebase.',
                footerAddressNotFound: 'Διεύθυνση δεν βρέθηκε.',
                promoDefaultText: 'Ακολουθήστε μας για υπέροχες προσφορές!'
            }
            // Diğer diller buraya eklenebilir
        };


        // Sayfa yüklendiğinde çalışacak ana fonksiyon
        document.addEventListener('DOMContentLoaded', async () => {
            // Firestore verilerini önce yükle
            try {
                const [countriesSnapshot, languagesSnapshot, currenciesSnapshot, settingsDoc] = await Promise.all([
                    db.collection('countries').get(),
                    db.collection('languages').get(),
                    db.collection('currencies').get(),
                    db.collection('settings').doc('siteConfig').get()
                ]);

                allCountries = countriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allLanguages = languagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allCurrencies = currenciesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                siteSettings = settingsDoc.exists ? settingsDoc.data() : {};
                console.log("Firebase verileri başarıyla yüklendi.");
                console.log("allCountries:", allCountries);
                console.log("allLanguages:", allLanguages);
                console.log("allCurrencies:", allCurrencies);
                console.log("siteSettings:", siteSettings);


            } catch (error) {
                console.error("Başlangıç Firebase verileri yüklenirken hata:", error);
                alert("Site verileri yüklenirken bir sorun oluştu. Lütfen Firebase konsolunuzdaki Hataları (Errors) kontrol edin (İzinler/Dizinler).");
                // Hata durumunda, modalları göstermeye çalışmak sorun çıkarabilir.
                // Firebase'den veri gelmediyse, allCountries vb. boş kalacaktır.
                // Bu durumda modalların doğru çalışmasını sağlamak için varsayılan bir dil ayarlayalım.
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'en'); 
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'USD'); // Varsayılan para birimi
                // Modalları ve diğer elementleri varsayılan İngilizce ile güncelle
                updateAllModalTexts('en');
                updateHeaderDisplays(); // Header'ı da varsayılan ile güncelle
                updateStaticContent();
            }

            // Modalları ve seçimleri yönet
            // Bu fonksiyon artık Firebaseden veri gelip gelmediğine bakmaksızın çalışacak
            // ve Firebase verisi eksikse varsayılan dilleri kullanacak.
            await handleInitialModalsAndSelections();
            
            // Footer ve header'daki statik alanları güncelle (Firebase verisi başarılı olsa da olmasa da)
            updateStaticContent();
            
            // Header'daki dil/para birimi/ülke seçicilerini doldur ve mevcut seçimleri göster
            await populateHeaderSelectors();
            updateHeaderDisplays();

            // Dinamik ana sayfa içeriğini yükle
            loadHeroSlider();
            loadFeaturedCategories();
            loadNewArrivals();
            updateCartItemCount(); // Sepet sayacını güncelle
        });

        async function handleInitialModalsAndSelections() {
            // Modalların metinlerini belirlemek için başlangıç dili
            let initialLangCodeForModals = 'en'; 
            const storedCountryCode = localStorage.getItem(LS_SELECTED_COUNTRY_CODE);

            if (storedCountryCode && allCountries.length > 0) { // Sadece ülkeler yüklendiyse kontrol et
                const selectedCountryData = allCountries.find(c => c.code === storedCountryCode);
                if (selectedCountryData) {
                    initialLangCodeForModals = selectedCountryData.language || 'tr'; 
                    localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, selectedCountryData.language || 'tr');
                    localStorage.setItem(LS_SELECTED_CURRENCY_CODE, selectedCountryData.currency || 'TRY');
                } else {
                    // Stored country not found in Firebase (perhaps deleted), fall back to default
                    localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'tr'); 
                    localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'TRY');
                }
            } else if (allCountries.length === 0) {
                // Firebase'den ülke verisi gelmediyse, varsayılan dile göre işlem yap
                // initialLangCodeForModals zaten 'en' olarak ayarlı.
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'en'); 
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'USD');
            } else {
                // Hiç storedCountryCode yoksa ve allCountries doluysa, varsayılanı TR ayarla, ama modal EN başlasın
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'tr'); 
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'TRY');
                // initialLangCodeForModals hala 'en' kalacak bu senaryoda, bu istenen davranış.
            }
            
            // Modalların metinlerini belirlenen başlangıç diline ayarla
            updateAllModalTexts(initialLangCodeForModals);

            // Modal'daki ülke seçicisini doldur
            countrySelectModal.innerHTML = ''; // Mevcut seçenekleri temizle (önceki placeholder da dahil)
            const textsForModalPopulate = appTexts[initialLangCodeForModals] || appTexts['en'];

            // Placeholder'ı en başa ekle
            const placeholderOption = document.createElement('option');
            placeholderOption.value = "";
            placeholderOption.textContent = textsForModalPopulate.countrySelectPlaceholder;
            countrySelectModal.appendChild(placeholderOption);

            // Ülke seçeneklerini doldur
            allCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                const countryNameDisplay = country[`name_${initialLangCodeForModals}`] || country.name_tr || country.name;
                option.textContent = countryNameDisplay; 
                countrySelectModal.appendChild(option);
            });

            // Eğer bir önceki seçim varsa, onu varsayılan olarak seçili yap
            if (storedCountryCode) {
                countrySelectModal.value = storedCountryCode;
            } else {
                countrySelectModal.value = ""; // Placeholder'ı seçili yap
            }
            
            // HER ZAMAN HOŞ GELDİNİZ MODALINI GÖSTER
            welcomeCountryModal.show();
        }

        // TÜM MODAL METİNLERİNİ VE ÜLKE SEÇENEKLERİNİ GÜNCELLEYEN MERKEZİ FONKSİYON
        function updateAllModalTexts(languageCode) {
            const texts = appTexts[languageCode] || appTexts['en']; 

            // Welcome Country Modal Metinlerini Güncelle
            welcomeCountryModalLabel.textContent = texts.welcomeModalTitle;
            welcomeCountryPrompt.textContent = texts.welcomeModalCountryPrompt;
            selectCountryBtn.textContent = texts.welcomeModalContinueBtn;
            
            // Ülke seçimi dropdown'daki placeholder'ı ve seçeneklerin dilini güncelle
            const currentCountrySelectValue = countrySelectModal.value; // Mevcut seçili değeri koru
            countrySelectModal.innerHTML = ''; // Tamamen temizle

            // Placeholder'ı yeniden ekle ve metnini güncelle
            const placeholderOption = document.createElement('option');
            placeholderOption.value = "";
            placeholderOption.textContent = texts.countrySelectPlaceholder;
            countrySelectModal.appendChild(placeholderOption); // Append, prepend yerine append kullanıldı, sonra value ayarlanır

            // Ülke seçeneklerini doldur
            allCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                const countryNameDisplay = country[`name_${languageCode}`] || country.name_tr || country.name;
                option.textContent = countryNameDisplay; 
                countrySelectModal.appendChild(option);
            });
            countrySelectModal.value = currentCountrySelectValue; // Seçimi geri yükle (yoksa boş kalır)


            // Auth Modal Metinlerini Güncelle
            authModalLabel.textContent = texts.authModalTitle;
            authLoginBtn.textContent = texts.authLoginBtn;
            authRegisterBtn.textContent = texts.authRegisterBtn;
            continueAsGuestBtn.textContent = texts.authGuestBtn;
        }


        function updateStaticContent() {
            const currentLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr'; 
            const texts = appTexts[currentLangCode] || appTexts['en']; 

            document.getElementById('footer-company-address').textContent = siteSettings[`companyAddress_${currentLangCode}`] || texts.footerAddressNotFound;
            document.getElementById('footer-contact-email').textContent = siteSettings.contactEmail || 'info@pufemo.com';
            document.getElementById('footer-whatsapp-number').textContent = siteSettings.whatsappNumber || '+90 5XX XXX XX XX';
            promoBanner.textContent = siteSettings[`promoText_${currentLangCode}`] || texts.promoDefaultText; 
        }

        async function populateHeaderSelectors() {
            const currentLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            headerCountrySelect.innerHTML = '';
            allCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country[`name_${currentLangCode}`] || country.name_tr || country.name;
                headerCountrySelect.appendChild(option);
            });

            headerLanguageSelect.innerHTML = '';
            allLanguages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.code;
                option.textContent = lang.name; 
                headerLanguageSelect.appendChild(option);
            });

            headerCurrencySelect.innerHTML = '';
            allCurrencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.code;
                option.textContent = `${currency.symbol} (${currency.code})`;
                headerCurrencySelect.appendChild(option);
            });

            headerCountrySelect.value = localStorage.getItem(LS_SELECTED_COUNTRY_CODE) || '';
            headerLanguageSelect.value = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || '';
            headerCurrencySelect.value = localStorage.getItem(LS_SELECTED_CURRENCY_CODE) || '';
        }

        function updateHeaderDisplays() {
            const currentCountryCode = localStorage.getItem(LS_SELECTED_COUNTRY_CODE);
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE);
            const currentCurrencyCode = localStorage.getItem(LS_SELECTED_CURRENCY_CODE);

            const selectedCountry = allCountries.find(c => c.code === currentCountryCode);
            const selectedLanguage = allLanguages.find(l => l.code === currentLanguageCode);
            const selectedCurrency = allCurrencies.find(c => c.code === currentCurrencyCode);

            selectedCountryDisplay.textContent = selectedCountry ? selectedCountry.code.toUpperCase() : 'TR';
            selectedLanguageDisplay.textContent = selectedLanguage ? selectedLanguage.code.toUpperCase() : 'TR';
            selectedCurrencyDisplay.textContent = selectedCurrency ? selectedCurrency.symbol : '₺';
        }

        async function setSelectedCountry(countryCode) {
            localStorage.setItem(LS_SELECTED_COUNTRY_CODE, countryCode);

            const selectedCountryData = allCountries.find(c => c.code === countryCode);
            if (selectedCountryData) {
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, selectedCountryData.language || 'tr'); 
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, selectedCountryData.currency || 'TRY'); 
            } else {
                localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, 'tr');
                localStorage.setItem(LS_SELECTED_CURRENCY_CODE, 'TRY');
            }
            updateHeaderDisplays();
            updateStaticContent(); 
            
            const newLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            updateAllModalTexts(newLangCode); // Modalların dilini güncelle

            loadHeroSlider();
            loadFeaturedCategories();
            loadNewArrivals();
        }

        // Event Listeners
        selectCountryBtn.addEventListener('click', () => {
            const selectedCountryCode = countrySelectModal.value;
            if (selectedCountryCode) {
                setSelectedCountry(selectedCountryCode);
                welcomeCountryModal.hide();
                authModal.show(); // Ülke seçildikten sonra yetkilendirme modalını göster
            } else {
                const currentLang = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
                alert(appTexts[currentLang]?.welcomeModalCountryPrompt || appTexts['en'].welcomeModalCountryPrompt);
            }
        });

        continueAsGuestBtn.addEventListener('click', () => {
            authModal.hide();
        });

        saveHeaderSelectionsBtn.addEventListener('click', () => {
            localStorage.setItem(LS_SELECTED_COUNTRY_CODE, headerCountrySelect.value);
            localStorage.setItem(LS_SELECTED_LANGUAGE_CODE, headerLanguageSelect.value);
            localStorage.setItem(LS_SELECTED_CURRENCY_CODE, headerCurrencySelect.value);
            updateHeaderDisplays();
            updateStaticContent(); 
            
            const newLangCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            updateAllModalTexts(newLangCode); // Modalların dilini güncelle

            loadHeroSlider();
            loadFeaturedCategories();
            loadNewArrivals();
            alert(appTexts[newLangCode]?.settingsSaved || appTexts['en'].settingsSaved); 
        });

        // --- Dinamik İçerik Yükleme Fonksiyonları (Firebase'den veri çekecek) ---

        async function loadHeroSlider() {
            const carouselInner = document.getElementById('carousel-inner');
            const carouselIndicators = document.querySelector('.carousel-indicators');
            carouselInner.innerHTML = '';
            carouselIndicators.innerHTML = '';

            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];

            try {
                const sliderSnapshot = await db.collection('homepage_slider').where('isActive', '==', true).orderBy('order').get();
                
                if (sliderSnapshot.empty) {
                    carouselInner.innerHTML = `<div class="carousel-item active">
                        <img src="https://via.placeholder.com/1500x500/cccccc/ffffff?text=${encodeURIComponent(texts.noSliders)}" class="d-block w-100" alt="${texts.noSliders}">
                        <div class="carousel-caption d-none d-md-block">
                            <h5>${texts.noSliders}</h5>
                            <p>${texts.noSlidersMessage}</p>
                        </div>
                    </div>`;
                    return;
                }

                sliderSnapshot.docs.forEach((doc, index) => {
                    const slider = doc.data();
                    const isActive = index === 0 ? 'active' : '';
                    const title = slider[`title_${currentLanguageCode}`] || slider.title_tr || texts.noSliders;
                    const description = slider[`description_${currentLanguageCode}`] || slider.description_tr || '';
                    const imageUrl = slider.imageUrl || `https://via.placeholder.com/1500x500/cccccc/ffffff?text=${encodeURIComponent(texts.noSliders)}`;
                    const link = slider.linkUrl || '#'; 

                    carouselIndicators.innerHTML += `<button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="${index}" class="${isActive}" aria-current="${isActive ? 'true' : 'false'}" aria-label="Slide ${index + 1}"></button>`;

                    carouselInner.innerHTML += `
                        <div class="carousel-item ${isActive}">
                            <img src="${imageUrl}" class="d-block w-100" alt="${title}">
                            <div class="carousel-caption d-none d-md-block">
                                <h5>${title}</h5>
                                <p>${description}</p>
                                <a href="${link}" class="btn btn-light btn-lg mt-3">Şimdi Keşfet</a>
                            </div>
                        </div>`;
                });

                const carousel = new bootstrap.Carousel(document.getElementById('heroCarousel'));

            } catch (error) {
                console.error("Slider yüklenirken hata:", error);
                 carouselInner.innerHTML = `<div class="carousel-item active">
                        <img src="https://via.placeholder.com/1500x500/cccccc/ffffff?text=${encodeURIComponent(texts.sliderLoadingError)}" class="d-block w-100" alt="${texts.sliderLoadingError}">
                        <div class="carousel-caption d-none d-md-block">
                            <h5>${texts.sliderLoadingError}</h5>
                            <p>${texts.productsLoadingError}</p>
                        </div>
                    </div>`;
            }
        }

        async function loadFeaturedCategories() {
            const featuredCategoriesContainer = document.getElementById('featured-categories');
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];
            featuredCategoriesContainer.innerHTML = `<p class="text-center col-12">${texts.categoriesLoadingError}</p>`;


            try {
                const categoriesSnapshot = await db.collection('categories').get();
                const categories = categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesToShow = categories.filter(cat => cat.showOnHomepage).slice(0, 3); 
                
                if (categoriesToShow.length === 0) {
                    featuredCategoriesContainer.innerHTML = `<p class="text-center col-12">${texts.noCategories}</p>`;
                    return;
                }
                
                featuredCategoriesContainer.innerHTML = ''; 

                categoriesToShow.forEach(category => {
                    const categoryName = category[`name_${currentLanguageCode}`] || category.name_tr || 'Kategori Adı Yok';
                    const imageUrl = category.imageUrl || `https://via.placeholder.com/400x250/f0f0f0/333333?text=${encodeURIComponent(categoryName)}`; 
                    const link = `category.html?id=${category.id}`; 

                    featuredCategoriesContainer.innerHTML += `
                        <div class="col">
                            <div class="card h-100 text-center product-card">
                                <img src="${imageUrl}" class="card-img-top" alt="${categoryName}">
                                <div class="card-body">
                                    <h5 class="card-title">${categoryName}</h5>
                                    <a href="${link}" class="btn btn-outline-primary btn-sm">Keşfet</a>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (error) {
                console.error("Öne çıkan kategoriler yüklenirken hata:", error);
                featuredCategoriesContainer.innerHTML = `<p class="text-center col-12 text-danger">${texts.categoriesLoadingError}</p>`;
            }
        }

        async function loadNewArrivals() {
            const newArrivalsContainer = document.getElementById('new-arrivals');
            const currentLanguageCode = localStorage.getItem(LS_SELECTED_LANGUAGE_CODE) || 'tr';
            const texts = appTexts[currentLanguageCode] || appTexts['en'];
            newArrivalsContainer.innerHTML = `<p class="text-center col-12">${texts.productsLoading}</p>`;


            const currentCurrencyCode = localStorage.getItem(LS_SELECTED_CURRENCY_CODE) || 'TRY';
            const currentCountryCode = localStorage.getItem(LS_SELECTED_COUNTRY_CODE) || 'TR';

            try {
                const productsSnapshot = await db.collection('products')
                                                .where('isActive', '==', true) 
                                                .orderBy('createdAt', 'desc') 
                                                .limit(8) 
                                                .get();

                if (productsSnapshot.empty) {
                    newArrivalsContainer.innerHTML = `<p class="text-center col-12">${texts.noProducts}</p>`;
                    return;
                }
                
                newArrivalsContainer.innerHTML = ''; 

                const products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const selectedCountryData = allCountries.find(c => c.code === currentCountryCode);
                const priceMultiplier = selectedCountryData ? (selectedCountryData.multiplier || 1) : 1; 

                products.forEach(product => {
                    const productName = product[`name_${currentLanguageCode}`] || product.name_tr || 'Ürün Adı Yok';
                    
                    const imageUrl = (product.mediaUrls && product.mediaUrls.length > 0) 
                                     ? product.mediaUrls[0] 
                                     : `https://via.placeholder.com/300x200/f5f5f5/333333?text=${encodeURIComponent(productName)}`; 
                    
                    let price = product.basePriceTRY || 0; 

                    price = (price * priceMultiplier).toFixed(2); 

                    const selectedCurrencySymbol = allCurrencies.find(c => c.code === currentCurrencyCode)?.symbol || '₺'; 

                    const link = `urun-detay.html?id=${product.id}`; 

                    newArrivalsContainer.innerHTML += `
                        <div class="col">
                            <div class="card product-card">
                                <a href="${link}"><img src="${imageUrl}" class="card-img-top" alt="${productName}"></a>
                                <div class="card-body text-center">
                                    <h5 class="card-title">${productName}</h5>
                                    <p class="card-text fw-bold">${price} ${selectedCurrencySymbol}</p>
                                    <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="${product.id}">Sepete Ekle</button>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (error) {
                console.error("Yeni ürünler yüklenirken hata:", error);
                newArrivalsContainer.innerHTML = `<p class="text-center col-12 text-danger">${texts.productsLoadingError}</p>`;
            }
        }

        // Sepet sayacı için basit bir placeholder (gerçek sepet mantığı daha sonra eklenecek)
        function updateCartItemCount() {
            const cartItems = JSON.parse(localStorage.getItem('pufemo_cart_items') || '[]');
            document.getElementById('cart-item-count').textContent = cartItems.length;
        }
        // Sepete Ekle butonu için geçıcı bir event listener (gerçek sepet mantığı "sepet.html"de detaylandırılacak)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.productId;
                alert(`Ürün ID: ${productId} sepete eklendi (geçici).`);
                // Gerçek sepete ekleme mantığı burada
                // Örn: let cart = JSON.parse(localStorage.getItem('pufemo_cart_items') || '[]');
                // cart.push({ productId: productId, quantity: 1 });
                // localStorage.setItem('pufemo_cart_items', JSON.stringify(cart));
                updateCartItemCount();
            }
        });

    </script>
</body>
</html>
