<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Modern ve Konforlu Mobilyalar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Genel Değişkenler ve Temel Stiller */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #e74c3c;
            --background-color: #ecf0f1; /* Anasayfa için arka plan rengi */
            --product-detail-background: #f9f9f9; /* Ürün detay sayfası için arka plan rengi */
            --text-color: #34495e;
            --light-text-color: #ffffff;
            --card-bg-color: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { text-decoration: none; color: inherit; }

        /* Yükleme Ekranı Stilleri */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loading-overlay p { font-size: 1.5rem; margin-top: 1.5rem; color: var(--primary-color); }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }

        /* Promosyon Çubuğu Stilleri */
        .promo-bar {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            text-align: center;
            padding: 8px 0;
            font-size: 0.95rem;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            z-index: 1001;
        }
        .promo-text {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-text 20s linear infinite;
        }
        @keyframes scroll-text {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }

        /* Ana Başlık (Header) Stilleri */
        .main-header {
            background-color: var(--card-bg-color);
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding-bottom: 0.5rem;
        }
        .header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem 0;
        }
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 20px;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        .logo i {
            color: var(--secondary-color);
            margin-right: 5px;
        }
        .logo img { max-width: 100%; height: auto; }
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .control-select { background-color: #f8f9fa; border: 1px solid #ddd; padding: 5px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; }
        .cart-icon { font-size: 1.5rem; position: relative; }
        .cart-badge { position: absolute; top: -5px; right: -10px; background-color: var(--secondary-color); color: var(--light-text-color); border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; }
        .hamburger-menu { display: none; cursor: pointer; width: 30px; height: 25px; flex-direction: column; justify-content: space-between; background: transparent; border: none; z-index: 1003; }
        .hamburger-menu span { display: block; width: 100%; height: 3px; background-color: var(--primary-color); border-radius: 3px; transition: all 0.3s ease-in-out; }
        .hamburger-menu.open span { background-color: var(--light-text-color); }
        .hamburger-menu.open span:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        .hamburger-menu.open span:nth-child(2) { opacity: 0; }
        .hamburger-menu.open span:nth-child(3) { transform: translateY(-11px) rotate(-45deg); }
        .mobile-nav { position: fixed; top: 0; left: -100%; width: 300px; height: 100vh; background-color: var(--primary-color); color: var(--light-text-color); z-index: 1002; transition: left 0.4s ease-in-out; box-shadow: 5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; padding: 1.5rem; }
        .mobile-nav.open { left: 0; }
        .mobile-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; }
        .mobile-nav-overlay.open { opacity: 1; visibility: visible; }
        .mobile-nav .mobile-nav-header { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.5rem; font-weight: 600; color: var(--light-text-color); }
        .mobile-nav ul { list-style: none; }
        .mobile-nav ul a { display: block; padding: 15px 0; color: var(--light-text-color); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 500; transition: background-color 0.3s ease; }
        .mobile-nav ul a:hover { background-color: rgba(255,255,255,0.1); }
        .mobile-nav ul ul a { padding-left: 20px; font-size: 0.9em; }
        .mobile-nav ul ul ul a { padding-left: 40px; }
        .category-nav { background-color: var(--primary-color); padding: 0.8rem 0; }
        .category-nav ul { list-style: none; display: flex; justify-content: center; gap: 2.5rem; flex-wrap: wrap; }
        .category-nav a { color: var(--light-text-color); font-weight: 500; padding: 5px 10px; border-radius: 5px; transition: background-color 0.3s ease; }
        .category-nav a:hover { background-color: rgba(255,255,255,0.1); }

        /* Anasayfa - Hero Banner Stilleri */
        .hero-banner { position: relative; width: 100%; height: 500px; overflow: hidden; background-color: #ccc; }
        .slide { position: absolute; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease-in-out; visibility: hidden; }
        .slide video, .slide .slide-bg-image { width: 100%; height: 100%; object-fit: cover; background-size: cover; background-position: center; }
        .slide.active { opacity: 1; visibility: visible; }
        
        .slide-content {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            max-width: 80%;
        }
        .slide-content h2 { font-size: 2.8rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 2px 2px 8px rgba(0,0,0,0.8); color: white; }
        .slide-content p { font-size: 1.2rem; margin-bottom: 1.5rem; text-shadow: 1px 1px 6px rgba(0,0,0,0.8); color: white; }
        .btn-shop {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            transition: background-color 0.3s ease;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .slide-nav { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s ease; }
        .nav-dot.active { background-color: var(--light-text-color); }
        
        main { padding: 3rem 0; }
        .page-content { display: none; } /* Sayfa içeriklerini gizle */
        .page-content.active { display: block; } /* Aktif sayfayı göster */

        .section { padding-top: 60px; margin-top: -60px; }
        .section-title { text-align: center; margin-bottom: 2.5rem; font-size: 2.2rem; font-weight: 600; color: var(--primary-color); }
        
        /* Anasayfa - Ürün Grid Stilleri */
        .product-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); } }
        @media (min-width: 1200px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }

        .product-card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .product-card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        
        .product-image-link {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 250px;
            background-color: #f0f0f0;
        }
        .product-image { width: 100%; height: 100%; object-fit: cover; }
        
        .product-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 1.2rem;
        }
        .product-info-top { flex-grow: 1; }
        .product-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-description { display: none; margin-bottom: 1rem; color: #7f8c8d; }
        
        .price-container { display: flex; align-items: baseline; gap: 8px; margin-top: 0.5rem; }
        .original-price { font-size: 1rem; color: #7f8c8d; text-decoration: line-through; font-weight: 400; }
        .discounted-price { font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); }

        .free-shipping-tag {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #27ae60;
            color: var(--light-text-color);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        /* Ürün Detay Bölümü Stilleri */
        .product-detail-container {
            max-width: 1200px;
            margin: auto;
            padding: 30px 20px;
            display: grid;
            grid-template-columns: 0.8fr 1fr;
            gap: 20px;
            align-items: start;
            background-color: var(--product-detail-background); /* Ürün detay için özel arka plan */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .image-gallery {
            display: flex;
            flex-direction: column;
            gap: 20px;
            order: 1;
            align-items: flex-start;
        }
        .image-gallery .main-media { width: 100%; aspect-ratio: 4/3; object-fit: cover; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .thumbnail-row {
            display: grid;
            grid-template-columns: repeat(7, 60px); /* Her satırda 7 adet 60px genişliğinde resim */
            gap: 10px; /* Resimler arası boşluk */
            justify-content: start; /* Resimleri sola hizala */
            width: fit-content; /* İçeriğe göre genişle, taşmaları engelle */
            padding-top: 10px;
        }
        .thumbnail-row .thumbnail-item {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .thumbnail-row .thumbnail-item.active { border-color: var(--secondary-color); }
        .thumbnail-row .thumbnail-item img,
        .thumbnail-row .thumbnail-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .thumbnail-row .thumbnail-item.video-thumb::after {
            content: "\f04b";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            color: white;
            font-size: 1.5rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .details { display: flex; flex-direction: column; gap: 20px; order: 2; }
        .details h1 { font-size: 2rem; font-weight: 700; }
        .price { display: flex; align-items: baseline; gap: 10px; }
        .old-price { text-decoration: line-through; color: #888; font-size: 1.1rem; }
        .new-price { font-size: 1.6rem; font-weight: bold; color: var(--secondary-color); }

        /* Adet Seçici Stilleri */
        .quantity-control { display: flex; align-items: center; gap: 5px; }
        .quantity-control .quantity-label { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); margin-right: 5px; }
        .quantity-button {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 8px;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }
        .quantity-button:hover { background-color: #1a242f; }
        .quantity-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .quantity-input {
            width: 60px;
            padding: 8px 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            -moz-appearance: textfield;
        }
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Toplam Fiyat Stilleri */
        .total-price-display {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .total-price-label { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        .calculated-total-price { font-size: 1.8rem; font-weight: bold; color: var(--secondary-color); }

        /* Yeni Varyant Bölümü Stilleri */
        .variant-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* sola hizalar */
            gap: 10px;
            padding-left: 0; /* Kaldırılan 10px padding, zaten genel padding'ler var */
        }
        .variant-title { font-size: 1.1rem; font-weight: 600; margin: 0; padding: 0; text-align: left; color: var(--primary-color); margin-bottom: 5px; }
        .variant-selectors {
            display: flex;
            gap: 8px; /* Varsayılan olarak 8px boşluk */
            flex-wrap: nowrap; /* Tek satırda kalmasını sağlar */
            overflow-x: auto; /* Yatay kaydırmayı etkinleştirir */
            justify-content: flex-start; /* Elemanları sola hizalar */
            width: 100%; /* Tam genişlik alır */
            padding-bottom: 10px; /* Kaydırma çubuğu için boşluk */
            -webkit-overflow-scrolling: touch; /* iOS'ta daha akıcı kaydırma */
        }
        /* Kaydırma çubuğunu gizle (isteğe bağlı) */
        .variant-selectors::-webkit-scrollbar { display: none; }
        .variant-selectors { -ms-overflow-style: none; /* IE and Edge */ scrollbar-width: none; /* Firefox */ }
        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center; /* Resmi ve yazıyı dikeyde ortalar */
            gap: 5px; /* Daire ile isim arasındaki boşluk */
            cursor: pointer;
            text-align: center;
            transition: transform 0.2s ease;
            flex: 0 0 auto; /* Esnemesini engeller, içeriğine göre boyutlanır */
            width: 80px; /* Her bir seçeneğin sabit genişliği */
            max-width: 80px; /* Her bir seçeneğin maksimum genişliği */
        }
        .color-option:hover { transform: translateY(-3px); }
        .color-circle {
            width: 70px; /* Ekran görüntüsündeki gibi daha büyük daire */
            height: 70px;
            border-radius: 50%;
            border: 2px solid #ccc;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .color-circle.active { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.3); }
        .color-circle img { width: 100%; height: 100%; object-fit: cover; /* Resmin daireye tam oturmasını sağlar */ border-radius: 50%; }
        .color-name {
            font-size: 0.8rem; /* Renk isminin font boyutu */
            color: var(--text-color);
            font-weight: 500;
            white-space: normal; /* Metnin gerektiğinde yeni satıra geçmesini sağlar */
            word-break: break-word; /* Uzun kelimelerin kırılmasını sağlar */
        }

        .actions { display: flex; gap: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-primary { background-color: var(--primary-color); color: var(--light-text-color); }
        .btn-primary:hover { background-color: #1a242f; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--light-text-color); }
        .btn-secondary:hover { background-color: #c0392b; }
        .free-shipping { background-color: #27ae60; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Ürün Açıklama Bölümü */
        .description-section {
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-width: 1100px;
        }
        .description-section h2 { margin-bottom: 15px; font-size: 1.5rem; border-bottom: 2px solid var(--secondary-color); display: inline-block; }

        /* Benzer Varyantlar Bölümü Stilleri */
        .related-variants-section {
            max-width: 1200px;
            margin: 40px auto 30px auto; /* Üstten ve alttan boşluk */
            padding: 30px 20px;
            background: var(--card-bg-color); /* Beyaz arka plan */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .related-variants-section h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            display: inline-block;
            padding-bottom: 5px;
            margin-left: auto;
            margin-right: auto;
        }

        .related-variants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px; /* Kartlar arası boşluk */
            justify-content: center; /* Kartları ortala */
        }
        .related-variant-card {
            background-color: var(--background-color); /* Hafif gri arka plan */
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0; /* padding kaldırıldı */
            padding-bottom: 15px; /* Alttan boşluk ekledik */
            text-align: center;
            position: relative; /* Ücretsiz kargo etiketi için gerekli */
        }
        .related-variant-card:hover { transform: translateY(-5px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }

        /* Resim boyutunu büyüt ve çerçeveyi kaldır */
        .related-variant-card img {
            width: 100%; /* Kartın tam genişliğini kaplasın */
            height: 200px; /* Daha büyük sabit yükseklik */
            object-fit: cover; /* Resmi orantılı olarak sığdırır ve kırpar */
            border-radius: 8px 8px 0 0; /* Üst köşeler yuvarlak, alt köşeler düz */
            margin-bottom: 10px; /* Resim ile yazı arasında boşluk */
            border: none; /* Çerçeveyi kaldır */
            padding: 0; /* İç dolguyu kaldır */
            background-color: #fff; /* Resmin arkası beyaz olsun */
        }
        .related-variant-card .variant-name { /* Sadece ürün adı gösterilecek */
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
            padding: 0 10px; /* Kenarlardan boşluk */
        }
        /* Benzer ürünler fiyat gösterimi için stiller */
        .related-variant-card .price-container {
            display: flex;
            align-items: baseline;
            justify-content: center; /* Fiyatları ortala */
            gap: 8px; /* Fiyatlar arası boşluk */
            margin-top: 5px;
            flex-wrap: wrap; /* Küçük ekranlarda sığmazsa alt satıra geçsin */
            padding: 0 10px; /* Kenarlardan boşluk */
        }
        .related-variant-card .old-price { text-decoration: line-through; color: #888; font-size: 0.9em; /* Daha küçük */ }
        .related-variant-card .new-price { font-size: 1.1em; /* Biraz daha büyük */ font-weight: bold; color: var(--secondary-color); }
        /* Ücretsiz kargo etiketi stili */
        .related-variant-card .free-shipping-tag {
            display: inline-block; /* Kendi satırında olsun */
            background-color: #27ae60; /* Yeşil */
            color: white;
            padding: 4px 8px; /* Daha küçük padding */
            border-radius: 12px; /* Ovalimsi */
            font-size: 0.75rem; /* Küçük font boyutu */
            font-weight: 600;
            z-index: 10; /* Diğer içeriklerin üzerinde olsun */
            pointer-events: none; /* Tıklanabilir olmasın */
        }
        /* Etiketi ortalamak için Flexbox kullanıyoruz */
        .related-variant-card .free-shipping-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 10px; /* Fiyat ile ücretsiz kargo etiketi arasına boşluk */
        }

        /* Sepet Sayfası Stilleri */
        .cart-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .cart-container h1 { font-size: 2rem; margin-bottom: 2rem; color: var(--primary-color); text-align: center; }
        .cart-items { border-top: 1px solid #eee; margin-top: 20px; padding-top: 20px; }
        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            background-color: #fcfcfc;
        }
        .cart-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-right: 15px;
            flex-shrink: 0;
        }
        .cart-item-details { flex-grow: 1; }
        .cart-item-details h3 { font-size: 1.2rem; margin-bottom: 5px; color: var(--primary-color); }
        .cart-item-details p { font-size: 0.9rem; color: #7f8c8d; }
        .cart-item-price { font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); margin-left: 15px; flex-shrink: 0; }
        .cart-item .quantity-control { margin-left: 15px; flex-shrink: 0; }
        .remove-item-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .cart-summary {
            border-top: 2px solid var(--primary-color);
            padding-top: 20px;
            margin-top: 30px;
            text-align: right;
        }
        .cart-summary p { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; }
        .cart-summary span { color: var(--secondary-color); }
        .cart-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .cart-empty-message { text-align: center; font-size: 1.2rem; color: #7f8c8d; padding: 50px 0; }

        /* Ödeme Sayfası Stilleri (Checkout) */
        .checkout-container {
            max-width: 800px;
            margin: 30px auto;
            padding: 30px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .checkout-container h1 { font-size: 2rem; margin-bottom: 2rem; color: var(--primary-color); text-align: center; }
        .checkout-form .form-group { margin-bottom: 1.5rem; }
        .checkout-form label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-color); }
        .checkout-form input[type="text"],
        .checkout-form input[type="email"],
        .checkout-form input[type="tel"],
        .checkout-form select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }
        .checkout-form select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.2H18.2c-4.8%200-9.6%201.8-13.2%206.2-6.4%206.4-6.4%2017.3%200%2023.7l133.9%20133.9c6.3%206.3%2017.2%206.3%2023.5%200L287%2093.1a17.6%2017.6%200%200%000-23.7z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 0.7em top 50%, 0 0; background-size: 0.65em auto, 100%; }

        .checkout-summary { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .checkout-summary h2 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary-color); }
        .checkout-summary .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; }
        .checkout-summary .summary-total { font-size: 1.4rem; font-weight: 700; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; }
        .checkout-summary .summary-total span { color: var(--secondary-color); }
        .checkout-actions { text-align: right; margin-top: 30px; }

        /* Altbilgi (Footer) Stilleri */
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 3rem 0 1rem 0; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem; text-align: center; }
        .footer-section { flex: 1; min-width: 200px; }
        .footer-section h4 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem; display: inline-block; }
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section a:hover { color: var(--secondary-color); }
        .footer-bottom { text-align: center; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        
        /* GÜNCELLENDİ: Ülke seçici için yeni stiller */
        .country-selector-container {
            text-align: center;
            padding: 2rem 0;
            margin: 2rem 0 0 0;
            border-top: 1px solid rgba(255,255,255,0.15);
        }
        .country-selector-container label { font-size: 1.1rem; color: var(--light-text-color); margin-right: 10px; font-weight: 500; }
        .country-selector-container .control-select {
            padding: 8px 12px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .country-selector-container .control-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }

        /* Yeni Karşılama Modalı Stilleri */
        .welcome-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Koyu arka plan */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001; /* Loading overlay'den de yüksek */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .welcome-modal-overlay.active { opacity: 1; visibility: visible; }
        .welcome-modal-content {
            background-color: var(--card-bg-color); /* Beyaz kart arkaplanı */
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .welcome-modal-overlay.active .welcome-modal-content { transform: translateY(0); }
        .welcome-modal-content h2 { font-size: 2rem; color: var(--primary-color); margin-bottom: 15px; }
        .welcome-modal-content p { font-size: 1.1rem; color: var(--text-color); margin-bottom: 25px; }
        .welcome-modal-content .control-select {
            width: 80%;
            max-width: 300px;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            outline: none;
            cursor: pointer;
        }
        .welcome-modal-content .control-select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2); }
        .welcome-modal-content button {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 12px 30px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .welcome-modal-content button:hover { background-color: #c0392b; /* Slightly darker red */ transform: translateY(-2px); }

        /* Responsive Ayarlamalar */
        @media (max-width: 992px) {
            .category-nav { display: none; }
            .hamburger-menu { display: flex; }
            .main-header { padding-bottom: 0.5rem; }
            .header-top { padding: 0.5rem 0; }
            .logo { font-size: 1.5rem; }
            .main-header .container { padding: 0.5rem 20px; }
            /* Ürün detay kısmı için responsive düzenlemeler - TEK SÜTUN */
            .product-detail-container {
                grid-template-columns: 1fr;
                padding: 20px 15px;
                gap: 20px;
            }
            .details { order: 2; padding-right: 0; }
            .image-gallery { order: 1; padding-left: 0; margin-bottom: 15px; align-items: center; }
            .image-gallery .main-media { border-radius: 10px; }
            /* Thumbnail-row için mobil responsive ayarlaması, 7 adet 60px yan yana sığmazsa otomatik olarak alt satıra geçmesini sağlar */
            /* Eğer bu boyutta da 7 adet yan yana kaydırılabilir olsun isterseniz aşağıdaki medya sorgusunu kaldırın ve üstteki width: fit-content; kalsın. */
            .thumbnail-row {
                grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); /* Esnek otomatik sığdırma */
                gap: 5px;
                width: 100%; /* Kapsayıcının tamamını kapla */
            }
            .thumbnail-row .thumbnail-item { width: 50px; height: 50px; border-radius: 6px; }
            .details h1 { font-size: 1.8rem; }
            .new-price { font-size: 1.4rem; }
            .old-price { font-size: 1rem; }
            .btn { padding: 10px 15px; font-size: 0.95rem; }
            .description-section { padding: 20px; margin: 20px auto; }
            .description-section h2 { font-size: 1.3rem; }

            /* Varyant seçiciler için responsive (Tablet) */
            .color-circle { width: 50px; height: 50px; }
            .color-name { font-size: 0.8rem; }
            /* Adet ve toplam için responsive */
            .quantity-control, .total-price-display {
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 10px;
            }
            .quantity-input { width: 60px; }
            .calculated-total-price { font-size: 1.6rem; }

            /* Benzer Varyantlar Responsive - GÜNCELLEMELER */
            .related-variants-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Tablet için 4 etiket yan yana */ gap: 15px; }
            .related-variant-card img { height: 160px; margin-bottom: 8px; }
            .related-variant-card { padding-bottom: 12px; }
            .related-variant-card .variant-name { font-size: 1rem; }
            .related-variant-card .old-price { font-size: 0.8em; }
            .related-variant-card .new-price { font-size: 1em; }
            .related-variant-card .free-shipping-tag { font-size: 0.75rem; padding: 3px 6px; }
            .related-variant-card .free-shipping-wrapper { margin-top: 8px; }

            /* Cart Page Responsive */
            .cart-item { flex-wrap: wrap; }
            .cart-item-image { margin-bottom: 10px; }
            .cart-item-details { flex-basis: 100%; margin-left: 0; }
            .cart-item-price, .cart-item .quantity-control, .remove-item-btn { margin-top: 10px; margin-left: 0; }
            .cart-item-price { order: -1; margin-right: auto; } /* Fiyatı yukarı sola taşı */
            .cart-item .quantity-control { order: 1; }
            .remove-item-btn { order: 2; margin-left: auto; }
            .cart-actions { flex-direction: column; align-items: flex-end; }
            .cart-actions .btn { width: 100%; }

            /* Checkout Page Responsive */
            .checkout-container { padding: 20px; }
            .checkout-container h1 { font-size: 1.8rem; }
        }

        @media (max-width: 767px) { /* Mobil ekranlar için */
            .product-detail-container { padding: 15px 10px; gap: 15px; }
            .image-gallery .main-media { border-radius: 8px; }
            /* Thumbnail-row için mobil responsive ayarlaması */
            /* Mobil için daha da dar olacağı için 7 adet 60px sığmayacaktır. */
            /* Bu durumda otomatik sığdırma ve daha küçük boyutlar daha iyi olacaktır. */
            .thumbnail-row {
                grid-template-columns: repeat(auto-fit, minmax(45px, 1fr)); /* Mobilde otomatik sığdırma ve daha küçük */
                gap: 5px;
            }
            .thumbnail-row .thumbnail-item { width: 45px; height: 45px; border-radius: 5px; }
            .details h1 { font-size: 1.6rem; }
            .new-price { font-size: 1.2rem; }
            .old-price { font-size: 0.9rem; }
            .actions { flex-direction: column; gap: 10px; }
            .btn { width: 100%; padding: 10px 15px; font-size: 0.9rem; }
            .free-shipping { font-size: 0.8rem; padding: 6px 12px; }
            .description-section { padding: 15px; margin: 15px auto; }
            .description-section h2 { font-size: 1.2rem; }

            .country-selector-container { padding: 1.5rem 0; }
            .country-selector-container label { font-size: 1rem; display: block; margin-bottom: 5px; }
            .country-selector-container .control-select { width: 80%; }

            /* En küçük ekranlarda varyant seçiciler için GÜNCELLEME */
            .variant-selectors { gap: 5px; justify-content: flex-start; }
            .color-option { flex-grow: 0; flex-shrink: 0; width: 70px; max-width: 70px; gap: 4px; }
            .color-circle { width: 60px; height: 60px; }
            .color-name { font-size: 0.75rem; }

            /* Benzer Varyantlar Responsive - GÜNCELLEMELER */
            .related-variants-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Mobilde 2 adet etiket yan yana */ gap: 10px; }
            .related-variant-card img { height: 120px; margin-bottom: 5px; }
            .related-variant-card { padding-bottom: 8px; }
            .related-variant-card .variant-name { font-size: 0.9rem; }
            .related-variant-card .old-price { font-size: 0.75em; }
            .related-variant-card .new-price { font-size: 0.9em; }
            .related-variant-card .free-shipping-tag { font-size: 0.65rem; padding: 2px 5px; }
            .related-variant-card .free-shipping-wrapper { margin-top: 5px; }

            /* Cart Page Responsive */
            .cart-item-image { width: 80px; height: 80px; }
            .cart-item-details h3 { font-size: 1rem; }
            .cart-item-price { font-size: 1rem; }
            .quantity-input { width: 50px; }
            .quantity-button { width: 30px; height: 30px; font-size: 1rem; }
            .remove-item-btn { font-size: 1.2rem; }
            .cart-summary p { font-size: 1rem; }
            .cart-empty-message { font-size: 1rem; }

            /* En Küçük Mobil Ekranlar (örneğin 320px) */
            @media (max-width: 480px) {
                .product-grid { gap: 8px; }
                .product-image-link { height: 110px; }
                .product-name { font-size: 0.8rem; height: auto; }
                .discounted-price { font-size: 0.95rem; }
                .original-price { font-size: 0.7rem; }
                .product-info { padding: 0.4rem; padding-bottom: 20px; }
                .free-shipping-tag { font-size: 0.65rem; padding: 1px 5px; bottom: 5px; }
                .product-card { padding-bottom: 25px; }
                /* Küçük ekranlarda modal düzenlemesi */
                .welcome-modal-content { padding: 20px; }
                .welcome-modal-content h2 { font-size: 1.5rem; }
                .welcome-modal-content p { font-size: 1rem; }
                .welcome-modal-content .control-select { width: 100%; }
                .welcome-modal-content button { padding: 10px 20px; font-size: 1rem; }
            }
        }
    </style>
</head>
<body>
    <div id="welcomeModalOverlay" class="welcome-modal-overlay">
        <div class="welcome-modal-content">
            <h2 id="welcome-modal-title"></h2>
            <p id="welcome-modal-message"></p>
            <select id="welcomeCountrySelect" class="control-select"></select>
            <button id="welcomeModalConfirmButton"></button>
        </div>
    </div>

    <div class="promo-bar">
        <span id="promo-text-content" class="promo-text"></span>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <i class="fa-solid fa-couch fa-bounce" style="font-size: 3rem;"></i>
        <p id="loading-text"></p>
    </div>
    <div id="mobile-nav-overlay" class="mobile-nav-overlay"></div>
    <header class="main-header">
        <div class="header-top">
            <a href="#home" class="logo" id="main-logo-link">
            </a>
        </div>
        <div class="container">
            <button class="hamburger-menu" id="hamburger-menu-btn" aria-label="Menüyü aç/kapat"><span></span><span></span><span></span></button>
            <div class="header-controls">
                <select id="language-selector" class="control-select"></select>
                <select id="currency-selector" class="control-select"></select>
                <a href="#cart" class="cart-icon" id="cart-page-link" title="">
                    <i class="fa-solid fa-cart-shopping"></i><span class="cart-badge">0</span>
                </a>
            </div>
        </div>
    </header>
    <nav id="mobile-nav" class="mobile-nav"></nav>
    <nav class="category-nav"><div class="container"><ul id="category-menu-container"></ul></div></nav>

    <main class="container">
        <section id="home-page" class="page-content active">
            <section class="hero-banner" id="hero-banner-container"><div class="slide-nav"></div></section>
            <section id="main-product-section" class="section featured-products">
                <h1 class="section-title" id="main-section-title"></h1>
                <div class="product-grid" id="product-grid-container"></div>
            </section>
            <div id="dynamic-product-sections"></div>
        </section>

        <section id="product-page" class="page-content" style="background-color: var(--product-detail-background); border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
            <div class="product-detail-container">
                <div class="image-gallery">
                    <div id="main-media-display"></div>
                    <div class="thumbnail-row" id="thumbnail-row"></div>
                </div>

                <div class="details">
                    <h1 id="product-title"></h1>
                    <div class="price">
                        <span class="old-price" id="product-old-price"></span>
                        <span class="new-price" id="product-price"></span>
                    </div>
                    
                    <div class="variant-section">
                        <span class="variant-title" id="variant-selector-label"></span>
                        <div class="variant-selectors" id="variant-selectors">
                        </div>
                    </div>
                    <div class="quantity-control">
                        <label for="quantity-input" id="quantity-label"></label>
                        <button type="button" id="decrease-quantity" class="quantity-button">-</button>
                        <input type="number" id="quantity-input" class="quantity-input" value="1" min="1" max="99">
                        <button type="button" id="increase-quantity" class="quantity-button">+</button>
                    </div>
                    <div class="total-price-display">
                        <span class="total-price-label" id="total-price-label"></span>
                        <span class="calculated-total-price" id="calculated-total-price"></span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" id="btn-add-to-cart"></button>
                        <button class="btn btn-secondary" id="btn-buy-now"></button>
                    </div>
                    <div id="free-shipping" class="free-shipping" style="display:none;"></div>
                </div>
            </div>
            <div class="description-section">
                <h2 id="product-details-heading"></h2>
                <p id="product-description"></p>
            </div>
            <section class="related-variants-section">
                <div class="container">
                    <h2 id="related-variants-title"></h2>
                    <div class="related-variants-grid" id="related-variants-grid">
                    </div>
                </div>
            </section>
        </section>

        <section id="cart-page" class="page-content">
            <div class="cart-container">
                <h1 id="cart-page-title"></h1>
                <div class="cart-items" id="cart-items-container">
                    </div>
                <p id="cart-empty-message" class="cart-empty-message" style="display:none;"></p>
                <div class="cart-summary">
                    <p id="cart-subtotal-label"></p>
                    <p id="cart-shipping-label"></p>
                    <p id="cart-total-label"></p>
                </div>
                <div class="cart-actions">
                    <button id="continue-shopping-btn" class="btn btn-primary"></button>
                    <button id="proceed-to-checkout-btn" class="btn btn-secondary"></button>
                </div>
            </div>
        </section>

        <section id="checkout-page" class="page-content">
            <div class="checkout-container">
                <h1 id="checkout-page-title"></h1>
                <form id="checkout-form" class="checkout-form">
                    <div class="form-section">
                        <h2 id="shipping-address-heading"></h2>
                        <div class="form-group">
                            <label for="shipping-firstName" id="label-firstName"></label>
                            <input type="text" id="shipping-firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="shipping-lastName" id="label-lastName"></label>
                            <input type="text" id="shipping-lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="shipping-address" id="label-address"></label>
                            <input type="text" id="shipping-address" required>
                        </div>
                        <div class="form-group">
                            <label for="shipping-city" id="label-city"></label>
                            <input type="text" id="shipping-city" required>
                        </div>
                        <div class="form-group">
                            <label for="shipping-zipCode" id="label-zipCode"></label>
                            <input type="text" id="shipping-zipCode" required>
                        </div>
                        <div class="form-group">
                            <label for="shipping-country" id="label-country"></label>
                            <select id="shipping-country" class="control-select" required></select>
                        </div>
                    </div>

                    <div class="form-section" style="margin-top: 2rem;">
                        <h2 id="contact-info-heading"></h2>
                        <div class="form-group">
                            <label for="contact-email" id="label-email"></label>
                            <input type="email" id="contact-email" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-phone" id="label-phone"></label>
                            <input type="tel" id="contact-phone" required>
                        </div>
                    </div>

                    <div class="form-section" style="margin-top: 2rem;">
                        <h2 id="payment-method-heading"></h2>
                        <div class="form-group">
                            <label for="payment-method" id="label-paymentMethod"></label>
                            <select id="payment-method" required>
                                <option value="cash_on_delivery" id="option-cashOnDelivery"></option>
                                <option value="credit_card" id="option-creditCard"></option>
                            </select>
                        </div>
                    </div>

                    <div class="checkout-summary">
                        <h2 id="order-summary-heading"></h2>
                        <div id="checkout-summary-items-container">
                            </div>
                        <div class="summary-item"><span id="checkout-subtotal-label"></span> <span id="checkout-subtotal-value"></span></div>
                        <div class="summary-item"><span id="checkout-shipping-label"></span> <span id="checkout-shipping-value"></span></div>
                        <div class="summary-total"><span id="checkout-total-label"></span> <span id="checkout-total-value"></span></div>
                    </div>

                    <div class="checkout-actions">
                        <button type="button" id="back-to-cart-btn" class="btn btn-primary"></button>
                        <button type="submit" id="place-order-btn" class="btn btn-secondary"></button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 id="footer-title-pufemo"></h4>
                    <p id="footer-desc-pufemo"></p>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-fast-links"></h4>
                    <ul>
                        <li><a href="#" id="footer-link-about"></a></li>
                        <li><a href="#" id="footer-link-contact"></a></li>
                        <li><a href="#" id="footer-link-privacy"></a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-follow-us"></h4>
                    <ul>
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Instagram</a></li>
                        <li><a href="#">Pinterest</a></li>
                    </ul>
                </div>
            </div>

            <div class="country-selector-container">
                <label for="country-selector" id="country-selector-label"></label>
                <select id="country-selector" class="control-select"></select>
            </div>

            <div class="footer-bottom" id="footer-copyright"></div>
        </div>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script type="module">
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
        };
        
        let db;
        let auth;
        let storage;

        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
        } catch (e) {
            console.error("Firebase başlatma hatası!", e);
            if (document.getElementById('loading-overlay')) document.getElementById('loading-overlay').classList.add('hidden');
            const defaultLangOnError = 'tr'; // Firebase başlatılamazsa varsayılan dil
            if (document.getElementById('loading-text')) document.getElementById('loading-text').textContent = "Hata: Sayfa yüklenemedi!";
            if (document.getElementById('main-section-title')) document.getElementById('main-section-title').textContent = "Ürünler Yüklenemedi";
            if (document.getElementById('footer-title-pufemo')) document.getElementById('footer-title-pufemo').textContent = "PUFEMO";
            // Disable critical elements if Firebase fails
            document.querySelectorAll('button, select, input').forEach(el => el.disabled = true);
            document.getElementById('cart-page-link').removeAttribute('href');
            document.getElementById('main-logo-link').removeAttribute('href');
        }

        // Global State Variables
        let siteData = {
            settings: {
                languages: [],
                banner: [], // Başlangıçta boş bir dizi
                general: { logo: {}, promoBar: {} },
                countryPricing: {},
                currencySymbols: {},
                exchangeRates: {} // Not used for now, but kept for future expansion
            },
            categories: { tree: [] },
            products: [],
            cart: []
        };
        let currentLang = localStorage.getItem('pufemo-language') || 'tr';
        let currentCurrency = localStorage.getItem('pufemo-currency') || 'USD';
        let currentCountryCode = localStorage.getItem('pufemo-country') || '';
        let currentProductData = null; // For product detail page
        let productContentGlobal = {}; // For product detail page

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingTextP = document.getElementById('loading-text');
        const welcomeModalOverlay = document.getElementById('welcomeModalOverlay');
        const welcomeCountrySelect = document.getElementById('welcomeCountrySelect');
        const welcomeModalConfirmButton = document.getElementById('welcomeModalConfirmButton');
        const welcomeModalTitle = document.getElementById('welcome-modal-title');
        const welcomeModalMessage = document.getElementById('welcome-modal-message');

        const mainLogoLink = document.getElementById('main-logo-link');
        const languageSelector = document.getElementById('language-selector');
        const currencySelector = document.getElementById('currency-selector');
        const countrySelector = document.getElementById('country-selector');
        const cartPageLink = document.getElementById('cart-page-link');
        const cartBadge = document.querySelector('.cart-badge');
        const hamburgerBtn = document.getElementById('hamburger-menu-btn');
        const mobileNav = document.getElementById('mobile-nav');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const promoBar = document.querySelector('.promo-bar');
        const promoTextContent = document.getElementById('promo-text-content');
        const categoryMenuContainer = document.getElementById('category-menu-container');

        // Page Sections
        const homePage = document.getElementById('home-page');
        const productPage = document.getElementById('product-page');
        const cartPage = document.getElementById('cart-page');
        const checkoutPage = document.getElementById('checkout-page');

        // Home Page Elements
        const heroBannerContainer = document.getElementById('hero-banner-container');
        const mainProductSection = document.getElementById('main-product-section');
        const mainSectionTitle = document.getElementById('main-section-title');
        const productGridContainer = document.getElementById('product-grid-container');
        const dynamicProductSections = document.getElementById('dynamic-product-sections');

        // Product Page Elements
        const mainMediaDisplayEl = document.getElementById("main-media-display");
        const thumbnailRowEl = document.getElementById("thumbnail-row");
        const productTitleEl = document.getElementById("product-title");
        const productOldPriceEl = document.getElementById("product-old-price");
        const productPriceEl = document.getElementById("product-price");
        const freeShippingEl = document.getElementById("free-shipping");
        const productDescriptionEl = document.getElementById("product-description");
        const btnAddToCart = document.getElementById('btn-add-to-cart');
        const btnBuyNow = document.getElementById('btn-buy-now');
        const productDetailsHeadingEl = document.getElementById('product-details-heading');
        const variantSectionEl = document.querySelector('.variant-section');
        const variantTitleEl = document.getElementById('variant-selector-label');
        const variantSelectorsEl = document.getElementById('variant-selectors');
        const quantityInputEl = document.getElementById('quantity-input');
        const quantityLabelEl = document.getElementById('quantity-label');
        const decreaseQuantityBtn = document.getElementById('decrease-quantity');
        const increaseQuantityBtn = document.getElementById('increase-quantity');
        const totalPriceLabelEl = document.getElementById('total-price-label');
        const calculatedTotalPriceEl = document.getElementById('calculated-total-price');
        const relatedVariantsGridEl = document.getElementById('related-variants-grid');
        const relatedVariantsTitleEl = document.getElementById('related-variants-title');

        // Cart Page Elements
        const cartPageTitle = document.getElementById('cart-page-title');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartEmptyMessage = document.getElementById('cart-empty-message');
        const cartSubtotalLabel = document.getElementById('cart-subtotal-label');
        const cartShippingLabel = document.getElementById('cart-shipping-label');
        const cartTotalLabel = document.getElementById('cart-total-label');
        const continueShoppingBtn = document.getElementById('continue-shopping-btn');
        const proceedToCheckoutBtn = document.getElementById('proceed-to-checkout-btn');

        // Checkout Page Elements
        const checkoutPageTitle = document.getElementById('checkout-page-title');
        const shippingFirstName = document.getElementById('shipping-firstName');
        const shippingLastName = document.getElementById('shipping-lastName');
        const shippingAddress = document.getElementById('shipping-address');
        const shippingCity = document.getElementById('shipping-city');
        const shippingZipCode = document.getElementById('shipping-zipCode');
        const shippingCountrySelect = document.getElementById('shipping-country');
        const contactEmail = document.getElementById('contact-email');
        const contactPhone = document.getElementById('contact-phone');
        const paymentMethod = document.getElementById('payment-method');
        const checkoutSummaryItemsContainer = document.getElementById('checkout-summary-items-container');
        const checkoutSubtotalLabel = document.getElementById('checkout-subtotal-label');
        const checkoutSubtotalValue = document.getElementById('checkout-subtotal-value');
        const checkoutShippingLabel = document.getElementById('checkout-shipping-label');
        const checkoutShippingValue = document.getElementById('checkout-shipping-value');
        const checkoutTotalLabel = document.getElementById('checkout-total-label');
        const checkoutTotalValue = document.getElementById('checkout-total-value');
        const backToCartBtn = document.getElementById('back-to-cart-btn');
        const placeOrderBtn = document.getElementById('place-order-btn');

        // Labels for Checkout Form
        const labelFirstName = document.getElementById('label-firstName');
        const labelLastName = document.getElementById('label-lastName');
        const labelAddress = document.getElementById('label-address');
        const labelCity = document.getElementById('label-city');
        const labelZipCode = document.getElementById('label-zipCode');
        const labelCountry = document.getElementById('label-country');
        const labelEmail = document.getElementById('label-email');
        const labelPhone = document.getElementById('label-phone');
        const labelPaymentMethod = document.getElementById('label-paymentMethod');
        const optionCashOnDelivery = document.getElementById('option-cashOnDelivery');
        const optionCreditCard = document.getElementById('option-creditCard');
        const shippingAddressHeading = document.getElementById('shipping-address-heading');
        const contactInfoHeading = document.getElementById('contact-info-heading');
        const paymentMethodHeading = document.getElementById('payment-method-heading');
        const orderSummaryHeading = document.getElementById('order-summary-heading');


        // Statik Çeviriler ve Metinler
        const staticTranslations = {
            'loading_text': { tr: 'PUFEMO Yükleniyor...', en: 'Loading PUFEMO...', el: 'Φόρτωση PUFEMO...', ru: 'Загрузка PUFEMO...', de: 'PUFEMO wird geladen...', fr: 'Chargement de PUFEMO...', it: 'Caricamento PUFEMO...' },
            'mobile_menu_title': { tr: 'Kategoriler', en: 'Categories', el: 'Κατηγορίες', ru: 'Категории', de: 'Kategorien', fr: 'Catégories', it: 'Categorie' },
            'main_section_title': { tr: 'Öne Çıkan Ürünler', en: 'Featured Products', el: 'Προτεινόμενα Προϊόντα', ru: 'Рекомендуемые товары', de: 'Ausgewählte Produkte', fr: 'Produits Phares', it: 'Prodotti in Evidenza' },
            'footer-title-pufemo': { tr: 'PUFEMO', en: 'PUFEMO', el: 'PUFEMO', ru: 'ПУΦΕΜΟ', de: 'PUFEMO', fr: 'PUFEMO', it: 'PUFEMO' },
            'footer-desc-pufemo': { tr: 'Hayallerinizdeki konforu ve estetiği evinize taşıyoruz.', en: 'We bring the comfort and aesthetics of your dreams to your home.', el: 'Φέρνουμε την άνεση και την αισθητική των ονείρων σας στο σπίτι σας.', ru: 'Мы приносим комфорт и эстетику в ваш дом.', de: 'Wir bringen den Komfort und die Ästhetik Ihrer Träume in Ihr Zuhause.', fr: 'Nous apportons le confort et l\'esthétique de vos rêves à votre maison.', it: 'Portiamo il comfort e l\'estetica dei vostri sogni nella vostra casa.' },
            'footer-title-fast-links': { tr: 'Hızlı Bağlantılar', en: 'Quick Links', el: 'Γρήγοροι Σύνδεσμοι', ru: 'Быстрые ссылки', de: 'Schnelllinks', fr: 'Liens Rapides', it: 'Link Veloci' },
            'footer-link-about': { tr: 'Hakkımızda', en: 'About Us', el: 'Σχετικά με εμάς', ru: 'О нас', de: 'Über Uns', fr: 'À Propos', it: 'Chi Siamo' },
            'footer-link-contact': { tr: 'İletişim', en: 'Contact', el: 'Επικοινωνία', ru: 'Контакт', de: 'Kontakt', fr: 'Contact', it: 'Contatti' },
            'footer-link-privacy': { tr: 'Gizlilik Politikası', en: 'Privacy Policy', el: 'Πολιτική Απορρήτου', ru: 'Политика конфиденциальности', de: 'Datenschutzbestimmungen', fr: 'Politique de Confidentialité', it: 'Informativa sulla Privacy' },
            'footer-title-follow-us': { tr: 'Bizi Takip Edin', en: 'Follow Us', el: 'Ακολουθήστε μας', ru: 'Следите за нами', de: 'Folgen Sie Uns', fr: 'Suivez-nous', it: 'Seguici' },
            'footer-copyright': { tr: '&copy; 2025 PUFEMO.COM | Tüm Hakları Saklıdır.', en: '&copy; 2025 PUFEMO.COM | All Rights Reserved.', el: '&copy; 2025 PUFEMO.COM | Με την επιφύλαξη παντός δικαιώματος.', ru: '&copy; 2025 PUFEMO.COM | Все права защищены.', de: '&copy; 2025 PUFEMO.COM | Alle Rechte vorbehalten.', fr: '&copy; 2025 PUFEMO.COM | Tous droits réservés.', it: '&copy; 2025 PUFEMO.COM | Tutti i diritti riservati.' },
            'default_button_text': { tr: 'Alışverişe Başla', en: 'Shop Now', el: 'Αγοράστε τώρα', ru: 'Купить сейчас', de: 'Jetzt einkaufen', fr: 'Acheter jetzt', it: 'Acquista ora' },
            'free_shipping_text': { tr: 'Ücretsiz Kargo', en: 'Free Shipping', el: 'Δωρεάν Αποστολή', ru: 'Бесплатная доставка', de: 'Kostenloser Versand', fr: 'Livraison Gratuite', it: 'Spedizione Gratuita' },
            'free_shipping_promo': { tr: 'Ücretsiz Kargo Fırsatını Kaçırmayın!', en: 'Don\'t Miss Free Shipping!', el: 'Μην χάσετε τη δωρεάν αποστολή!', ru: 'Не пропустите бесплатную доставку!', de: 'Verpassen Sie nicht den kostenlosen Versand!', fr: 'Ne manquez pas la livraison gratuite !', it: 'Non perdere la spedizione gratuita!' },
            'country_selector_label': { tr: 'Ülke Seçimi:', en: 'Select Country:', el: 'Επιλέξτε Χώρα:', ru: 'Выбрать страну:', de: 'Land auswählen:', fr: 'Sélectionner le pays :', it: 'Seleziona Paese:' },
            'welcome_modal_title': { tr: 'Hoş Geldiniz!', en: 'Welcome!', el: 'Καλώς ήρθατε!', ru: 'Добро пожаловать!', de: 'Willkommen!', fr: 'Bienvenue !', it: 'Benvenuto!' },
            'welcome_modal_message': { tr: 'Lütfen ülkenizi seçin.', en: 'Please select your country below.', el: 'Παρακαλώ επιλέξτε τη χώρα σας παρακάτω.', ru: 'Пожалуйста, выберите свою страну ниже.', de: 'Bitte wählen Sie Ihr Land unten aus.', fr: 'Veuillez sélectionner votre pays ci-dessous.', it: 'Seleziona il tuo paese qui sotto.' },
            'welcome_modal_confirm_button': { tr: 'Devam Et', en: 'Continue', el: 'Συνέχεια', ru: 'Продолжить', de: 'Weiter', fr: 'Continuer', it: 'Continua' },
            'cart_page_link_title': { tr: 'Sepetim', en: 'My Cart', el: 'Το καλάθι μου', ru: 'Моя корзина', de: 'Mein Warenkorb', fr: 'Mon Panier', it: 'Il mio Carrello' },
            'untitled_product': { tr: 'İsimsiz Ürün', en: 'Untitled Product', el: 'Προϊόν χωρίς τίτλο', ru: 'Товар без названия', de: 'Unbenanntes Produkt', fr: 'Produit sans titre', it: 'Prodotto senza titolo' },
            'no_image': { tr: 'Resim Yok', en: 'No Image', el: 'Χωρίς Εικόνα', ru: 'Нет изображения', de: 'Kein Bild', fr: 'Pas d\'image', it: 'Nessuna immagine' },

            // Product Page Specific
            'product_title_default': { tr: 'Ürün Başlığı', en: 'Product Title', el: 'Τίτλος Προϊόντος', ru: 'Название продукта', de: 'Produkttitel', fr: 'Titre du Produit', it: 'Titolo Prodotto' },
            'product_description_loading': { tr: 'Yükleniyor...', en: 'Loading...', el: 'Φορτώνεται...', ru: 'Загрузка...', de: 'Wird geladen...', fr: 'Chargement...', it: 'Caricamento...' },
            'product_description_no_info': { tr: 'Bu ürün hakkında detaylı bilgi bulunmamaktadır.', en: 'No detailed information is available for this product.', el: 'Δεν υπάρχουν διαθέσιμες λεπτομέρειες για αυτό το προϊόν.', ru: 'Подробная информация об этом продукте отсутствует.', de: 'Keine detaillierten Informationen zu diesem Produkt verfügbar.', fr: 'Aucune information détaillée n\'est disponible pour ce prodotto.', it: 'Nessuna informazione dettagliata disponibile per questo prodotto.' },
            'product_not_found_title': { tr: 'Ürün Bulunamadı', en: 'Product Not Found', el: 'Το προϊόν δεν βρέθηκε', ru: 'Продукт не найден', de: 'Produkt nicht gefunden', fr: 'Produit non trouvé', it: 'Prodotto non trovato' },
            'product_not_found_desc': { tr: 'Aradığınız ürün bulunamamaktadır.', en: 'The product you are looking for cannot be found.', el: 'Το προϊόν που αναζητάτε δεν μπορεί να βρεθεί.', ru: 'Искомый товар не найден.', de: 'Das gesuchte Produkt konnte nicht gefunden werden.', fr: 'Le produit que vous recherchez est introuvable.', it: 'Il prodotto che stai cercando non è stato trovato.' },
            'error_loading_product_title': { tr: 'Hata Oluştu', en: 'Error Occurred', el: 'Σφάλμα παρουσιάστηκε', ru: 'Произошла ошибка', de: 'Fehler aufgetreten', fr: 'Erreur survenue', it: 'Si è verificato un errore' },
            'error_loading_product_desc': { tr: 'Ürün bilgileri yüklenemedi. Lütfen daha sonra tekrar deneyin.', en: 'Product information could not be loaded. Please try again later.', el: 'Δεν ήταν δυνατή η φόρτωση των πληροφοριών προϊόντος. Παρακαλώ δοκιμάστε ξανά αργότερα.', ru: 'Не удалось загрузить информацию о товаре. Пожалуйста, попробуйте еще раз позже.', de: 'Produktinformationen konnten nicht geladen werden. Bitte versuchen Sie es später erneut.', fr: 'Les informations sur le produit n\'ont pas pu être chargées. Veuillez réessayer plus tard.', it: 'Impossibile caricare le informazioni sul prodotto. Si prega di riprovare più tardi.' },
            'add_to_cart_button': { tr: 'Sepete Ekle', en: 'Add to Cart', el: 'Προσθήκη στο καλάθι', ru: 'Добавить в корзину', de: 'In den Warenkorb', fr: 'Ajouter au panier', it: 'Aggiungi al carrello' },
            'buy_now_button': { tr: 'Şimdi Al', en: 'Buy Now', el: 'Αγορά τώρα', ru: 'Купить сейчас', de: 'Jetzt kaufen', fr: 'Acheter maintenant', it: 'Acquista ora' },
            'product_details_heading': { tr: 'Ürün Detayları', en: 'Product Details', el: 'Λεπτομέρειες προϊόντος', ru: 'Информация о продукте', de: 'Produktdetails', fr: 'Détails du Produit', it: 'Dettagli Prodotto' },
            'variant_selection_label': { tr: 'Renk Seçimi', en: 'Color Selection', el: 'Επιλογή Χρώματος', ru: 'Выбор цвета', de: 'Farbauswahl', fr: 'Sélection de couleur', it: 'Selezione Colore' },
            'unknown_color': { tr: 'Bilinmeyen Renk', en: 'Unknown Color', el: 'Άγνωστο Χρώμα', ru: 'Неизвестный цвет', de: 'Unbekannte Farbe', fr: 'Couleur inconnue', it: 'Colore sconosciuto' },
            'quantity_label': { tr: 'Adet:', en: 'Quantity:', el: 'Ποσότητα:', ru: 'Количество:', de: 'Menge:', fr: 'Quantité :', it: 'Quantità:' },
            'total_price_label': { tr: 'Genel Toplam:', en: 'Total:', el: 'Σύνολο:', ru: 'Итого:', de: 'Gesamt:', fr: 'Total :', it: 'Totale:' },
            'description_not_found_fallback': { tr: 'Açıklama bulunamadı.', en: 'Description not found.', el: 'Περιγραφή δεν βρέθηκε.', ru: 'Описание не найдено.', de: 'Beschreibung nicht gefunden.', fr: 'Description introuvable.', it: 'Descrizione non trovata.' },
            'related_products_title': { tr: 'Diğer Renk Varyantları', en: 'Other Color Variants', el: 'Άλλες Παραλλαγές Χρωμάτων', ru: 'Другие цветовые варианты', de: 'Andere Farbvarianten', fr: 'Autres Variantes de Couleur', it: 'Altre Varianti di Colore' },

            // Cart Page Specific
            'cart_page_title': { tr: 'Sepetim', en: 'My Cart', el: 'Το Καλάθι μου', ru: 'Моя Корзина', de: 'Mein Warenkorb', fr: 'Mon Panier', it: 'Il mio Carrello' },
            'cart_empty_message': { tr: 'Sepetinizde ürün bulunmamaktadır.', en: 'Your cart is empty.', el: 'Το καλάθι σας είναι άδειο.', ru: 'Ваша корзина пуста.', de: 'Ihr Warenkorb ist leer.', fr: 'Votre panier est vide.', it: 'Il tuo carrello è vuoto.' },
            'cart_subtotal_label': { tr: 'Ara Toplam:', en: 'Subtotal:', el: 'Υποσύνολο:', ru: 'Подытог:', de: 'Zwischensumme:', fr: 'Sous-total :', it: 'Subtotale:' },
            'cart_shipping_label': { tr: 'Kargo:', en: 'Shipping:', el: 'Μεταφορικά:', ru: 'Доставка:', de: 'Versand:', fr: 'Livraison :', it: 'Spedizione:' },
            'cart_total_label': { tr: 'Toplam:', en: 'Total:', el: 'Σύνολο:', ru: 'Иστοτ:', de: 'Gesamtsumme:', fr: 'Total :', it: 'Totale:' },
            'continue_shopping_button': { tr: 'Alışverişe Devam Et', en: 'Continue Shopping', el: 'Συνέχιση αγορών', ru: 'Продолжить покупки', de: 'Weiter einkaufen', fr: 'Continuer mes achats', it: 'Continua lo shopping' },
            'proceed_to_checkout_button': { tr: 'Kasaya Git', en: 'Proceed to Checkout', el: 'Προχωρήστε στην πληρωμή', ru: 'Перейти к оформлению', de: 'Zur Kasse gehen', fr: 'Passer à la caisse', it: 'Procedi al checkout' },
            'remove_item_button': { tr: 'Sil', en: 'Remove', el: 'Αφαίρεση', ru: 'Удалить', de: 'Entfernen', fr: 'Supprimer', it: 'Rimuovi' },

            // Checkout Page Specific
            'checkout_page_title': { tr: 'Ödeme', en: 'Checkout', el: 'Ολοκλήρωση αγοράς', ru: 'Оформление заказа', de: 'Kasse', fr: 'Paiement', it: 'Cassa' },
            'shipping_address_heading': { tr: 'Teslimat Adresi', en: 'Shipping Address', el: 'Διεύθυνση Αποστολής', ru: 'Адрес доставки', de: 'Lieferadresse', fr: 'Adresse de livraison', it: 'Indirizzo di spedizione' },
            'label_firstName': { tr: 'Ad', en: 'First Name', el: 'Όνομα', ru: 'Имя', de: 'Vorname', fr: 'Prénom', it: 'Nome' },
            'label_lastName': { tr: 'Soyad', en: 'Last Name', el: 'Επώνυμο', ru: 'ФаSoyad', de: 'Nachname', fr: 'Nom', it: 'Cognome' },
            'label_address': { tr: 'Adres', en: 'Address', el: 'Διεύθυνση', ru: 'Адрес', de: 'Adresse', fr: 'Adresse', it: 'Indirizzo' },
            'label_city': { tr: 'Şehir', en: 'City', el: 'Πόλη', ru: 'Город', de: 'Stadt', fr: 'Ville', it: 'Città' },
            'label_zipCode': { tr: 'Posta Kodu', en: 'Zip Code', el: 'Ταχυδρομικός Κώδικας', ru: 'Почтовый индекс', de: 'Postleitzahl', fr: 'Code Postal', it: 'CAP' },
            'label_country': { tr: 'Ülke', en: 'Country', el: 'Χώρα', ru: 'Страна', de: 'Land', fr: 'Pays', it: 'Paese' },
            'contact_info_heading': { tr: 'İletişim Bilgileri', en: 'Contact Information', el: 'Στοιχεία Επικοινωνίας', ru: 'Контактная информация', de: 'Kontaktdaten', fr: 'Coordonnées', it: 'Informazioni di contatto' },
            'label_email': { tr: 'E-posta', en: 'Email', el: 'Email', ru: 'Эл. почта', de: 'E-Mail', fr: 'E-mail', it: 'E-mail' },
            'label_phone': { tr: 'Telefon', en: 'Phone', el: 'Τηλέφωνο', ru: 'Телефон', de: 'Telefon', fr: 'Téléphone', it: 'Telefono' },
            'payment_method_heading': { tr: 'Ödeme Yöntemi', en: 'Payment Method', el: 'Μέθοδος Πληρωμής', ru: 'Метод оплаты', de: 'Zahlungsmethode', fr: 'Mode de paiement', it: 'Metodo di pagamento' },
            'label_paymentMethod': { tr: 'Ödeme Yöntemi Seçin', en: 'Select Payment Method', el: 'Επιλέξτε Μέθοδο Πληρωμής', ru: 'Выберите способ оплаты', de: 'Zahlungsmethode auswählen', fr: 'Sélectionner le mode de paiement', it: 'Seleziona metodo di pagamento' },
            'option_cashOnDelivery': { tr: 'Kapıda Ödeme', en: 'Cash on Delivery', el: 'Αντικαταβολή', ru: 'Наличными при доставке', de: 'Barzahlung bei Lieferung', fr: 'Paiement à la livraison', it: 'Pagamento alla consegna' },
            'option_creditCard': { tr: 'Kredi Kartı', en: 'Credit Card', el: 'Πιστωτική Κάρτα', ru: 'Кредитная карта', de: 'Kreditkarte', fr: 'Carte de crédit', it: 'Carta di credito' },
            'order_summary_heading': { tr: 'Sipariş Özeti', en: 'Order Summary', el: 'Σύνοψη Παραγγελίας', ru: 'Сводка заказа', de: 'Bestellübersicht', fr: 'Résumé de la commande', it: 'Riepilogo ordine' },
            'checkout_subtotal_label': { tr: 'Ara Toplam:', en: 'Subtotal:', el: 'Υποσύνολο:', ru: 'Подытог:', de: 'Zwischensumme:', fr: 'Sous-total :', it: 'Subtotale:' },
            'checkout_shipping_label': { tr: 'Kargo:', en: 'Shipping:', el: 'Μεταφορικά:', ru: 'Доставка:', de: 'Versand:', fr: 'Livraison :', it: 'Spedizione:' },
            'checkout_total_label': { tr: 'Genel Toplam:', en: 'Total:', el: 'Σύνολο:', ru: 'Итого:', de: 'Gesamt:', fr: 'Total :', it: 'Totale:' },
            'back_to_cart_button': { tr: 'Sepete Geri Dön', en: 'Back to Cart', el: 'Επιστροφή στο Καλάθι', ru: 'Вернуться в корзину', de: 'Zurück zum Warenkorb', fr: 'Retour au panier', it: 'Torna al carrello' },
            'place_order_button': { tr: 'Sipariş Ver', en: 'Place Order', el: 'Ολοκλήρωση Παραγγελίας', ru: 'Разместить заказ', de: 'Bestellung aufgeben', fr: 'Passer la commande', it: 'Effettua ordine' },
            'order_placed_success': { tr: 'Siparişiniz başarıyla alındı! Teşekkür ederiz.', en: 'Your order has been placed successfully! Thank you.', el: 'Η παραγγελία σας καταχωρήθηκε επιτυχώς! Ευχαριστούμε.', ru: 'Ваш заказ успешно размещен! Спасибо.', de: 'Ihre Bestellung wurde erfolgreich aufgegeben! Vielen Dank.', fr: 'Votre commande a été passée avec succès ! Merci.', it: 'Il tuo ordine è stato effettuato con successo! Grazie.' },
            'order_place_error': { tr: 'Siparişiniz verilirken bir hata oluştu. Lütfen tekrar deneyin.', en: 'An error occurred while placing your order. Please try again.', el: 'Παρουσιάστηκε σφάλμα κατά την καταχώρηση της παραγγελίας σας. Παρακαλώ δοκιμάστε ξανά.', ru: 'Произошла ошибка при размещении заказа. Пожалуйста, попробуйте еще раз.', de: 'Beim Aufgeben Ihrer Bestellung ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.', fr: 'Une erreur s\'est produite lors de la passation de votre commande. Veuillez réessayer.', it: 'Si è verificato un errore durante l\'invio dell\'ordine. Si prega di riprovare.' },

        };

        // Utility Functions
        function countryCodeToEmoji(code) {
            if (!code || code.length !== 2) return '';
            return code.toUpperCase().split('').map(char => String.fromCodePoint(char.charCodeAt(0) + 127397)).join('');
        }

        const translate = (key) => staticTranslations[key]?.[currentLang] || staticTranslations[key]?.['en'] || staticTranslations[key]?.['tr'] || '';

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        // --- Core Data Fetching ---
        async function fetchData() {
            showLoading();
            try {
                const [settingsDoc, categoriesDoc, productsSnap] = await Promise.all([
                    db.collection('pufemo').doc('settings').get(),
                    db.collection('pufemo').doc('categories').get(),
                    db.collection('pufemo-products').get() // Fetch all products, filter for showcase later
                ]);

                if (settingsDoc.exists) {
                    siteData.settings = { ...siteData.settings, ...settingsDoc.data() };
                } else {
                    console.warn('Settings document not found in Firebase.');
                }
                if (categoriesDoc.exists) {
                    siteData.categories = { ...siteData.categories, ...categoriesDoc.data() };
                } else {
                    console.warn('Categories document not found in Firebase.');
                }
                siteData.products = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Initialize cart from localStorage
                siteData.cart = JSON.parse(localStorage.getItem('pufemo-cart')) || [];

                // Determine initial country, language, currency
                const availableCountries = Object.keys(siteData.settings.countryPricing);

                if (localStorage.getItem('pufemo-country') && availableCountries.includes(localStorage.getItem('pufemo-country'))) {
                    currentCountryCode = localStorage.getItem('pufemo-country');
                } else if (availableCountries.length > 0) {
                    // If no country stored or invalid, default to first available country
                    currentCountryCode = availableCountries[0];
                    localStorage.setItem('pufemo-country', currentCountryCode);
                } else {
                    // Fallback if no countries are defined in DB
                    currentCountryCode = 'US';
                    localStorage.setItem('pufemo-country', currentCountryCode);
                }

                const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                if (selectedCountryData) {
                    currentLang = selectedCountryData.defaultLanguage || 'en';
                    const currencySymbol = selectedCountryData.currencySymbol;
                    currentCurrency = Object.keys(siteData.settings.currencySymbols || {}).find(key => siteData.settings.currencySymbols[key] === currencySymbol) || 'USD';
                } else {
                    currentLang = 'en';
                    currentCurrency = 'USD';
                }
                localStorage.setItem('pufemo-language', currentLang);
                localStorage.setItem('pufemo-currency', currentCurrency);

            } catch (e) {
                console.error("Failed to fetch initial data:", e);
                // Fallback to static defaults if Firebase data fetch fails
                currentLang = 'tr';
                currentCurrency = 'USD';
                currentCountryCode = 'US';
                localStorage.setItem('pufemo-language', currentLang);
                localStorage.setItem('pufemo-currency', currentCurrency);
                localStorage.setItem('pufemo-country', currentCountryCode);
            } finally {
                hideLoading();
            }
        }

        // --- Routing Logic (SPA) ---
        function navigateTo(path) {
            history.pushState(null, '', path);
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const path = window.location.hash.substring(1); // Get hash like 'product?id=xyz'
            const [pageId, queryString] = path.split('?');
            const params = new URLSearchParams(queryString);

            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));

            switch (pageId || 'home') {
                case 'home':
                    homePage.classList.add('active');
                    renderHomePage();
                    break;
                case 'product':
                    productPage.classList.add('active');
                    const productId = params.get('id');
                    loadProductDetails(productId);
                    break;
                case 'cart':
                    cartPage.classList.add('active');
                    renderCartPage();
                    break;
                case 'checkout':
                    if (siteData.cart.length === 0) {
                        navigateTo('#cart'); // Cannot go to checkout with empty cart
                        break;
                    }
                    checkoutPage.classList.add('active');
                    renderCheckoutPage();
                    break;
                default:
                    homePage.classList.add('active');
                    renderHomePage();
                    break;
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', renderCurrentPage);

        // --- General UI Rendering Functions (Header, Footer, Controls) ---
        function renderAllGlobalElements() {
            renderStaticText();
            setupControls();
            renderCategories();
            renderGeneralSiteElements();
            updateCartBadge(); // Update cart badge on every render
        }

        function renderStaticText() {
            document.documentElement.lang = currentLang;
            loadingTextP.textContent = translate('loading_text');
            welcomeModalTitle.textContent = translate('welcome_modal_title');
            welcomeModalMessage.textContent = translate('welcome_modal_message');
            welcomeModalConfirmButton.textContent = translate('welcome_modal_confirm_button');
            mainSectionTitle.textContent = translate('main_section_title');
            document.getElementById('footer-title-pufemo').textContent = translate('footer-title-pufemo');
            document.getElementById('footer-desc-pufemo').textContent = translate('footer-desc-pufemo');
            document.getElementById('footer-title-fast-links').textContent = translate('footer-title-fast-links');
            document.getElementById('footer-link-about').textContent = translate('footer-link-about');
            document.getElementById('footer-link-contact').textContent = translate('footer-link-contact');
            document.getElementById('footer-link-privacy').textContent = translate('footer-link-privacy');
            document.getElementById('footer-title-follow-us').textContent = translate('footer-title-follow-us');
            document.getElementById('footer-copyright').innerHTML = translate('footer-copyright');
            document.getElementById('country-selector-label').textContent = translate('country_selector_label');
            cartPageLink.title = translate('cart_page_link_title');

            // Product Page
            btnAddToCart.textContent = translate('add_to_cart_button');
            btnBuyNow.textContent = translate('buy_now_button');
            productDetailsHeadingEl.textContent = translate('product_details_heading');
            variantTitleEl.textContent = translate('variant_selection_label');
            quantityLabelEl.textContent = translate('quantity_label');
            totalPriceLabelEl.textContent = translate('total_price_label');
            relatedVariantsTitleEl.textContent = translate('related_products_title');
            freeShippingEl.textContent = translate('free_shipping_text');

            // Cart Page
            cartPageTitle.textContent = translate('cart_page_title');
            cartEmptyMessage.textContent = translate('cart_empty_message');
            cartSubtotalLabel.textContent = translate('cart_subtotal_label');
            cartShippingLabel.textContent = translate('cart_shipping_label');
            cartTotalLabel.textContent = translate('cart_total_label');
            continueShoppingBtn.textContent = translate('continue_shopping_button');
            proceedToCheckoutBtn.textContent = translate('proceed_to_checkout_button');

            // Checkout Page
            checkoutPageTitle.textContent = translate('checkout_page_title');
            shippingAddressHeading.textContent = translate('shipping_address_heading');
            labelFirstName.textContent = translate('label_firstName');
            labelLastName.textContent = translate('label_lastName');
            labelAddress.textContent = translate('label_address');
            labelCity.textContent = translate('label_city');
            labelZipCode.textContent = translate('label_zipCode');
            labelCountry.textContent = translate('label_country');
            contactInfoHeading.textContent = translate('contact_info_heading');
            labelEmail.textContent = translate('label_email');
            labelPhone.textContent = translate('label_phone');
            paymentMethodHeading.textContent = translate('payment_method_heading');
            labelPaymentMethod.textContent = translate('label_paymentMethod');
            optionCashOnDelivery.textContent = translate('option_cashOnDelivery');
            optionCreditCard.textContent = translate('option_creditCard');
            orderSummaryHeading.textContent = translate('order_summary_heading');
            checkoutSubtotalLabel.textContent = translate('checkout_subtotal_label');
            checkoutShippingLabel.textContent = translate('checkout_shipping_label');
            checkoutTotalLabel.textContent = translate('checkout_total_label');
            backToCartBtn.textContent = translate('back_to_cart_button');
            placeOrderBtn.textContent = translate('place_order_button');
        }

        function renderGeneralSiteElements() {
            const generalSettings = siteData.settings.general || {};

            // Logo
            if (mainLogoLink) {
                mainLogoLink.innerHTML = '';
                if (generalSettings.logo?.type === 'image' && generalSettings.logo.imageUrl) {
                    const img = document.createElement('img');
                    img.src = generalSettings.logo.imageUrl;
                    img.alt = generalSettings.logo.text || 'PUFEMO Logo';
                    if (generalSettings.logo.imageWidth) img.style.width = `${generalSettings.logo.imageWidth}px`;
                    if (generalSettings.logo.imageHeight) img.style.height = `${generalSettings.logo.imageHeight}px`;
                    mainLogoLink.appendChild(img);
                } else {
                    const icon = document.createElement('i');
                    icon.className = generalSettings.logo?.icon || 'fa-solid fa-couch';
                    icon.style.color = generalSettings.logo?.iconColor || 'var(--secondary-color)';
                    mainLogoLink.appendChild(icon);
                    const textNode = document.createTextNode(generalSettings.logo?.text ? ` ${generalSettings.logo.text}` : ' PUFEMO');
                    mainLogoLink.appendChild(textNode);
                    mainLogoLink.style.color = generalSettings.logo?.textColor || 'var(--primary-color)';
                }
                mainLogoLink.onclick = (e) => { e.preventDefault(); navigateTo('#home'); };
            }

            // Promo Bar
            if (promoBar && promoTextContent) {
                promoBar.style.backgroundColor = generalSettings.promoBar?.bgColor || 'var(--secondary-color)';
                promoBar.style.color = generalSettings.promoBar?.textColor || 'var(--light-text-color)';
                promoBar.style.fontSize = generalSettings.promoBar?.fontSize || '0.95rem';
                const scrollSpeed = generalSettings.promoBar?.scrollSpeed || '20s';
                promoTextContent.style.animationDuration = scrollSpeed;
                const promoText = generalSettings.promoBar?.text?.[currentLang] || translate('free_shipping_promo');
                promoTextContent.textContent = promoText;
                promoBar.style.display = generalSettings.promoBar?.enabled ? 'block' : 'none';
            }
        }

        function renderCategories() {
            const desktopContainer = document.getElementById('category-menu-container');
            const mobileContainer = document.getElementById('mobile-nav');
            const categories = siteData.categories?.tree || [];

            desktopContainer.innerHTML = '';
            mobileContainer.innerHTML = '';

            if (categories.length === 0) return;

            const mobileMenuTitle = translate('mobile_menu_title');
            mobileContainer.innerHTML += `<div class="mobile-nav-header">${mobileMenuTitle}</div>`;

            const createMenu = (categoryArray) => {
                const ul = document.createElement('ul');
                categoryArray.forEach(cat => {
                    const li = document.createElement('li');
                    // Category links do not yet filter products, so they go to home
                    li.innerHTML = `<a href="#home">${cat.name[currentLang] || cat.name.tr}</a>`;
                    if (cat.children && cat.children.length > 0) li.appendChild(createMenu(cat.children));
                    ul.appendChild(li);
                });
                return ul;
            };

            categories.forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#home">${cat.name[currentLang] || cat.name.tr}</a>`;
                desktopContainer.appendChild(li);
            });

            mobileContainer.appendChild(createMenu(categories));
        }

        function setupControls() {
            // Language Selector
            const languagesFromDB = siteData.settings.languages || [];
            languageSelector.innerHTML = languagesFromDB.map(l => `<option value="${l.code}">${countryCodeToEmoji(l.flag)} ${l.name}</option>`).join('');
            languageSelector.value = currentLang;
            languageSelector.style.display = languagesFromDB.length > 0 ? 'block' : 'none';
            languageSelector.onchange = (e) => {
                currentLang = e.target.value;
                localStorage.setItem('pufemo-language', currentLang);
                renderAllGlobalElements();
                renderCurrentPage(); // Re-render current page to apply language changes
            };

            // Currency Selector
            const currencies = siteData.settings?.currencySymbols || {};
            const availableCurrencies = Object.keys(currencies);
            currencySelector.innerHTML = availableCurrencies.map(c => {
                const symbol = currencies[c] || c;
                return `<option value="${c}">${symbol} ${c}</option>`;
            }).join('');
            currencySelector.value = currentCurrency;
            currencySelector.style.display = availableCurrencies.length > 0 ? 'block' : 'none';
            currencySelector.onchange = (e) => {
                currentCurrency = e.target.value;
                localStorage.setItem('pufemo-currency', currentCurrency);
                renderAllGlobalElements();
                renderCurrentPage(); // Re-render current page to apply currency changes
            };

            // Country Selector (Footer and Welcome Modal)
            const countries = siteData.settings.countryPricing || {};
            const countryOptionsHtml = Object.entries(countries).map(([code, data]) => {
                const countryName = data.name?.[currentLang] || data.name?.['tr'] || code.toUpperCase();
                return `<option value="${code}">${countryCodeToEmoji(data.flag)} ${countryName}</option>`;
            }).join('');

            if (Object.keys(countries).length > 0) {
                countrySelector.innerHTML = countryOptionsHtml;
                countrySelector.value = currentCountryCode;
                countrySelector.parentElement.style.display = 'block';

                welcomeCountrySelect.innerHTML = countryOptionsHtml;
                welcomeCountrySelect.value = currentCountryCode;
                shippingCountrySelect.innerHTML = countryOptionsHtml; // For checkout page
                shippingCountrySelect.value = currentCountryCode; // Set initial value for checkout
            } else {
                countrySelector.parentElement.style.display = 'none';
                welcomeModalOverlay.classList.remove('active');
            }

            countrySelector.onchange = (e) => { applyCountryAndRender(e.target.value); };

            // Welcome Modal Confirm Button
            welcomeModalConfirmButton.onclick = function() {
                const selectedCountry = welcomeCountrySelect.value;
                if (selectedCountry) {
                    applyCountryAndRender(selectedCountry);
                    welcomeModalOverlay.classList.remove('active');
                } else {
                    alert(translate('welcome_modal_message').replace('Lütfen ülkenizi seçin.', 'Lütfen devam etmek için bir ülke seçin.'));
                }
            };

            // Hamburger Menu
            const toggleMenu = () => {
                hamburgerBtn.classList.toggle('open');
                mobileNav.classList.toggle('open');
                mobileNavOverlay.classList.toggle('open');
                document.body.classList.toggle('mobile-menu-open');
            };
            hamburgerBtn.onclick = toggleMenu;
            mobileNavOverlay.onclick = toggleMenu;
            mobileNav.onclick = (e) => { if (e.target.tagName === 'A') toggleMenu(); }; // Close menu if a link is clicked

            // Cart Icon Link
            cartPageLink.onclick = (e) => { e.preventDefault(); navigateTo('#cart'); };
        }

        function applyCountryAndRender(countryCode) {
            currentCountryCode = countryCode;
            localStorage.setItem('pufemo-country', currentCountryCode);

            const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
            if (selectedCountryData) {
                currentLang = selectedCountryData.defaultLanguage || 'en';
                const currencySymbol = selectedCountryData.currencySymbol;
                currentCurrency = Object.keys(siteData.settings.currencySymbols || {}).find(key => siteData.settings.currencySymbols[key] === currencySymbol) || 'USD';
            } else {
                currentLang = 'en';
                currentCurrency = 'USD';
            }
            localStorage.setItem('pufemo-language', currentLang);
            localStorage.setItem('pufemo-currency', currentCurrency);

            renderAllGlobalElements();
            renderCurrentPage(); // Re-render current page with new country/lang/currency
        }

        function updateCartBadge() {
            const totalItems = siteData.cart.reduce((sum, item) => sum + item.quantity, 0);
            cartBadge.textContent = totalItems;
        }

        function formatPrice(basePrice, discountPrice = null) {
            const symbols = siteData.settings?.currencySymbols || {};
            const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
            let priceToFormat = discountPrice !== null ? discountPrice : basePrice;

            if (selectedCountryData && typeof selectedCountryData.adjustment === 'number') {
                const adjustmentPercentage = selectedCountryData.adjustment / 100;
                priceToFormat = priceToFormat * (1 + adjustmentPercentage);
            }

            // Note: exchangeRates are not fetched/used in this version, assumes prices are relative to TRY base and adjusted.
            // If actual currency conversion is needed, firebase.firestore().collection('exchangeRates').doc('rates').get() would be needed.
            const rates = siteData.settings?.exchangeRates || {};
            const rate = rates[currentCurrency] || 1; // Fallback to 1 if no rate found for currentCurrency
            priceToFormat = priceToFormat * rate;

            const symbol = symbols[currentCurrency] || currentCurrency;

            const numberFormatOptions = currentCurrency === 'TRY'
                ? { maximumFractionDigits: 0 }
                : { minimumFractionDigits: 2, maximumFractionDigits: 2 };

            const formattedPrice = new Intl.NumberFormat(currentLang, numberFormatOptions).format(priceToFormat);

            return `${symbol} ${formattedPrice}`;
        }

        // --- Home Page Rendering ---
        function renderHomePage() {
            renderBanner();
            renderProductsGrid();
        }

        function renderBanner() {
            const slides = siteData.settings?.banner || [];
            heroBannerContainer.innerHTML = '';
            const slideNav = document.createElement('div');
            slideNav.className = 'slide-nav';
            heroBannerContainer.appendChild(slideNav);

            if (slides.length === 0) {
                heroBannerContainer.style.display = 'none';
                return;
            }
            heroBannerContainer.style.display = 'block';

            slides.forEach((slideData, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = 'slide' + (index === 0 ? ' active' : '');

                const content = slideData.content?.[currentLang] || slideData.content?.tr || {};
                const buttonText = content.button_text || translate('default_button_text');
                const slideStyle = slideData.style || {};

                if (slideData.image_url?.includes('.mp4')) {
                    slideEl.innerHTML = `<video src="${slideData.image_url}" autoplay muted loop playsinline></video>`;
                } else {
                    slideEl.innerHTML = `<div class="slide-bg-image" style="background-image: url('${slideData.image_url || ''}')"></div>`;
                }

                const titleStyle = `${slideStyle.title_color ? `color: ${slideStyle.title_color};` : ''} ${slideStyle.title_font_size ? `font-size: ${slideStyle.title_font_size};` : ''}`;
                const subtitleStyle = `${slideStyle.subtitle_color ? `color: ${slideStyle.subtitle_color};` : ''} ${slideStyle.subtitle_font_size ? `font-size: ${slideStyle.subtitle_font_size};` : ''}`;
                const buttonInlineStyle = `${slideStyle.button_bg_color ? `background-color: ${slideStyle.button_bg_color};` : ''} ${slideStyle.button_text_color ? `color: ${slideStyle.button_text_color};` : ''} ${slideStyle.button_border_radius ? `border-radius: ${slideStyle.button_border_radius};` : ''} ${slideData.style.button_padding ? `padding: ${slideData.style.button_padding};` : ''}`;

                slideEl.innerHTML += `
                    <div class="slide-content">
                        <h2 style="${titleStyle}">${content.title || ''}</h2>
                        <p style="${subtitleStyle}">${content.subtitle || ''}</p>
                        <a href="${slideData.link_url || '#home'}" class="btn-shop">${buttonText}</a>
                    </div>`;
                heroBannerContainer.insertBefore(slideEl, slideNav);
            });
            startSlider();
        }

        let slideInterval;
        function startSlider() {
            const slides = document.querySelectorAll('#hero-banner-container .slide');
            const navContainer = document.querySelector('#hero-banner-container .slide-nav');
            if (!navContainer || slides.length <= 1) {
                clearInterval(slideInterval);
                return;
            }
            navContainer.innerHTML = ''; // Clear existing dots

            slides.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'nav-dot' + (index === 0 ? ' active' : '');
                dot.dataset.index = index;
                navContainer.appendChild(dot);
            });

            const dots = navContainer.querySelectorAll('.nav-dot');
            let currentSlideIndex = 0;

            function setSlide(index) {
                slides.forEach((s, i) => s.classList.toggle('active', i === index));
                dots.forEach((d, i) => d.classList.toggle('active', i === index));
                currentSlideIndex = index;
            }
            function nextSlide() { setSlide((currentSlideIndex + 1) % slides.length); }

            clearInterval(slideInterval); // Clear any previous interval
            slideInterval = setInterval(nextSlide, 5000);

            dots.forEach(dot => dot.addEventListener('click', () => {
                setSlide(parseInt(dot.dataset.index));
                clearInterval(slideInterval);
                slideInterval = setInterval(nextSlide, 5000);
            }));
            // Ensure first slide is active on init
            if (slides.length > 0) setSlide(0);
        }

        function renderProductsGrid() {
            const products = siteData.products.filter(p => p.isInShowcase); // Only showcase products
            productGridContainer.innerHTML = '';
            if (products.length === 0) return;

            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                const firstImage = product.variants?.[0]?.media?.[0]?.url || `https://placehold.co/400x300/ccc/fff?text=${translate('no_image')}`;
                const name = product.content?.[currentLang]?.name || product.content?.tr?.name || translate('untitled_product');

                const originalPrice = product.basePriceTL;
                const discountedPrice = product.baseDiscountedPriceTL;

                let priceHTML = '';
                if (discountedPrice !== null && typeof discountedPrice === 'number' && discountedPrice < originalPrice) {
                    priceHTML = `
                        <div class="price-container">
                            <span class="original-price">${formatPrice(originalPrice)}</span>
                            <span class="discounted-price">${formatPrice(originalPrice, discountedPrice)}</span>
                        </div>`;
                } else {
                    priceHTML = `<div class="price-container"><span class="discounted-price">${formatPrice(originalPrice)}</span></div>`;
                }

                const freeShippingTag = product.isFreeShipping
                    ? `<div class="free-shipping-tag">${translate('free_shipping_text')}</div>`
                    : '';

                card.innerHTML = `
                    <a href="#product?id=${product.id}" class="product-image-link">
                        <img src="${firstImage}" alt="${name}" class="product-image">
                    </a>
                    <div class="product-info">
                        <div class="product-info-top">
                            <h3 class="product-name"><a href="#product?id=${product.id}">${name}</a></h3>
                        </div>
                        ${priceHTML}
                    </div>
                    ${freeShippingTag}`;
                productGridContainer.appendChild(card);
            });
            // Add click handlers for product links
            productGridContainer.querySelectorAll('.product-image-link, .product-name a').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigateTo(link.getAttribute('href'));
                };
            });
        }

        // --- Product Detail Page Rendering ---
        async function loadProductDetails(productId) {
            if (!productId) {
                productTitleEl.textContent = translate('product_not_found_title');
                productDescriptionEl.textContent = translate('product_not_found_desc');
                mainMediaDisplayEl.innerHTML = '';
                thumbnailRowEl.innerHTML = '';
                productOldPriceEl.textContent = '';
                productPriceEl.textContent = '';
                freeShippingEl.style.display = 'none';
                variantSectionEl.style.display = 'none';
                variantSelectorsEl.innerHTML = '';
                calculatedTotalPriceEl.textContent = '';
                decreaseQuantityBtn.disabled = true;
                increaseQuantityBtn.disabled = true;
                relatedVariantsGridEl.innerHTML = '';
                document.querySelector('.related-variants-section').style.display = 'none';
                return;
            }

            productTitleEl.textContent = translate('product_title_default');
            productDescriptionEl.textContent = translate('product_description_loading');
            quantityInputEl.value = '1';
            calculatedTotalPriceEl.textContent = translate('product_description_loading');
            decreaseQuantityBtn.disabled = true;
            increaseQuantityBtn.disabled = true;

            showLoading();
            try {
                const product = siteData.products.find(p => p.id === productId);

                if (!product) {
                    productTitleEl.textContent = translate('product_not_found_title');
                    productDescriptionEl.textContent = translate('product_not_found_desc');
                    mainMediaDisplayEl.innerHTML = '';
                    thumbnailRowEl.innerHTML = '';
                    productOldPriceEl.textContent = '';
                    productPriceEl.textContent = '';
                    freeShippingEl.style.display = 'none';
                    variantSectionEl.style.display = 'none';
                    variantSelectorsEl.innerHTML = '';
                    calculatedTotalPriceEl.textContent = '';
                    decreaseQuantityBtn.disabled = true;
                    increaseQuantityBtn.disabled = true;
                    relatedVariantsGridEl.innerHTML = '';
                    document.querySelector('.related-variants-section').style.display = 'none';
                    return;
                }

                currentProductData = product; // Store current product data
                productContentGlobal = product.content?.[currentLang] || product.content?.tr || {};

                productTitleEl.textContent = productContentGlobal.name || translate('product_title_default');
                productDescriptionEl.textContent = productContentGlobal.description || translate('description_not_found_fallback');

                const basePrice = currentProductData.basePriceTL || 0;
                const discountedPrice = currentProductData.baseDiscountedPriceTL;

                if (discountedPrice !== undefined && discountedPrice < basePrice) {
                    productOldPriceEl.textContent = formatPrice(basePrice);
                    productPriceEl.textContent = formatPrice(basePrice, discountedPrice);
                } else {
                    productPriceEl.textContent = formatPrice(basePrice);
                    productOldPriceEl.textContent = '';
                }

                if (currentProductData.isFreeShipping) {
                    freeShippingEl.style.display = 'inline-block';
                } else {
                    freeShippingEl.style.display = 'none';
                }

                const variants = currentProductData.variants || [];
                if (variants.length > 0) {
                    variantTitleEl.style.display = 'block';
                    variantSectionEl.style.display = 'flex'; // show the whole section
                    renderVariantSelectors(variants);
                    setImages(variants[0].media); // Display first variant's media by default
                } else {
                    variantTitleEl.style.display = 'none';
                    variantSectionEl.style.display = 'none'; // hide the whole section
                    setImages(currentProductData.media); // If no variants, display product's general media
                }

                updateCalculatedTotalPrice();
                decreaseQuantityBtn.disabled = false;
                increaseQuantityBtn.disabled = false;

                renderRelatedVariants(variants, currentProductData.id); // Pass currentProductId to exclude itself
            } catch (error) {
                console.error("Error loading product details:", error);
                productTitleEl.textContent = translate('error_loading_product_title');
                productDescriptionEl.textContent = translate('error_loading_product_desc');
                calculatedTotalPriceEl.textContent = '';
                decreaseQuantityBtn.disabled = true;
                increaseQuantityBtn.disabled = true;
                relatedVariantsGridEl.innerHTML = '';
                document.querySelector('.related-variants-section').style.display = 'none';
            } finally {
                hideLoading();
            }
        }

        function renderVariantSelectors(variants) {
            variantSelectorsEl.innerHTML = '';
            variants.forEach((variant, index) => {
                const colorOptionDiv = document.createElement('div');
                colorOptionDiv.className = 'color-option';

                const colorCircleDiv = document.createElement('div');
                colorCircleDiv.className = 'color-circle';

                const variantFirstMedia = variant.media?.[0];
                let variantImageUrl = 'https://via.placeholder.com/60x60/cccccc/000000?text=NoImg';
                if (variantFirstMedia && variantFirstMedia.type === 'image' && variantFirstMedia.url) {
                    variantImageUrl = variantFirstMedia.url;
                } else if (variantFirstMedia && variantFirstMedia.type === 'video' && variantFirstMedia.thumbnailUrl) {
                    variantImageUrl = variantFirstMedia.thumbnailUrl;
                } else if (variantFirstMedia && variantFirstMedia.url) { // Fallback if url is present but type is not image/video
                    variantImageUrl = variantFirstMedia.url;
                }

                const img = document.createElement('img');
                img.src = variantImageUrl;
                img.alt = variant.colorName?.[currentLang] || variant.colorName?.tr || translate('unknown_color');
                colorCircleDiv.appendChild(img);

                const colorNameSpan = document.createElement('span');
                colorNameSpan.className = 'color-name';
                colorNameSpan.textContent = variant.colorName?.[currentLang] || variant.colorName?.tr || translate('unknown_color');
                colorOptionDiv.title = colorNameSpan.textContent;

                if (index === 0) { // Default select first variant
                    colorCircleDiv.classList.add('active');
                    colorOptionDiv.classList.add('active');
                }

                colorOptionDiv.onclick = () => {
                    // Update UI active state
                    document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('active'));
                    colorOptionDiv.classList.add('active');
                    colorCircleDiv.classList.add('active');

                    // Update main media
                    setImages(variant.media);

                    // Update prices and shipping based on selected variant (if variant has its own prices)
                    const basePriceMain = variant.basePriceTL !== undefined ? variant.basePriceTL : currentProductData.basePriceTL;
                    const discountedPriceMain = variant.baseDiscountedPriceTL !== undefined ? variant.baseDiscountedPriceTL : currentProductData.baseDiscountedPriceTL;
                    
                    if (discountedPriceMain !== undefined && discountedPriceMain < basePriceMain) {
                        productOldPriceEl.textContent = formatPrice(basePriceMain);
                        productPriceEl.textContent = formatPrice(basePriceMain, discountedPriceMain);
                    } else {
                        productPriceEl.textContent = formatPrice(basePriceMain);
                        productOldPriceEl.textContent = '';
                    }

                    freeShippingEl.style.display = (variant.isFreeShipping || currentProductData.isFreeShipping) ? 'inline-block' : 'none';

                    // Temporarily update currentProductData for price calculation consistency
                    // This is important for add to cart and buy now
                    currentProductData._activePrice = (discountedPriceMain !== undefined && discountedPriceMain < basePriceMain) ? discountedPriceMain : basePriceMain;
                    currentProductData._activeIsFreeShipping = (variant.isFreeShipping || currentProductData.isFreeShipping);
                    currentProductData._activeVariant = variant; // Store active variant for cart

                    updateCalculatedTotalPrice();
                };
                colorOptionDiv.appendChild(colorCircleDiv);
                colorOptionDiv.appendChild(colorNameSpan);
                variantSelectorsEl.appendChild(colorOptionDiv);
            });
            // After rendering, simulate click on the first option to set initial active state and media
            if (variants.length > 0) {
                variantSelectorsEl.querySelector('.color-option').click();
            }
        }

        function setImages(media) {
            mainMediaDisplayEl.innerHTML = '';
            thumbnailRowEl.innerHTML = '';

            if (!media || media.length === 0) {
                const imgPlaceholder = document.createElement('img');
                imgPlaceholder.src = 'https://via.placeholder.com/600x450?text=No Image';
                imgPlaceholder.alt = (productContentGlobal && productContentGlobal.name) ? productContentGlobal.name + " - No Image" : "Product Image Not Available";
                imgPlaceholder.classList.add('main-media');
                mainMediaDisplayEl.appendChild(imgPlaceholder);
                return;
            }

            const initialMediaToDisplay = media[0];

            if (initialMediaToDisplay.type === 'video') {
                const videoEl = document.createElement('video');
                videoEl.src = initialMediaToDisplay.url;
                videoEl.controls = true;
                videoEl.autoplay = true;
                videoEl.muted = true;
                videoEl.loop = true;
                videoEl.playsInline = true;
                videoEl.classList.add('main-media');
                mainMediaDisplayEl.appendChild(videoEl);
            } else {
                const imgEl = document.createElement('img');
                imgEl.src = initialMediaToDisplay.url;
                imgEl.alt = (productContentGlobal && productContentGlobal.name) ? productContentGlobal.name + " - Main Image" : "Main Image";
                imgEl.classList.add('main-media');
                mainMediaDisplayEl.appendChild(imgEl);
            }

            media.forEach((m, i) => {
                const thumbnailItem = document.createElement('div');
                thumbnailItem.classList.add('thumbnail-item');

                if (i === 0) {
                    thumbnailItem.classList.add('active');
                }

                if (m.type === 'video') {
                    const videoThumb = document.createElement('video');
                    videoThumb.src = m.url;
                    videoThumb.muted = true;
                    videoThumb.playsInline = true;
                    videoThumb.preload = "metadata";
                    thumbnailItem.appendChild(videoThumb);
                    thumbnailItem.classList.add('video-thumb');
                } else {
                    const imgThumb = document.createElement('img');
                    imgThumb.src = m.url;
                    imgThumb.loading = "lazy";
                    thumbnailItem.appendChild(imgThumb);
                }

                thumbnailItem.onclick = () => {
                    document.querySelectorAll('.thumbnail-item').forEach(el => el.classList.remove('active'));
                    thumbnailItem.classList.add('active');
                    mainMediaDisplayEl.innerHTML = '';

                    if (m.type === 'video') {
                        const videoEl = document.createElement('video');
                        videoEl.src = m.url;
                        videoEl.controls = true;
                        videoEl.autoplay = true;
                        videoEl.muted = true;
                        videoEl.loop = true;
                        videoEl.playsInline = true;
                        videoEl.classList.add('main-media');
                        mainMediaDisplayEl.appendChild(videoEl);
                    } else {
                        const imgEl = document.createElement('img');
                        imgEl.src = m.url;
                        imgEl.alt = (productContentGlobal && productContentGlobal.name) ? productContentGlobal.name + " - " + (m.alt || "Image") : "Image";
                        imgEl.classList.add('main-media');
                        mainMediaDisplayEl.appendChild(imgEl);
                    }
                };
                thumbnailRowEl.appendChild(thumbnailItem);
            });
        }

        function updateCalculatedTotalPrice() {
            if (!currentProductData || !calculatedTotalPriceEl || !quantityInputEl) return;

            let quantity = parseInt(quantityInputEl.value);
            const min = parseInt(quantityInputEl.min);
            const max = parseInt(quantityInputEl.max);

            if (isNaN(quantity) || quantity < min) {
                quantity = min;
            } else if (quantity > max) {
                quantity = max;
            }
            quantityInputEl.value = quantity;

            decreaseQuantityBtn.disabled = (quantity === min);
            increaseQuantityBtn.disabled = (quantity === max);

            // Use _activePrice which is set when a variant is selected or default product is loaded
            const currentPrice = currentProductData._activePrice !== undefined ? currentProductData._activePrice : (currentProductData.baseDiscountedPriceTL !== undefined && currentProductData.baseDiscountedPriceTL < currentProductData.basePriceTL
                ? currentProductData.baseDiscountedPriceTL
                : currentProductData.basePriceTL);

            const totalPrice = currentPrice * quantity;
            calculatedTotalPriceEl.textContent = formatPrice(totalPrice);
        }

        function renderRelatedVariants(allVariants) {
            relatedVariantsGridEl.innerHTML = '';
            if (!allVariants || allVariants.length <= 1) {
                document.querySelector('.related-variants-section').style.display = 'none';
                return;
            } else {
                document.querySelector('.related-variants-section').style.display = 'block';
            }
            relatedVariantsTitleEl.textContent = translate('related_products_title');

            allVariants.forEach(variant => {
                const productName = productContentGlobal.name || translate('product_title_default');
                const variantImageUrl = variant.media?.[0]?.url || 'https://via.placeholder.com/200x200/cccccc/000000?text=NoImg';

                const basePriceForVariant = variant.basePriceTL !== undefined ? variant.basePriceTL : (currentProductData.basePriceTL || 0);
                const discountedPriceForVariant = variant.baseDiscountedPriceTL !== undefined ? variant.baseDiscountedPriceTL : currentProductData.baseDiscountedPriceTL;

                let priceHtml = '';
                if (discountedPriceForVariant !== undefined && discountedPriceForVariant < basePriceForVariant) {
                    priceHtml = `
                        <span class="old-price">${formatPrice(basePriceForVariant)}</span>
                        <span class="new-price">${formatPrice(basePriceForVariant, discountedPriceForVariant)}</span>
                    `;
                } else {
                    priceHtml = `<span class="new-price">${formatPrice(basePriceForVariant)}</span>`;
                }

                const isFreeShippingForVariant = variant.isFreeShipping || currentProductData.isFreeShipping;
                const freeShippingTagHtml = isFreeShippingForVariant
                    ? `<div class="free-shipping-wrapper"><span class="free-shipping-tag">${translate('free_shipping_text')}</span></div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'related-variant-card';
                card.innerHTML = `
                    <img src="${variantImageUrl}" alt="${productName}">
                    <span class="variant-name">${productName}</span>
                    <div class="price-container">
                        ${priceHtml}
                    </div>
                    ${freeShippingTagHtml}
                `;

                card.onclick = () => {
                    // Simulate clicking on the corresponding color option in the main product details
                    const targetVariantName = variant.colorName?.[currentLang] || variant.colorName?.tr || translate('unknown_color');
                    const targetOption = Array.from(variantSelectorsEl.querySelectorAll('.color-option')).find(
                        opt => opt.querySelector('.color-name').textContent === targetVariantName
                    );
                    if (targetOption) {
                        targetOption.click();
                        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top after selecting variant
                    }
                };
                relatedVariantsGridEl.appendChild(card);
            });
        }

        // Product Page Event Listeners
        quantityInputEl.addEventListener('input', updateCalculatedTotalPrice);
        decreaseQuantityBtn.addEventListener('click', () => {
            let currentQuantity = parseInt(quantityInputEl.value);
            if (isNaN(currentQuantity)) currentQuantity = 1;
            if (currentQuantity > parseInt(quantityInputEl.min)) {
                quantityInputEl.value = currentQuantity - 1;
                updateCalculatedTotalPrice();
            }
        });
        increaseQuantityBtn.addEventListener('click', () => {
            let currentQuantity = parseInt(quantityInputEl.value);
            if (isNaN(currentQuantity)) currentQuantity = 1;
            if (currentQuantity < parseInt(quantityInputEl.max)) {
                quantityInputEl.value = currentQuantity + 1;
                updateCalculatedTotalPrice();
            }
        });
        
        btnAddToCart.addEventListener('click', () => {
            if (!currentProductData || !currentProductData.id) return;

            const quantity = parseInt(quantityInputEl.value);
            if (isNaN(quantity) || quantity <= 0) {
                alert("Lütfen geçerli bir miktar girin.");
                return;
            }

            const itemToAdd = {
                productId: currentProductData.id,
                sku: currentProductData.sku,
                name: currentProductData.content?.[currentLang]?.name || currentProductData.content?.tr?.name || translate('untitled_product'),
                quantity: quantity,
                basePrice: currentProductData.basePriceTL,
                discountedPrice: currentProductData.baseDiscountedPriceTL,
                isFreeShipping: currentProductData.isFreeShipping,
                selectedVariant: currentProductData._activeVariant ? {
                    colorName: currentProductData._activeVariant.colorName,
                    media: currentProductData._activeVariant.media,
                    basePriceTL: currentProductData._activeVariant.basePriceTL,
                    baseDiscountedPriceTL: currentProductData._activeVariant.baseDiscountedPriceTL,
                    isFreeShipping: currentProductData._activeVariant.isFreeShipping,
                } : null,
            };

            const existingItemIndex = siteData.cart.findIndex(item =>
                item.productId === itemToAdd.productId &&
                JSON.stringify(item.selectedVariant?.colorName) === JSON.stringify(itemToAdd.selectedVariant?.colorName)
            );

            if (existingItemIndex > -1) {
                siteData.cart[existingItemIndex].quantity += quantity;
            } else {
                siteData.cart.push(itemToAdd);
            }
            localStorage.setItem('pufemo-cart', JSON.stringify(siteData.cart));
            updateCartBadge();
            alert("Ürün sepete eklendi!");
        });

        btnBuyNow.addEventListener('click', () => {
            btnAddToCart.click(); // Add to cart first
            navigateTo('#checkout'); // Then navigate to checkout
        });

        // --- Cart Page Rendering ---
        function renderCartPage() {
            cartItemsContainer.innerHTML = '';
            let subtotal = 0;
            let totalShipping = 0;
            let hasFreeShippingItem = false;

            if (siteData.cart.length === 0) {
                cartEmptyMessage.style.display = 'block';
                cartSummary.style.display = 'none';
                cartActions.style.display = 'none';
                return;
            } else {
                cartEmptyMessage.style.display = 'none';
                document.querySelector('.cart-summary').style.display = 'block';
                document.querySelector('.cart-actions').style.display = 'flex';
            }

            siteData.cart.forEach((item, index) => {
                const product = siteData.products.find(p => p.id === item.productId);
                if (!product) return; // Should not happen if data is consistent

                const itemDisplayPrice = (item.selectedVariant?.baseDiscountedPriceTL !== undefined && item.selectedVariant.baseDiscountedPriceTL < item.selectedVariant.basePriceTL)
                    ? item.selectedVariant.baseDiscountedPriceTL
                    : (item.selectedVariant?.basePriceTL || item.baseDiscountedPriceTL || item.basePrice);

                subtotal += itemDisplayPrice * item.quantity;
                if (!item.isFreeShipping) {
                    totalShipping += (item.quantity * 5); // Example shipping cost per item (5 units of currency)
                } else {
                    hasFreeShippingItem = true; // Mark if any item has free shipping
                }

                const imageUrl = item.selectedVariant?.media?.[0]?.url || item.media?.[0]?.url || 'https://via.placeholder.com/100x100?text=NoImg';
                const productName = item.name;
                const variantName = item.selectedVariant?.colorName?.[currentLang] || item.selectedVariant?.colorName?.tr || '';

                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item';
                cartItemEl.innerHTML = `
                    <img src="${imageUrl}" alt="${productName}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h3><a href="#product?id=${item.productId}">${productName}</a></h3>
                        ${variantName ? `<p>${translate('variant_selection_label')}: ${variantName}</p>` : ''}
                    </div>
                    <div class="cart-item-price">${formatPrice(itemDisplayPrice * item.quantity)}</div>
                    <div class="quantity-control">
                        <button type="button" class="quantity-button decrease-cart-quantity" data-index="${index}">-</button>
                        <input type="number" class="quantity-input cart-quantity-input" value="${item.quantity}" min="1" max="99" data-index="${index}">
                        <button type="button" class="quantity-button increase-cart-quantity" data-index="${index}">+</button>
                    </div>
                    <button type="button" class="remove-item-btn" data-index="${index}"><i class="fa-solid fa-trash"></i></button>
                `;
                cartItemsContainer.appendChild(cartItemEl);
            });

            // If any item has free shipping, make total shipping 0
            if (hasFreeShippingItem) {
                totalShipping = 0;
            }
            
            const total = subtotal + totalShipping;

            document.getElementById('cart-subtotal-label').innerHTML = `${translate('cart_subtotal_label')} <span>${formatPrice(subtotal)}</span>`;
            document.getElementById('cart-shipping-label').innerHTML = `${translate('cart_shipping_label')} <span>${formatPrice(totalShipping)}</span>`;
            document.getElementById('cart-total-label').innerHTML = `${translate('cart_total_label')} <span>${formatPrice(total)}</span>`;

            // Add event listeners for cart item quantity and removal
            cartItemsContainer.querySelectorAll('.decrease-cart-quantity').forEach(btn => {
                btn.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (siteData.cart[index].quantity > 1) {
                        siteData.cart[index].quantity--;
                        localStorage.setItem('pufemo-cart', JSON.stringify(siteData.cart));
                        renderCartPage();
                        updateCartBadge();
                    }
                };
            });
            cartItemsContainer.querySelectorAll('.increase-cart-quantity').forEach(btn => {
                btn.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (siteData.cart[index].quantity < 99) { // Max quantity 99
                        siteData.cart[index].quantity++;
                        localStorage.setItem('pufemo-cart', JSON.stringify(siteData.cart));
                        renderCartPage();
                        updateCartBadge();
                    }
                };
            });
            cartItemsContainer.querySelectorAll('.cart-quantity-input').forEach(input => {
                input.onchange = (e) => {
                    const index = parseInt(e.target.dataset.index);
                    let newQuantity = parseInt(e.target.value);
                    if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;
                    if (newQuantity > 99) newQuantity = 99; // Max quantity 99
                    siteData.cart[index].quantity = newQuantity;
                    localStorage.setItem('pufemo-cart', JSON.stringify(siteData.cart));
                    renderCartPage();
                    updateCartBadge();
                };
            });
            cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index);
                    if (confirm("Bu ürünü sepetten kaldırmak istediğinizden emin misiniz?")) {
                        siteData.cart.splice(index, 1);
                        localStorage.setItem('pufemo-cart', JSON.stringify(siteData.cart));
                        renderCartPage();
                        updateCartBadge();
                    }
                };
            });
            cartItemsContainer.querySelectorAll('.cart-item-details h3 a').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    navigateTo(link.getAttribute('href'));
                };
            });
        }
        
        // Cart Page Event Listeners
        continueShoppingBtn.onclick = () => { navigateTo('#home'); };
        proceedToCheckoutBtn.onclick = () => { navigateTo('#checkout'); };


        // --- Checkout Page Rendering ---
        function renderCheckoutPage() {
            // Populate country selector for shipping address
            const countries = siteData.settings.countryPricing || {};
            const countryOptionsHtml = Object.entries(countries).map(([code, data]) => {
                const countryName = data.name?.[currentLang] || data.name?.['tr'] || code.toUpperCase();
                return `<option value="${code}">${countryCodeToEmoji(data.flag)} ${countryName}</option>`;
            }).join('');
            shippingCountrySelect.innerHTML = countryOptionsHtml;
            shippingCountrySelect.value = currentCountryCode; // Default to currently selected country

            renderCheckoutSummary();
        }

        function renderCheckoutSummary() {
            checkoutSummaryItemsContainer.innerHTML = '';
            let subtotal = 0;
            let totalShipping = 0;
            let hasFreeShippingItem = false;

            siteData.cart.forEach(item => {
                const product = siteData.products.find(p => p.id === item.productId);
                if (!product) return;

                const itemDisplayPrice = (item.selectedVariant?.baseDiscountedPriceTL !== undefined && item.selectedVariant.baseDiscountedPriceTL < item.selectedVariant.basePriceTL)
                    ? item.selectedVariant.baseDiscountedPriceTL
                    : (item.selectedVariant?.basePriceTL || item.baseDiscountedPriceTL || item.basePrice);

                subtotal += itemDisplayPrice * item.quantity;
                if (!item.isFreeShipping) {
                    totalShipping += (item.quantity * 5); // Example shipping cost per item
                } else {
                    hasFreeShippingItem = true;
                }

                const summaryItemEl = document.createElement('div');
                summaryItemEl.className = 'summary-item';
                const productName = item.name;
                const variantName = item.selectedVariant?.colorName?.[currentLang] || item.selectedVariant?.colorName?.tr || '';
                summaryItemEl.innerHTML = `
                    <span>${productName} ${variantName ? `(${variantName})` : ''} x ${item.quantity}</span>
                    <span>${formatPrice(itemDisplayPrice * item.quantity)}</span>
                `;
                checkoutSummaryItemsContainer.appendChild(summaryItemEl);
            });

            if (hasFreeShippingItem) {
                totalShipping = 0;
            }
            const total = subtotal + totalShipping;

            checkoutSubtotalValue.textContent = formatPrice(subtotal);
            checkoutShippingValue.textContent = formatPrice(totalShipping);
            checkoutTotalValue.textContent = formatPrice(total);
        }

        // Checkout Page Event Listeners
        backToCartBtn.onclick = () => { navigateTo('#cart'); };
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Simple validation
            const requiredFields = [
                shippingFirstName, shippingLastName, shippingAddress, shippingCity,
                shippingZipCode, shippingCountrySelect, contactEmail, contactPhone,
                paymentMethod
            ];
            for (const field of requiredFields) {
                if (!field.value.trim()) {
                    alert(`Lütfen "${field.previousElementSibling.textContent.replace(':', '')}" alanını doldurunuz.`);
                    field.focus();
                    return;
                }
            }

            // Construct order data
            const orderData = {
                items: siteData.cart.map(item => ({
                    productId: item.productId,
                    sku: item.sku,
                    name: item.name,
                    quantity: item.quantity,
                    basePrice: item.basePrice,
                    discountedPrice: item.discountedPrice,
                    isFreeShipping: item.isFreeShipping,
                    selectedVariant: item.selectedVariant,
                    // Store the price at the time of order
                    priceAtOrder: (item.selectedVariant?.baseDiscountedPriceTL !== undefined && item.selectedVariant.baseDiscountedPriceTL < item.selectedVariant.basePriceTL)
                        ? item.selectedVariant.baseDiscountedPriceTL
                        : (item.selectedVariant?.basePriceTL || item.baseDiscountedPriceTL || item.basePrice),
                })),
                shippingAddress: {
                    firstName: shippingFirstName.value.trim(),
                    lastName: shippingLastName.value.trim(),
                    address: shippingAddress.value.trim(),
                    city: shippingCity.value.trim(),
                    zipCode: shippingZipCode.value.trim(),
                    countryCode: shippingCountrySelect.value,
                    countryName: shippingCountrySelect.options[shippingCountrySelect.selectedIndex].text.trim().split(' ')[1] || shippingCountrySelect.value.toUpperCase()
                },
                contactInfo: {
                    email: contactEmail.value.trim(),
                    phone: contactPhone.value.trim()
                },
                paymentMethod: paymentMethod.value,
                currency: currentCurrency,
                totalAmount: parseFloat(checkoutTotalValue.textContent.replace(/[^\d.,]/g, '').replace('.', '').replace(',', '.')), // Clean and parse total
                orderDate: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'Pending',
                userUid: auth.currentUser ? auth.currentUser.uid : 'anonymous' // If user is logged in
            };
            
            showLoading();
            try {
                await db.collection('orders').add(orderData);
                alert(translate('order_placed_success'));
                localStorage.removeItem('pufemo-cart'); // Clear cart after successful order
                siteData.cart = []; // Clear in-memory cart
                updateCartBadge();
                navigateTo('#home'); // Go to home page
            } catch (error) {
                console.error("Error placing order:", error);
                alert(translate('order_place_error'));
            } finally {
                hideLoading();
            }
        });

        // --- Initialization ---
        async function init() {
            showLoading();
            await fetchData();
            renderAllGlobalElements();

            // Show welcome modal if no country is set or first visit
            const storedCountry = localStorage.getItem('pufemo-country');
            const availableCountries = Object.keys(siteData.settings.countryPricing);
            if (!storedCountry || !availableCountries.includes(storedCountry)) {
                if (availableCountries.length > 0) {
                    welcomeModalOverlay.classList.add('active');
                } else {
                    // If no countries are set up in Firebase, just go to home
                    navigateTo('#home');
                }
            } else {
                navigateTo(window.location.hash || '#home'); // Navigate based on hash or default to home
            }
            hideLoading();
        }
        init();
    </script>
</body>
</html>
