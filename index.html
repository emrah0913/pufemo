<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Hoş Geldiniz</title>
    <meta name="description" content="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .initial-modal { display: none; position: fixed; z-index: 1060; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .initial-modal.is-visible { display: flex; align-items: center; justify-content: center; }
        .country-list { max-height: 400px; overflow-y: auto; }
        .product-card img { height: 250px; object-fit: cover; }
        .modal-step { display: none; }
    </style>
</head>
<body>

    <div class="initial-modal" id="initial-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-step" id="step-country">
                    <div class="modal-header"><h5 class="modal-title">Lütfen Ülkenizi Seçin / Please Select Your Country</h5></div>
                    <div class="modal-body"><p class="text-muted">Fiyat ve teslimat seçeneklerini görebilmek için lütfen ülkenizi seçin.</p><div class="list-group country-list" id="country-list"><div class="text-center p-3">Yükleniyor...</div></div></div>
                </div>
                <div class="modal-step" id="step-auth-options">
                    <div class="modal-header"><h5 class="modal-title">Hoş Geldiniz</h5></div>
                    <div class="modal-body text-center">
                        <p><strong id="selected-country-name"></strong> için devam edin.</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="guest-btn">Misafir Olarak Devam Et</button>
                            <button class="btn btn-secondary" id="show-login-btn">Giriş Yap</button>
                            <button class="btn btn-outline-secondary" id="show-register-btn">Kayıt Ol</button>
                        </div>
                    </div>
                </div>
                <div class="modal-step" id="step-login">
                    <div class="modal-header"><h5 class="modal-title">Giriş Yap</h5></div>
                    <div class="modal-body">
                        <form id="login-form">
                            <div class="mb-3"><input type="email" class="form-control" id="login-email" placeholder="E-posta" required></div>
                            <div class="mb-3"><input type="password" class="form-control" id="login-password" placeholder="Şifre" required></div>
                            <div id="login-error" class="alert alert-danger d-none"></div>
                            <div class="d-grid"><button type="submit" class="btn btn-primary">Giriş Yap</button></div>
                            <a href="#" class="btn btn-link btn-sm float-end" id="back-to-options-1">Geri</a>
                        </form>
                    </div>
                </div>
                <div class="modal-step" id="step-register">
                     <div class="modal-header"><h5 class="modal-title">Kayıt Ol</h5></div>
                    <div class="modal-body">
                        <form id="register-form">
                            <div class="mb-3"><input type="email" class="form-control" id="register-email" placeholder="E-posta" required></div>
                            <div class="mb-3"><input type="password" class="form-control" id="register-password" placeholder="Şifre" required></div>
                            <div id="register-error" class="alert alert-danger d-none"></div>
                            <div class="d-grid"><button type="submit" class="btn btn-primary">Kayıt Ol</button></div>
                            <a href="#" class="btn btn-link btn-sm float-end" id="back-to-options-2">Geri</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header id="page-header" class="sticky-top"></header>
    <main></main>
    <footer class="bg-dark text-white pt-5 pb-4"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4", authDomain: "pufemo-com.firebaseapp.com", projectId: "pufemo-com", storageBucket: "pufemo-com.firebasestorage.app", messagingSenderId: "983352837227", appId: "1:983352837227:web:defaa8dae215776e2e1d2e", measurementId: "G-RH8XHC7P91" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const exchangeRates = { "TRY": 1.0, "USD": 33.0, "EUR": 35.0, "GBP": 41.0, "RUB": 0.37 };
        let selectedCountry = null;

        document.addEventListener('DOMContentLoaded', showCountryModal);

        function showStep(stepId) {
            document.querySelectorAll('.modal-step').forEach(step => step.style.display = 'none');
            document.getElementById(stepId).style.display = 'block';
        }

        async function showCountryModal() {
            const countryList = document.getElementById('country-list');
            countryList.innerHTML = '<div class="text-center p-3">Yükleniyor...</div>';
            const countriesSnapshot = await db.collection('countries').get();
            countryList.innerHTML = '';
            countriesSnapshot.forEach(doc => {
                const country = { id: doc.id, ...doc.data() };
                let flagUrl = 'https://via.placeholder.com/24x18?text=--';
                if (country.code) { flagUrl = `https://flagsapi.com/${country.code.toUpperCase()}/flat/24.png`; }

                const countryElement = document.createElement('a');
                countryElement.href = '#';
                countryElement.className = 'list-group-item list-group-item-action d-flex align-items-center';
                countryElement.innerHTML = `<img src="${flagUrl}" class="me-2" style="width:24px; border:1px solid #ddd;"> ${country.name}`;
                countryElement.onclick = (e) => { e.preventDefault(); selectCountry(country); };
                countryList.appendChild(countryElement);
            });
            document.getElementById('initial-modal').classList.add('is-visible');
            showStep('step-country');
        }

        function selectCountry(country) {
            selectedCountry = country;
            document.getElementById('selected-country-name').textContent = country.name;
            showStep('step-auth-options');
        }

        document.getElementById('guest-btn').addEventListener('click', async () => {
            try {
                const userCredential = await auth.signInAnonymously();
                completeSessionSetup(userCredential.user, selectedCountry);
            } catch (error) { console.error("Anonim giriş hatası:", error); }
        });

        document.getElementById('show-login-btn').addEventListener('click', () => showStep('step-login'));
        document.getElementById('show-register-btn').addEventListener('click', () => showStep('step-register'));
        document.getElementById('back-to-options-1').onclick = (e) => { e.preventDefault(); showStep('step-auth-options'); };
        document.getElementById('back-to-options-2').onclick = (e) => { e.preventDefault(); showStep('step-auth-options'); };

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.classList.add('d-none');
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                completeSessionSetup(userCredential.user, selectedCountry);
            } catch (error) {
                errorDiv.textContent = "E-posta veya şifre hatalı.";
                errorDiv.classList.remove('d-none');
            }
        });
        
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorDiv = document.getElementById('register-error');
            errorDiv.classList.add('d-none');
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                completeSessionSetup(userCredential.user, selectedCountry);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('d-none');
            }
        });

        function completeSessionSetup(user, country) {
            localStorage.setItem('pufemo-country', JSON.stringify(country));
            document.getElementById('initial-modal').classList.remove('is-visible');
            initializeApp(country);
        }

        async function initializeApp(countrySettings) {
            // Sayfanın geri kalanını render eden kodlar buraya gelecek
            console.log(`Uygulama başlatıldı. Ülke: ${countrySettings.name}, Dil: ${countrySettings.language}`);
            // Örnek: renderHeader(), renderSlider(), renderProducts() vb. fonksiyonlar burada çağrılır.
        }
    </script>
</body>
</html>
