<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PUFEMO - Ana Sayfa</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f6f8; }
  header { background: #27ae60; color: white; padding: 20px; text-align: center; font-size: 26px; font-weight: bold; }
  .product-list { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 20px; margin-top: 20px; }
  .product-card { background: white; border-radius: 10px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1); padding: 15px; display: flex; flex-direction: column; }
  .product-card img { max-width: 100%; border-radius: 10px; object-fit: cover; height: 150px; }
  .product-title { font-weight: 700; font-size: 18px; margin: 10px 0 5px; }
  .product-price { color: #27ae60; font-weight: 600; font-size: 16px; margin-top: auto; }
  a { text-decoration: none; color: inherit; }
  select, label { font-weight: 600; }
  .filters { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
</style>
</head>
<body>

<header>PUFEMO - Modern Mobilyalar</header>

<div class="filters">
  <label for="category-filter">Kategori:</label>
  <select id="category-filter">
    <option value="">Tüm Kategoriler</option>
  </select>

  <label for="country-filter">Ülke:</label>
  <select id="country-filter">
    <option value="">Ülke Seçiniz</option>
  </select>
</div>

<div class="product-list" id="product-list">
  Yükleniyor...
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
    authDomain: "pufemo-com.firebaseapp.com",
    projectId: "pufemo-com",
    storageBucket: "pufemo-com.firebasestorage.app",
    messagingSenderId: "983352837227",
    appId: "1:983352837227:web:defaa8dae215776e2e",
    measurementId: "G-RH8XHC7P91"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const productListEl = document.getElementById('product-list');
  const categoryFilter = document.getElementById('category-filter');
  const countryFilter = document.getElementById('country-filter');

  let categories = [];
  let countries = [];
  let products = [];

  async function loadCategories() {
    const snapshot = await getDocs(collection(db, 'categories'));
    categories = [];
    categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
    snapshot.forEach(docSnap => {
      const c = docSnap.data();
      categories.push({ id: docSnap.id, title: c.translations?.tr?.title || 'Kategori' });
      categoryFilter.innerHTML += `<option value="${docSnap.id}">${categories[categories.length-1].title}</option>`;
    });
  }

  async function loadCountries() {
    const snapshot = await getDocs(collection(db, 'countries'));
    countries = [];
    countryFilter.innerHTML = '<option value="">Ülke Seçiniz</option>';
    snapshot.forEach(docSnap => {
      const c = docSnap.data();
      countries.push({ id: docSnap.id, name: c.name, priceMultiplier: c.priceMultiplier, currency: c.currency });
      countryFilter.innerHTML += `<option value="${docSnap.id}">${c.name}</option>`;
    });
  }

  async function loadProducts() {
    productListEl.innerHTML = 'Yükleniyor...';
    const snapshot = await getDocs(collection(db, 'products'));
    products = [];
    snapshot.forEach(docSnap => {
      const p = docSnap.data();
      products.push({ id: docSnap.id, ...p });
    });
    renderProducts();
  }

  function renderProducts() {
    const selectedCategory = categoryFilter.value;
    const selectedCountry = countries.find(c => c.id === countryFilter.value);
    productListEl.innerHTML = '';

    let filtered = products;

    if (selectedCategory) {
      filtered = filtered.filter(p => p.categoryId === selectedCategory);
    }

    if (filtered.length === 0) {
      productListEl.innerHTML = '<p style="text-align:center;">Ürün bulunamadı.</p>';
      return;
    }

    filtered.forEach(p => {
      const price = selectedCountry ? (p.basePrice * selectedCountry.priceMultiplier).toFixed(2) : p.basePrice.toFixed(2);
      const currency = selectedCountry ? selectedCountry.currency : '₺';
      const img = (p.images && p.images.length > 0) ? p.images[0] : 'https://via.placeholder.com/300x200?text=No+Image';
      const cat = categories.find(c => c.id === p.categoryId);
      const catName = cat ? cat.title : 'Kategori Yok';

      productListEl.innerHTML += `
        <a href="product.html?id=${p.id}" class="product-card">
          <img src="${img}" alt="${p.translations?.tr?.title || 'Ürün'}" />
          <div class="product-title">${p.translations?.tr?.title || 'Ürün'}</div>
          <div>${catName}</div>
          <div class="product-price">${price} ${currency}</div>
        </a>
      `;
    });
  }

  categoryFilter.addEventListener('change', renderProducts);
  countryFilter.addEventListener('change', renderProducts);

  async function init() {
    await loadCategories();
    await loadCountries();
    await loadProducts();
  }

  init();

</script>

</body>
</html>
