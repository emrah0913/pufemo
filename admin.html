<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | Getir Kıbrıs</title>
    <meta name="description" content="Getir Kıbrıs Yönetici Paneli - Siparişleri ve kullanıcıları yönetin.">
    <link rel="icon" href="https://pufemo.netlify.app/favicon.ico?v=2" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

    <script>
        // Tailwind CSS Konfigürasyonu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5d3ebc',
                        secondary: '#ffd300',
                        status: {
                            pending: '#f59e0b', // Amber 500
                            processing: '#3b82f6', // Blue 500
                            shipped: '#10b981', // Emerald 500
                            delivered: '#22c55e', // Green 500
                            cancelled: '#ef4444'  // Red 500
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'button': '8px'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3; /* Corrected border width */
            border-top: 4px solid #5d3ebc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Toast Notification Styling */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            z-index: 1000;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="w-full max-w-screen-lg mx-auto relative min-h-screen">
    <header class="sticky top-0 w-full bg-white shadow-sm z-50 px-4 py-3 flex items-center justify-between">
        <a href="https://pufemo.netlify.app/index.html" class="flex items-center gap-2">
            <img src="https://placehold.co/100x40/5d3ebc/ffffff?text=GetirKıbrıs&font=inter" alt="Getir Kıbrıs Logo" class="h-10">
        </a>
        <div class="flex items-center gap-4">
            <a href="https://pufemo.netlify.app/index.html" class="text-gray-600 hover:text-primary transition-colors">
                <i class="ri-home-4-line ri-lg"></i>
            </a>
            <div id="auth-button-container" class="w-8 h-8 flex items-center justify-center">
                <div id="profile-container" class="hidden cursor-pointer">
                    <img id="profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full">
                </div>
            </div>
        </div>
    </header>

    <main id="admin-content" class="pt-8 pb-20 px-4 hidden">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Yönetici Paneli</h1>

        <section id="unauthorized-message" class="text-center py-16 bg-red-100 rounded-lg shadow-md hidden">
            <i class="ri-lock-2-line text-6xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-red-700">Yetkisiz Erişim!</h2>
            <p class="mt-2 text-red-600">Bu sayfayı görüntülemek için yönetici yetkiniz bulunmamaktadır.</p>
            <a href="https://pufemo.netlify.app/index.html" class="mt-6 inline-block bg-primary text-white px-6 py-2 rounded-button font-semibold hover:bg-primary/90 transition-colors">Ana Sayfaya Dön</a>
        </section>

        <section id="admin-dashboard" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Dashboard Bilgi Kartları (Örnek) -->
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="ri-bar-chart-box-line ri-xl text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Toplam Siparişler</p>
                        <p id="total-orders-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="ri-check-double-line ri-xl text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tamamlanan Siparişler</p>
                        <p id="completed-orders-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="ri-user-line ri-xl text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Toplam Kullanıcılar</p>
                        <p id="total-users-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>

            <!-- Yeni Sekmeler Menüsü -->
            <div class="flex border-b border-gray-200 mb-6">
                <button data-tab="orders" class="px-4 py-2 text-sm font-medium text-primary border-b-2 border-primary-500 focus:outline-none tab-button">Tüm Siparişler</button>
                <button data-tab="users" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none tab-button">Kullanıcılar</button>
                <button data-tab="products" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none tab-button">Ürün Yönetimi</button>
                <button data-tab="settings" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none tab-button">Ayarlar</button>
            </div>

            <!-- Siparişler Sekmesi İçeriği -->
            <div id="orders-tab" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Tüm Siparişler</h2>
                <div id="orders-list" class="space-y-4">
                    <p class="text-center text-gray-500">Siparişler yükleniyor...</p>
                </div>
                <div id="no-orders-admin-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-file-list-3-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz hiç sipariş bulunmuyor.</p>
                </div>
            </div>

            <!-- Kullanıcılar Sekmesi İçeriği -->
            <div id="users-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Kullanıcı Yönetimi</h2>
                <div id="users-list" class="space-y-4">
                    <p class="text-center text-gray-500">Kullanıcılar yükleniyor...</p>
                </div>
                <div id="no-users-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-user-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz hiç kullanıcı bulunmuyor.</p>
                </div>
            </div>

            <!-- Ürün Yönetimi Sekmesi İçeriği -->
            <div id="products-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ürün Yönetimi (Üretici Onayları)</h2>
                <div id="products-list" class="space-y-4">
                    <p class="text-center text-gray-500">Ürünler yükleniyor...</p>
                </div>
                <div id="no-products-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-box-3-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz onay bekleyen ürün bulunmuyor.</p>
                </div>
            </div>

            <!-- Ayarlar Sekmesi İçeriği -->
            <div id="settings-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Fiyatlandırma ve Şehir Ayarları</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold text-lg mb-4">Kategori Oranları (%)</h3>
                    <div id="category-rates-settings" class="space-y-3">
                        <!-- Kategori oranları buraya dinamik olarak yüklenecek -->
                        <p class="text-gray-500">Ayarlar yükleniyor...</p>
                    </div>

                    <h3 class="font-semibold text-lg mt-6 mb-4">Şehir Teslimat Ücretleri (₺)</h3>
                    <div id="city-fees-settings" class="space-y-3">
                        <!-- Şehir ücretleri buraya dinamik olarak yüklenecek -->
                        <p class="text-gray-500">Ayarlar yükleniyor...</p>
                    </div>
                    <button id="save-settings-btn" class="mt-6 bg-primary text-white py-2 px-4 rounded-button font-semibold hover:bg-primary/90 transition-colors">Ayarları Kaydet</button>
                </div>
            </div>

        </section>
    </main>

    <div id="loader" class="flex justify-center items-center h-[calc(100vh-80px)]">
        <div class="loader"></div>
    </div>
</div>

<div id="toast" class="fixed bottom-24 right-6 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-[110] transform translate-y-4">
    <span id="toast-message"></span>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase yapılandırma bilgileriniz (sepet.html ile aynı)
    const firebaseConfig = {
        apiKey: "AIzaSyB64tAKvCHeYnJ8-HNRLpzB7sQRng4FHyA",
        authDomain: "pufemo-2dc3a.firebaseapp.com",
        projectId: "pufemo-2dc3a",
        storageBucket: "pufemo-2dc3a.firebasestorage.app", 
        messagingSenderId: "321284306570",
        appId: "1:321284306570:web:ca891826c3e4edde8edf73"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log("Firebase uygulaması başlatıldı (Admin).");
    console.log("Auth objesi başlatıldı (Admin):", auth);

    let currentUser = null;
    let pricingSettings = {}; // Fiyatlandırma ayarları, sipariş detayları için gerekli
    const DEFAULT_SETTINGS = {
        categoryRates: { 'furniture': 0.70, 'electronics': 0.70, 'clothing': 0.45, 'cosmetics': 0.70, 'stationery': 0.40, 'default': 0.50 },
        cityFees: { 'Lefkoşa': 200, 'Girne': 350, 'Gazimağusa': 300, 'Güzelyurt': 400, 'İskele': 450, 'Diğer': 500 }
    };

    // DOM öğeleri
    const loader = document.getElementById('loader');
    const adminContent = document.getElementById('admin-content');
    const unauthorizedMessage = document.getElementById('unauthorized-message');
    const adminDashboard = document.getElementById('admin-dashboard');
    const ordersList = document.getElementById('orders-list'); // Orders Tab's list
    const noOrdersAdminMessage = document.getElementById('no-orders-admin-message'); // Orders Tab's message
    const profileImg = document.getElementById('profile-img');
    const profileContainer = document.getElementById('profile-container');

    // New DOM elements for dashboard sections
    const totalOrdersCount = document.getElementById('total-orders-count');
    const completedOrdersCount = document.getElementById('completed-orders-count');
    const totalUsersCount = document.getElementById('total-users-count');

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    const usersList = document.getElementById('users-list');
    const noUsersMessage = document.getElementById('no-users-message');

    const productsList = document.getElementById('products-list');
    const noProductsMessage = document.getElementById('no-products-message');

    const categoryRatesSettings = document.getElementById('category-rates-settings');
    const cityFeesSettings = document.getElementById('city-fees-settings');
    const saveSettingsBtn = document.getElementById('save-settings-btn');


    // Toast Bildirimi Fonksiyonu
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4', 'hidden');
            toast.classList.add('opacity-100', 'translate-y-0', 'show');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0', 'show');
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, duration);
        } else {
            console.warn("Toast öğeleri bulunamadı, bildirim gösterilemiyor:", message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        onAuthStateChanged(auth, async (user) => {
            if (loader) loader.classList.remove('hidden'); // Yükleyiciyi göster
            if (adminContent) adminContent.classList.add('hidden'); // İçeriği gizle

            if (user) {
                currentUser = user;
                if (profileImg) profileImg.src = user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=P';
                if (profileContainer) profileContainer.classList.remove('hidden');

                // Kullanıcının rolünü kontrol et
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    console.log("Yönetici girişi başarılı.");
                    await loadPricingSettings(); // Yönetici panelinde de fiyatlandırma ayarları gerekli olabilir
                    if (adminContent) adminContent.classList.remove('hidden');
                    if (adminDashboard) adminDashboard.classList.remove('hidden');
                    if (unauthorizedMessage) unauthorizedMessage.classList.add('hidden');
                    
                    // Dashboard verilerini yükle
                    await loadDashboardData();

                    // İlk olarak siparişler sekmesini göster
                    showTab('orders'); 
                    listenToAllOrders(); // Tüm siparişleri dinlemeye başla
                    listenToAllUsers(); // Tüm kullanıcıları dinlemeye başla
                    listenToPendingProducts(); // Onay bekleyen ürünleri dinle
                    renderSettings(); // Ayarları render et
                } else {
                    console.warn("Yetkisiz erişim: Kullanıcı yönetici değil.");
                    if (adminContent) adminContent.classList.remove('hidden');
                    if (unauthorizedMessage) unauthorizedMessage.classList.remove('hidden');
                    if (adminDashboard) adminDashboard.classList.add('hidden');
                    showToast("Bu sayfayı görüntülemek için yetkiniz yok.");
                }
            } else {
                console.warn("Kullanıcı giriş yapmadı (Admin).");
                if (adminContent) adminContent.classList.remove('hidden');
                if (unauthorizedMessage) unauthorizedMessage.classList.remove('hidden');
                if (adminDashboard) adminDashboard.classList.add('hidden');
                showToast("Yönetici panelini görüntülemek için giriş yapmanız gerekiyor.");
            }
            if (loader) loader.classList.add('hidden'); // Yükleyiciyi gizle
        });

        // Tab değiştirme olay dinleyicileri
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                showTab(tab);
            });
        });

        // Ayarları kaydet butonu
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', savePricingSettings);
        }
    });

    // Sekme gösterme fonksiyonu
    function showTab(tabId) {
        tabContents.forEach(content => {
            content.classList.add('hidden');
        });
        tabButtons.forEach(button => {
            button.classList.remove('border-primary-500', 'text-primary');
            button.classList.add('border-transparent', 'text-gray-600');
        });

        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('border-primary-500', 'text-primary');
        document.querySelector(`[data-tab="${tabId}"]`).classList.remove('border-transparent', 'text-gray-600');
    }

    // Dashboard özet verilerini yükle
    async function loadDashboardData() {
        try {
            // Toplam Siparişler
            const ordersSnapshot = await getDocs(collection(db, 'orders'));
            if (totalOrdersCount) totalOrdersCount.textContent = ordersSnapshot.size;

            // Tamamlanan Siparişler (status === 'delivered')
            const completedOrdersQuery = query(collection(db, 'orders'), where('status', '==', 'delivered'));
            const completedOrdersSnapshot = await getDocs(completedOrdersQuery);
            if (completedOrdersCount) completedOrdersCount.textContent = completedOrdersSnapshot.size;

            // Toplam Kullanıcılar
            const usersSnapshot = await getDocs(collection(db, 'users'));
            if (totalUsersCount) totalUsersCount.textContent = usersSnapshot.size;

        } catch (error) {
            console.error("Dashboard verileri yüklenirken hata:", error);
            showToast("Dashboard verileri yüklenirken bir hata oluştu.");
        }
    }


    // Fiyatlandırma ayarlarını yükle (sipariş toplamlarını doğru hesaplamak için)
    async function loadPricingSettings() {
        try {
            const docRef = doc(db, "settings", "pricing");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().categoryRates) {
                pricingSettings = docSnap.data();
            } else {
                pricingSettings = DEFAULT_SETTINGS;
                // Eğer ayarlar yoksa, varsayılanları Firestore'a kaydet (ilk kez)
                await setDoc(docRef, DEFAULT_SETTINGS);
                console.log("Varsayılan fiyatlandırma ayarları Firestore'a kaydedildi.");
            }
        } catch (error) {
            console.error("Fiyat ayarları yüklenirken hata oluştu (Admin):", error);
            pricingSettings = DEFAULT_SETTINGS;
        }
    }

    // Tüm siparişleri dinle ve göster
    function listenToAllOrders() {
        if (!ordersList || !noOrdersAdminMessage) {
            console.error("Yönetici sipariş DOM öğeleri eksik.");
            return;
        }

        const ordersRef = collection(db, 'orders');
        // Tüm siparişleri, en yeni olandan en eskiye doğru sırala
        const q = query(ordersRef, orderBy("orderDate", "desc"));

        onSnapshot(q, (snapshot) => {
            const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm siparişler yüklendi (Admin):", allOrders);
            renderAdminOrders(allOrders);
        }, (error) => {
            console.error("Tüm siparişler dinlenirken hata oluştu (Admin):", error);
            showToast("Siparişler yüklenirken bir hata oluştu.");
            if (ordersList) ordersList.innerHTML = `<p class="text-red-500">Siparişler yüklenemedi.</p>`;
        });
    }

    function renderAdminOrders(orders) {
        if (!ordersList || !noOrdersAdminMessage) return;

        if (orders.length === 0) {
            noOrdersAdminMessage.classList.remove('hidden');
            ordersList.innerHTML = '';
            return;
        }

        noOrdersAdminMessage.classList.add('hidden');
        ordersList.innerHTML = '';

        orders.forEach(order => {
            const orderDate = order.orderDate?.seconds
                ? new Date(order.orderDate.seconds * 1000).toLocaleDateString("tr-TR", {
                      year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit"
                    })
                : "Tarih Yok";
            
            const statusStyles = {
                pending_payment: { text: 'Ödeme Bekleniyor', bg: 'bg-yellow-500', text_color: 'text-white' },
                processing: { text: 'İşleniyor', bg: 'bg-blue-500', text_color: 'text-white' }, 
                shipped: { text: 'Kargoya Verildi', bg: 'bg-teal-500', text_color: 'text-white' },
                delivered: { text: 'Teslim Edildi', bg: 'bg-green-500', text_color: 'text-white' },
                cancelled: { text: 'İptal Edildi', bg: 'bg-red-500', text_color: 'text-white' }
            };
            const currentStatus = statusStyles[order.status] || { text: order.status, bg: 'bg-gray-400', text_color: 'text-white' };

            const categoryRates = pricingSettings.categoryRates || {};
            const itemsHtml = (order.items ?? []).map(item => {
                const itemProductPriceValue = parseFloat(item.productPrice) || 0;
                const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);
                let itemServiceFee = 0;
                if (item.type === 'custom_order') {
                    itemServiceFee = itemProductPriceValue * serviceRate;
                }
                const itemFinalPrice = item.orderMethod === 'service' ? itemProductPriceValue + itemServiceFee : itemProductPriceValue;
                const itemLineTotal = (itemFinalPrice * (parseInt(item.quantity) || 1)).toFixed(2);

                return `
                    <li class="text-sm text-gray-700 mb-1 flex justify-between items-start">
                        <div class="flex-1 min-w-0 pr-2">
                            <p class="font-medium truncate">${item.productLink}</p>
                            <p class="text-xs text-gray-500 mt-0.5">Kategori: ${item.category || 'Belirtilmemiş'} | Adet: ${item.quantity || 1}</p>
                        </div>
                        <span class="font-semibold text-gray-800 flex-shrink-0">${itemLineTotal} ₺</span>
                    </li>`;
            }).join("");
            
            // Debugging: Log the raw grandTotal from Firestore
            console.log(`Order ID: ${order.id}, Raw grandTotal:`, order.grandTotal, `Type:`, typeof order.grandTotal);

            // Ensure grandTotal is treated as a number for display
            const numericGrandTotal = parseFloat(order.grandTotal); // Explicitly parse as float

            const grandTotalDisplay = !isNaN(numericGrandTotal)
                ? `${numericGrandTotal.toFixed(2)} ₺`
                : 'Hesaplanamadı'; // Fallback if it's still not a valid number or is NaN


            const card = `
                <div class="bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200">
                    <div class="flex justify-between items-center pb-2 border-b border-gray-100 mb-2">
                        <h3 class="font-bold text-primary text-lg">Sipariş: ${order.id.substring(0, 8).toUpperCase()}</h3>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${currentStatus.bg} ${currentStatus.text_color}">${currentStatus.text}</span>
                    </div>
                    <p class="text-sm text-gray-500">Kullanıcı: ${order.userFullName || 'Bilinmiyor'} (${order.userEmail})</p>
                    <p class="text-sm text-gray-500">Telefon: ${order.userPhone || 'Bilinmiyor'}</p>
                    <p class="text-sm text-gray-500">Tarih: ${orderDate}</p>
                    <p class="text-sm text-gray-500">Teslimat: ${order.deliveryType === 'home' ? 'Eve Teslim' : 'Depodan Teslim'}${order.selectedCity ? ` (${order.selectedCity})` : ''}</p>
                    <p class="text-sm text-gray-500">Adres: ${order.deliveryAddress}</p>
                    
                    <h4 class="font-semibold text-gray-700 mt-4 mb-2">Ürünler:</h4>
                    <ul class="space-y-2 border-t pt-2">${itemsHtml}</ul>
                    
                    <div class="flex justify-end border-t pt-3 mt-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Genel Toplam</p>
                            <p class="font-bold text-lg">${grandTotalDisplay}</p>
                        </div>
                    </div>
                </div>
            `;
            ordersList.innerHTML += card;
        });
    }

    // --- Kullanıcı Yönetimi Fonksiyonları ---
    function listenToAllUsers() {
        if (!usersList || !noUsersMessage) {
            console.error("Kullanıcı DOM öğeleri eksik.");
            return;
        }
        const usersRef = collection(db, 'users');
        const q = query(usersRef, orderBy("createdAt", "desc")); // Kullanıcıları oluşturulma tarihine göre sırala

        onSnapshot(q, (snapshot) => {
            const allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm kullanıcılar yüklendi (Admin):", allUsers);
            renderUsers(allUsers);
        }, (error) => {
            console.error("Kullanıcılar dinlenirken hata oluştu (Admin):", error);
            showToast("Kullanıcılar yüklenirken bir hata oluştu.");
            if (usersList) usersList.innerHTML = `<p class="text-red-500">Kullanıcılar yüklenemedi.</p>`;
        });
    }

    function renderUsers(users) {
        if (!usersList || !noUsersMessage) return;

        if (users.length === 0) {
            noUsersMessage.classList.remove('hidden');
            usersList.innerHTML = '';
            return;
        }

        noUsersMessage.classList.add('hidden');
        usersList.innerHTML = '';

        users.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200 flex items-center justify-between';
            userCard.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=U'}" alt="User" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-semibold text-gray-800">${user.fullName || user.email}</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${user.role || 'customer'}</span>
                    <button data-user-id="${user.id}" data-current-role="${user.role}" class="toggle-admin-btn bg-purple-500 text-white text-sm px-3 py-1 rounded-button hover:bg-purple-600 transition-colors">
                        ${user.role === 'admin' ? 'Adminlikten Çıkar' : 'Admin Yap'}
                    </button>
                </div>
            `;
            usersList.appendChild(userCard);
        });

        // Rol değiştirme butonlarına olay dinleyici ekle
        document.querySelectorAll('.toggle-admin-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const userId = e.target.dataset.userId;
                const currentRole = e.target.dataset.currentRole;
                const newRole = currentRole === 'admin' ? 'customer' : 'admin';
                
                if (confirm(`Kullanıcının rolünü "${newRole}" olarak değiştirmek istediğinize emin misiniz?`)) {
                    try {
                        const userRef = doc(db, 'users', userId);
                        await updateDoc(userRef, { role: newRole });
                        showToast("Kullanıcı rolü başarıyla güncellendi!");
                    } catch (error) {
                        console.error("Kullanıcı rolü güncellenirken hata:", error);
                        showToast("Kullanıcı rolü güncellenemedi: " + error.message);
                    }
                }
            });
        });
    }

    // --- Ürün Yönetimi Fonksiyonları ---
    function listenToPendingProducts() {
        if (!productsList || !noProductsMessage) {
            console.error("Ürün DOM öğeleri eksik.");
            return;
        }
        const productsRef = collection(db, 'products');
        const q = query(productsRef, where("isApproved", "==", false), orderBy("createdAt", "desc")); // Onay bekleyen ürünleri getir

        onSnapshot(q, (snapshot) => {
            const pendingProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Onay bekleyen ürünler yüklendi (Admin):", pendingProducts);
            renderPendingProducts(pendingProducts);
        }, (error) => {
            console.error("Onay bekleyen ürünler dinlenirken hata oluştu (Admin):", error);
            showToast("Ürünler yüklenirken bir hata oluştu.");
            if (productsList) productsList.innerHTML = `<p class="text-red-500">Ürünler yüklenemedi.</p>`;
        });
    }

    function renderPendingProducts(products) {
        if (!productsList || !noProductsMessage) return;

        if (products.length === 0) {
            noProductsMessage.classList.remove('hidden');
            productsList.innerHTML = '';
            return;
        }

        noProductsMessage.classList.add('hidden');
        productsList.innerHTML = '';

        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200';
            productCard.innerHTML = `
                <div class="flex items-center gap-4">
                    <img src="${product.imageUrl || 'https://placehold.co/80x80/e2e8f0/64748b?text=Ürün'}" alt="${product.productName}" class="w-20 h-20 object-cover rounded-md">
                    <div class="flex-1">
                        <p class="font-semibold text-lg text-gray-800">${product.productName}</p>
                        <p class="text-sm text-gray-600 line-clamp-2">${product.description}</p>
                        <p class="text-md font-bold text-primary">${product.price.toFixed(2)} ₺</p>
                        <p class="text-xs text-gray-500">Üretici ID: ${product.producerId}</p>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button data-product-id="${product.id}" class="approve-product-btn bg-green-500 text-white text-sm px-4 py-2 rounded-button hover:bg-green-600 transition-colors">Onayla</button>
                    <button data-product-id="${product.id}" class="reject-product-btn bg-red-500 text-white text-sm px-4 py-2 rounded-button hover:bg-red-600 transition-colors">Reddet</button>
                </div>
            `;
            productsList.appendChild(productCard);
        });

        // Onay/Reddet butonlarına olay dinleyici ekle
        document.querySelectorAll('.approve-product-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const productId = e.target.dataset.productId;
                if (confirm('Bu ürünü onaylamak istediğinize emin misiniz?')) {
                    try {
                        const productRef = doc(db, 'products', productId);
                        await updateDoc(productRef, { isApproved: true });
                        showToast("Ürün başarıyla onaylandı!");
                    } catch (error) {
                        console.error("Ürün onaylanırken hata:", error);
                        showToast("Ürün onaylanamadı: " + error.message);
                    }
                }
            });
        });

        document.querySelectorAll('.reject-product-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const productId = e.target.dataset.productId;
                if (confirm('Bu ürünü reddetmek istediğinize emin misiniz? Bu işlem ürünü kalıcı olarak siler.')) {
                    try {
                        const productRef = doc(db, 'products', productId);
                        await deleteDoc(productRef); // Reddetmek ürünü siler
                        showToast("Ürün başarıyla reddedildi ve silindi!");
                    } catch (error) {
                        console.error("Ürün reddedilirken hata:", error);
                        showToast("Ürün reddedilemedi: " + error.message);
                    }
                }
            });
        });
    }

    // --- Ayarlar Yönetimi Fonksiyonları ---
    function renderSettings() {
        if (!categoryRatesSettings || !cityFeesSettings) return;

        categoryRatesSettings.innerHTML = '';
        for (const category in pricingSettings.categoryRates) {
            const rate = pricingSettings.categoryRates[category];
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <label for="rate-${category}" class="flex-1 text-sm font-medium text-gray-700 capitalize">${category}:</label>
                <input type="number" id="rate-${category}" data-setting-type="category" data-key="${category}" value="${(rate * 100).toFixed(0)}" class="w-20 p-2 border border-gray-300 rounded-md text-sm text-right" min="0" max="100">
                <span class="text-sm">%</span>
            `;
            categoryRatesSettings.appendChild(div);
        }

        cityFeesSettings.innerHTML = '';
        for (const city in pricingSettings.cityFees) {
            const fee = pricingSettings.cityFees[city];
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <label for="fee-${city}" class="flex-1 text-sm font-medium text-gray-700">${city}:</label>
                <input type="number" id="fee-${city}" data-setting-type="city" data-key="${city}" value="${fee.toFixed(0)}" class="w-20 p-2 border border-gray-300 rounded-md text-sm text-right" min="0">
                <span class="text-sm">₺</span>
            `;
            cityFeesSettings.appendChild(div);
        }
    }

    async function savePricingSettings() {
        const updatedCategoryRates = {};
        document.querySelectorAll('[data-setting-type="category"]').forEach(input => {
            updatedCategoryRates[input.dataset.key] = parseFloat(input.value) / 100;
        });

        const updatedCityFees = {};
        document.querySelectorAll('[data-setting-type="city"]').forEach(input => {
            updatedCityFees[input.dataset.key] = parseFloat(input.value);
        });

        try {
            const settingsRef = doc(db, 'settings', 'pricing');
            await updateDoc(settingsRef, {
                categoryRates: updatedCategoryRates,
                cityFees: updatedCityFees
            });
            pricingSettings.categoryRates = updatedCategoryRates;
            pricingSettings.cityFees = updatedCityFees;
            showToast("Ayarlar başarıyla kaydedildi!");
        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            showToast("Ayarlar kaydedilemedi: " + error.message);
        }
    }

</script>
</body>
</html>
