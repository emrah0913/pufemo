<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - YÃ¶netim Paneli</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #e74c3c; --background-color: #f4f7f9;
            --form-bg-color: #ffffff; --text-color: #34495e; --border-color: #dfe6e9;
            --success-color: #27ae60; --danger-color: #c0392b; --info-color: #3498db;
            --border-radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; transition: opacity 0.3s ease; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background-color: var(--primary-color); color: white; padding: 1.5rem; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; margin-bottom: 2rem; }
        .sidebar-header h2 { font-size: 1.8rem; }
        .sidebar-header i { color: var(--secondary-color); }
        .sidebar-nav ul { list-style: none; padding: 0;}
        .sidebar-nav h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem; }
        .sidebar-nav li { padding: 0.8rem 1rem; margin-bottom: 0.5rem; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-nav li:hover, .sidebar-nav li.active { background-color: rgba(255,255,255,0.1); }
        .sidebar-nav .nav-item-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; max-height: 100vh; }
        .page { display: block; }
        .form-section { background-color: var(--form-bg-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; position: relative;}
        .form-section h2, .form-section h3 { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
        .main-content .page > h1:first-child { font-size: 2.2rem; margin-bottom: 2rem; color: var(--primary-color); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: opacity 0.3s; }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-primary { background-color: var(--info-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #bdc3c7; color: white; }
        .form-actions { margin-top: 2rem; text-align: right; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; }
        .country-pricing-item { display: flex; align-items: center; justify-content: space-between; background-color: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 10px 15px; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .country-name-inputs-group { display: flex; flex-wrap: wrap; gap: 10px; flex-grow: 1; align-items: center; min-width: 200px; }
        .country-name-inputs-group .form-group { margin-bottom: 0; flex: 1; min-width: 100px; }
        .country-name-inputs-group .form-group label { font-size: 0.8em; color: #666; margin-bottom: 2px; }
        .country-name-inputs-group .form-group input { padding: 8px; font-size: 0.9rem; }
        .country-adjustments-group { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex-grow: 1; }
        .country-controls { flex-shrink: 0; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">YÃ¼kleniyor...</div>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fa-solid fa-couch"></i> PUFEMO</h2>
                <p>YÃ¶netim Paneli</p>
            </div>
            <nav class="sidebar-nav">
                <h3>Genel</h3>
                <ul>
                    <li class="nav-item" data-page="homepage-settings"><span class="nav-item-name">Anasayfa AyarlarÄ±</span></li>
                    <li class="nav-item" data-page="general-settings"><span class="nav-item-name">Site Genel AyarlarÄ±</span></li>
                </ul>
                <h3>Ä°Ã§erik</h3>
                <ul>
                    <li class="nav-item" data-page="product-management"><span class="nav-item-name">ÃœrÃ¼nler</span></li>
                    <li class="nav-item" data-page="category-management"><span class="nav-item-name">Kategoriler</span></li>
                    <li class="nav-item" data-page="country-pricing-management"><span class="nav-item-name">Ãœlkelere GÃ¶re FiyatlandÄ±rma</span></li> 
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Ä°Ã§erik buraya yÃ¼klenecek -->
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
        };
        
        let db;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (e) { alert('Firebase baÅŸlatÄ±lamadÄ±: ' + e.message); }

        if (db) {
            // === BÃ–LÃœM 1: GLOBAL STATE VE TEMEL FONKSÄ°YONLAR ===
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContent = document.querySelector('.main-content');
            let localState = {};

            const showLoading = () => loadingOverlay.classList.remove('hidden');
            const hideLoading = () => loadingOverlay.classList.add('hidden');
            
            // === BÃ–LÃœM 2: VERÄ° Ä°ÅžLEMLERÄ° (FIREBASE) ===
            async function fetchData() {
                showLoading();
                try {
                    const [settingsDoc, categoriesDoc, productsSnapshot] = await Promise.all([
                        db.collection('pufemo').doc('settings').get(),
                        db.collection('pufemo').doc('categories').get(),
                        db.collection('pufemo-products').get() 
                    ]);
                    
                    const defaultState = {
                         settings: { 
                            languages: [ { code: 'tr', name: { tr: 'TÃ¼rkÃ§e', en: 'Turkish' }, flag: 'ðŸ‡¹ðŸ‡·' } ],
                            countryPricing: {}, 
                            currencySymbols: { "TRY": "â‚º" },
                            banner: { slides: [] },
                            general: { 
                                logo: { type: 'text_icon', text: 'PUFEMO', icon: 'fa-solid fa-couch' },
                                promoBar: { enabled: true }
                            }
                        }, 
                        categories: [], 
                        products: [] 
                    };
                    const fetchedSettings = settingsDoc.exists ? settingsDoc.data() : {};
                    const areLanguagesValid = fetchedSettings.languages?.length > 0 && typeof fetchedSettings.languages[0].name === 'object';
                    localState.settings = {
                        ...defaultState.settings, ...fetchedSettings,
                        general: { ...defaultState.settings.general, ...(fetchedSettings.general || {}) },
                        banner: fetchedSettings.banner || defaultState.settings.banner,
                        languages: areLanguagesValid ? fetchedSettings.languages : defaultState.settings.languages,
                        countryPricing: fetchedSettings.countryPricing || defaultState.settings.countryPricing,
                        currencySymbols: fetchedSettings.currencySymbols || defaultState.settings.currencySymbols,
                    };
                    localState.categories = categoriesDoc.exists ? categoriesDoc.data().tree || [] : defaultState.categories;
                    localState.products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Veri yÃ¼klenirken hata: ', error);
                } finally {
                    hideLoading();
                }
            }

            async function saveData(data) {
                showLoading();
                try {
                    await db.collection('pufemo').doc('settings').set(data, { merge: true });
                    alert('DeÄŸiÅŸiklikler kaydedildi!'); 
                } catch (error) {
                    alert('Kaydedilirken bir hata oluÅŸtu: ' + error.message);
                } finally {
                    hideLoading();
                }
            }

            // === BÃ–LÃœM 3: SAYFA YÃ–NETÄ°MÄ° ===
            async function loadPage(pageName) {
                if (!pageName) return;
                showLoading();
                try {
                    const response = await fetch(`sayfalar/${pageName}.html`);
                    if (!response.ok) throw new Error(`${pageName}.html dosyasÄ± bulunamadÄ±.`);
                    mainContent.innerHTML = await response.text();
                    setupPage(pageName);
                } catch (error) {
                    mainContent.innerHTML = `<h1>Hata</h1><p>${error.message}</p>`;
                } finally {
                    hideLoading();
                }
            }

            function setupPage(pageName) {
                switch (pageName) {
                    case 'product-management': break;
                    case 'category-management': break;
                    case 'homepage-settings': break;
                    case 'general-settings': break;
                    case 'country-pricing-management':
                        renderCountryPricingList();
                        setupCountryPricingListeners();
                        break;
                }
            }

            // === BÃ–LÃœM 4: ÃœLKE FÄ°YATLANDIRMA FONKSÄ°YONLARI ===
            function renderCountryPricingList() {
                const container = mainContent.querySelector('#country-pricing-list-container');
                if (!container) return;
                container.innerHTML = '';
                
                const countries = localState.settings.countryPricing || {};
                const sortedCountryCodes = Object.keys(countries).sort((a, b) => {
                    const nameA = countries[a].name?.tr || countries[a].name?.en || a;
                    const nameB = countries[b].name?.tr || countries[b].name?.en || b;
                    return nameA.localeCompare(nameB);
                });

                if (sortedCountryCodes.length === 0) {
                    container.innerHTML = '<p>HenÃ¼z tanÄ±mlÄ± bir Ã¼lke fiyatlandÄ±rmasÄ± yok. "Yeni Ãœlke Ekle" butonu ile baÅŸlayabilirsiniz.</p>';
                    return;
                }

                sortedCountryCodes.forEach(code => {
                    const country = countries[code];
                    const item = document.createElement('div');
                    item.className = 'country-pricing-item';
                    item.dataset.code = code;

                    const nameInputsHTML = localState.settings.languages.map(lang => `
                        <div class="form-group">
                            <label>${lang.flag || ''} ${lang.code.toUpperCase()}</label>
                            <input type="text" class="country-name-input" data-lang="${lang.code}" value="${country.name?.[lang.code] || ''}" placeholder="${lang.name.tr || lang.code} AdÄ±">
                        </div>`).join('');
                    
                    const currencyOptionsHTML = Object.keys(localState.settings.currencySymbols).map(cCode => 
                        `<option value="${localState.settings.currencySymbols[cCode]}" ${localState.settings.currencySymbols[cCode] === country.currencySymbol ? 'selected' : ''}>${cCode}</option>`
                    ).join('');

                    const languageOptionsHTML = localState.settings.languages.map(lang =>
                        `<option value="${lang.code}" ${lang.code === country.defaultLanguage ? 'selected' : ''}>${lang.name.tr || lang.name.en || lang.code}</option>`
                    ).join('');

                    item.innerHTML = `
                        <div class="country-name-inputs-group">
                            ${nameInputsHTML}
                        </div>
                        <div class="country-adjustments-group">
                            <span style="font-weight: 500;">(${country.flag || ''} ${code.toUpperCase()})</span>
                            <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.8em;">Fiyat FarkÄ± (%)</label><input type="number" data-field="adjustment" value="${country.adjustment || 0}" style="width: 80px;"></div>
                            <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.8em;">Para Birimi</label><select data-field="currencySymbol">${currencyOptionsHTML}</select></div>
                            <div class="form-group" style="margin-bottom:0;"><label style="font-size:0.8em;">VarsayÄ±lan Dil</label><select data-field="defaultLanguage">${languageOptionsHTML}</select></div>
                        </div>
                        <div class="country-controls">
                            <button type="button" class="btn btn-sm btn-danger delete-country-btn" data-code="${code}" title="Ãœlkeyi Sil"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                    container.appendChild(item);
                });
            }

            function showNewCountryPricingForm() {
                const container = mainContent.querySelector('#new-country-pricing-form-container');
                if (!container || container.querySelector('form')) return;

                const nameInputsHTML = localState.settings.languages.map(lang => `
                    <div class="form-group"><label>Ãœlke AdÄ± (${lang.name.tr || lang.code})</label><input type="text" class="new-country-name-input" data-lang="${lang.code}" placeholder="${lang.name.tr || lang.code} dilindeki adÄ±"></div>
                `).join('');

                container.innerHTML = `
                    <form class="form-section">
                        <h3>Yeni Ãœlke Ekle</h3>
                        <div class="form-group"><label for="newCountryCode">Ãœlke Kodu (Ã–rn: DE, FR)</label><input type="text" id="newCountryCode" maxlength="2" required style="text-transform: uppercase;"></div>
                        ${nameInputsHTML}
                        <div class="form-group"><label for="newCountryFlag">Bayrak Emojisi</label><input type="text" id="newCountryFlag" maxlength="2"></div>
                        <div class="form-group"><label for="newCountryAdjustment">YÃ¼zdesel Ayarlama (%)</label><input type="number" id="newCountryAdjustment" value="0"></div>
                        <div class="form-group"><label for="newCountryDefaultLanguage">VarsayÄ±lan Dil</label><select id="newCountryDefaultLanguage" required>${localState.settings.languages.map(lang => `<option value="${lang.code}">${lang.name.tr || lang.code}</option>`).join('')}</select></div>
                        <div class="form-group"><label for="newCountryCurrencySymbol">Para Birimi</label><select id="newCountryCurrencySymbol" required>${Object.keys(localState.settings.currencySymbols).map(code => `<option value="${localState.settings.currencySymbols[code]}">${code}</option>`).join('')}</select></div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary cancel-new-country-btn">Ä°ptal</button>
                            <button type="submit" class="btn btn-success">Ekle</button>
                        </div>
                    </form>`;
                
                const form = container.querySelector('form');
                form.querySelector('#newCountryCode').focus();

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const code = form.querySelector('#newCountryCode').value.trim().toLowerCase();
                    if (!code) { alert('Ãœlke kodu boÅŸ bÄ±rakÄ±lamaz.'); return; }
                    if (localState.settings.countryPricing[code]) { alert('Bu Ã¼lke kodu zaten mevcut!'); return; }

                    const newCountryData = {
                        name: {},
                        flag: form.querySelector('#newCountryFlag').value.trim(),
                        adjustment: parseFloat(form.querySelector('#newCountryAdjustment').value) || 0,
                        defaultLanguage: form.querySelector('#newCountryDefaultLanguage').value,
                        currencySymbol: form.querySelector('#newCountryCurrencySymbol').value
                    };
                    form.querySelectorAll('.new-country-name-input').forEach(input => newCountryData.name[input.dataset.lang] = input.value.trim());
                    
                    localState.settings.countryPricing[code] = newCountryData;
                    await saveData({ settings: { countryPricing: localState.settings.countryPricing } });
                    container.innerHTML = '';
                    renderCountryPricingList();
                });
                form.querySelector('.cancel-new-country-btn').addEventListener('click', () => container.innerHTML = '');
            }

            function setupCountryPricingListeners() {
                const page = mainContent.querySelector('.page');
                if(!page) return;

                page.querySelector('#add-new-country-pricing-btn').addEventListener('click', showNewCountryPricingForm);

                page.querySelector('#country-pricing-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const updatedPricing = {};
                    page.querySelectorAll('.country-pricing-item').forEach(item => {
                        const code = item.dataset.code;
                        const countryData = {
                            name: {},
                            flag: localState.settings.countryPricing[code].flag || '',
                            adjustment: parseFloat(item.querySelector('[data-field="adjustment"]').value) || 0,
                            defaultLanguage: item.querySelector('[data-field="defaultLanguage"]').value,
                            currencySymbol: item.querySelector('[data-field="currencySymbol"]').value
                        };
                        item.querySelectorAll('.country-name-input').forEach(input => countryData.name[input.dataset.lang] = input.value.trim());
                        updatedPricing[code] = countryData;
                    });
                    localState.settings.countryPricing = updatedPricing;
                    await saveData({ settings: { countryPricing: localState.settings.countryPricing } });
                });

                page.querySelector('#country-pricing-list-container').addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.delete-country-btn');
                    if (deleteBtn) {
                        const codeToDelete = deleteBtn.dataset.code;
                        const countryName = localState.settings.countryPricing[codeToDelete]?.name.tr || codeToDelete.toUpperCase();
                        if (confirm(`'${countryName}' Ã¼lkesini silmek istediÄŸinizden emin misiniz?`)) {
                            delete localState.settings.countryPricing[codeToDelete];
                            const updateData = { [`settings.countryPricing.${codeToDelete}`]: firebase.firestore.FieldValue.delete() };
                            await db.collection('pufemo').doc('settings').update(updateData);
                            alert('Ãœlke baÅŸarÄ±yla silindi.');
                            renderCountryPricingList();
                        }
                    }
                });
            }

            // === BÃ–LÃœM 5: BAÅžLANGIÃ‡ ===
            async function init() {
                await fetchData();
                const initialPage = 'product-management'; // BaÅŸlangÄ±Ã§ sayfasÄ±
                document.querySelector('.sidebar-nav .nav-item.active')?.classList.remove('active');
                document.querySelector(`.sidebar-nav .nav-item[data-page="${initialPage}"]`).classList.add('active');
                await loadPage(initialPage);
            }
            
            document.querySelector('.sidebar-nav').addEventListener('click', e => { 
                const navItem = e.target.closest('.nav-item'); 
                if (!navItem) return; 
                document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => item.classList.remove('active')); 
                navItem.classList.add('active'); 
                loadPage(navItem.dataset.page); 
            });

            init();
        }
    </script>
</body>
</html>
