<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PUFEMO - Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f8f9fa; padding:20px; margin:0; }
    .container { max-width: 1000px; margin:auto; background:#fff; padding:25px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    h2 { text-align:center; margin-bottom:20px; }
    select, button { padding:8px 15px; margin-right:10px; border-radius:5px; border:1px solid #ccc; cursor:pointer; }
    .order { border-radius:6px; padding:15px; margin-bottom:20px; }
    .status-bekliyor { background-color: #fff3cd; }
    .status-hazirlaniyor { background-color: #cce5ff; }
    .status-kargoda { background-color: #b8daff; }
    .status-teslim { background-color: #d4edda; }
    .order h3 { margin:0 0 10px 0; }
    .order p { margin:5px 0; font-size:14px; }
    .order ul { padding-left:20px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
      authDomain: "pufemo-com.firebaseapp.com",
      projectId: "pufemo-com",
      storageBucket: "pufemo-com.firebasestorage.app",
      messagingSenderId: "983352837227",
      appId: "1:983352837227:web:defaa8dae215776e2e",
      measurementId: "G-RH8XHC7P91"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_UID = "H6sELZRKnKdmyBH42tyItpglwRJ3"; // Senin verdiğin UID

    let ordersData = [];
    let filteredStatus = 'all';

    function getStatusClass(status) {
      switch(status?.toLowerCase()) {
        case 'bekliyor': return 'status-bekliyor';
        case 'hazırlanıyor': return 'status-hazirlaniyor';
        case 'kargoda': return 'status-kargoda';
        case 'teslim edildi': return 'status-teslim';
        default: return '';
      }
    }

    function renderOrders() {
      const container = document.getElementById('order-list');
      container.innerHTML = '';
      const filtered = filteredStatus === 'all' ? ordersData : ordersData.filter(o => o.status.toLowerCase() === filteredStatus);

      filtered.forEach(order => {
        const list = order.cart.map(i => `<li>${i.name} x ${i.qty}</li>`).join('');
        const orderDiv = document.createElement('div');
        orderDiv.className = `order ${getStatusClass(order.status)}`;
        orderDiv.innerHTML = `
          <h3>${order.name} - ${order.total} ${order.currency}</h3>
          <p><strong>Tarih:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
          <p><strong>Telefon:</strong> ${order.phone}</p>
          <p><strong>Adres:</strong> ${order.address}</p>
          <p><strong>Sipariş:</strong></p>
          <ul>${list}</ul>
          <p><strong>Durum:</strong>
            <select onchange="updateStatus('${order.id}', this.value)">
              <option value="Bekliyor" ${order.status === 'Bekliyor' ? 'selected' : ''}>Bekliyor</option>
              <option value="Hazırlanıyor" ${order.status === 'Hazırlanıyor' ? 'selected' : ''}>Hazırlanıyor</option>
              <option value="Kargoda" ${order.status === 'Kargoda' ? 'selected' : ''}>Kargoda</option>
              <option value="Teslim Edildi" ${order.status === 'Teslim Edildi' ? 'selected' : ''}>Teslim Edildi</option>
            </select>
          </p>
          <button onclick="downloadPDF('${order.id}')">PDF İndir</button>
        `;
        container.appendChild(orderDiv);
      });
    }

    async function updateStatus(id, status) {
      const ref = doc(db, "orders", id);
      await updateDoc(ref, { status });
      ordersData = ordersData.map(o => o.id === id ? {...o, status} : o);
      renderOrders();
      alert("Sipariş durumu güncellendi.");
    }

    async function downloadPDF(orderId) {
      const { jsPDF } = window.jspdf;
      const order = ordersData.find(o => o.id === orderId);
      if (!order) return alert("Sipariş bulunamadı.");

      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text(`Sipariş Detayı - ${order.name}`, 10, 20);
      doc.setFontSize(12);
      doc.text(`Tarih: ${new Date(order.timestamp).toLocaleString()}`, 10, 30);
      doc.text(`Telefon: ${order.phone}`, 10, 40);
      doc.text(`Adres: ${order.address}`, 10, 50);
      doc.text(`Toplam: ${order.total} ${order.currency}`, 10, 60);
      doc.text("Ürünler:", 10, 70);

      order.cart.forEach((item, i) => {
        doc.text(`${i + 1}. ${item.name} x ${item.qty}`, 15, 80 + i * 10);
      });

      doc.save(`siparis_${order.id}.pdf`);
    }

    function filterChange(event) {
      filteredStatus = event.target.value.toLowerCase();
      renderOrders();
    }

    onAuthStateChanged(auth, async user => {
      if (!user || user.uid !== ADMIN_UID) {
        document.body.innerHTML = '<p style="text-align:center;">Yetkiniz yok. Lütfen admin girişi yapınız.</p>';
        return;
      }
      const snapshot = await getDocs(collection(db, "orders"));
      ordersData = [];
      snapshot.forEach(docSnap => {
        ordersData.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderOrders();
    });

    window.updateStatus = updateStatus;
    window.downloadPDF = downloadPDF;
    window.filterChange = filterChange;
  </script>
</head>
<body>
  <div class="container">
    <h2>Admin - Sipariş Yönetimi</h2>
    <select onchange="filterChange(event)">
      <option value="all">Tüm Durumlar</option>
      <option value="bekliyor">Bekliyor</option>
      <option value="hazırlanıyor">Hazırlanıyor</option>
      <option value="kargoda">Kargoda</option>
      <option value="teslim edildi">Teslim Edildi</option>
    </select>
    <div id="order-list"></div>
  </div>
</body>
</html>
