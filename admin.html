<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getir Kıbrıs - Yönetici Paneli</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: { primary: '#5d3ebc', secondary: '#ffd300' },
                borderRadius: { 'button': '8px' }
            }
        }
    }
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f9f9f9; }
    .active-nav-link { background-color: #f0f0f0; color: #5d3ebc; font-weight: 600; }
    .fixed-header { height: 64px; }
    .fixed-sidebar { top: 64px; height: calc(100vh - 64px); }
    .content-area { margin-left: 224px; padding: 20px; }
    .status-badge { display: inline-flex; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; line-height: 1.25rem; font-weight: 600; }
    .status-pending { background-color: #fef3c7; color: #b45309; } .status-approved { background-color: #bfdbfe; color: #1d4ed8; }
    .status-tr_warehouse { background-color: #fef9c3; color: #a16207; } .status-shipped { background-color: #e9d5ff; color: #8b5cf6; }
    .status-cy_warehouse { background-color: #dbeafe; color: #1e40af; } .status-delivered { background-color: #d1fae5; color: #065f46; }
    .status-cancelled { background-color: #fee2e2; color: #b91c1c; } .status-unknown { background-color: #e5e7eb; color: #4b5563; }
</style>
</head>
<body class="bg-gray-50">
<div class="w-full max-w-screen-xl mx-auto relative min-h-screen">

    <header class="fixed-header fixed top-0 w-full bg-white shadow-sm z-50 px-4 py-3 flex items-center">
        <div class="flex-1">
            <h1 class="text-xl font-semibold text-primary">Yönetici Paneli</h1>
        </div>
        <div class="flex flex-col items-center">
             <a href="index.html"><img src="logom.png" alt="Getir Kıbrıs" class="h-12"></a>
        </div>
        <div class="flex-1 flex justify-end">
            <div id="admin-auth-button" class="w-8 h-8 flex items-center justify-center">
                <div id="admin-profile-container" class="hidden">
                    <img id="admin-profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full cursor-pointer">
                </div>
            </div>
        </div>
    </header>

    <div class="flex pt-16">
        <aside class="fixed-sidebar w-56 bg-white shadow-md p-4 fixed left-0 flex flex-col">
            <nav class="space-y-2">
                <a href="#" id="nav-dashboard" class="flex items-center gap-2 p-2 rounded-md text-gray-700 hover:bg-gray-100"><i class="ri-dashboard-line"></i><span>Kontrol Paneli</span></a>
                <a href="#" id="nav-orders" class="flex items-center gap-2 p-2 rounded-md text-gray-700 hover:bg-gray-100"><i class="ri-file-list-3-line"></i><span>Siparişler</span></a>
                <a href="#" id="nav-reviews" class="flex items-center gap-2 p-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <i class="ri-message-2-line"></i><span>Yorum Yönetimi</span>
                    <span id="pending-reviews-badge" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center ml-auto hidden">0</span>
                </a>
                <a href="#" id="nav-users" class="flex items-center gap-2 p-2 rounded-md text-gray-700 hover:bg-gray-100"><i class="ri-user-line"></i><span>Kullanıcılar</span></a>
                <a href="#" id="nav-settings" class="flex items-center gap-2 p-2 rounded-md text-gray-700 hover:bg-gray-100"><i class="ri-settings-3-line"></i><span>Ayarlar</span></a>
            </nav>
        </aside>

        <main class="flex-1 content-area">
            <div id="content-dashboard" class="admin-content-section"></div>
            <div id="content-orders" class="admin-content-section hidden"></div>
            <div id="content-reviews" class="admin-content-section hidden"></div>
            <div id="content-users" class="admin-content-section hidden"></div>
            <div id="content-settings" class="admin-content-section hidden"></div>
        </main>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCHms5Y5x-KOu3Y43FrfRoljmW_4m3H4yY",
        authDomain: "kibris-6b4f7.firebaseapp.com",
        projectId: "kibris-6b4f7",
        storageBucket: "kibris-6b4f7.appspot.com",
        messagingSenderId: "141262926171",
        appId: "1:141262926171:web:07226845e51d4bbc0dea7e",
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', () => {
        const mainContent = document.querySelector('main');
        let currentEditingOrderId = null;

        const showSection = async (sectionId) => {
            document.querySelectorAll('aside nav a').forEach(a => a.classList.remove('active-nav-link'));
            document.querySelector(`#nav-${sectionId.replace('content-','')}`).classList.add('active-nav-link');
            
            mainContent.innerHTML = '<div class="text-center p-10"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div></div>';

            if (sectionId === 'content-dashboard') await loadDashboard();
            if (sectionId === 'content-orders') await loadOrders();
            if (sectionId === 'content-reviews') await loadReviews();
            if (sectionId === 'content-users') await loadUsers();
            if (sectionId === 'content-settings') await loadSettings();
        };

        const setupNavListeners = () => {
            document.querySelectorAll('aside nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = `content-${link.id.replace('nav-', '')}`;
                    showSection(sectionId);
                });
            });
        };

        const checkAuth = () => {
             auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().role === 'admin') {
                        document.getElementById('admin-profile-container').classList.remove('hidden');
                        document.getElementById('admin-profile-img').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=5d3ebc&color=fff`;
                        await showSection('content-dashboard');
                        await updatePendingReviewsBadge();
                    } else {
                        alert('Yönetici paneline erişim izniniz yok.');
                        window.location.href = 'index.html';
                    }
                } else {
                     alert('Yönetici paneline erişmek için giriş yapmalısınız.');
                     window.location.href = 'index.html';
                }
            });
            document.getElementById('admin-profile-container').addEventListener('click', () => {
                if (confirm('Çıkış yapmak istiyor musunuz?')) auth.signOut();
            });
        };
        
        const updatePendingReviewsBadge = async () => {
             const snapshot = await db.collection('reviews').where('isApproved', '==', false).get();
             const badge = document.getElementById('pending-reviews-badge');
             if(!snapshot.empty) {
                 badge.textContent = snapshot.size;
                 badge.classList.remove('hidden');
             } else {
                 badge.classList.add('hidden');
             }
        };

        const loadDashboard = async () => { /* ... Dashboard yükleme mantığı ... */ };
        const loadOrders = async () => { /* ... Sipariş yükleme mantığı ... */ };
        const loadUsers = async () => { /* ... Kullanıcı yükleme mantığı ... */ };
        const loadSettings = async () => { /* ... Ayar yükleme mantığı ... */ };

        const loadReviews = async () => {
            mainContent.innerHTML = `
                <div id="content-reviews">
                    <h2 class="text-2xl font-bold text-primary mb-6">Yorum Yönetimi</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Müşteri</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Yorum</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Puan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Durum</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="reviews-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="text-center p-4">Yorumlar yükleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            
            const tableBody = document.getElementById('reviews-table-body');
            const snapshot = await db.collection('reviews').orderBy('createdAt', 'desc').get();
            if(snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Henüz hiç yorum yapılmamış.</td></tr>';
                return;
            }
            tableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const review = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">${review.userName}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${review.reviewText}</td>
                    <td class="px-6 py-4">${[...Array(5)].map((_, i) => `<i class="ri-star-${i < review.rating ? 'fill' : 'line'} text-yellow-400"></i>`).join('')}</td>
                    <td class="px-6 py-4">${review.isApproved ? '<span class="text-green-600 font-semibold">Onaylandı</span>' : '<span class="text-yellow-600 font-semibold">Bekliyor</span>'}</td>
                    <td class="px-6 py-4 text-right">
                        ${!review.isApproved ? `<button data-id="${doc.id}" class="approve-review-btn text-green-600 hover:underline">Onayla</button>` : ''}
                        <button data-id="${doc.id}" class="delete-review-btn text-red-600 hover:underline ml-2">Sil</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        mainContent.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            
            if (button.classList.contains('approve-review-btn')) {
                if (confirm('Bu yorumu onaylayıp ana sayfada görünür yapmak istediğinize emin misiniz?')) {
                    await db.collection('reviews').doc(id).update({ isApproved: true });
                    await loadReviews();
                    await updatePendingReviewsBadge();
                }
            }
            if (button.classList.contains('delete-review-btn')) {
                 if (confirm('Bu yorumu kalıcı olarak silmek istediğinize emin misiniz?')) {
                    await db.collection('reviews').doc(id).delete();
                    await loadReviews();
                    await updatePendingReviewsBadge();
                }
            }
            // Diğer button eventleri buraya eklenebilir (sipariş detayı, kullanıcı detayı vs.)
        });
        
        setupNavListeners();
        checkAuth();
    });
</script>

</body>
</html>
