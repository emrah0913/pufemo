<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | Getir Kıbrıs</title>
    <meta name="description" content="Getir Kıbrıs Yönetici Paneli - Siparişleri ve kullanıcıları yönetin.">
    <link rel="icon" href="https://pufemo.netlify.app/favicon.ico?v=2" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">

    <script>
        // Tailwind CSS Konfigürasyonu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5d3ebc',
                        secondary: '#ffd300',
                        status: {
                            pending: '#f59e0b', // Amber 500
                            processing: '#3b82f6', // Blue 500
                            shipped: '#10b981', // Emerald 500
                            delivered: '#22c55e', // Green 500
                            cancelled: '#ef4444'  // Red 500
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'button': '8px'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Gizli öğeleri varsayılan olarak gizler */
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #5d3ebc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Toast Notification Styling */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            z-index: 1000;
        }
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* Tab button active state */
        .tab-button.active {
            border-color: #5d3ebc; /* Primary color */
            color: #5d3ebc;
            font-weight: 600;
        }
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Varsayılan olarak gizli */
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        /* Modal gösterildiğinde görünür yap ve opaklığı ayarla */
        .modal-overlay.show {
            display: flex; /* Modal'ı görünür yap */
            opacity: 1;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-50">

<div class="w-full max-w-screen-lg mx-auto relative min-h-screen">
    <header class="sticky top-0 w-full bg-white shadow-sm z-50 px-4 py-3 flex items-center justify-between">
        <a href="https://pufemo.netlify.app/index.html" class="flex items-center gap-2">
            <img src="https://placehold.co/100x40/5d3ebc/ffffff?text=GetirKıbrıs&font=inter" alt="Getir Kıbrıs Logo" class="h-10">
        </a>
        <div class="flex items-center gap-4">
            <a href="https://pufemo.netlify.app/index.html" class="text-gray-600 hover:text-primary transition-colors">
                <i class="ri-home-4-line ri-lg"></i>
            </a>
            <div id="auth-button-container" class="w-8 h-8 flex items-center justify-center">
                <div id="profile-container" class="hidden cursor-pointer">
                    <img id="profile-img" src="" alt="Profil" class="w-8 h-8 rounded-full">
                </div>
            </div>
        </div>
    </header>

    <main id="admin-content" class="pt-8 pb-20 px-4 hidden">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Yönetici Paneli</h1>

        <section id="unauthorized-message" class="text-center py-16 bg-red-100 rounded-lg shadow-md hidden">
            <i class="ri-lock-2-line text-6xl text-red-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-red-700">Yetkisiz Erişim!</h2>
            <p class="mt-2 text-red-600">Bu sayfayı görüntülemek için yönetici yetkiniz bulunmamaktadır.</p>
            <a href="https://pufemo.netlify.app/index.html" class="mt-6 inline-block bg-primary text-white px-6 py-2 rounded-button font-semibold hover:bg-primary/90 transition-colors">Ana Sayfaya Dön</a>
        </section>

        <section id="admin-dashboard" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Dashboard Bilgi Kartları -->
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="ri-bar-chart-box-line ri-xl text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Toplam Siparişler</p>
                        <p id="total-orders-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="ri-check-double-line ri-xl text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Tamamlanan Siparişler</p>
                        <p id="completed-orders-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center gap-4">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="ri-user-line ri-xl text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Toplam Kullanıcılar</p>
                        <p id="total-users-count" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>
            </div>

            <!-- Sekmeler Menüsü -->
            <div class="flex border-b border-gray-200 mb-6 -mt-2">
                <button data-tab="orders" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none border-b-2 border-transparent transition-colors duration-200">Tüm Siparişler</button>
                <button data-tab="users" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none border-b-2 border-transparent transition-colors duration-200">Kullanıcılar</button>
                <button data-tab="producers" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none border-b-2 border-transparent transition-colors duration-200">Üreticiler</button>
                <button data-tab="products" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none border-b-2 border-transparent transition-colors duration-200">Ürün Yönetimi</button>
                <button data-tab="settings" class="tab-button px-4 py-2 text-sm font-medium text-gray-600 hover:text-primary focus:outline-none border-b-2 border-transparent transition-colors duration-200">Ayarlar</button>
            </div>

            <!-- Sekme İçerikleri -->
            
            <!-- Siparişler Sekmesi -->
            <div id="orders-tab" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Tüm Siparişler</h2>
                <div id="orders-list" class="space-y-4">
                    <p class="text-center text-gray-500">Siparişler yükleniyor...</p>
                </div>
                <div id="no-orders-admin-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-file-list-3-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz hiç sipariş bulunmuyor.</p>
                </div>
            </div>

            <!-- Kullanıcılar Sekmesi -->
            <div id="users-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Kullanıcı Yönetimi</h2>
                <div id="users-list" class="space-y-4">
                    <p class="text-center text-gray-500">Kullanıcılar yükleniyor...</p>
                </div>
                <div id="no-users-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-user-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz hiç kullanıcı bulunmuyor.</p>
                </div>
            </div>

            <!-- Üreticiler Sekmesi -->
            <div id="producers-tab" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Üretici Yönetimi</h2>
                    <button id="add-producer-btn" class="bg-primary text-white py-2 px-4 rounded-button font-semibold hover:bg-primary/90 transition-colors flex items-center gap-2">
                        <i class="ri-add-line"></i> Yeni Üretici Ekle
                    </button>
                </div>
                <div id="producers-list" class="space-y-4">
                    <p class="text-center text-gray-500">Üreticiler yükleniyor...</p>
                </div>
                <div id="no-producers-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-factory-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz hiç üretici bulunmuyor.</p>
                </div>
            </div>

            <!-- Ürün Yönetimi Sekmesi -->
            <div id="products-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ürün Yönetimi (Tüm Ürünler)</h2>
                <div class="mb-4">
                    <label for="product-filter-status" class="block text-sm font-medium text-gray-700 mb-1">Duruma Gööre Filtrele:</label>
                    <select id="product-filter-status" class="w-full md:w-auto p-2 border border-gray-300 rounded-md bg-white text-sm">
                        <option value="all">Tümü</option>
                        <option value="approved">Onaylı Ürünler</option>
                        <option value="pending">Onay Bekleyen Ürünler</option>
                    </select>
                </div>
                <div id="products-list" class="space-y-4">
                    <p class="text-center text-gray-500">Ürünler yükleniyor...</p>
                </div>
                <div id="no-products-message" class="text-center py-10 bg-white rounded-lg shadow-md hidden">
                    <i class="ri-box-3-line text-6xl text-gray-300"></i>
                    <p class="mt-4 text-gray-500">Henüz ürün bulunmuyor.</p>
                </div>
            </div>

            <!-- Ayarlar Sekmesi -->
            <div id="settings-tab" class="tab-content hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Fiyatlandırma ve Şehir Ayarları</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-semibold text-lg mb-4">Kategori Hizmet/Kar Marjı Oranları (%)</h3>
                    <p class="text-sm text-gray-600 mb-4">Bu oranlar, kategori bazında ürün fiyatlarına eklenecek hizmet veya kâr marjını yüzde olarak belirler.</p>
                    <div id="category-rates-settings" class="space-y-3">
                        <p class="text-gray-500">Ayarlar yükleniyor...</p>
                    </div>

                    <h3 class="font-semibold text-lg mt-6 mb-4">Şehir Teslimat Ücretleri (₺)</h3>
                    <p class="text-sm text-gray-600 mb-4">Şehirlere göre belirlenen sabit teslimat ücretleridir.</p>
                    <div id="city-fees-settings" class="space-y-3">
                        <p class="text-gray-500">Ayarlar yükleniyor...</p>
                    </div>
                    <button id="save-settings-btn" class="mt-6 bg-primary text-white py-2 px-4 rounded-button font-semibold hover:bg-primary/90 transition-colors">Ayarları Kaydet</button>
                </div>
            </div>

        </section>
    </main>

    <div id="loader" class="flex justify-center items-center h-[calc(100vh-80px)]">
        <div class="loader"></div>
    </div>
</div>

<div id="toast" class="fixed bottom-24 right-6 bg-gray-800 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-[110] transform translate-y-4">
    <span id="toast-message"></span>
</div>

<!-- Yeni Üretici Ekleme Modalı -->
<div id="add-producer-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Yeni Üretici Ekle</h3>
        <form id="add-producer-form" class="space-y-4">
            <div>
                <label for="producer-email" class="block text-sm font-medium text-gray-700">E-posta</label>
                <input type="email" id="producer-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div>
                <label for="producer-password" class="block text-sm font-medium text-gray-700">Şifre</label>
                <input type="password" id="producer-password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required minlength="6">
            </div>
            <div>
                <label for="producer-full-name" class="block text-sm font-medium text-gray-700">Adı Soyadı</label>
                <input type="text" id="producer-full-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="producer-phone" class="block text-sm font-medium text-gray-700">Telefon</label>
                <input type="tel" id="producer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="producer-address" class="block text-sm font-medium text-gray-700">Adres</label>
                <textarea id="producer-address" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-add-producer" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-button hover:bg-gray-300">İptal</button>
                <button type="submit" class="bg-primary text-white py-2 px-4 rounded-button hover:bg-primary/90">Üretici Ekle</button>
            </div>
        </form>
    </div>
</div>

<!-- Ürünü Düzenleme Modalı -->
<div id="edit-product-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Ürünü Düzenle</h3>
        <form id="edit-product-form" class="space-y-4">
            <input type="hidden" id="edit-product-id">
            <div>
                <label for="edit-product-name" class="block text-sm font-medium text-gray-700">Ürün Adı</label>
                <input type="text" id="edit-product-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div>
                <label for="edit-product-description" class="block text-sm font-medium text-gray-700">Açıklama</label>
                <textarea id="edit-product-description" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <div>
                <label for="edit-product-price" class="block text-sm font-medium text-gray-700">Fiyat (₺)</label>
                <input type="number" id="edit-product-price" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" step="0.01" min="0" required>
            </div>
            <div>
                <label for="edit-product-category" class="block text-sm font-medium text-gray-700">Kategori</label>
                <input type="text" id="edit-product-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
            </div>
            <div>
                <label for="edit-product-image-url" class="block text-sm font-medium text-gray-700">Görsel URL</label>
                <input type="url" id="edit-product-image-url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-edit-product" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-button hover:bg-gray-300">İptal</button>
                <button type="submit" class="bg-primary text-white py-2 px-4 rounded-button hover:bg-primary/90">Kaydet</button>
            </div>
        </form>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, onSnapshot, query, orderBy, getDocs, updateDoc, setDoc, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase yapılandırma bilgileri
    const firebaseConfig = {
        apiKey: "AIzaSyB64tAKvCHeYnJ8-HNRLpzB7sQRng4FHyA",
        authDomain: "pufemo-2dc3a.firebaseapp.com",
        projectId: "pufemo-2dc3a",
        storageBucket: "pufemo-2dc3a.firebasestorage.app", 
        messagingSenderId: "321284306570",
        appId: "1:321284306570:web:ca891826c3e4edde8edf73"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    console.log("Firebase uygulaması başlatıldı (Admin).");
    console.log("Auth objesi başlatıldı (Admin):", auth);

    let currentUser = null;
    let pricingSettings = {}; 
    // Varsayılan ayarlar, eğer Firestore'da bulunamazsa kullanılacak.
    const DEFAULT_SETTINGS = {
        categoryRates: { 'furniture': 0.70, 'electronics': 0.70, 'clothing': 0.45, 'cosmetics': 0.70, 'stationery': 0.40, 'default': 0.50 },
        cityFees: { 'Lefkoşa': 200, 'Girne': 350, 'Gazimağusa': 300, 'Güzelyurt': 400, 'İskele': 450, 'Diğer': 500 }
    };

    // DOM öğeleri referansları
    const loader = document.getElementById('loader');
    const adminContent = document.getElementById('admin-content');
    const unauthorizedMessage = document.getElementById('unauthorized-message');
    const adminDashboard = document.getElementById('admin-dashboard');
    const ordersList = document.getElementById('orders-list'); 
    const noOrdersAdminMessage = document.getElementById('no-orders-admin-message'); 
    const profileImg = document.getElementById('profile-img');
    const profileContainer = document.getElementById('profile-container');

    const totalOrdersCount = document.getElementById('total-orders-count');
    const completedOrdersCount = document.getElementById('completed-orders-count');
    const totalUsersCount = document.getElementById('total-users-count');

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    const usersList = document.getElementById('users-list');
    const noUsersMessage = document.getElementById('no-users-message');

    const producersList = document.getElementById('producers-list');
    const noProducersMessage = document.getElementById('no-producers-message');
    const addProducerBtn = document.getElementById('add-producer-btn');

    const productsList = document.getElementById('products-list');
    const noProductsMessage = document.getElementById('no-products-message');
    const productFilterStatus = document.getElementById('product-filter-status');

    const categoryRatesSettings = document.getElementById('category-rates-settings');
    const cityFeesSettings = document.getElementById('city-fees-settings');
    const saveSettingsBtn = document.getElementById('save-settings-btn');

    // Modal öğeleri
    const addProducerModal = document.getElementById('add-producer-modal');
    const addProducerForm = document.getElementById('add-producer-form');
    const cancelAddProducerBtn = document.getElementById('cancel-add-producer');

    const editProductModal = document.getElementById('edit-product-modal');
    const editProductForm = document.getElementById('edit-product-form');
    const cancelEditProductBtn = document.getElementById('cancel-edit-product');


    // Toast Bildirimi Fonksiyonu
    function showToast(message, duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        if (toast && toastMessage) {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4', 'hidden');
            toast.classList.add('opacity-100', 'translate-y-0', 'show');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0', 'show');
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, duration);
        } else {
            console.warn("Toast öğeleri bulunamadı, bildirim gösterilemiyor:", message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        onAuthStateChanged(auth, async (user) => {
            if (loader) loader.classList.remove('hidden'); 
            if (adminContent) adminContent.classList.add('hidden'); 

            if (user) {
                currentUser = user;
                if (profileImg) profileImg.src = user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=P';
                if (profileContainer) profileContainer.classList.remove('hidden');

                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'admin') {
                    console.log("Yönetici girişi başarılı.");
                    await loadPricingSettings(); 
                    if (adminContent) adminContent.classList.remove('hidden');
                    if (adminDashboard) adminDashboard.classList.remove('hidden');
                    if (unauthorizedMessage) unauthorizedMessage.classList.add('hidden');
                    
                    // Dashboard verilerini ve tüm listeleri başlat
                    await loadDashboardData();
                    showTab('orders'); // Varsayılan olarak siparişler sekmesini göster
                    listenToAllOrders(); 
                    listenToAllUsers(); 
                    listenToAllProducers(); // Yeni: Üreticileri dinle
                    listenToAllProducts(); // Tüm ürünleri dinle (filtrelenebilir)
                    renderSettings(); 
                } else {
                    console.warn("Yetkisiz erişim: Kullanıcı yönetici değil.");
                    if (adminContent) adminContent.classList.remove('hidden');
                    if (unauthorizedMessage) unauthorizedMessage.classList.remove('hidden');
                    if (adminDashboard) adminDashboard.classList.add('hidden');
                    showToast("Bu sayfayı görüntülemek için yetkiniz yok.");
                }
            } else {
                console.warn("Kullanıcı giriş yapmadı (Admin).");
                if (adminContent) adminContent.classList.remove('hidden');
                if (unauthorizedMessage) unauthorizedMessage.classList.remove('hidden');
                if (adminDashboard) adminDashboard.classList.add('hidden');
                showToast("Yönetici panelini görüntülemek için giriş yapmanız gerekiyor.");
            }
            if (loader) loader.classList.add('hidden'); 
        });

        // Tab değiştirme olay dinleyicileri
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                showTab(tab);
            });
        });

        // Ayarları kaydet butonu
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', savePricingSettings);
        }

        // Yeni Üretici Ekleme Modalı Olay Dinleyicileri
        if (addProducerBtn) {
            addProducerBtn.addEventListener('click', () => {
                addProducerForm.reset(); // Formu temizle
                addProducerModal.classList.add('show');
            });
        }
        if (cancelAddProducerBtn) {
            cancelAddProducerBtn.addEventListener('click', () => addProducerModal.classList.remove('show'));
        }
        if (addProducerForm) {
            addProducerForm.addEventListener('submit', handleAddProducer);
        }

        // Ürünü Düzenleme Modalı Olay Dinleyicileri
        if (cancelEditProductBtn) {
            cancelEditProductBtn.addEventListener('click', () => editProductModal.classList.remove('show'));
        }
        if (editProductForm) {
            editProductForm.addEventListener('submit', handleEditProduct);
        }

        // Ürün filtreleme select box
        if (productFilterStatus) {
            productFilterStatus.addEventListener('change', listenToAllProducts); // Filtre değiştiğinde ürünleri yeniden yükle
        }
    });

    // Sekme gösterme fonksiyonu
    function showTab(tabId) {
        tabContents.forEach(content => {
            content.classList.add('hidden');
        });
        tabButtons.forEach(button => {
            button.classList.remove('active'); // Önceki aktif sınıfı kaldır
            button.classList.remove('border-primary-500', 'text-primary');
            button.classList.add('border-transparent', 'text-gray-600');
        });

        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
        const activeTabButton = document.querySelector(`[data-tab="${tabId}"]`);
        activeTabButton.classList.add('active'); 
        activeTabButton.classList.add('border-primary-500', 'text-primary');
        activeTabButton.classList.remove('border-transparent', 'text-gray-600');
    }

    // Dashboard özet verilerini yükle
    async function loadDashboardData() {
        try {
            const ordersSnapshot = await getDocs(collection(db, 'orders'));
            if (totalOrdersCount) totalOrdersCount.textContent = ordersSnapshot.size;

            const completedOrdersQuery = query(collection(db, 'orders'), where('status', '==', 'delivered'));
            const completedOrdersSnapshot = await getDocs(completedOrdersQuery);
            if (completedOrdersCount) completedOrdersCount.textContent = completedOrdersSnapshot.size;

            const usersSnapshot = await getDocs(collection(db, 'users')); // Tüm kullanıcıları say
            if (totalUsersCount) totalUsersCount.textContent = usersSnapshot.size;

        } catch (error) {
            console.error("Dashboard verileri yüklenirken hata:", error);
            showToast("Dashboard verileri yüklenirken bir hata oluştu.");
        }
    }


    // Fiyatlandırma ayarlarını yükle (sipariş toplamlarını doğru hesaplamak için)
    async function loadPricingSettings() {
        try {
            const docRef = doc(db, "settings", "pricing");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().categoryRates) {
                pricingSettings = docSnap.data();
            } else {
                pricingSettings = DEFAULT_SETTINGS;
                await setDoc(docRef, DEFAULT_SETTINGS);
                console.log("Varsayılan fiyatlandırma ayarları Firestore'a kaydedildi.");
            }
        } catch (error) {
            console.error("Fiyat ayarları yüklenirken hata oluştu (Admin):", error);
            pricingSettings = DEFAULT_SETTINGS;
        }
    }

    // Tüm siparişleri dinle ve göster
    function listenToAllOrders() {
        if (!ordersList || !noOrdersAdminMessage) {
            console.error("Yönetici sipariş DOM öğeleri eksik.");
            return;
        }

        const ordersRef = collection(db, 'orders');
        const q = query(ordersRef, orderBy("orderDate", "desc"));

        onSnapshot(q, (snapshot) => {
            const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm siparişler yüklendi (Admin):", allOrders);
            renderAdminOrders(allOrders);
            loadDashboardData(); // Her sipariş değiştiğinde dashboard verilerini güncelle
        }, (error) => {
            console.error("Tüm siparişler dinlenirken hata oluştu (Admin):", error);
            showToast("Siparişler yüklenirken bir hata oluştu.");
            if (ordersList) ordersList.innerHTML = `<p class="text-red-500">Siparişler yüklenemedi.</p>`;
        });
    }

    function renderAdminOrders(orders) {
        if (!ordersList || !noOrdersAdminMessage) return;

        if (orders.length === 0) {
            noOrdersAdminMessage.classList.remove('hidden');
            ordersList.innerHTML = '';
            return;
        }

        noOrdersAdminMessage.classList.add('hidden');
        ordersList.innerHTML = '';

        orders.forEach(order => {
            const orderDate = order.orderDate?.seconds
                ? new Date(order.orderDate.seconds * 1000).toLocaleDateString("tr-TR", {
                      year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit"
                    })
                : "Tarih Yok";
            
            const statusOptions = [
                { value: 'pending_payment', label: 'Ödeme Bekleniyor', class: 'bg-yellow-500 text-white' },
                { value: 'processing', label: 'İşleniyor', class: 'bg-blue-500 text-white' },
                { value: 'shipped', label: 'Kargoya Verildi', class: 'bg-teal-500 text-white' },
                { value: 'delivered', label: 'Teslim Edildi', class: 'bg-green-500', text_color: 'text-white' }, // Corrected text_color
                { value: 'cancelled', label: 'İptal Edildi', class: 'bg-red-500', text_color: 'text-white' } // Corrected text_color
            ];


            const currentStatusInfo = statusOptions.find(s => s.value === order.status) || { label: order.status, class: 'bg-gray-400 text-white' };

            const categoryRates = pricingSettings.categoryRates || {};
            const itemsHtml = (order.items ?? []).map(item => {
                const itemProductPriceValue = parseFloat(item.productPrice) || 0;
                const serviceRate = item.serviceFeeRate !== undefined ? item.serviceFeeRate : (categoryRates[item.category] || categoryRates['default'] || 0);
                let itemServiceFee = 0;
                if (item.type === 'custom_order') {
                    itemServiceFee = itemProductPriceValue * serviceRate;
                }
                const itemFinalPrice = item.orderMethod === 'service' ? itemProductPriceValue + itemServiceFee : itemProductPriceValue;
                const itemLineTotal = (itemFinalPrice * (parseInt(item.quantity) || 1)).toFixed(2);

                return `
                    <li class="text-sm text-gray-700 mb-1 flex justify-between items-start">
                        <div class="flex-1 min-w-0 pr-2">
                            <p class="font-medium truncate">${item.productLink}</p>
                            <p class="text-xs text-gray-500 mt-0.5">Kategori: ${item.category || 'Belirtilmemiş'} | Adet: ${item.quantity || 1}</p>
                        </div>
                        <span class="font-semibold text-gray-800 flex-shrink-0">${itemLineTotal} ₺</span>
                    </li>`;
            }).join("");
            
            const numericGrandTotal = parseFloat(order.grandTotal); 
            const grandTotalDisplay = !isNaN(numericGrandTotal)
                ? `${numericGrandTotal.toFixed(2)} ₺`
                : 'Hesaplanamadı'; 

            const statusDropdownOptions = statusOptions.map(option => `
                <option value="${option.value}" ${order.status === option.value ? 'selected' : ''}>
                    ${option.label}
                </option>
            `).join('');

            const card = `
                <div class="bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200">
                    <div class="flex justify-between items-center pb-2 border-b border-gray-100 mb-2">
                        <h3 class="font-bold text-primary text-lg">Sipariş: ${order.id.substring(0, 8).toUpperCase()}</h3>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${currentStatusInfo.class}">${currentStatusInfo.label}</span>
                            <select data-order-id="${order.id}" class="order-status-select bg-gray-100 border border-gray-300 text-gray-800 text-xs rounded-md p-1 focus:ring-primary focus:border-primary">
                                ${statusDropdownOptions}
                            </select>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Kullanıcı: ${order.userFullName || 'Bilinmiyor'} (${order.userEmail})</p>
                    <p class="text-sm text-gray-500">Telefon: ${order.userPhone || 'Bilinmiyor'}</p>
                    <p class="text-sm text-gray-500">Tarih: ${orderDate}</p>
                    <p class="text-sm text-gray-500">Teslimat: ${order.deliveryType === 'home' ? 'Eve Teslim' : 'Depodan Teslim'}${order.selectedCity ? ` (${order.selectedCity})` : ''}</p>
                    <p class="text-sm text-gray-500">Adres: ${order.deliveryAddress}</p>
                    
                    <h4 class="font-semibold text-gray-700 mt-4 mb-2">Ürünler:</h4>
                    <ul class="space-y-2 border-t pt-2">${itemsHtml}</ul>
                    
                    <div class="flex justify-end border-t pt-3 mt-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Genel Toplam</p>
                            <p class="font-bold text-lg">${grandTotalDisplay}</p>
                        </div>
                    </div>
                </div>
            `;
            ordersList.innerHTML += card;
        });

        document.querySelectorAll('.order-status-select').forEach(selectElement => {
            selectElement.addEventListener('change', async (e) => {
                const orderId = e.target.dataset.orderId;
                const newStatus = e.target.value;
                // find the correct old status label from the original order object
                const currentOrder = orders.find(o => o.id === orderId);
                const oldStatusLabel = statusOptions.find(s => s.value === currentOrder.status).label;
                const newStatusLabel = statusOptions.find(s => s.value === newStatus).label;

                if (confirm(`Siparişin durumunu "${oldStatusLabel}" konumundan "${newStatusLabel}" konumuna değiştirmek istediğinize emin misiniz?`)) {
                    await updateOrderStatus(orderId, newStatus);
                } else {
                    // Revert select back to original status if cancelled
                    e.target.value = currentOrder.status;
                }
            });
        });
    }

    async function updateOrderStatus(orderId, newStatus) {
        try {
            const orderRef = doc(db, 'orders', orderId);
            await updateDoc(orderRef, { status: newStatus });
            showToast(`Sipariş (${orderId.substring(0, 8).toUpperCase()}) durumu "${newStatus}" olarak güncellendi.`);
        } catch (error) {
            console.error("Sipariş durumu güncellenirken hata:", error);
            showToast("Sipariş durumu güncellenemedi: " + error.message);
        }
    }

    // --- Kullanıcı Yönetimi Fonksiyonları ---
    function listenToAllUsers() {
        if (!usersList || !noUsersMessage) {
            console.error("Kullanıcı DOM öğeleri eksik.");
            return;
        }
        const usersRef = collection(db, 'users');
        const q = query(usersRef, orderBy("createdAt", "desc")); 

        onSnapshot(q, (snapshot) => {
            const allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm kullanıcılar yüklendi (Admin):", allUsers);
            renderUsers(allUsers);
            loadDashboardData(); // Kullanıcı değiştiğinde dashboard verilerini güncelle
        }, (error) => {
            console.error("Kullanıcılar dinlenirken hata oluştu (Admin):", error);
            showToast("Kullanıcılar yüklenirken bir hata oluştu.");
            if (usersList) usersList.innerHTML = `<p class="text-red-500">Kullanıcılar yüklenemedi.</p>`;
        });
    }

    function renderUsers(users) {
        if (!usersList || !noUsersMessage) return;

        // Sadece customer rolündekileri filtrele ve say
        const customerUsers = users.filter(user => user.role === 'customer');

        if (customerUsers.length === 0) {
            noUsersMessage.classList.remove('hidden');
            usersList.innerHTML = '';
            return;
        }

        noUsersMessage.classList.add('hidden');
        usersList.innerHTML = '';

        customerUsers.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200 flex flex-col sm:flex-row items-start sm:items-center justify-between';
            userCard.innerHTML = `
                <div class="flex items-center gap-3 mb-3 sm:mb-0">
                    <img src="${user.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=U'}" alt="User" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-gray-800">${user.fullName || 'İsim Yok'}</p>
                        <p class="text-sm text-gray-600">${user.email || 'E-posta Yok'}</p>
                        <p class="text-xs text-gray-500">${user.phone || 'Telefon Yok'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${user.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${user.role || 'customer'}</span>
                    <button data-user-id="${user.id}" data-current-role="${user.role}" class="toggle-admin-btn bg-purple-500 text-white text-sm px-3 py-1 rounded-button hover:bg-purple-600 transition-colors">
                        ${user.role === 'admin' ? 'Adminlikten Çıkar' : 'Admin Yap'}
                    </button>
                </div>
            `;
            usersList.appendChild(userCard);
        });

        document.querySelectorAll('.toggle-admin-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const userId = e.target.dataset.userId;
                const currentRole = e.target.dataset.currentRole;
                const newRole = currentRole === 'admin' ? 'customer' : 'admin';
                
                if (confirm(`Kullanıcının rolünü "${newRole}" olarak değiştirmek istediğinize emin misiniz?`)) {
                    try {
                        const userRef = doc(db, 'users', userId);
                        await updateDoc(userRef, { role: newRole });
                        showToast("Kullanıcı rolü başarıyla güncellendi!");
                    } catch (error) {
                        console.error("Kullanıcı rolü güncellenirken hata:", error);
                        showToast("Kullanıcı rolü güncellenemedi: " + error.message);
                    }
                }
            });
        });
    }

    // --- Üretici Yönetimi Fonksiyonları ---
    function listenToAllProducers() {
        if (!producersList || !noProducersMessage) {
            console.error("Üretici DOM öğeleri eksik.");
            return;
        }
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where("role", "==", "producer"), orderBy("createdAt", "desc")); 

        onSnapshot(q, (snapshot) => {
            const allProducers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm üreticiler yüklendi (Admin):", allProducers);
            renderProducers(allProducers);
        }, (error) => {
            console.error("Üreticiler dinlenirken hata oluştu (Admin):", error);
            showToast("Üreticiler yüklenirken bir hata oluştu.");
            if (producersList) producersList.innerHTML = `<p class="text-red-500">Üreticiler yüklenemedi.</p>`;
        });
    }

    function renderProducers(producers) {
        if (!producersList || !noProducersMessage) return;

        if (producers.length === 0) {
            noProducersMessage.classList.remove('hidden');
            producersList.innerHTML = '';
            return;
        }

        noProducersMessage.classList.add('hidden');
        producersList.innerHTML = '';

        producers.forEach(producer => {
            const producerCard = document.createElement('div');
            producerCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200 flex flex-col sm:flex-row items-start sm:items-center justify-between';
            producerCard.innerHTML = `
                <div class="flex items-center gap-3 mb-3 sm:mb-0">
                    <img src="${producer.photoURL || 'https://placehold.co/40x40/cccccc/000000?text=P'}" alt="Producer" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <p class="font-semibold text-gray-800">${producer.fullName || 'İsim Yok'}</p>
                        <p class="text-sm text-gray-600">${producer.email || 'E-posta Yok'}</p>
                        <p class="text-xs text-gray-500">${producer.phone || 'Telefon Yok'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm font-medium px-3 py-1 rounded-full bg-blue-100 text-blue-800">${producer.role || 'producer'}</span>
                    <button data-producer-id="${producer.id}" class="edit-producer-btn bg-blue-500 text-white text-sm px-3 py-1 rounded-button hover:bg-blue-600 transition-colors">
                        Düzenle
                    </button>
                    <button data-producer-id="${producer.id}" class="delete-producer-btn bg-red-500 text-white text-sm px-3 py-1 rounded-button hover:bg-red-600 transition-colors">
                        Sil
                    </button>
                </div>
            `;
            producersList.appendChild(producerCard);
        });

        document.querySelectorAll('.edit-producer-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const producerId = e.target.dataset.producerId;
                // Düzenleme fonksiyonu burada tetiklenebilir, örneğin bir modal açıp bilgileri doldurarak
                showToast(`Üretici ID: ${producerId} için düzenleme formu açılacak.`);
                // TODO: Üretici düzenleme modalını burada doldurup gösterebiliriz
            });
        });

        document.querySelectorAll('.delete-producer-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const producerId = e.target.dataset.producerId;
                if (confirm('Bu üreticiyi ve Firebase Authentication kaydını silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
                    try {
                        // ÖNEMLİ: Firebase Auth kullanıcısını sunucu tarafında silmeniz önerilir
                        // Client-side silme için yetki kısıtlamaları olabilir.
                        // Örnek: Admin SDK kullanarak sunucudan silme.
                        // Burası sadece gösterim amaçlıdır.
                        // await deleteUser(auth.currentUser); // Bu kendi admin hesabınızı siler! DİKKAT!
                        
                        // Sadece Firestore belgesini siliyoruz
                        const producerRef = doc(db, 'users', producerId);
                        await deleteDoc(producerRef);
                        showToast("Üretici başarıyla silindi (Firestore belgesi).");
                    } catch (error) {
                        console.error("Üretici silinirken hata:", error);
                        showToast("Üretici silinemedi: " + error.message);
                    }
                }
            });
        });
    }

    async function handleAddProducer(event) {
        event.preventDefault();
        const email = document.getElementById('producer-email').value;
        const password = document.getElementById('producer-password').value;
        const fullName = document.getElementById('producer-full-name').value;
        const phone = document.getElementById('producer-phone').value;
        const address = document.getElementById('producer-address').value;

        if (!email || !password) {
            showToast("E-posta ve şifre zorunludur.");
            return;
        }

        try {
            // İlk olarak, bu e-posta adresine sahip bir kullanıcının Firestore 'users' koleksiyonunda olup olmadığını kontrol edin.
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where("email", "==", email));
            const userSnapshots = await getDocs(q);

            if (!userSnapshots.empty) {
                // Firestore'da kullanıcı belgesi bulundu
                const existingUserDoc = userSnapshots.docs[0];
                const existingUserData = existingUserDoc.data();
                const existingUserId = existingUserDoc.id;

                if (existingUserData.role === 'customer') {
                    // Mevcut müşteri bulundu, yükseltme iste
                    if (confirm(`"${email}" e-posta adresine sahip bir müşteri hesabı zaten mevcut. Bu hesabı üreticiye yükseltmek istiyor musunuz?`)) {
                        const userRef = doc(db, 'users', existingUserId);
                        await updateDoc(userRef, { role: 'producer' });
                        showToast(`Müşteri hesabı "${email}" başarıyla üreticiye yükseltildi!`);
                        addProducerModal.classList.remove('show');
                        return; // Yükseltme sonrası fonksiyondan çık
                    } else {
                        showToast("Üretici ekleme işlemi iptal edildi.");
                        return; // Kullanıcı iptal etti
                    }
                } else if (existingUserData.role === 'producer') {
                    showToast(`"${email}" e-posta adresine sahip hesap zaten bir üretici hesabı.`);
                    return; // Zaten üretici
                } else if (existingUserData.role === 'admin') {
                    showToast(`"${email}" e-posta adresine sahip hesap zaten bir yönetici hesabı.`);
                    return; // Zaten yönetici
                }
            }

            // Firestore'da kullanıcı belgesi bulunamazsa veya kullanıcı yükseltmeyi iptal ederse, yeni Auth kullanıcısı oluşturmaya devam et
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const newProducerUid = userCredential.user.uid;

            // Firestore'da üretici profili oluştur
            const producerRef = doc(db, 'users', newProducerUid);
            await setDoc(producerRef, {
                email: email,
                fullName: fullName,
                phone: phone,
                address: address,
                role: 'producer',
                createdAt: serverTimestamp(),
                photoURL: 'https://placehold.co/40x40/cccccc/000000?text=P' // Varsayılan görsel
            });

            showToast("Yeni üretici başarıyla eklendi!");
            addProducerModal.classList.remove('show');

        } catch (error) {
            console.error("Üretici eklenirken hata:", error);
            let errorMessage = "Üretici eklenemedi.";
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = "Bu e-posta adresi Firebase Authentication'da zaten kayıtlı. Lütfen farklı bir e-posta adresi deneyin veya mevcut bir hesabı yükseltmeyi düşünün.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "Şifre en az 6 karakter olmalıdır.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Geçersiz e-posta adresi formatı.";
            }
            showToast(errorMessage);
        }
    }


    // --- Ürün Yönetimi Fonksiyonları ---
    // Ürünleri filtreye göre dinle
    function listenToAllProducts() {
        if (!productsList || !noProductsMessage || !productFilterStatus) {
            console.error("Ürün DOM öğeleri eksik.");
            return;
        }
        const productsRef = collection(db, 'products');
        let q = query(productsRef, orderBy("createdAt", "desc")); 

        const filterStatus = productFilterStatus.value;

        if (filterStatus === 'approved') {
            q = query(productsRef, where("isApproved", "==", true), orderBy("createdAt", "desc"));
        } else if (filterStatus === 'pending') {
            // Only show products that are explicitly false or do not have isApproved field
            q = query(productsRef, where("isApproved", "==", false), orderBy("createdAt", "desc"));
        }
        // 'all' durumu için ekstra where clause eklemeye gerek yok

        onSnapshot(q, (snapshot) => {
            const allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tüm ürünler yüklendi (Admin, filtrelenmiş):", allProducts);
            renderProducts(allProducts); // Render fonksiyonunu yeniden adlandırdık
        }, (error) => {
            console.error("Ürünler dinlenirken hata oluştu (Admin):", error);
            showToast("Ürünler yüklenirken bir hata oluştu.");
            if (productsList) productsList.innerHTML = `<p class="text-red-500">Ürünler yüklenemedi.</p>`;
        });
    }

    function renderProducts(products) { // Fonksiyon adını daha genel hale getirdik
        if (!productsList || !noProductsMessage) return;

        if (products.length === 0) {
            noProductsMessage.classList.remove('hidden');
            productsList.innerHTML = '';
            return;
        }

        noProductsMessage.classList.add('hidden');
        productsList.innerHTML = '';

        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'bg-white rounded-lg shadow-md p-4 space-y-2 border border-gray-200';
            productCard.innerHTML = `
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 mb-3 sm:mb-0">
                    <img src="${product.imageUrl || 'https://placehold.co/80x80/e2e8f0/64748b?text=Ürün'}" alt="${product.name}" class="w-20 h-20 object-cover rounded-md flex-shrink-0">
                    <div class="flex-1">
                        <p class="font-semibold text-lg text-gray-800">${product.name || 'İsimsiz Ürün'}</p>
                        <p class="text-sm text-gray-600 line-clamp-2">${product.description || 'Açıklama yok.'}</p>
                        <p class="text-md font-bold text-primary">${(parseFloat(product.price) || 0).toFixed(2)} ₺</p>
                        <p class="text-xs text-gray-500">Kategori: ${product.category || 'Belirtilmemiş'}</p>
                        <p class="text-xs text-gray-500">Üretici ID: ${product.producerId || 'Bilinmiyor'}</p>
                        <p class="text-xs font-semibold ${product.isApproved ? 'text-green-600' : (product.isApproved === false ? 'text-orange-600' : 'text-gray-500')}">Durum: ${product.isApproved ? 'Onaylı' : (product.isApproved === false ? 'Onay Bekliyor' : 'Bilinmiyor')}</p>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button data-product-id="${product.id}" class="edit-product-btn bg-blue-500 text-white text-sm px-4 py-2 rounded-button hover:bg-blue-600 transition-colors">Düzenle</button>
                    ${product.isApproved === false ? `<button data-product-id="${product.id}" class="approve-product-btn bg-green-500 text-white text-sm px-4 py-2 rounded-button hover:bg-green-600 transition-colors">Onayla</button>` : ''}
                    <button data-product-id="${product.id}" class="delete-product-btn bg-red-500 text-white text-sm px-4 py-2 rounded-button hover:bg-red-600 transition-colors">Sil</button>
                </div>
            `;
            productsList.appendChild(productCard);
        });

        document.querySelectorAll('.edit-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                const productToEdit = products.find(p => p.id === productId);
                if (productToEdit) {
                    document.getElementById('edit-product-id').value = productToEdit.id;
                    document.getElementById('edit-product-name').value = productToEdit.name || ''; 
                    document.getElementById('edit-product-description').value = productToEdit.description || '';
                    document.getElementById('edit-product-price').value = productToEdit.price || 0;
                    document.getElementById('edit-product-category').value = productToEdit.category || '';
                    document.getElementById('edit-product-image-url').value = productToEdit.imageUrl || '';
                    editProductModal.classList.add('show');
                }
            });
        });

        document.querySelectorAll('.approve-product-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const productId = e.target.dataset.productId;
                if (confirm('Bu ürünü onaylamak istediğinize emin misiniz?')) {
                    try {
                        const productRef = doc(db, 'products', productId);
                        await updateDoc(productRef, { isApproved: true, approvedAt: serverTimestamp() });
                        showToast("Ürün başarıyla onaylandı!");
                    } catch (error) {
                        console.error("Ürün onaylanırken hata:", error);
                        showToast("Ürün onaylanamadı: " + error.message);
                    }
                }
            });
        });

        document.querySelectorAll('.delete-product-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const productId = e.target.dataset.productId;
                if (confirm('Bu ürünü silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
                    try {
                        const productRef = doc(db, 'products', productId);
                        await deleteDoc(productRef); 
                        showToast("Ürün başarıyla silindi!");
                    }
                     catch (error) {
                        console.error("Ürün silinirken hata:", error);
                        showToast("Ürün silinemedi: " + error.message);
                    }
                }
            });
        });
    }

    async function handleEditProduct(event) {
        event.preventDefault();
        const productId = document.getElementById('edit-product-id').value;
        const productName = document.getElementById('edit-product-name').value;
        const description = document.getElementById('edit-product-description').value;
        const price = parseFloat(document.getElementById('edit-product-price').value);
        const category = document.getElementById('edit-product-category').value;
        const imageUrl = document.getElementById('edit-product-image-url').value;

        if (!productName || isNaN(price) || price < 0 || !category) {
            showToast("Lütfen ürün adı, fiyatı ve kategoriyi doğru giriniz.");
            return;
        }

        try {
            const productRef = doc(db, 'products', productId);
            await updateDoc(productRef, {
                name: productName, // Burası düzeltildi: productName yerine 'name' kullanıldı
                description: description,
                price: price,
                category: category,
                imageUrl: imageUrl
            });
            showToast("Ürün başarıyla güncellendi!");
            editProductModal.classList.remove('show');
        } catch (error) {
            console.error("Ürün güncellenirken hata:", error);
            showToast("Ürün güncellenemedi: " + error.message);
        }
    }


    // --- Ayarlar Yönetimi Fonksiyonları ---
    function renderSettings() {
        if (!categoryRatesSettings || !cityFeesSettings) return;

        categoryRatesSettings.innerHTML = '';
        for (const category in pricingSettings.categoryRates) {
            const rate = pricingSettings.categoryRates[category];
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <label for="rate-${category}" class="flex-1 text-sm font-medium text-gray-700 capitalize">${category}:</label>
                <input type="number" id="rate-${category}" data-setting-type="category" data-key="${category}" value="${(rate * 100).toFixed(0)}" class="w-20 p-2 border border-gray-300 rounded-md text-sm text-right" min="0" max="100">
                <span class="text-sm">%</span>
            `;
            categoryRatesSettings.appendChild(div);
        }

        cityFeesSettings.innerHTML = '';
        for (const city in pricingSettings.cityFees) {
            const fee = pricingSettings.cityFees[city];
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <label for="fee-${city}" class="flex-1 text-sm font-medium text-gray-700">${city}:</label>
                <input type="number" id="fee-${city}" data-setting-type="city" data-key="${city}" value="${fee.toFixed(0)}" class="w-20 p-2 border border-gray-300 rounded-md text-sm text-right" min="0">
                <span class="text-sm">₺</span>
            `;
            cityFeesSettings.appendChild(div);
        }
    }

    async function savePricingSettings() {
        const updatedCategoryRates = {};
        let validationError = false;
        document.querySelectorAll('[data-setting-type="category"]').forEach(input => {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0 || value > 100) {
                validationError = true;
                input.classList.add('border-red-500'); 
            } else {
                input.classList.remove('border-red-500');
                updatedCategoryRates[input.dataset.key] = value / 100;
            }
        });

        const updatedCityFees = {};
        document.querySelectorAll('[data-setting-type="city"]').forEach(input => {
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                validationError = true;
                input.classList.add('border-red-500'); 
            } else {
                input.classList.remove('border-red-500');
                updatedCityFees[input.dataset.key] = value;
            }
        });

        if (validationError) {
            showToast("Lütfen tüm ayar değerlerini geçerli aralıkta giriniz (Oranlar 0-100%, Ücretler 0'dan büyük).");
            return;
        }

        try {
            const settingsRef = doc(db, 'settings', 'pricing');
            await updateDoc(settingsRef, {
                categoryRates: updatedCategoryRates,
                cityFees: updatedCityFees
            });
            // Ayarlar güncellendikten sonra pricingSettings global değişkenini de güncelle
            pricingSettings.categoryRates = updatedCategoryRates;
            pricingSettings.cityFees = updatedCityFees;
            showToast("Ayarlar başarıyla kaydedildi!");
        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            showToast("Ayarlar kaydedilemedi: " + error.message);
        }
    }

</script>
</body>
</html>
