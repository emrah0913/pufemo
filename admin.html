<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO Admin Paneli</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --admin-primary-color: #34495e; /* Koyu Mavi */
            --admin-secondary-color: #2ecc71; /* Yeşil */
            --admin-background-color: #f4f7f6; /* Açık Gri */
            --admin-card-bg-color: #ffffff;
            --admin-text-color: #333;
            --admin-light-text-color: #ffffff;
            --admin-border-color: #e0e0e0;
            --admin-box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            --admin-border-radius: 6px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--admin-background-color); color: var(--admin-text-color); line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

        /* Login Sayfası */
        .admin-login-container {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 100vh; background-color: var(--admin-primary-color);
        }
        .admin-login-box {
            background-color: var(--admin-card-bg-color); padding: 40px; border-radius: var(--admin-border-radius);
            box-shadow: var(--admin-box-shadow); text-align: center; max-width: 400px; width: 90%;
        }
        .admin-login-box h2 { font-size: 2rem; color: var(--admin-primary-color); margin-bottom: 25px; }
        .admin-login-box input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid var(--admin-border-color);
            border-radius: var(--admin-border-radius); font-size: 1rem;
        }
        .admin-login-box button {
            background-color: var(--admin-secondary-color); color: var(--admin-light-text-color);
            padding: 12px 25px; border: none; border-radius: var(--admin-border-radius);
            font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%;
            transition: background-color 0.3s ease;
        }
        .admin-login-box button:hover { background-color: #27ae60; }
        .admin-login-box .error-message { color: #e74c3c; margin-top: 15px; font-size: 0.9rem; display: none; }

        /* Dashboard Yapısı */
        .admin-dashboard {
            display: flex; min-height: 100vh;
        }
        .admin-sidebar {
            width: 250px; background-color: var(--admin-primary-color); padding: 20px;
            color: var(--admin-light-text-color); flex-shrink: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .admin-sidebar h3 { font-size: 1.8rem; margin-bottom: 30px; text-align: center; }
        .admin-sidebar nav ul { list-style: none; }
        .admin-sidebar nav ul li { margin-bottom: 10px; }
        .admin-sidebar nav ul li a {
            display: block; padding: 12px 15px; border-radius: var(--admin-border-radius);
            color: var(--admin-light-text-color); text-decoration: none; font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .admin-sidebar nav ul li a:hover,
        .admin-sidebar nav ul li a.active {
            background-color: rgba(255,255,255,0.15);
        }
        .admin-logout-btn {
            background-color: #e74c3c; /* Kırmızı tonu */
            color: var(--admin-light-text-color);
            padding: 10px 15px; border: none; border-radius: var(--admin-border-radius);
            cursor: pointer; width: 100%; margin-top: 30px; font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .admin-logout-btn:hover { background-color: #c0392b; }

        .admin-content {
            flex-grow: 1; padding: 30px;
        }
        .admin-content .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px;
        }
        .admin-content h1 { font-size: 2.5rem; color: var(--admin-primary-color); }
        .admin-content .add-btn {
            background-color: var(--admin-secondary-color); color: var(--admin-light-text-color);
            padding: 10px 20px; border: none; border-radius: var(--admin-border-radius);
            cursor: pointer; font-weight: 500; transition: background-color 0.3s ease;
        }
        .admin-content .add-btn:hover { background-color: #27ae60; }

        /* Ortak Form ve Liste Stilleri */
        .admin-form-container, .admin-list-container {
            background-color: var(--admin-card-bg-color); padding: 30px;
            border-radius: var(--admin-border-radius); box-shadow: var(--admin-box-shadow);
            margin-bottom: 30px;
        }
        .admin-form-container h2, .admin-list-container h2 {
            font-size: 1.8rem; color: var(--admin-primary-color); margin-bottom: 20px;
            border-bottom: 1px solid var(--admin-border-color); padding-bottom: 10px;
        }
        .admin-form-group { margin-bottom: 15px; }
        .admin-form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .admin-form-group input[type="text"],
        .admin-form-group input[type="number"],
        .admin-form-group input[type="email"],
        .admin-form-group input[type="password"],
        .admin-form-group input[type="url"],
        .admin-form-group select,
        .admin-form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--admin-border-color);
            border-radius: var(--admin-border-radius); font-size: 1rem;
        }
        .admin-form-group textarea { min-height: 100px; resize: vertical; }
        .admin-form-group input[type="checkbox"] { margin-right: 10px; }
        .admin-form-actions { margin-top: 20px; text-align: right; }
        .admin-form-actions button {
            padding: 10px 20px; border: none; border-radius: var(--admin-border-radius);
            cursor: pointer; font-weight: 500; margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        .admin-form-actions .save-btn { background-color: var(--admin-secondary-color); color: var(--admin-light-text-color); }
        .admin-form-actions .save-btn:hover { background-color: #27ae60; }
        .admin-form-actions .cancel-btn { background-color: #95a5a6; color: var(--admin-light-text-color); }
        .admin-form-actions .cancel-btn:hover { background-color: #7f8c8d; }

        /* Tablolar */
        .admin-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .admin-table th, .admin-table td {
            padding: 12px 15px; border: 1px solid var(--admin-border-color);
            text-align: left;
        }
        .admin-table th { background-color: #f8f8f8; font-weight: 600; color: var(--admin-primary-color); }
        .admin-table tbody tr:nth-child(even) { background-color: #fcfcfc; }
        .admin-table tbody tr:hover { background-color: #f0f0f0; }
        .admin-table .actions-column button {
            background: none; border: none; cursor: pointer; color: var(--admin-primary-color);
            font-size: 1.1rem; margin-right: 10px; transition: color 0.3s ease;
        }
        .admin-table .actions-column button:hover { color: var(--admin-secondary-color); }
        .admin-table .status-badge {
            padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
        }
        .admin-table .status-pending { background-color: #f39c12; color: white; }
        .admin-table .status-processed { background-color: #3498db; color: white; }
        .admin-table .status-shipped { background-color: #2ecc71; color: white; }
        .admin-table .status-completed { background-color: #27ae60; color: white; }
        .admin-table .status-cancelled { background-color: #e74c3c; color: white; }

        /* Media Upload */
        .media-upload-preview {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
        }
        .media-item {
            position: relative; width: 100px; height: 100px; border: 1px solid #ddd;
            border-radius: var(--admin-border-radius); overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .media-item img, .media-item video {
            width: 100%; height: 100%; object-fit: cover;
        }
        .media-item .delete-media {
            position: absolute; top: 5px; right: 5px; background-color: rgba(231,76,60,0.8);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 0.8rem;
        }
        .variant-row { margin-bottom: 20px; border: 1px dashed #ccc; padding: 15px; border-radius: var(--admin-border-radius); }
        .variant-row hr { margin: 15px 0; border: none; border-top: 1px dashed #eee; }
        .remove-variant-btn { background-color: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; margin-top: 10px; }


        /* Responsive */
        @media (max-width: 768px) {
            .admin-dashboard { flex-direction: column; }
            .admin-sidebar { width: 100%; height: auto; padding: 15px; }
            .admin-sidebar nav ul { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
            .admin-sidebar nav ul li { margin-bottom: 0; }
            .admin-sidebar h3 { margin-bottom: 15px; }
            .admin-content { padding: 20px; }
            .admin-table th, .admin-table td { padding: 8px 10px; font-size: 0.9rem; }
            /* .admin-table th:nth-child(n+3), .admin-table td:nth-child(n+3) { display: none; } /* Küçük ekranlarda bazı sütunları gizle */
        }
    </style>
</head>
<body>
    <div id="admin-login-view" class="admin-login-container">
        <div class="admin-login-box">
            <h2>Admin Girişi</h2>
            <form id="admin-login-form">
                <input type="email" id="admin-email" placeholder="E-posta" required autocomplete="email">
                <input type="password" id="admin-password" placeholder="Şifre" required autocomplete="current-password">
                <button type="submit">Giriş Yap</button>
                <p id="login-error-message" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="admin-dashboard-view" class="admin-dashboard" style="display: none;">
        <aside class="admin-sidebar">
            <h3>PUFEMO Admin</h3>
            <nav>
                <ul>
                    <li><a href="#dashboard" class="sidebar-link active">Dashboard</a></li>
                    <li><a href="#products" class="sidebar-link">Ürünler</a></li>
                    <li><a href="#categories" class="sidebar-link">Kategoriler</a></li>
                    <li><a href="#orders" class="sidebar-link">Siparişler</a></li>
                    <li><a href="#users" class="sidebar-link">Kullanıcılar</a></li>
                    <li><a href="#settings" class="sidebar-link">Ayarlar</a></li>
                </ul>
            </nav>
            <button id="admin-logout-btn" class="admin-logout-btn">Çıkış Yap</button>
        </aside>

        <main class="admin-content">
            <section id="dashboard-section" class="admin-page-section active">
                <div class="section-header">
                    <h1>Dashboard</h1>
                </div>
                <div class="admin-form-container">
                    <p>Burada genel istatistikler ve özet bilgiler yer alacak.</p>
                    <p>Hoş geldiniz, <span id="admin-user-email"></span>!</p>
                </div>
            </section>

            <section id="products-section" class="admin-page-section">
                <div class="section-header">
                    <h1>Ürün Yönetimi</h1>
                    <button class="add-btn" id="add-product-btn">Yeni Ürün Ekle</button>
                </div>
                <div class="admin-list-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Adı</th>
                                <th>Fiyat (TL)</th>
                                <th>Stok</th>
                                <th>Vitrin</th>
                                <th class="actions-column">Eylemler</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            </tbody>
                    </table>
                </div>

                <div id="product-form-container" class="admin-form-container" style="display: none;">
                    <h2>Ürün <span id="product-form-title">Ekle</span></h2>
                    <form id="product-form">
                        <input type="hidden" id="product-id">
                        <div class="admin-form-group">
                            <label for="product-name-tr">Ürün Adı (TR):</label>
                            <input type="text" id="product-name-tr" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="product-name-en">Ürün Adı (EN):</label>
                            <input type="text" id="product-name-en" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="product-desc-tr">Açıklama (TR):</label>
                            <textarea id="product-desc-tr"></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label for="product-desc-en">Açıklama (EN):</label>
                            <textarea id="product-desc-en"></textarea>
                        </div>
                        <div class="admin-form-group">
                            <label for="product-base-price">Ana Fiyat (TL):</label>
                            <input type="number" id="product-base-price" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="product-discounted-price">İndirimli Fiyat (TL):</label>
                            <input type="number" id="product-discounted-price" step="0.01">
                        </div>
                        <div class="admin-form-group">
                            <label for="product-is-free-shipping">Ücretsiz Kargo:</label>
                            <input type="checkbox" id="product-is-free-shipping">
                        </div>
                        <div class="admin-form-group">
                            <label for="product-is-in-showcase">Vitrine Çıkar:</label>
                            <input type="checkbox" id="product-is-in-showcase">
                        </div>

                        <h3>Varyantlar</h3>
                        <div id="product-variants-container">
                            </div>
                        <button type="button" id="add-variant-btn" class="add-btn">Yeni Varyant Ekle</button>

                        <div class="admin-form-actions">
                            <button type="submit" class="save-btn">Kaydet</button>
                            <button type="button" class="cancel-btn" id="cancel-product-form">İptal</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="categories-section" class="admin-page-section">
                <div class="section-header">
                    <h1>Kategori Yönetimi</h1>
                    <button class="add-btn" id="add-category-btn">Yeni Kategori Ekle</button>
                </div>
                <div class="admin-list-container">
                    <ul id="categories-list">
                        </ul>
                </div>

                <div id="category-form-container" class="admin-form-container" style="display: none;">
                    <h2>Kategori <span id="category-form-title">Ekle</span></h2>
                    <form id="category-form">
                        <input type="hidden" id="category-id">
                        <div class="admin-form-group">
                            <label for="category-name-tr">Kategori Adı (TR):</label>
                            <input type="text" id="category-name-tr" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="category-name-en">Kategori Adı (EN):</label>
                            <input type="text" id="category-name-en" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="parent-category">Üst Kategori:</label>
                            <select id="parent-category">
                                <option value="">Yok (Ana Kategori)</option>
                                </select>
                        </div>
                        <div class="admin-form-actions">
                            <button type="submit" class="save-btn">Kaydet</button>
                            <button type="button" class="cancel-btn" id="cancel-category-form">İptal</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="orders-section" class="admin-page-section">
                <div class="section-header">
                    <h1>Sipariş Yönetimi</h1>
                </div>
                <div class="admin-list-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Sipariş ID</th>
                                <th>Kullanıcı</th>
                                <th>Tarih</th>
                                <th>Toplam</th>
                                <th>Durum</th>
                                <th class="actions-column">Eylemler</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body">
                            </tbody>
                    </table>
                </div>

                <div id="order-detail-view" class="admin-form-container" style="display: none;">
                    <h2>Sipariş Detayı - #<span id="order-detail-id"></span></h2>
                    <div id="order-details-content">
                        </div>
                    <div class="admin-form-group">
                        <label for="order-status-select">Durum:</label>
                        <select id="order-status-select">
                            <option value="pending">Beklemede</option>
                            <option value="processed">İşleniyor</option>
                            <option value="shipped">Kargoda</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="cancelled">İptal Edildi</option>
                        </select>
                    </div>
                    <div class="admin-form-actions">
                        <button type="button" class="save-btn" id="update-order-status-btn">Durumu Güncelle</button>
                        <button type="button" class="cancel-btn" id="close-order-detail-btn">Kapat</button>
                    </div>
                </div>
            </section>

            <section id="users-section" class="admin-page-section">
                <div class="section-header">
                    <h1>Kullanıcı Yönetimi</h1>
                </div>
                <div class="admin-list-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>E-posta</th>
                                <th>Ad Soyad</th>
                                <th>Rol</th>
                                <th class="actions-column">Eylemler</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            </tbody>
                    </table>
                </div>
                </section>

            <section id="settings-section" class="admin-page-section">
                <div class="section-header">
                    <h1>Site Ayarları</h1>
                </div>
                <div class="admin-form-container">
                    <h2>Genel Ayarlar</h2>
                    <form id="general-settings-form">
                        <h3>Logo Ayarları</h3>
                        <div class="admin-form-group">
                            <label for="logo-type">Logo Tipi:</label>
                            <select id="logo-type">
                                <option value="text">Metin & İkon</option>
                                <option value="image">Resim</option>
                            </select>
                        </div>
                        <div class="admin-form-group" id="logo-text-settings">
                            <label for="logo-text">Metin:</label>
                            <input type="text" id="logo-text">
                            <label for="logo-icon">İkon (Font Awesome Class):</label>
                            <input type="text" id="logo-icon">
                            <label for="logo-text-color">Metin Rengi:</label>
                            <input type="color" id="logo-text-color">
                            <label for="logo-icon-color">İkon Rengi:</label>
                            <input type="color" id="logo-icon-color">
                        </div>
                        <div class="admin-form-group" id="logo-image-settings" style="display: none;">
                            <label for="logo-image-url">Resim URL:</label>
                            <input type="url" id="logo-image-url">
                            <input type="file" id="logo-image-file">
                            <button type="button" id="upload-logo-image">Yükle</button>
                            <div class="media-upload-preview" id="logo-image-preview"></div>
                        </div>

                        <h3>Promosyon Çubuğu Ayarları</h3>
                        <div class="admin-form-group">
                            <label for="promo-bar-enabled">Etkin:</label>
                            <input type="checkbox" id="promo-bar-enabled">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-text-tr">Metin (TR):</label>
                            <input type="text" id="promo-bar-text-tr">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-text-en">Metin (EN):</label>
                            <input type="text" id="promo-bar-text-en">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-bg-color">Arkaplan Rengi:</label>
                            <input type="color" id="promo-bar-bg-color">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-text-color">Metin Rengi:</label>
                            <input type="color" id="promo-bar-text-color">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-font-size">Yazı Boyutu:</label>
                            <input type="text" id="promo-bar-font-size" placeholder="örn: 0.95rem">
                        </div>
                        <div class="admin-form-group">
                            <label for="promo-bar-scroll-speed">Kaydırma Hızı (örn: 20s):</label>
                            <input type="text" id="promo-bar-scroll-speed" placeholder="örn: 20s">
                        </div>

                        <div class="admin-form-actions">
                            <button type="submit" class="save-btn">Genel Ayarları Kaydet</button>
                        </div>
                    </form>

                    <h2 style="margin-top: 30px;">Banner Ayarları</h2>
                    <div id="banner-list-container">
                        </div>
                    <button type="button" id="add-banner-btn" class="add-btn">Yeni Banner Ekle</button>

                    <div id="banner-form-container" class="admin-form-container" style="display: none;">
                        <h3>Banner <span id="banner-form-title">Ekle</span></h3>
                        <form id="banner-form">
                            <input type="hidden" id="banner-index">
                            <div class="admin-form-group">
                                <label for="banner-title-tr">Başlık (TR):</label>
                                <input type="text" id="banner-title-tr">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-subtitle-tr">Alt Başlık (TR):</label>
                                <input type="text" id="banner-subtitle-tr">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-title-en">Başlık (EN):</label>
                                <input type="text" id="banner-title-en">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-subtitle-en">Alt Başlık (EN):</label>
                                <input type="text" id="banner-subtitle-en">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-link-url">Link URL:</label>
                                <input type="url" id="banner-link-url">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-image-url">Resim/Video URL:</label>
                                <input type="url" id="banner-image-url">
                                <input type="file" id="banner-image-file">
                                <button type="button" id="upload-banner-image">Yükle</button>
                                <div class="media-upload-preview" id="banner-image-preview"></div>
                            </div>
                            <h3>Stil Ayarları</h3>
                            <div class="admin-form-group">
                                <label for="banner-style-title-color">Başlık Rengi:</label>
                                <input type="color" id="banner-style-title-color">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-style-title-font-size">Başlık Font Boyutu:</label>
                                <input type="text" id="banner-style-title-font-size" placeholder="örn: 2.8rem">
                            </div>
                             <div class="admin-form-group">
                                <label for="banner-style-subtitle-color">Alt Başlık Rengi:</label>
                                <input type="color" id="banner-style-subtitle-color">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-style-subtitle-font-size">Alt Başlık Font Boyutu:</label>
                                <input type="text" id="banner-style-subtitle-font-size" placeholder="örn: 1.2rem">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-style-button-bg-color">Buton Arkaplan Rengi:</label>
                                <input type="color" id="banner-style-button-bg-color">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-style-button-text-color">Buton Metin Rengi:</label>
                                <input type="color" id="banner-style-button-text-color">
                            </div>
                            <div class="admin-form-group">
                                <label for="banner-style-button-border-radius">Buton Kenar Yuvarlaklığı:</label>
                                <input type="text" id="banner-style-button-border-radius" placeholder="örn: 5px">
                            </div>
                            <div class="admin-form-actions">
                                <button type="submit" class="save-btn">Kaydet</button>
                                <button type="button" class="cancel-btn" id="cancel-banner-form">İptal</button>
                            </div>
                        </form>
                    </div>

                    <h2 style="margin-top: 30px;">Ülke ve Para Birimi Ayarları</h2>
                    <div id="country-currency-list">
                        </div>
                    <button type="button" id="add-country-currency-btn" class="add-btn">Yeni Ülke Ekle</button>

                    <div id="country-currency-form-container" class="admin-form-container" style="display: none;">
                        <h3>Ülke <span id="country-currency-form-title">Ekle</span></h3>
                        <form id="country-currency-form">
                            <input type="hidden" id="country-currency-code">
                            <div class="admin-form-group">
                                <label for="country-code-input">Ülke Kodu (örn: TR, US):</label>
                                <input type="text" id="country-code-input" maxlength="2" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="country-name-tr">Ülke Adı (TR):</label>
                                <input type="text" id="country-name-tr">
                            </div>
                            <div class="admin-form-group">
                                <label for="country-name-en">Ülke Adı (EN):</label>
                                <input type="text" id="country-name-en">
                            </div>
                            <div class="admin-form-group">
                                <label for="currency-code-input">Para Birimi Kodu (örn: TRY, USD):</label>
                                <input type="text" id="currency-code-input" maxlength="3" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="currency-symbol-input">Para Birimi Sembolü (örn: ₺, $):</label>
                                <input type="text" id="currency-symbol-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="exchange-rate-input">Döviz Kuru (USD'ye göre):</label>
                                <input type="number" id="exchange-rate-input" step="0.0001" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="default-language-input">Varsayılan Dil (örn: tr, en):</label>
                                <input type="text" id="default-language-input" maxlength="2" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="flag-emoji-input">Bayrak Emojisi (örn: 🇹🇷):</label>
                                <input type="text" id="flag-emoji-input">
                            </div>
                            <div class="admin-form-group">
                                <label for="price-adjustment-input">Fiyat Ayarlaması (%):</label>
                                <input type="number" id="price-adjustment-input" step="0.1">
                            </div>
                            <div class="admin-form-actions">
                                <button type="submit" class="save-btn">Kaydet</button>
                                <button type="button" class="cancel-btn" id="cancel-country-currency-form">İptal</button>
                            </div>
                        </form>
                    </div>

                    <h2 style="margin-top: 30px;">Diller</h2>
                    <div id="language-list-container">
                        </div>
                    <button type="button" id="add-language-btn" class="add-btn">Yeni Dil Ekle</button>

                    <div id="language-form-container" class="admin-form-container" style="display: none;">
                        <h3>Dil <span id="language-form-title">Ekle</span></h3>
                        <form id="language-form">
                            <input type="hidden" id="language-index">
                            <div class="admin-form-group">
                                <label for="language-code-input">Dil Kodu (örn: tr, en):</label>
                                <input type="text" id="language-code-input" maxlength="2" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="language-name-input">Dil Adı (örn: Türkçe, English):</label>
                                <input type="text" id="language-name-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="language-flag-input">Bayrak Emojisi (örn: 🇹🇷):</label>
                                <input type="text" id="language-flag-input" required>
                            </div>
                            <div class="admin-form-actions">
                                <button type="submit" class="save-btn">Kaydet</button>
                                <button type="button" class="cancel-btn" id="cancel-language-form">İptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script type="module">
        // Firebase Modüler SDK Import'ları
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // getAnalytics'i admin panelinde kullanmıyoruz, kaldırılabilir veya tutulabilir.
        // import { getAnalytics } from "firebase/analytics"; 
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, getDocs, addDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // Firebase Configuration (Aynı proje ID'si ve anahtarlar kullanılmalı)
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com", // Bu alan firebaseConfig içinde böyle olmalı
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
            // measurementId: "G-RH8XHC7P91" // Admin panelinde Analytics genellikle kullanılmaz
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        // const analytics = getAnalytics(app); // Admin panelinde kullanmıyorsak yorum satırı yapabiliriz

        // --- DOM Elements ---
        const adminLoginView = document.getElementById('admin-login-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginErrorMessage = document.getElementById('login-error-message');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminUserEmailSpan = document.getElementById('admin-user-email');

        // Sidebar Links
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const adminPageSections = document.querySelectorAll('.admin-page-section');

        // Product Management Elements
        const productsTableBody = document.getElementById('products-table-body');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormContainer = document.getElementById('product-form-container');
        const productFormTitle = document.getElementById('product-form-title');
        const productForm = document.getElementById('product-form');
        const productIdInput = document.getElementById('product-id');
        const productNameTrInput = document.getElementById('product-name-tr');
        const productNameEnInput = document.getElementById('product-name-en');
        const productDescTrTextarea = document.getElementById('product-desc-tr');
        const productDescEnTextarea = document.getElementById('product-desc-en');
        const productBasePriceInput = document.getElementById('product-base-price');
        const productDiscountedPriceInput = document.getElementById('product-discounted-price');
        const productIsFreeShippingCheckbox = document.getElementById('product-is-free-shipping');
        const productIsInShowcaseCheckbox = document.getElementById('product-is-in-showcase');
        const productVariantsContainer = document.getElementById('product-variants-container');
        const addVariantBtn = document.getElementById('add-variant-btn');
        const cancelProductFormBtn = document.getElementById('cancel-product-form');

        // Category Management Elements
        const categoriesList = document.getElementById('categories-list');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryFormContainer = document.getElementById('category-form-container');
        const categoryFormTitle = document.getElementById('category-form-title');
        const categoryForm = document.getElementById('category-form');
        const categoryIdInput = document.getElementById('category-id');
        const categoryNameTrInput = document.getElementById('category-name-tr');
        const categoryNameEnInput = document.getElementById('category-name-en');
        const parentCategorySelect = document.getElementById('parent-category');
        const cancelCategoryFormBtn = document.getElementById('cancel-category-form');

        // Order Management Elements
        const ordersTableBody = document.getElementById('orders-table-body');
        const orderDetailView = document.getElementById('order-detail-view');
        const orderDetailIdSpan = document.getElementById('order-detail-id');
        const orderDetailsContent = document.getElementById('order-details-content');
        const orderStatusSelect = document.getElementById('order-status-select');
        const updateOrderStatusBtn = document.getElementById('update-order-status-btn');
        const closeOrderDetailBtn = document.getElementById('close-order-detail-btn');

        // User Management Elements
        const usersTableBody = document.getElementById('users-table-body');

        // Settings Elements
        const generalSettingsForm = document.getElementById('general-settings-form');
        const logoTypeSelect = document.getElementById('logo-type');
        const logoTextSettings = document.getElementById('logo-text-settings');
        const logoImageSettings = document.getElementById('logo-image-settings');
        const logoTextInput = document.getElementById('logo-text');
        const logoIconInput = document.getElementById('logo-icon');
        const logoTextColorInput = document.getElementById('logo-text-color');
        const logoIconColorInput = document.getElementById('logo-icon-color');
        const logoImageUrlInput = document.getElementById('logo-image-url');
        const logoImageFileInput = document.getElementById('logo-image-file');
        const uploadLogoImageBtn = document.getElementById('upload-logo-image');
        const logoImagePreview = document.getElementById('logo-image-preview');

        const promoBarEnabledCheckbox = document.getElementById('promo-bar-enabled');
        const promoBarTextTrInput = document.getElementById('promo-bar-text-tr');
        const promoBarTextEnInput = document.getElementById('promo-bar-text-en');
        const promoBarBgColorInput = document.getElementById('promo-bar-bg-color');
        const promoBarTextColorInput = document.getElementById('promo-bar-text-color');
        const promoBarFontSizeInput = document.getElementById('promo-bar-font-size');
        const promoBarScrollSpeedInput = document.getElementById('promo-bar-scroll-speed');

        const bannerListContainer = document.getElementById('banner-list-container');
        const addBannerBtn = document.getElementById('add-banner-btn');
        const bannerFormContainer = document.getElementById('banner-form-container');
        const bannerFormTitle = document.getElementById('banner-form-title');
        const bannerForm = document.getElementById('banner-form');
        const bannerIndexInput = document.getElementById('banner-index');
        const bannerTitleTrInput = document.getElementById('banner-title-tr');
        const bannerSubtitleTrInput = document.getElementById('banner-subtitle-tr');
        const bannerTitleEnInput = document.getElementById('banner-title-en');
        const bannerSubtitleEnInput = document.getElementById('banner-subtitle-en');
        const bannerLinkUrlInput = document.getElementById('banner-link-url');
        const bannerImageUrlInput = document.getElementById('banner-image-url');
        const bannerImageFileInput = document.getElementById('banner-image-file');
        const uploadBannerImageBtn = document.getElementById('upload-banner-image');
        const bannerImagePreview = document.getElementById('banner-image-preview');
        const bannerStyleTitleColorInput = document.getElementById('banner-style-title-color');
        const bannerStyleTitleFontSizeInput = document.getElementById('banner-style-title-font-size');
        const bannerStyleSubtitleColorInput = document.getElementById('banner-style-subtitle-color');
        const bannerStyleSubtitleFontSizeInput = document.getElementById('banner-style-subtitle-font-size');
        const bannerStyleButtonBgColorInput = document.getElementById('banner-style-button-bg-color');
        const bannerStyleButtonTextColorInput = document.getElementById('banner-style-button-text-color');
        const bannerStyleButtonBorderRadiusInput = document.getElementById('banner-style-button-border-radius');
        const cancelBannerFormBtn = document.getElementById('cancel-banner-form');

        const countryCurrencyList = document.getElementById('country-currency-list');
        const addCountryCurrencyBtn = document.getElementById('add-country-currency-btn');
        const countryCurrencyFormContainer = document.getElementById('country-currency-form-container');
        const countryCurrencyFormTitle = document.getElementById('country-currency-form-title');
        const countryCurrencyForm = document.getElementById('country-currency-form');
        const countryCurrencyCodeInput = document.getElementById('country-currency-code');
        const countryNameTrInput = document.getElementById('country-name-tr');
        const countryNameEnInput = document.getElementById('country-name-en');
        const currencyCodeInput = document.getElementById('currency-code-input');
        const currencySymbolInput = document.getElementById('currency-symbol-input');
        const exchangeRateInput = document.getElementById('exchange-rate-input');
        const defaultLanguageInput = document.getElementById('default-language-input');
        const flagEmojiInput = document.getElementById('flag-emoji-input');
        const priceAdjustmentInput = document.getElementById('price-adjustment-input');
        const cancelCountryCurrencyFormBtn = document.getElementById('cancel-country-currency-form');

        const languageListContainer = document.getElementById('language-list-container');
        const addLanguageBtn = document.getElementById('add-language-btn');
        const languageFormContainer = document.getElementById('language-form-container');
        const languageFormTitle = document.getElementById('language-form-title');
        const languageForm = document.getElementById('language-form');
        const languageIndexInput = document.getElementById('language-index');
        const languageCodeInput = document.getElementById('language-code-input');
        const languageNameInput = document.getElementById('language-name-input');
        const languageFlagInput = document.getElementById('language-flag-input');
        const cancelLanguageFormBtn = document.getElementById('cancel-language-form');


        // --- Global Data & State ---
        let adminSiteData = {
            settings: null,
            categories: null,
            products: [],
            orders: [],
            users: []
        };
        let currentEditingProduct = null;
        let currentEditingCategory = null;
        let currentEditingOrder = null;
        let currentEditingBannerIndex = -1;
        let currentEditingCountryCode = null;
        let currentEditingLanguageIndex = -1;

        // --- Helper Functions ---
        const showView = (viewId) => {
            adminLoginView.style.display = 'none';
            adminDashboardView.style.display = 'none';
            document.getElementById(viewId).style.display = 'flex'; // login için 'flex', dashboard için 'flex'

            if (viewId === 'admin-dashboard-view') {
                const currentSectionId = localStorage.getItem('adminLastSection') || 'dashboard-section';
                showAdminSection(currentSectionId);
            }
        };

        const showAdminSection = (sectionId) => {
            adminPageSections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            sidebarLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId.replace('-section', '')}`) {
                    link.classList.add('active');
                }
            });
            localStorage.setItem('adminLastSection', sectionId);

            // Her bölüm gösterildiğinde ilgili verileri yükle/yenile
            if (sectionId === 'products-section') {
                loadProducts();
            } else if (sectionId === 'categories-section') {
                loadCategories();
            } else if (sectionId === 'orders-section') {
                loadOrders();
            } else if (sectionId === 'users-section') {
                loadUsers();
            } else if (sectionId === 'settings-section') {
                loadSettings();
            }
        };

        const displayErrorMessage = (message, element) => {
            element.textContent = message;
            element.style.display = 'block';
        };

        const clearErrorMessage = (element) => {
            element.textContent = '';
            element.style.display = 'none';
        };

        const countryCodeToEmoji = (code) => {
            if (!code || code.length !== 2) return '';
            return code.toUpperCase().split('').map(char => String.fromCodePoint(char.charCodeAt(0) + 127397)).join('');
        };

        const getTranslatedName = (obj) => {
            if (!obj || !obj.name) return 'N/A';
            return obj.name.tr || obj.name.en || 'N/A'; // Varsayılan olarak Türkçe veya İngilizce
        };

        const getTranslatedContent = (obj, field) => {
            if (!obj || !obj.content) return '';
            return obj.content.tr?.[field] || obj.content.en?.[field] || '';
        };

        // Helper to get translated content for specific language
        const getTranslatedContentForLang = (obj, field, langCode) => {
            return obj?.content?.[langCode]?.[field] || '';
        };

        const deleteMediaFromPreview = (index, url, previewId) => {
            document.getElementById(previewId).innerHTML = '';
            if (previewId.startsWith('variant-image-preview-')) {
                 document.getElementById(`variant-image-url-${index}`).value = '';
            } else if (previewId === 'logo-image-preview') {
                 document.getElementById('logo-image-url').value = '';
            } else if (previewId === 'banner-image-preview') {
                 document.getElementById('banner-image-url').value = '';
            }

            // Opsiyonel: Firebase Storage'dan da silmek isterseniz
            // const storageRef = ref(storage, url);
            // deleteObject(storageRef).then(() => {
            //     console.log('Dosya Storage\'dan silindi:', url);
            // }).catch((error) => {
            //     console.error('Dosya Storage\'dan silinirken hata:', error);
            // });
        };


        // --- Products Management Functions ---
        const loadProducts = async () => {
            productsTableBody.innerHTML = '<tr><td colspan="6">Ürünler yükleniyor...</td></tr>';
            try {
                const productsSnap = await getDocs(collection(db, 'products'));
                adminSiteData.products = productsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductsTable();
            } catch (error) {
                console.error("Ürünler yüklenirken hata:", error);
                productsTableBody.innerHTML = '<tr><td colspan="6">Ürünler yüklenemedi.</td></tr>';
            }
        };

        const renderProductsTable = () => {
            productsTableBody.innerHTML = '';
            if (adminSiteData.products.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="6">Henüz ürün eklenmemiş.</td></tr>';
                return;
            }

            adminSiteData.products.forEach(product => {
                const row = productsTableBody.insertRow();
                row.innerHTML = `
                    <td>${product.id.substring(0, 6)}...</td>
                    <td>${getTranslatedContent(product, 'name')}</td>
                    <td>${product.basePriceTL ? product.basePriceTL.toFixed(2) : 'N/A'}</td>
                    <td>${product.variants?.[0]?.stock !== undefined ? product.variants[0].stock : 'N/A'}</td>
                    <td>${product.isInShowcase ? 'Evet' : 'Hayır'}</td>
                    <td class="actions-column">
                        <button class="edit-product-btn" data-id="${product.id}" title="Düzenle"><i class="fa-solid fa-edit"></i></button>
                        <button class="delete-product-btn" data-id="${product.id}" title="Sil"><i class="fa-solid fa-trash-alt"></i></button>
                    </td>
                `;
            });
            addTableEventListeners('products');
        };

        const addTableEventListeners = (type) => {
            if (type === 'products') {
                document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', () => editProduct(btn.dataset.id)));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', () => deleteProduct(btn.dataset.id)));
            } else if (type === 'orders') {
                document.querySelectorAll('.view-order-detail-btn').forEach(btn => btn.addEventListener('click', () => viewOrderDetail(btn.dataset.id)));
            } else if (type === 'users') {
                 document.querySelectorAll('.edit-user-role-btn').forEach(btn => btn.addEventListener('click', () => editUserRole(btn.dataset.id)));
            }
        };

        const showProductForm = (isEdit = false) => {
            productFormContainer.style.display = 'block';
            productFormTitle.textContent = isEdit ? 'Düzenle' : 'Ekle';
            if (!isEdit) {
                productForm.reset();
                productIdInput.value = '';
                productVariantsContainer.innerHTML = '';
                addVariantRow(); // Yeni ürün için varsayılan bir varyant ekle
            }
        };

        const hideProductForm = () => {
            productFormContainer.style.display = 'none';
            productForm.reset();
            currentEditingProduct = null;
        };

        const addVariantRow = (variant = {}) => {
            const index = productVariantsContainer.children.length;
            const variantDiv = document.createElement('div');
            variantDiv.className = 'admin-form-group variant-row';
            variantDiv.innerHTML = `
                <h4>Varyant ${index + 1}</h4>
                <label for="variant-name-${index}">Varyant Adı:</label>
                <input type="text" id="variant-name-${index}" value="${variant.name || ''}">
                <label for="variant-price-${index}">Varyant Fiyat (TL):</label>
                <input type="number" id="variant-price-${index}" step="0.01" value="${variant.priceTL || ''}">
                <label for="variant-discounted-price-${index}">Varyant İndirimli Fiyat (TL):</label>
                <input type="number" id="variant-discounted-price-${index}" step="0.01" value="${variant.discountedPriceTL || ''}">
                <label for="variant-stock-${index}">Stok:</label>
                <input type="number" id="variant-stock-${index}" value="${variant.stock || 0}" required>
                <label for="variant-image-url-${index}">Varyant Resim URL:</label>
                <input type="url" id="variant-image-url-${index}" value="${variant.media?.[0]?.url || ''}">
                <input type="file" id="variant-image-file-${index}">
                <button type="button" class="upload-variant-image" data-index="${index}">Yükle</button>
                <div class="media-upload-preview" id="variant-image-preview-${index}">
                    ${variant.media?.[0]?.url ? `<div class="media-item"><img src="${variant.media[0].url}"><button class="delete-media" data-index="${index}" data-url="${variant.media[0].url}">X</button></div>` : ''}
                </div>
                <button type="button" class="remove-variant-btn" data-index="${index}">Varyantı Sil</button>
                <hr>
            `;
            productVariantsContainer.appendChild(variantDiv);

            variantDiv.querySelector('.upload-variant-image').addEventListener('click', (e) => uploadProductVariantImage(e.target.dataset.index));
            variantDiv.querySelector('.remove-variant-btn').addEventListener('click', (e) => removeVariantRow(e.target.dataset.index));
            if (variantDiv.querySelector('.delete-media')) {
                 variantDiv.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, `variant-image-preview-${e.target.dataset.index}`));
            }
        };

        const removeVariantRow = (indexToRemove) => {
            if (productVariantsContainer.children.length === 1) {
                alert("En az bir varyant olmak zorundadır.");
                return;
            }
            productVariantsContainer.children[indexToRemove].remove();
            // İndeksleri yeniden düzenle
            Array.from(productVariantsContainer.children).forEach((child, i) => {
                child.querySelector('h4').textContent = `Varyant ${i + 1}`;
                child.querySelectorAll('[id^="variant-"], [for^="variant-"]').forEach(el => {
                    el.id = el.id.replace(/-\d+/, `-${i}`);
                    el.htmlFor = el.htmlFor.replace(/-\d+/, `-${i}`);
                });
                child.querySelector('.upload-variant-image').dataset.index = i;
                child.querySelector('.remove-variant-btn').dataset.index = i;
                if (child.querySelector('.delete-media')) child.querySelector('.delete-media').dataset.index = i;
            });
        };

        const uploadProductVariantImage = async (index) => {
            const fileInput = document.getElementById(`variant-image-file-${index}`);
            const imageUrlInput = document.getElementById(`variant-image-url-${index}`);
            const previewContainer = document.getElementById(`variant-image-preview-${index}`);

            if (fileInput.files.length === 0) {
                alert("Lütfen bir resim dosyası seçin.");
                return;
            }

            const file = fileInput.files[0];
            const storageRef = ref(storage, `product_variants/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                imageUrlInput.value = downloadURL;
                previewContainer.innerHTML = `<div class="media-item"><img src="${downloadURL}"><button class="delete-media" data-index="${index}" data-url="${downloadURL}">X</button></div>`;
                previewContainer.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, `variant-image-preview-${e.target.dataset.index}`));
            } catch (error) {
                console.error("Resim yüklenirken hata:", error);
                alert("Resim yüklenirken hata oluştu.");
            }
        };

        const editProduct = (productId) => {
            const product = adminSiteData.products.find(p => p.id === productId);
            if (!product) return;

            currentEditingProduct = product;
            productIdInput.value = product.id;
            productNameTrInput.value = getTranslatedContent(product, 'name', 'tr');
            productNameEnInput.value = getTranslatedContent(product, 'name', 'en');
            productDescTrTextarea.value = getTranslatedContent(product, 'description', 'tr');
            productDescEnTextarea.value = getTranslatedContent(product, 'description', 'en');
            productBasePriceInput.value = product.basePriceTL;
            productDiscountedPriceInput.value = product.baseDiscountedPriceTL;
            productIsFreeShippingCheckbox.checked = product.isFreeShipping || false;
            productIsInShowcaseCheckbox.checked = product.isInShowcase || false;

            productVariantsContainer.innerHTML = ''; // Önceki varyantları temizle
            if (product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => addVariantRow(variant));
            } else {
                addVariantRow(); // Varyant yoksa boş bir tane ekle
            }

            showProductForm(true);
        };

        const deleteProduct = async (productId) => {
            if (!confirm("Bu ürünü silmek istediğinize emin misiniz?")) return;
            try {
                await deleteDoc(doc(db, 'products', productId));
                alert("Ürün başarıyla silindi!");
                loadProducts();
            } catch (error) {
                console.error("Ürün silinirken hata:", error);
                alert("Ürün silinirken bir hata oluştu: " + error.message);
            }
        };


        // --- Categories Management Functions ---
        const loadCategories = async () => {
            categoriesList.innerHTML = '<li>Kategoriler yükleniyor...</li>';
            try {
                const categoriesDoc = await getDoc(doc(db, 'pufemo', 'categories'));
                if (categoriesDoc.exists()) {
                    adminSiteData.categories = categoriesDoc.data();
                    renderCategoriesList(adminSiteData.categories.tree);
                    populateParentCategorySelect(adminSiteData.categories.tree);
                } else {
                    adminSiteData.categories = { tree: [] };
                    categoriesList.innerHTML = '<li>Henüz kategori eklenmemiş.</li>';
                    populateParentCategorySelect([]);
                }
            } catch (error) {
                console.error("Kategoriler yüklenirken hata:", error);
                categoriesList.innerHTML = '<li>Kategoriler yüklenemedi.</li>';
            }
        };

        const renderCategoriesList = (categories, ulEl = categoriesList, depth = 0) => {
            if (depth === 0) ulEl.innerHTML = ''; // Sadece en üst seviyede temizle

            categories.forEach(cat => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div style="margin-left: ${depth * 20}px;">
                        ${getTranslatedContentForLang({ content: cat.name }, 'name', 'tr')} 
                        (<button class="edit-category-btn" data-id="${cat.id}">Düzenle</button> 
                        <button class="delete-category-btn" data-id="${cat.id}">Sil</button>)
                    </div>
                `;
                ulEl.appendChild(li);
                if (cat.children && cat.children.length > 0) {
                    const childUl = document.createElement('ul');
                    li.appendChild(childUl);
                    renderCategoriesList(cat.children, childUl, depth + 1);
                }
            });
            addCategoryEventListeners();
        };

        const populateParentCategorySelect = (categories, prefix = '', level = 0) => {
            if (level === 0) {
                parentCategorySelect.innerHTML = '<option value="">Yok (Ana Kategori)</option>';
            }
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${prefix}${getTranslatedContentForLang({ content: cat.name }, 'name', 'tr')}`;
                parentCategorySelect.appendChild(option);
                if (cat.children) { // Sadece varsa children'ı kontrol et
                    populateParentCategorySelect(cat.children, prefix + '-- ', level + 1);
                }
            });
        };

        const findCategoryById = (id, categories) => {
            for (const cat of categories) {
                if (cat.id === id) return cat;
                if (cat.children) {
                    const found = findCategoryById(id, cat.children);
                    if (found) return found;
                }
            }
            return null;
        };

        const updateCategoryInTree = (categories, updatedCategory) => {
            return categories.map(cat => {
                if (cat.id === updatedCategory.id) {
                    return { ...cat, name: updatedCategory.name };
                } else if (cat.children) {
                    return { ...cat, children: updateCategoryInTree(cat.children, updatedCategory) };
                }
                return cat;
            });
        };

        const removeCategoryFromTree = (categories, categoryId) => {
            return categories.filter(cat => cat.id !== categoryId).map(cat => {
                if (cat.children) {
                    return { ...cat, children: removeCategoryFromTree(cat.children, categoryId) };
                }
                return cat;
            });
        };

        const addCategoryEventListeners = () => {
            document.querySelectorAll('.edit-category-btn').forEach(btn => btn.addEventListener('click', () => editCategory(btn.dataset.id)));
            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', () => deleteCategory(btn.dataset.id)));
        };

        const showCategoryForm = (isEdit = false) => {
            categoryFormContainer.style.display = 'block';
            categoryFormTitle.textContent = isEdit ? 'Düzenle' : 'Ekle';
            if (!isEdit) {
                categoryForm.reset();
                categoryIdInput.value = '';
                currentEditingCategory = null;
            }
        };

        const hideCategoryForm = () => {
            categoryFormContainer.style.display = 'none';
            categoryForm.reset();
            currentEditingCategory = null;
        };

        const editCategory = (id) => {
            const category = findCategoryById(id, adminSiteData.categories.tree);
            if (!category) return;

            currentEditingCategory = category;
            categoryIdInput.value = category.id;
            categoryNameTrInput.value = getTranslatedContentForLang({ content: category.name }, 'name', 'tr');
            categoryNameEnInput.value = getTranslatedContentForLang({ content: category.name }, 'name', 'en');

            // Find parent and set select box
            const findParentId = (nodes, childId, parent = null) => {
                for (const node of nodes) {
                    if (node.id === childId) return parent ? parent.id : '';
                    if (node.children) {
                        const foundId = findParentId(node.children, childId, node);
                        if (foundId !== null) return foundId;
                    }
                }
                return null;
            };
            parentCategorySelect.value = findParentId(adminSiteData.categories.tree, category.id) || '';

            showCategoryForm(true);
        };

        const deleteCategory = async (id) => {
            if (!confirm("Bu kategoriyi ve alt kategorilerini silmek istediğinize emin misiniz?")) return;
            try {
                let updatedTree = removeCategoryFromTree(adminSiteData.categories.tree, id);
                await updateDoc(doc(db, 'pufemo', 'categories'), { tree: updatedTree });
                adminSiteData.categories.tree = updatedTree; // State'i güncelle
                alert("Kategori başarıyla silindi!");
                renderCategoriesList(adminSiteData.categories.tree); // UI'ı yenile
                populateParentCategorySelect(adminSiteData.categories.tree); // Selectbox'ı yenile
            } catch (error) {
                console.error("Kategori silinirken hata:", error);
                alert("Kategori silinirken bir hata oluştu: " + error.message);
            }
        };

        // --- Orders Management Functions ---
        const loadOrders = async () => {
            ordersTableBody.innerHTML = '<tr><td colspan="6">Siparişler yükleniyor...</td></tr>';
            try {
                const ordersSnap = await getDocs(collection(db, 'orders'));
                adminSiteData.orders = ordersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrdersTable();
            } catch (error) {
                console.error("Siparişler yüklenirken hata:", error);
                ordersTableBody.innerHTML = '<tr><td colspan="6">Siparişler yüklenemedi.</td></tr>';
            }
        };

        const renderOrdersTable = () => {
            ordersTableBody.innerHTML = '';
            if (adminSiteData.orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="6">Henüz sipariş yok.</td></tr>';
                return;
            }

            adminSiteData.orders.forEach(order => {
                const row = ordersTableBody.insertRow();
                const orderDate = new Date(order.orderDate).toLocaleDateString('tr-TR'); // Türkçe format
                const orderTime = new Date(order.orderDate).toLocaleTimeString('tr-TR');

                let statusClass = '';
                switch (order.status) {
                    case 'pending': statusClass = 'status-pending'; break;
                    case 'processed': statusClass = 'status-processed'; break;
                    case 'shipped': statusClass = 'status-shipped'; break;
                    case 'completed': statusClass = 'status-completed'; break;
                    case 'cancelled': statusClass = 'status-cancelled'; break;
                }

                row.innerHTML = `
                    <td>${order.id.substring(0, 8)}...</td>
                    <td>${order.userId ? order.userId.substring(0, 8) + '...' : 'Misafir'}</td>
                    <td>${orderDate} ${orderTime}</td>
                    <td>${order.totalTL ? (order.totalTL * (adminSiteData.settings?.exchangeRates?.[order.currency] || 1)).toFixed(2) : 'N/A'} ${adminSiteData.settings?.currencySymbols?.[order.currency] || order.currency}</td>
                    <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                    <td class="actions-column">
                        <button class="view-order-detail-btn" data-id="${order.id}" title="Detayları Görüntüle"><i class="fa-solid fa-eye"></i></button>
                    </td>
                `;
            });
            addTableEventListeners('orders');
        };

        const viewOrderDetail = (orderId) => {
            const order = adminSiteData.orders.find(o => o.id === orderId);
            if (!order) return;

            currentEditingOrder = order;
            orderDetailIdSpan.textContent = order.id.substring(0, 8);
            orderDetailsContent.innerHTML = `
                <p><strong>Kullanıcı ID:</strong> ${order.userId || 'Misafir'}</p>
                <p><strong>Sipariş Tarihi:</strong> ${new Date(order.orderDate).toLocaleString('tr-TR')}</p>
                <p><strong>Kargo Adresi:</strong> ${order.shippingAddress?.address1 || ''}, ${order.shippingAddress?.city || ''}, ${order.shippingAddress?.country || ''}</p>
                <p><strong>Ödeme Yöntemi:</strong> ${order.paymentMethod || 'Belirtilmemiş'}</p>
                <hr>
                <h4>Ürünler:</h4>
                <ul>
                    ${order.items.map(item => `
                        <li>
                            <img src="${item.imageUrl || `https://placehold.co/50x50/ccc/fff?text=N/A`}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 3px; vertical-align: middle; margin-right: 10px;">
                            ${item.name} ${item.variantName ? `(${item.variantName})` : ''} x ${item.quantity} - 
                            ${(item.priceAtPurchase * item.quantity * (adminSiteData.settings?.exchangeRates?.[order.currency] || 1)).toFixed(2)} ${adminSiteData.settings?.currencySymbols?.[order.currency] || order.currency}
                        </li>
                    `).join('')}
                </ul>
                <p><strong>Ara Toplam:</strong> ${(order.subtotalTL * (adminSiteData.settings?.exchangeRates?.[order.currency] || 1)).toFixed(2)} ${adminSiteData.settings?.currencySymbols?.[order.currency] || order.currency}</p>
                <p><strong>Kargo Ücreti:</strong> ${(order.shippingCostTL * (adminSiteData.settings?.exchangeRates?.[order.currency] || 1)).toFixed(2)} ${adminSiteData.settings?.currencySymbols?.[order.currency] || order.currency}</p>
                <p><strong>Toplam:</strong> ${(order.totalTL * (adminSiteData.settings?.exchangeRates?.[order.currency] || 1)).toFixed(2)} ${adminSiteData.settings?.currencySymbols?.[order.currency] || order.currency}</p>
            `;
            orderStatusSelect.value = order.status;
            orderDetailView.style.display = 'block';
        };

        // --- Users Management Functions ---
        const loadUsers = async () => {
            usersTableBody.innerHTML = '<tr><td colspan="5">Kullanıcılar yükleniyor...</td></tr>';
            try {
                // Not: Eğer Firestore koleksiyon adınız 'users' değil 'uyeler' ise bu satırı güncelleyin:
                // const usersSnap = await getDocs(collection(db, 'uyeler'));
                const usersSnap = await getDocs(collection(db, 'users')); // Varsayılan olarak 'users' kullanılıyor
                adminSiteData.users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsersTable();
            } catch (error) {
                console.error("Kullanıcılar yüklenirken hata:", error);
                usersTableBody.innerHTML = '<tr><td colspan="5">Kullanıcılar yüklenemedi.</td></tr>';
            }
        };

        const renderUsersTable = () => {
            usersTableBody.innerHTML = '';
            if (adminSiteData.users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="5">Henüz kullanıcı yok.</td></tr>';
                return;
            }

            adminSiteData.users.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `
                    <td>${user.id.substring(0, 8)}...</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.firstName || ''} ${user.lastName || ''}</td>
                    <td>${user.role || 'customer'}</td>
                    <td class="actions-column">
                        <button class="edit-user-role-btn" data-id="${user.id}" data-role="${user.role || 'customer'}" title="Rolü Değiştir"><i class="fa-solid fa-user-tag"></i></button>
                        </td>
                `;
            });
            addTableEventListeners('users');
        };

        const editUserRole = async (userId) => {
            const user = adminSiteData.users.find(u => u.id === userId);
            if (!user) return;

            const newRole = prompt(`Kullanıcı "${user.email}" için yeni rolü girin (customer, admin):`, user.role || 'customer');
            if (newRole && ['customer', 'admin'].includes(newRole)) {
                try {
                    // Not: Eğer Firestore koleksiyon adınız 'users' değil 'uyeler' ise bu satırı güncelleyin:
                    // await updateDoc(doc(db, 'uyeler', userId), { role: newRole });
                    await updateDoc(doc(db, 'users', userId), { role: newRole }); // Varsayılan olarak 'users' kullanılıyor
                    alert(`Kullanıcı rolü "${newRole}" olarak güncellendi.`);
                    loadUsers();
                } catch (error) {
                    console.error("Kullanıcı rolü güncellenirken hata:", error);
                    alert("Kullanıcı rolü güncellenirken bir hata oluştu: " + error.message);
                }
            } else if (newRole !== null) {
                alert("Geçersiz rol! Lütfen 'customer' veya 'admin' girin.");
            }
        };

        // --- Settings Management Functions ---
        const loadSettings = async () => {
            try {
                const settingsDoc = await getDoc(doc(db, 'pufemo', 'settings'));
                if (settingsDoc.exists()) {
                    adminSiteData.settings = settingsDoc.data();
                    fillGeneralSettingsForm(adminSiteData.settings.general || {});
                    renderBannerList(adminSiteData.settings.banner || []);
                    renderCountryCurrencyList(adminSiteData.settings.countryPricing || {});
                    renderLanguageList(adminSiteData.settings.languages || []);
                } else {
                    adminSiteData.settings = { general: {}, banner: [], countryPricing: {}, languages: [] };
                    fillGeneralSettingsForm({});
                    renderBannerList([]);
                    renderCountryCurrencyList({});
                    renderLanguageList([]);
                    console.warn("Settings document not found in Firestore.");
                }
            } catch (error) {
                console.error("Ayarlar yüklenirken hata:", error);
                alert("Ayarlar yüklenirken bir hata oluştu.");
            }
        };

        const fillGeneralSettingsForm = (generalSettings) => {
            // Logo
            logoTypeSelect.value = generalSettings.logo?.type || 'text';
            toggleLogoSettings(); // Seçime göre ilgili alanı göster/gizle
            logoTypeSelect.addEventListener('change', toggleLogoSettings);

            logoTextInput.value = generalSettings.logo?.text || '';
            logoIconInput.value = generalSettings.logo?.icon || '';
            logoTextColorInput.value = generalSettings.logo?.textColor || '#2c3e50';
            logoIconColorInput.value = generalSettings.logo?.iconColor || '#e74c3c';
            logoImageUrlInput.value = generalSettings.logo?.imageUrl || '';
            
            logoImagePreview.innerHTML = '';
            if (generalSettings.logo?.imageUrl) {
                logoImagePreview.innerHTML = `<div class="media-item"><img src="${generalSettings.logo.imageUrl}"><button class="delete-media" data-index="-1" data-url="${generalSettings.logo.imageUrl}">X</button></div>`;
                logoImagePreview.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, 'logo-image-preview'));
            }

            // Promo Bar
            promoBarEnabledCheckbox.checked = generalSettings.promoBar?.enabled || false;
            promoBarTextTrInput.value = generalSettings.promoBar?.text?.tr || '';
            promoBarTextEnInput.value = generalSettings.promoBar?.text?.en || '';
            promoBarBgColorInput.value = generalSettings.promoBar?.bgColor || '#e74c3c';
            promoBarTextColorInput.value = generalSettings.promoBar?.textColor || '#ffffff';
            promoBarFontSizeInput.value = generalSettings.promoBar?.fontSize || '0.95rem';
            promoBarScrollSpeedInput.value = generalSettings.promoBar?.scrollSpeed || '20s';
        };

        const toggleLogoSettings = () => {
            if (logoTypeSelect.value === 'image') {
                logoTextSettings.style.display = 'none';
                logoImageSettings.style.display = 'block';
            } else {
                logoTextSettings.style.display = 'block';
                logoImageSettings.style.display = 'none';
            }
        };

        // Banner Management Functions
        const renderBannerList = (banners) => {
            bannerListContainer.innerHTML = '';
            if (banners.length === 0) {
                bannerListContainer.innerHTML = '<p>Henüz banner eklenmemiş.</p>';
                return;
            }
            banners.forEach((banner, index) => {
                const bannerDiv = document.createElement('div');
                bannerDiv.className = 'admin-form-container'; // Reuse form-container style
                bannerDiv.innerHTML = `
                    <h3>Banner ${index + 1}</h3>
                    <p>Başlık (TR): ${banner.content?.tr?.title || 'Yok'}</p>
                    <p>Resim/Video: ${banner.image_url ? `<img src="${banner.image_url}" style="max-width: 100px; max-height: 100px; object-fit: contain;">` : 'Yok'}</p>
                    <div class="admin-form-actions">
                        <button type="button" class="edit-banner-btn save-btn" data-index="${index}">Düzenle</button>
                        <button type="button" class="delete-banner-btn cancel-btn" data-index="${index}">Sil</button>
                    </div>
                `;
                bannerListContainer.appendChild(bannerDiv);
            });
            document.querySelectorAll('.edit-banner-btn').forEach(btn => btn.addEventListener('click', () => editBanner(parseInt(btn.dataset.index))));
            document.querySelectorAll('.delete-banner-btn').forEach(btn => btn.addEventListener('click', () => deleteBanner(parseInt(btn.dataset.index))));
        };

        const showBannerForm = (isEdit = false) => {
            bannerFormContainer.style.display = 'block';
            bannerFormTitle.textContent = isEdit ? 'Düzenle' : 'Ekle';
            if (!isEdit) {
                bannerForm.reset();
                bannerIndexInput.value = '';
                currentEditingBannerIndex = -1;
                bannerImagePreview.innerHTML = '';
            }
        };

        const hideBannerForm = () => {
            bannerFormContainer.style.display = 'none';
            bannerForm.reset();
            currentEditingBannerIndex = -1;
        };

        const editBanner = (index) => {
            const banner = adminSiteData.settings.banner[index];
            if (!banner) return;

            currentEditingBannerIndex = index;
            bannerIndexInput.value = index;
            bannerTitleTrInput.value = banner.content?.tr?.title || '';
            bannerSubtitleTrInput.value = banner.content?.tr?.subtitle || '';
            bannerTitleEnInput.value = banner.content?.en?.title || '';
            bannerSubtitleEnInput.value = banner.content?.en?.subtitle || '';
            bannerLinkUrlInput.value = banner.link_url || '';
            bannerImageUrlInput.value = banner.image_url || '';
            bannerImagePreview.innerHTML = '';
            if (banner.image_url) {
                const isVideo = banner.image_url.includes('.mp4'); // Simple check
                bannerImagePreview.innerHTML = `<div class="media-item">${isVideo ? `<video src="${banner.image_url}" controls></video>` : `<img src="${banner.image_url}">`}<button class="delete-media" data-index="${index}" data-url="${banner.image_url}">X</button></div>`;
                 bannerImagePreview.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, 'banner-image-preview'));
            }
            bannerStyleTitleColorInput.value = banner.style?.title_color || '#ffffff';
            bannerStyleTitleFontSizeInput.value = banner.style?.title_font_size || '2.8rem';
            bannerStyleSubtitleColorInput.value = banner.style?.subtitle_color || '#ffffff';
            bannerStyleSubtitleFontSizeInput.value = banner.style?.subtitle_font_size || '1.2rem';
            bannerStyleButtonBgColorInput.value = banner.style?.button_bg_color || '#e74c3c';
            bannerStyleButtonTextColorInput.value = banner.style?.button_text_color || '#ffffff';
            bannerStyleButtonBorderRadiusInput.value = banner.style?.button_border_radius || '5px';

            showBannerForm(true);
        };

        const deleteBanner = async (index) => {
            if (!confirm("Bu bannerı silmek istediğinize emin misiniz?")) return;
            let updatedBanners = [...(adminSiteData.settings?.banner || [])];
            const [deletedBanner] = updatedBanners.splice(index, 1); // Silineni al

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), { banner: updatedBanners });
                // Opsiyonel: Eğer Firebase Storage'dan da silmek isterseniz
                // if (deletedBanner && deletedBanner.image_url) {
                //     const storageRef = ref(storage, deletedBanner.image_url);
                //     await deleteObject(storageRef);
                //     console.log('Banner medya dosyası Storage\'dan silindi.');
                // }
                alert("Banner başarıyla silindi!");
                loadSettings();
            } catch (error) {
                console.error("Banner silinirken hata:", error);
                alert("Banner silinirken bir hata oluştu: " + error.message);
            }
        };

        // Country & Currency Management Functions
        const renderCountryCurrencyList = (countryPricing) => {
            countryCurrencyList.innerHTML = '';
            const countries = Object.entries(countryPricing);
            if (countries.length === 0) {
                countryCurrencyList.innerHTML = '<p>Henüz ülke/para birimi bilgisi eklenmemiş.</p>';
                return;
            }
            countries.forEach(([code, data]) => {
                const div = document.createElement('div');
                div.className = 'admin-form-container'; // Reuse style
                div.innerHTML = `
                    <h3>${countryCodeToEmoji(data.flag)} ${data.name?.tr || data.name?.en || code.toUpperCase()} (${code})</h3>
                    <p>Para Birimi: ${data.currencyCode} (${adminSiteData.settings.currencySymbols?.[data.currencyCode] || data.currencyCode})</p>
                    <p>Varsayılan Dil: ${data.defaultLanguage}</p>
                    <p>Döviz Kuru (USD'ye göre): ${adminSiteData.settings.exchangeRates?.[data.currencyCode]?.toFixed(4) || 'Yok'}</p>
                    <p>Fiyat Ayarlaması: %${data.adjustment || 0}</p>
                    <div class="admin-form-actions">
                        <button type="button" class="edit-country-currency-btn save-btn" data-code="${code}">Düzenle</button>
                        <button type="button" class="delete-country-currency-btn cancel-btn" data-code="${code}">Sil</button>
                    </div>
                `;
                countryCurrencyList.appendChild(div);
            });
            document.querySelectorAll('.edit-country-currency-btn').forEach(btn => btn.addEventListener('click', () => editCountryCurrency(btn.dataset.code)));
            document.querySelectorAll('.delete-country-currency-btn').forEach(btn => btn.addEventListener('click', () => deleteCountryCurrency(btn.dataset.code)));
        };

        const showCountryCurrencyForm = (isEdit = false) => {
            countryCurrencyFormContainer.style.display = 'block';
            countryCurrencyFormTitle.textContent = isEdit ? 'Düzenle' : 'Ekle';
            if (!isEdit) {
                countryCurrencyForm.reset();
                countryCurrencyCodeInput.value = '';
                countryCurrencyCodeInput.readOnly = false; // Yeni eklerken kod düzenlenebilir
                currentEditingCountryCode = null;
            } else {
                countryCurrencyCodeInput.readOnly = true; // Düzenlerken kod değiştirilemez
            }
        };

        const hideCountryCurrencyForm = () => {
            countryCurrencyFormContainer.style.display = 'none';
            countryCurrencyForm.reset();
            currentEditingCountryCode = null;
        };

        const editCountryCurrency = (code) => {
            const country = adminSiteData.settings.countryPricing[code];
            const currencySymbol = adminSiteData.settings.currencySymbols[country.currencyCode];
            const exchangeRate = adminSiteData.settings.exchangeRates[country.currencyCode];

            if (!country) return;

            currentEditingCountryCode = code;
            countryCurrencyCodeInput.value = code;
            countryNameTrInput.value = country.name?.tr || '';
            countryNameEnInput.value = country.name?.en || '';
            currencyCodeInput.value = country.currencyCode || '';
            currencySymbolInput.value = currencySymbol || '';
            exchangeRateInput.value = exchangeRate || 1;
            defaultLanguageInput.value = country.defaultLanguage || '';
            flagEmojiInput.value = country.flag || '';
            priceAdjustmentInput.value = country.adjustment || 0;

            showCountryCurrencyForm(true);
        };

        const deleteCountryCurrency = async (code) => {
            if (!confirm("Bu ülke/para birimi bilgisini silmek istediğinize emin misiniz?")) return;

            let updatedCountryPricing = { ...(adminSiteData.settings.countryPricing || {}) };
            let updatedCurrencySymbols = { ...(adminSiteData.settings.currencySymbols || {}) };
            let updatedExchangeRates = { ...(adminSiteData.settings.exchangeRates || {}) };

            const deletedCountry = updatedCountryPricing[code];
            const deletedCurrencyCode = deletedCountry.currencyCode;

            delete updatedCountryPricing[code];
            // Eğer silinen para birimi başka bir ülke tarafından kullanılmıyorsa, sembolünü ve kurunu da sil
            const isCurrencyUsedByOtherCountries = Object.values(updatedCountryPricing).some(c => c.currencyCode === deletedCurrencyCode);
            if (!isCurrencyUsedByOtherCountries) {
                delete updatedCurrencySymbols[deletedCurrencyCode];
                delete updatedExchangeRates[deletedCurrencyCode];
            }

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), {
                    countryPricing: updatedCountryPricing,
                    currencySymbols: updatedCurrencySymbols,
                    exchangeRates: updatedExchangeRates
                });
                alert("Ülke/Para Birimi ayarı başarıyla silindi!");
                loadSettings();
            } catch (error) {
                console.error("Ülke/Para Birimi ayarı silinirken hata:", error);
                alert("Ülke/Para Birimi ayarı silinirken bir hata oluştu: " + error.message);
            }
        };

        // Language Management Functions
        const renderLanguageList = (languages) => {
            languageListContainer.innerHTML = '';
            if (languages.length === 0) {
                languageListContainer.innerHTML = '<p>Henüz dil eklenmemiş.</p>';
                return;
            }
            languages.forEach((lang, index) => {
                const langDiv = document.createElement('div');
                langDiv.className = 'admin-form-container'; // Reuse form-container style
                langDiv.innerHTML = `
                    <h3>${countryCodeToEmoji(lang.flag)} ${lang.name} (${lang.code})</h3>
                    <div class="admin-form-actions">
                        <button type="button" class="edit-language-btn save-btn" data-index="${index}">Düzenle</button>
                        <button type="button" class="delete-language-btn cancel-btn" data-index="${index}">Sil</button>
                    </div>
                `;
                languageListContainer.appendChild(langDiv);
            });
            document.querySelectorAll('.edit-language-btn').forEach(btn => btn.addEventListener('click', () => editLanguage(parseInt(btn.dataset.index))));
            document.querySelectorAll('.delete-language-btn').forEach(btn => btn.addEventListener('click', () => deleteLanguage(parseInt(btn.dataset.index))));
        };

        const showLanguageForm = (isEdit = false) => {
            languageFormContainer.style.display = 'block';
            languageFormTitle.textContent = isEdit ? 'Düzenle' : 'Ekle';
            if (!isEdit) {
                languageForm.reset();
                languageIndexInput.value = '';
                languageCodeInput.readOnly = false;
                currentEditingLanguageIndex = -1;
            } else {
                languageCodeInput.readOnly = true;
            }
        };

        const hideLanguageForm = () => {
            languageFormContainer.style.display = 'none';
            languageForm.reset();
            currentEditingLanguageIndex = -1;
        };

        const editLanguage = (index) => {
            const language = adminSiteData.settings.languages[index];
            if (!language) return;

            currentEditingLanguageIndex = index;
            languageIndexInput.value = index;
            languageCodeInput.value = language.code || '';
            languageNameInput.value = language.name || '';
            languageFlagInput.value = language.flag || '';

            showLanguageForm(true);
        };

        const deleteLanguage = async (index) => {
            if (!confirm("Bu dili silmek istediğinize emin misiniz?")) return;
            let updatedLanguages = [...(adminSiteData.settings?.languages || [])];
            updatedLanguages.splice(index, 1);

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), { languages: updatedLanguages });
                alert("Dil ayarı başarıyla silindi!");
                loadSettings();
            } catch (error) {
                console.error("Dil ayarı silinirken hata:", error);
                alert("Dil ayarı silinirken bir hata oluştu: " + error.message);
            }
        };


        // --- Event Listeners ---
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrorMessage(loginErrorMessage);
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // NOT: Eğer kullanıcı verilerinizi 'uyeler' koleksiyonunda tutuyorsanız, aşağıdaki satırı güncelleyin:
                // const userDoc = await getDoc(doc(db, 'uyeler', user.uid));
                const userDoc = await getDoc(doc(db, 'users', user.uid)); // Varsayılan: 'users'

                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    showView('admin-dashboard-view');
                    adminUserEmailSpan.textContent = user.email;
                    console.log("Admin logged in!");
                } else {
                    await signOut(auth); // Admin değilse çıkış yap
                    displayErrorMessage('Bu hesap yönetici yetkisine sahip değil.', loginErrorMessage);
                    return; // Hata durumunda fonksiyonu sonlandır
                }
            } catch (error) {
                displayErrorMessage(`Giriş hatası: ${error.message}`, loginErrorMessage);
                console.error("Admin Login Error:", error);
                return; // Hata durumunda fonksiyonu sonlandır
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showView('admin-login-view');
                adminEmailInput.value = '';
                adminPasswordInput.value = '';
                console.log("Admin logged out.");
            } catch (error) {
                console.error("Logout Error:", error);
            }
        });

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Not: Eğer kullanıcı verilerinizi 'uyeler' koleksiyonunda tutuyorsanız, aşağıdaki satırı güncelleyin:
                    // const userDoc = await getDoc(doc(db, 'uyeler', user.uid));
                    const userDoc = await getDoc(doc(db, 'users', user.uid)); // Varsayılan: 'users'
                    if (userDoc.exists() && userDoc.data().role === 'admin') {
                        showView('admin-dashboard-view');
                        adminUserEmailSpan.textContent = user.email;
                    } else {
                        await signOut(auth); // Yetkisiz kullanıcı
                        showView('admin-login-view');
                    }
                } catch (error) {
                    console.error("Auth state check error:", error);
                    await signOut(auth); // Hata olursa çıkış yap
                    showView('admin-login-view');
                }
            } else {
                showView('admin-login-view');
            }
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.target.getAttribute('href').substring(1) + '-section';
                showAdminSection(sectionId);
            });
        });

        // Product Management Event Listeners
        addProductBtn.addEventListener('click', () => showProductForm(false));
        cancelProductFormBtn.addEventListener('click', hideProductForm);
        addVariantBtn.addEventListener('click', () => addVariantRow());
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = productIdInput.value;
            const variants = [];
            Array.from(productVariantsContainer.children).forEach((variantDiv, index) => {
                variants.push({
                    id: currentEditingProduct?.variants?.[index]?.id || Math.random().toString(36).substring(2, 11), // Mevcut id'yi koru veya yeni oluştur
                    name: variantDiv.querySelector(`input[id^="variant-name-"]`).value,
                    priceTL: parseFloat(variantDiv.querySelector(`input[id^="variant-price-"]`).value) || null,
                    discountedPriceTL: parseFloat(variantDiv.querySelector(`input[id^="variant-discounted-price-"]`).value) || null,
                    stock: parseInt(variantDiv.querySelector(`input[id^="variant-stock-"]`).value) || 0,
                    media: variantDiv.querySelector(`input[id^="variant-image-url-"]`).value ? [{ type: 'image', url: variantDiv.querySelector(`input[id^="variant-image-url-"]`).value }] : []
                });
            });

            const productData = {
                content: {
                    tr: {
                        name: productNameTrInput.value,
                        description: productDescTrTextarea.value,
                    },
                    en: {
                        name: productNameEnInput.value,
                        description: productDescEnTextarea.value,
                    }
                },
                basePriceTL: parseFloat(productBasePriceInput.value),
                baseDiscountedPriceTL: parseFloat(productDiscountedPriceInput.value) || null,
                isFreeShipping: productIsFreeShippingCheckbox.checked,
                isInShowcase: productIsInShowcaseCheckbox.checked,
                variants: variants
            };

            try {
                if (productId) {
                    await updateDoc(doc(db, 'products', productId), productData);
                    alert("Ürün başarıyla güncellendi!");
                } else {
                    await addDoc(collection(db, 'products'), productData);
                    alert("Ürün başarıyla eklendi!");
                }
                hideProductForm();
                loadProducts();
            } catch (error) {
                console.error("Ürün kaydedilirken hata:", error);
                alert("Ürün kaydedilirken bir hata oluştu: " + error.message);
            }
        });

        // Category Management Event Listeners
        addCategoryBtn.addEventListener('click', () => showCategoryForm(false));
        cancelCategoryFormBtn.addEventListener('click', hideCategoryForm);
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryId = categoryIdInput.value;
            const parentId = parentCategorySelect.value;
            const newCategory = {
                id: categoryId || Math.random().toString(36).substring(2, 11),
                name: {
                    tr: categoryNameTrInput.value,
                    en: categoryNameEnInput.value,
                },
                children: []
            };

            let updatedTree = JSON.parse(JSON.stringify(adminSiteData.categories.tree)); // Deep copy

            if (categoryId) { // Edit existing
                const updateNode = (nodes) => {
                    return nodes.map(node => {
                        if (node.id === categoryId) {
                            return newCategory;
                        }
                        if (node.children) {
                            return { ...node, children: updateNode(node.children) };
                        }
                        return node;
                    });
                };
                updatedTree = updateNode(updatedTree);
                alert("Kategori başarıyla güncellendi!");
            } else { // Add new
                if (parentId) {
                    const addNodeToParent = (nodes) => {
                        return nodes.map(node => {
                            if (node.id === parentId) {
                                return { ...node, children: [...(node.children || []), newCategory] };
                            }
                            if (node.children) {
                                return { ...node, children: addNodeToParent(node.children) };
                            }
                            return node;
                        });
                    };
                    updatedTree = addNodeToParent(updatedTree);
                } else {
                    updatedTree.push(newCategory);
                }
                alert("Kategori başarıyla eklendi!");
            }

            try {
                await updateDoc(doc(db, 'pufemo', 'categories'), { tree: updatedTree });
                adminSiteData.categories.tree = updatedTree; // State'i güncelle
                hideCategoryForm(); // Formu gizle
                renderCategoriesList(adminSiteData.categories.tree); // UI'ı yenile
                populateParentCategorySelect(adminSiteData.categories.tree); // Selectbox'ı yenile
            } catch (error) {
                console.error("Kategori kaydedilirken hata:", error);
                alert("Kategori kaydedilirken bir hata oluştu: " + error.message);
            }
        });

        // Order Management Event Listeners
        closeOrderDetailBtn.addEventListener('click', () => {
            orderDetailView.style.display = 'none';
            currentEditingOrder = null;
        });

        updateOrderStatusBtn.addEventListener('click', async () => {
            if (!currentEditingOrder) return;
            const newStatus = orderStatusSelect.value;
            try {
                await updateDoc(doc(db, 'orders', currentEditingOrder.id), { status: newStatus });
                alert("Sipariş durumu güncellendi!");
                orderDetailView.style.display = 'none';
                loadOrders(); // Listeyi yenile
            } catch (error) {
                console.error("Sipariş durumu güncellenirken hata:", error);
                alert("Sipariş durumu güncellenirken bir hata oluştu: " + error.message);
            }
        });

        // Settings Management Event Listeners
        uploadLogoImageBtn.addEventListener('click', async () => {
            if (logoImageFileInput.files.length === 0) {
                alert("Lütfen bir resim dosyası seçin.");
                return;
            }
            const file = logoImageFileInput.files[0];
            const storageRef = ref(storage, `logo/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                logoImageUrlInput.value = downloadURL;
                logoImagePreview.innerHTML = `<div class="media-item"><img src="${downloadURL}"><button class="delete-media" data-index="-1" data-url="${downloadURL}">X</button></div>`;
                logoImagePreview.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, 'logo-image-preview'));
                alert("Logo resmi yüklendi!");
            } catch (error) {
                console.error("Logo resmi yüklenirken hata:", error);
                alert("Logo resmi yüklenirken bir hata oluştu.");
            }
        });

        generalSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const generalSettings = {
                logo: {
                    type: logoTypeSelect.value,
                    text: logoTextInput.value,
                    icon: logoIconInput.value,
                    textColor: logoTextColorInput.value,
                    iconColor: logoIconColorInput.value,
                    imageUrl: logoImageUrlInput.value,
                },
                promoBar: {
                    enabled: promoBarEnabledCheckbox.checked,
                    text: {
                        tr: promoBarTextTrInput.value,
                        en: promoBarTextEnInput.value,
                    },
                    bgColor: promoBarBgColorInput.value,
                    textColor: promoBarTextColorInput.value,
                    fontSize: promoBarFontSizeInput.value,
                    scrollSpeed: promoBarScrollSpeedInput.value,
                }
            };
            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), { general: generalSettings });
                alert("Genel Ayarlar başarıyla kaydedildi!");
                loadSettings(); // Ayarları tekrar yükle
            } catch (error) {
                console.error("Genel ayarlar kaydedilirken hata:", error);
                alert("Genel ayarlar kaydedilirken bir hata oluştu: " + error.message);
            }
        });

        // Banner Management Event Listeners
        addBannerBtn.addEventListener('click', () => showBannerForm(false));
        cancelBannerFormBtn.addEventListener('click', hideBannerForm);
        uploadBannerImageBtn.addEventListener('click', async () => {
            if (bannerImageFileInput.files.length === 0) {
                alert("Lütfen bir resim/video dosyası seçin.");
                return;
            }
            const file = bannerImageFileInput.files[0];
            const storagePath = file.type.startsWith('image/') ? 'banner_images' : 'banner_videos';
            const storageRef = ref(storage, `${storagePath}/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                bannerImageUrlInput.value = downloadURL;
                bannerImagePreview.innerHTML = `<div class="media-item">${file.type.startsWith('image/') ? `<img src="${downloadURL}">` : `<video src="${downloadURL}" controls></video>`}<button class="delete-media" data-index="-1" data-url="${downloadURL}">X</button></div>`;
                bannerImagePreview.querySelector('.delete-media').addEventListener('click', (e) => deleteMediaFromPreview(e.target.dataset.index, e.target.dataset.url, 'banner-image-preview'));
                alert("Banner medyası yüklendi!");
            } catch (error) {
                console.error("Banner medyası yüklenirken hata:", error);
                alert("Banner medyası yüklenirken bir hata oluştu.");
            }
        });

        bannerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newBanner = {
                image_url: bannerImageUrlInput.value,
                link_url: bannerLinkUrlInput.value,
                content: {
                    tr: {
                        title: bannerTitleTrInput.value,
                        subtitle: bannerSubtitleTrInput.value,
                    },
                    en: {
                        title: bannerTitleEnInput.value,
                        subtitle: bannerSubtitleEnInput.value,
                    }
                },
                style: {
                    title_color: bannerStyleTitleColorInput.value,
                    title_font_size: bannerStyleTitleFontSizeInput.value,
                    subtitle_color: bannerStyleSubtitleColorInput.value,
                    subtitle_font_size: bannerStyleSubtitleFontSizeInput.value,
                    button_bg_color: bannerStyleButtonBgColorInput.value,
                    button_text_color: bannerStyleButtonTextColorInput.value,
                    button_border_radius: bannerStyleButtonBorderRadiusInput.value,
                }
            };

            let updatedBanners = [...(adminSiteData.settings?.banner || [])];
            if (currentEditingBannerIndex > -1) {
                updatedBanners[currentEditingBannerIndex] = newBanner;
            } else {
                updatedBanners.push(newBanner);
            }

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), { banner: updatedBanners });
                alert("Banner başarıyla kaydedildi!");
                hideBannerForm();
                loadSettings();
            } catch (error) {
                console.error("Banner kaydedilirken hata:", error);
                alert("Banner kaydedilirken bir hata oluştu: " + error.message);
            }
        });

        // Country & Currency Management Event Listeners
        addCountryCurrencyBtn.addEventListener('click', () => showCountryCurrencyForm(false));
        cancelCountryCurrencyFormBtn.addEventListener('click', hideCountryCurrencyForm);
        countryCurrencyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const countryCode = countryCurrencyCodeInput.value.toUpperCase();
            const currencyCode = currencyCodeInput.value.toUpperCase();

            const newCountryData = {
                name: {
                    tr: countryNameTrInput.value,
                    en: countryNameEnInput.value,
                },
                currencyCode: currencyCode,
                defaultLanguage: defaultLanguageInput.value.toLowerCase(),
                flag: flagEmojiInput.value,
                adjustment: parseFloat(priceAdjustmentInput.value) || 0
            };

            let updatedCountryPricing = { ...(adminSiteData.settings.countryPricing || {}) };
            let updatedCurrencySymbols = { ...(adminSiteData.settings.currencySymbols || {}) };
            let updatedExchangeRates = { ...(adminSiteData.settings.exchangeRates || {}) };

            updatedCountryPricing[countryCode] = newCountryData;
            updatedCurrencySymbols[currencyCode] = currencySymbolInput.value;
            updatedExchangeRates[currencyCode] = parseFloat(exchangeRateInput.value); // USD'ye göre kur

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), {
                    countryPricing: updatedCountryPricing,
                    currencySymbols: updatedCurrencySymbols,
                    exchangeRates: updatedExchangeRates
                });
                alert("Ülke/Para Birimi ayarı başarıyla kaydedildi!");
                hideCountryCurrencyForm();
                loadSettings();
            } catch (error) {
                console.error("Ülke/Para Birimi ayarı kaydedilirken hata:", error);
                alert("Ülke/Para Birimi ayarı kaydedilirken bir hata oluştu: " + error.message);
            }
        });

        // Language Management Event Listeners
        addLanguageBtn.addEventListener('click', () => showLanguageForm(false));
        cancelLanguageFormBtn.addEventListener('click', hideLanguageForm);
        languageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newLanguage = {
                code: languageCodeInput.value.toLowerCase(),
                name: languageNameInput.value,
                flag: languageFlagInput.value
            };

            let updatedLanguages = [...(adminSiteData.settings?.languages || [])];
            if (currentEditingLanguageIndex > -1) {
                updatedLanguages[currentEditingLanguageIndex] = newLanguage;
            } else {
                updatedLanguages.push(newLanguage);
            }

            try {
                await updateDoc(doc(db, 'pufemo', 'settings'), { languages: updatedLanguages });
                alert("Dil ayarı başarıyla kaydedildi!");
                hideLanguageForm();
                loadSettings();
            } catch (error) {
                console.error("Dil ayarı kaydedilirken hata:", error);
                alert("Dil ayarı kaydedilirken bir hata oluştu: " + error.message);
            }
        });


        // --- Initialization ---
        const initAdminPanel = () => {
            // Auth state listener ilk görünümü belirleyecek
        };

        document.addEventListener('DOMContentLoaded', initAdminPanel);

    </script>
</body>
</html>
