<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Yönetim Paneli (Tam Sürüm)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --primary-color: #2c3e50; --secondary-color: #e74c3c; --background-color: #f4f7f9;
            --form-bg-color: #ffffff; --text-color: #34495e; --border-color: #dfe6e9;
            --success-color: #27ae60; --danger-color: #c0392b; --info-color: #3498db;
            --border-radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; transition: opacity 0.3s ease; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .admin-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background-color: var(--primary-color); color: white; padding: 1.5rem; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; margin-bottom: 2rem; }
        .sidebar-header h2 { font-size: 1.8rem; }
        .sidebar-header i { color: var(--secondary-color); }
        .sidebar-nav ul { list-style: none; padding: 0;}
        .sidebar-nav h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem; }
        .sidebar-nav li { padding: 0.8rem 1rem; margin-bottom: 0.5rem; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-nav li:hover, .sidebar-nav li.active { background-color: rgba(255,255,255,0.1); }
        .sidebar-nav .nav-item-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; max-height: 100vh; }
        .main-content h1 { font-size: 2.2rem; margin-bottom: 2rem; color: var(--primary-color); }
        .page { display: none; }
        .page.active { display: block; }
        .form-section { background-color: var(--form-bg-color); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; position: relative;}
        .form-section h2, .form-section h3 { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;}
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .lang-tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 1rem; }
        .lang-tab { padding: 8px 15px; background: #eee; border: 1px solid var(--border-color); border-bottom: none; border-radius: 5px 5px 0 0; cursor: pointer; }
        .lang-tab.active { background: var(--form-bg-color); font-weight: 600; }
        .lang-content { display: none; }
        .lang-content.active { display: block; }
        .variant-color-block { border: 1px solid var(--border-color); border-radius: 5px; padding: 1rem; margin-bottom: 1rem; background-color: #fafafa; }
        .variant-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .media-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px;}
        .media-input-group select { width: 120px; flex-shrink: 0; }
        .media-input-group input { flex-grow: 1; }
        .category-tree-container ul, .category-checklist-container ul { list-style: none; padding-left: 20px; }
        .category-item { background-color: #fff; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .category-name-inputs { display: flex; gap: 15px; flex-grow: 1;}
        .category-name-inputs .form-group { margin-bottom: 0; flex: 1; }
        .category-name-inputs .form-group label { font-size: 0.8em; }
        .category-controls { display: flex; align-items: center; }
        .category-controls button { background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; }
        .category-controls button:hover { background-color: #f0f0f0; }
        .category-checklist-container label { font-weight: normal; display: flex; align-items: center; }
        .category-checklist-container input[type="checkbox"] { margin-right: 10px; width: auto; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: opacity 0.3s; }
        .form-actions { margin-top: 2rem; text-align: right; }
        .delete-slide-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: var(--danger-color); cursor: pointer; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Yükleniyor...</div>

    <div class="admin-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fa-solid fa-couch"></i> PUFEMO</h2>
                <p>Yönetim Paneli</p>
            </div>
            <nav class="sidebar-nav">
                <h3>Genel</h3>
                <ul>
                    <li class="nav-item" data-page="homepage-settings"><span class="nav-item-name">Anasayfa Ayarları</span></li>
                </ul>
                <h3>İçerik</h3>
                <ul>
                    <li class="nav-item active" data-page="product-management"><span class="nav-item-name">Ürünler</span></li>
                    <li class="nav-item" data-page="category-management"><span class="nav-item-name">Kategoriler</span></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div id="product-management" class="page active">
                </div>

            <div id="homepage-settings" class="page">
                </div>

            <div id="category-management" class="page">
                <h1>Kategori Yönetimi</h1>
                <div class="form-section">
                    <button id="add-main-category-btn" class="btn btn-primary">Yeni Ana Kategori Ekle</button>
                    </div>
                <div id="category-tree-container" class="form-section">
                    </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="module">
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
        };
        
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (e) { alert('Firebase başlatılamadı: ' + e.message); }

        if (db) {
            // === 1. GLOBAL STATE VE DOM ELEMENTLERİ ===
            let localState = { settings: { languages: [], banner: { slides: [] } }, categories: [], products: [] };
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContent = document.querySelector('.main-content');
            const productManagementPage = document.getElementById('product-management'); // Referans olarak eklendi
            const homepageSettingsPage = document.getElementById('homepage-settings'); // Referans olarak eklendi
            const categoryManagementPage = document.getElementById('category-management');
            const categoryTreeContainer = document.getElementById('category-tree-container');

            // === 2. ÇEKİRDEK FONKSİYONLAR ===
            const showLoading = () => loadingOverlay.classList.remove('hidden');
            const hideLoading = () => loadingOverlay.classList.add('hidden');
            const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);
            
            async function fetchData() {
                showLoading();
                try {
                    const [settingsDoc, categoriesDoc, productsSnapshot] = await Promise.all([
                        db.collection('pufemo').doc('settings').get(),
                        db.collection('pufemo').doc('categories').get(),
                        db.collection('pufemo-products').get()
                    ]);
                    localState.settings = settingsDoc.exists ? settingsDoc.data() : { languages: [], banner: { slides: [] } };
                    localState.categories = categoriesDoc.exists ? categoriesDoc.data().tree || [] : [];
                    localState.products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    alert('Veri yüklenirken hata: ' + error.message);
                } finally {
                    hideLoading();
                }
            }

            async function saveData(docName, data) {
                showLoading();
                try {
                    const dataToSave = docName === 'categories' ? { tree: data } : data;
                    await db.collection('pufemo').doc(docName).set(dataToSave, { merge: true });
                    console.log(`${docName} başarıyla kaydedildi!`);
                } catch (error) {
                     alert(`${docName} kaydedilirken bir hata oluştu: ' + error.message`);
                } finally {
                    hideLoading();
                }
            }

            // === 3. KATEGORİ YÖNETİMİ (Yeniden Yazıldı) ===

            function refreshCategoryView() {
                categoryTreeContainer.innerHTML = '';
                // Ana kategorileri eklemek için bir UL oluşturalım
                const mainUl = document.createElement('ul');
                localState.categories.forEach(cat => mainUl.appendChild(createCategoryNode(cat)));
                categoryTreeContainer.appendChild(mainUl);
            }
            
            function createCategoryNode(category) {
                const li = document.createElement('li');
                li.dataset.id = category.id;
                let nameInputsHTML = (localState.settings.languages || []).map(lang => 
                    `<div class="form-group"><label>${lang.flag}</label><input type="text" class="category-name-input" data-lang="${lang.code}" value="${category.name?.[lang.code] || ''}"></div>`
                ).join('');
                
                li.innerHTML = `
                    <div class="category-item">
                        <div class="category-name-inputs">${nameInputsHTML}</div>
                        <div class="category-controls">
                            <button class="add-subcategory-btn" title="Alt Kategori Ekle"><i class="fa-solid fa-plus"></i></button>
                            <button class="delete-category-btn" title="Kategoriyi Sil"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;

                const subcategoriesUl = document.createElement('ul');
                if (category.children?.length > 0) {
                    category.children.forEach(child => subcategoriesUl.appendChild(createCategoryNode(child)));
                }
                li.appendChild(subcategoriesUl);
                return li;
            }
            
            function showCategoryInputForm(container, parentCategoryArray) {
                // Mevcut bir input formu varsa tekrar oluşturma
                if (container.querySelector('.new-category-form')) return;

                const formLi = document.createElement('li');
                formLi.className = 'category-item new-category-form';

                let nameInputsHTML = (localState.settings.languages || []).map(lang => 
                    `<div class="form-group"><label>${lang.flag}</label><input type="text" class="new-category-name-input" data-lang="${lang.code}" placeholder="${lang.name} Adı"></div>`
                ).join('');

                formLi.innerHTML = `
                    <form style="width: 100%;">
                        <div class="category-name-inputs">${nameInputsHTML}</div>
                        <div class="form-actions" style="margin-top: 1rem;">
                            <button type="button" class="btn btn-danger btn-sm cancel-new-category">İptal</button>
                            <button type="submit" class="btn btn-success btn-sm">Kaydet ✅</button>
                        </div>
                    </form>
                `;

                container.prepend(formLi);
                formLi.querySelector('input').focus();

                formLi.querySelector('form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newCategory = { id: generateUniqueId(), name: {}, children: [] };
                    let hasName = false;
                    formLi.querySelectorAll('.new-category-name-input').forEach(input => {
                        if (input.value.trim()) hasName = true;
                        newCategory.name[input.dataset.lang] = input.value.trim();
                    });

                    if (!hasName) {
                        alert('Lütfen en az bir dilde kategori adı girin.');
                        return;
                    }

                    parentCategoryArray.push(newCategory);
                    await saveData('categories', localState.categories);
                    refreshCategoryView(); // Formu kaldırıp yeni eklenmiş kategoriyi göster
                });

                formLi.querySelector('.cancel-new-category').addEventListener('click', () => {
                    formLi.remove();
                });
            }

            // === 4. OLAY DİNLEYİCİLER ===

            // Kenar Çubuğu Navigasyonu
            document.querySelector('.sidebar-nav').addEventListener('click', e => {
                const navItem = e.target.closest('.nav-item');
                if (!navItem) return;
                document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => item.classList.remove('active'));
                navItem.classList.add('active');
                const pageId = navItem.dataset.page;
                document.querySelectorAll('.page').forEach(page => page.classList.toggle('active', false));
                // Eğer sayfa HTML'de yoksa hata vermemesi için kontrol
                const pageElement = document.getElementById(pageId);
                if (pageElement) pageElement.classList.add('active');
            });
            
            // Kategori Yönetimi Olayları
            document.getElementById('add-main-category-btn').addEventListener('click', () => {
                showCategoryInputForm(categoryTreeContainer.querySelector('ul'), localState.categories);
            });
            
            categoryTreeContainer.addEventListener('click', e => {
                const btn = e.target.closest('button');
                if (!btn) return;

                const li = btn.closest('li[data-id]');
                const id = li?.dataset.id;
                
                const findCategory = (categories, catId) => {
                    for (const cat of categories) {
                        if (cat.id === catId) return cat;
                        if (cat.children) {
                            const found = findCategory(cat.children, catId);
                            if (found) return found;
                        }
                    }
                    return null;
                };

                const findAndRemove = (categories, catId) => {
                    for (let i = 0; i < categories.length; i++) {
                        if(categories[i].id === catId) {
                            categories.splice(i, 1);
                            return true;
                        }
                        if(categories[i].children && findAndRemove(categories[i].children, catId)) return true;
                    }
                    return false;
                }

                if (btn.matches('.add-subcategory-btn, .add-subcategory-btn *')) {
                    const parentCategory = findCategory(localState.categories, id);
                    if (parentCategory) {
                        if (!parentCategory.children) parentCategory.children = [];
                        let subList = li.querySelector('ul');
                        if(!subList) {
                            subList = document.createElement('ul');
                            li.appendChild(subList);
                        }
                        showCategoryInputForm(subList, parentCategory.children);
                    }
                } else if (btn.matches('.delete-category-btn, .delete-category-btn *')) {
                    if (confirm('Bu kategoriyi ve tüm alt kategorilerini silmek istediğinizden emin misiniz?')) {
                        findAndRemove(localState.categories, id);
                        saveData('categories', localState.categories).then(refreshCategoryView);
                    }
                }
            });

            categoryTreeContainer.addEventListener('change', e => {
                if(e.target.matches('.category-name-input')) {
                    const id = e.target.closest('li[data-id]').dataset.id;
                    const lang = e.target.dataset.lang;
                    const findAndUpdate = (cats, catId) => {
                        for(const cat of cats) {
                            if(cat.id === catId) { if(!cat.name) cat.name={}; cat.name[lang] = e.target.value; return true; }
                            if(cat.children && findAndUpdate(cat.children, catId)) return true;
                        } return false;
                    };
                    if (findAndUpdate(localState.categories, id)) {
                        saveData('categories', localState.categories);
                    }
                }
            });
            
            // === 5. BAŞLANGIÇ FONKSİYONU ===
            async function init() {
                // Diğer sayfa HTML'leri bu kodda olmadığı için referansları kaldırıyoruz.
                // İhtiyaç halinde bu sayfaların HTML'i eklenip ilgili render fonksiyonları çağrılabilir.
                productManagementPage.innerHTML = `<h1>Ürün Yönetimi</h1><div style="display: flex; gap: 2rem; align-items: flex-start;"><div style="width: 280px; flex-shrink: 0;"><div class="form-section" style="padding: 1rem;"><h3>Ürünler</h3><ul id="product-list-container"></ul><button id="add-new-product-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Yeni Ürün Ekle</button></div></div><div style="flex-grow: 1;"><form id="product-form" style="display: none;"><section class="form-section"><h2>Temel Bilgiler</h2><input type="hidden" id="productId"><div class="form-group"><label for="productSKU">Ürün Kodu (SKU)</label><input type="text" id="productSKU" required></div><div class="form-group"><label for="productPrice">Taban Fiyat (₺)</label><input type="number" id="productPrice" step="any" required></div></section><section class="form-section"><h2>Ürün Kategorisi</h2><div id="product-category-checklist" class="category-checklist-container"></div></section><section class="form-section"><h2>Ürün Açıklamaları (Dile Göre)</h2><div class="lang-tabs" id="product-lang-tabs-container"></div><div id="product-lang-content-container"></div></section><section class="form-section"><h2>Renk Seçenekleri ve Medya</h2><div id="color-variants-container"></div><button type="button" class="btn btn-primary" id="add-color-variant-btn">Yeni Renk Ekle</button></section><div class="form-actions"><button type="button" id="delete-product-btn" class="btn btn-danger" style="float: left;">Ürünü Sil</button><button type="submit" class="btn btn-success">Ürünü Kaydet</button></div></form></div></div>`;
                homepageSettingsPage.innerHTML = `<h1>Anasayfa Ayarları</h1><form id="homepage-form"><section class="form-section"><div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem;"><h2>Banner (Slider) Ayarları</h2><button type="button" id="add-new-slide-btn" class="btn btn-primary">Yeni Slayt Ekle</button></div><div id="banner-settings-container"></div></section><div class="form-actions"><button type="submit" class="btn btn-success">Anasayfa Ayarlarını Kaydet</button></div></form>`;

                await fetchData();
                refreshCategoryView(); // Sadece kategori görünümünü render et
                // Diğer render fonksiyonları ilgili sayfa seçildiğinde çağrılabilir
            }
            
            init();
        }
    </script>
</body>
</html>
