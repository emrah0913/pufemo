<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFEMO - Sepetim</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --primary-color: #2c3e50; --secondary-color: #e74c3c; --background-color: #ecf0f1; --text-color: #34495e; --light-text-color: #ffffff; --card-bg-color: #ffffff; --border-radius: 8px; --box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { text-decoration: none; color: inherit; }
        
        .promo-bar {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            text-align: center;
            padding: 8px 0;
            font-size: 0.95rem;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            z-index: 1001;
        }

        .promo-text {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-text 20s linear infinite;
        }

        @keyframes scroll-text {
            0% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        .main-header {
            background-color: var(--card-bg-color);
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding-bottom: 0.5rem;
        }
        
        .header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.8rem 0;
        }

        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 20px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        .logo i {
            color: var(--secondary-color);
            margin-right: 5px;
        }
        .logo img {
            max-width: 100%;
            height: auto;
        }
        
        .header-controls { display: flex; align-items: center; gap: 1rem; }
        .control-select { background-color: #f8f9fa; border: 1px solid #ddd; padding: 5px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; }
        .cart-icon { font-size: 1.5rem; position: relative; }
        .cart-badge { position: absolute; top: -5px; right: -10px; background-color: var(--secondary-color); color: var(--light-text-color); border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; }
        .hamburger-menu { display: none; cursor: pointer; width: 30px; height: 25px; flex-direction: column; justify-content: space-between; background: transparent; border: none; z-index: 1003; }
        .hamburger-menu span { display: block; width: 100%; height: 3px; background-color: var(--primary-color); border-radius: 3px; transition: all 0.3s ease-in-out; }
        .hamburger-menu.open span { background-color: var(--light-text-color); }
        .hamburger-menu.open span:nth-child(1) { transform: translateY(11px) rotate(45deg); }
        .hamburger-menu.open span:nth-child(2) { opacity: 0; }
        .hamburger-menu.open span:nth-child(3) { transform: translateY(-11px) rotate(-45deg); }
        .mobile-nav { position: fixed; top: 0; left: -100%; width: 300px; height: 100vh; background-color: var(--primary-color); color: var(--light-text-color); z-index: 1002; transition: left 0.4s ease-in-out; box-shadow: 5px 0 15px rgba(0,0,0,0.2); overflow-y: auto; padding: 1.5rem; }
        .mobile-nav.open { left: 0; }
        .mobile-nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s ease; }
        .mobile-nav-overlay.open { opacity: 1; visibility: visible; }
        .mobile-nav .mobile-nav-header { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.5rem; font-weight: 600; color: var(--light-text-color); }
        .mobile-nav ul { list-style: none; }
        .mobile-nav ul a { display: block; padding: 15px 0; color: var(--light-text-color); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 500; transition: background-color 0.3s ease; }
        .mobile-nav ul a:hover { background-color: rgba(255,255,255,0.1); }
        .mobile-nav ul ul a { padding-left: 20px; font-size: 0.9em; }
        .mobile-nav ul ul ul a { padding-left: 40px; }
        .category-nav { background-color: var(--primary-color); padding: 0.8rem 0; }
        .category-nav ul { list-style: none; display: flex; justify-content: center; gap: 2.5rem; flex-wrap: wrap; }
        .category-nav a { color: var(--light-text-color); font-weight: 500; padding: 5px 10px; border-radius: 5px; transition: background-color 0.3s ease; }
        .category-nav a:hover { background-color: rgba(255,255,255,0.1); }
        main { padding: 3rem 0; }
        .section-title { text-align: center; margin-bottom: 2.5rem; font-size: 2.2rem; font-weight: 600; color: var(--primary-color); }
        
        /* Auth related styles from index.html (copy-pasted for consistency) */
        .auth-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-controls .profile-pic {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            transition: border-color 0.3s ease;
        }

        .auth-controls .profile-pic:hover {
            border-color: var(--secondary-color);
        }

        .auth-controls .sign-in-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #eee;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .auth-controls .sign-in-btn:hover {
            background-color: #ddd;
            transform: translateY(-1px);
        }

        .auth-controls .sign-in-btn i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .auth-controls .sign-out-btn {
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .auth-controls .sign-out-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }

        .auth-dropdown {
            position: absolute;
            top: 60px; /* Adjust as needed */
            right: 20px;
            background-color: var(--card-bg-color);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .auth-dropdown.active {
            display: flex;
        }


        /* Cart Page Specific Styles */
        .cart-page-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .cart-items-container {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .cart-item-price {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--secondary-color);
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cart-item-quantity button {
            background-color: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .cart-item-quantity button:hover {
            background-color: #34495e;
        }

        .cart-item-quantity input {
            width: 40px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 0;
            font-size: 1rem;
            -moz-appearance: textfield; /* Firefox'ta sayı alanındaki okları kaldırır */
        }
        .cart-item-quantity input::-webkit-outer-spin-button,
        .cart-item-quantity input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .remove-item-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 1rem;
            transition: color 0.3s ease;
        }

        .remove-item-btn:hover {
            color: #c0392b;
        }

        .cart-summary {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
        }

        .cart-summary h3 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .summary-line {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
        }

        .summary-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            border-top: 1px solid #eee;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .checkout-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--secondary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 1.5rem;
        }

        .checkout-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .empty-cart-message {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-color);
            padding: 3rem;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 2rem;
        }

        /* Footer styles (copy-pasted for consistency) */
        .main-footer { background-color: var(--primary-color); color: var(--light-text-color); padding: 3rem 0 1rem 0; margin-top: 3rem; }
        .footer-content { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem; text-align: center; }
        .footer-section { flex: 1; min-width: 200px; }
        .footer-section h4 { font-size: 1.2rem; margin-bottom: 1rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem; display: inline-block; }
        .footer-section ul { list-style: none; padding: 0;}
        .footer-section a:hover { color: var(--secondary-color); }
        .footer-bottom { text-align: center; margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem; }
        
        .country-selector-container {
            text-align: center;
            padding: 2rem 0;
            margin: 2rem 0 0 0;
            border-top: 1px solid rgba(255,255,255,0.15);
        }

        .country-selector-container label {
            font-size: 1.1rem;
            color: var(--light-text-color); 
            margin-right: 10px;
            font-weight: 500;
        }

        .country-selector-container .control-select {
            padding: 8px 12px;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .country-selector-container .control-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
        }


        @media (max-width: 992px) {
            .category-nav { display: none; }
            .hamburger-menu { display: flex; }

            .main-header {
                padding-bottom: 0.5rem;
            }

            .header-top {
                padding: 0.5rem 0;
            }
            
            .logo {
                font-size: 1.5rem;
            }

            .main-header .container {
                padding: 0.5rem 20px;
            }

            /* Mobile cart styles */
            .cart-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
                text-align: center;
            }

            .cart-item-image {
                width: 80px;
                height: 80px;
                margin: 0 auto;
            }

            .cart-item-details {
                text-align: center;
            }

            .cart-item-quantity {
                justify-content: center;
                width: 100%;
                margin-top: 0.5rem;
            }
            .remove-item-btn {
                position: absolute;
                top: 10px;
                right: 10px;
                margin-left: 0;
            }
            .cart-item {
                position: relative;
            }

            .cart-items-container, .cart-summary {
                padding: 1rem;
            }
        }
        @media (max-width: 480px) {
             .auth-controls {
                gap: 5px;
            }
            .auth-controls .profile-pic,
            .auth-controls .sign-in-btn {
                width: 30px;
                height: 30px;
            }
            .auth-controls .sign-in-btn i {
                font-size: 1rem;
            }
            .auth-controls .sign-out-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .country-selector-container {
                padding: 1.5rem 0;
            }
            .country-selector-container label {
                font-size: 1.0rem;
                display: block;
                margin-bottom: 5px;
            }
            .country-selector-container .control-select {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div class="promo-bar">
        <span id="promo-text-content" class="promo-text"></span>
    </div>

    <div id="mobile-nav-overlay" class="mobile-nav-overlay"></div>
    <header class="main-header">
        <div class="header-top">
            <a href="index.html" class="logo" id="main-logo-link">
            </a>
        </div>
        <div class="container">
            <button class="hamburger-menu" id="hamburger-menu-btn" aria-label="Menüyü aç/kapat"><span></span><span></span><span></span></button>
            <div class="header-controls">
                <select id="language-selector" class="control-select"></select>
                <select id="currency-selector" class="control-select"></select>
                <a href="cart.html" class="cart-icon" id="cart-page-link" title=""><i class="fa-solid fa-cart-shopping"></i><span class="cart-badge">0</span></a>
                <div class="auth-controls">
                    <img id="user-profile-pic" class="profile-pic" src="https://via.placeholder.com/35" alt="Profile" style="display:none;">
                    <button id="auth-toggle-button" class="sign-in-btn" title="Sign In"><i class="fa-solid fa-user"></i></button>
                    <div id="auth-dropdown" class="auth-dropdown">
                        <button id="google-sign-in-desktop-button"></button>
                        <button id="anonymous-sign-in-desktop-button"></button>
                        <button id="sign-out-button"></button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <nav id="mobile-nav" class="mobile-nav"></nav>
    <nav class="category-nav"><div class="container"><ul id="category-menu-container"></ul></div></nav>

    <main class="container">
        <h1 class="section-title" id="cart-page-title">Sepetim</h1>
        
        <div id="cart-content" class="cart-page-content">
            <div id="cart-items-container" class="cart-items-container">
                </div>
            
            <div id="cart-summary-container" class="cart-summary">
                <h3 id="cart-summary-title">Sepet Özeti</h3>
                <div class="summary-line">
                    <span id="summary-subtotal-label">Ara Toplam:</span>
                    <span id="summary-subtotal"></span>
                </div>
                <div class="summary-line">
                    <span id="summary-shipping-label">Kargo:</span>
                    <span id="summary-shipping"></span>
                </div>
                <div class="summary-line summary-total">
                    <span id="summary-total-label">Toplam:</span>
                    <span id="summary-total"></span>
                </div>
                <button class="checkout-btn" id="checkout-button"></button>
            </div>

            <div id="empty-cart-message" class="empty-cart-message" style="display:none;">
                <p id="empty-cart-text"></p>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 id="footer-title-pufemo"></h4>
                    <p id="footer-desc-pufemo"></p>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-fast-links"></h4>
                    <ul>
                        <li><a href="#" id="footer-link-about"></a></li>
                        <li><a href="#" id="footer-link-contact"></a></li>
                        <li><a href="#" id="footer-link-privacy"></a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 id="footer-title-follow-us"></h4>
                    <ul>
                        <li><a href="#">Facebook</a></li>
                        <li><a href="#">Instagram</a></li>
                        <li><a href="#">Pinterest</a></li>
                    </ul>
                </div>
            </div>

            <div class="country-selector-container">
                <label for="country-selector" id="country-selector-label"></label>
                <select id="country-selector" class="control-select"></select>
            </div>

            <div class="footer-bottom" id="footer-copyright"></div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDYkzZzNXB22U4oEXxOoPh-puwuE8kz0g4",
            authDomain: "pufemo-com.firebaseapp.com",
            projectId: "pufemo-com",
            storageBucket: "pufemo-com.appspot.com",
            messagingSenderId: "983352837227",
            appId: "1:983352837227:web:defaa8dae215776e2e1d2e",
        };
        
        let db;
        let auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) { 
            console.error("Firebase başlatma hatası!", e); 
        }

        if (db && auth) {
            function countryCodeToEmoji(code) {
                if (!code || code.length !== 2) {
                    return '';
                }
                return code.toUpperCase().split('').map(char =>
                    String.fromCodePoint(char.charCodeAt(0) + 127397)
                ).join('');
            }

            const staticTranslations = {
                'loading_text': { tr: 'PUFEMO Yükleniyor...', en: 'Loading PUFEMO...', el: 'Φόρτωση PUFEMO...', ru: 'Загрузка PUFEMO...', de: 'PUFEMO wird geladen...', fr: 'Chargement de PUFEMO...', it: 'Caricamento PUFEMO...' },
                'mobile_menu_title': { tr: 'Kategoriler', en: 'Categories', el: 'Κατηγορίες', ru: 'Категории', de: 'Kategorien', fr: 'Catégories', it: 'Categorie' },
                'main_section_title': { tr: 'Öne Çıkan Ürünler', en: 'Featured Products', el: 'Προτεινόμενα Προϊόντα', ru: 'Рекомендуемые товары', de: 'Ausgewählte Produkte', fr: 'Produits Phares', it: 'Prodotti in Evidenza' },
                'footer-title-pufemo': { tr: 'PUFEMO', en: 'PUFEMO', el: 'PUFEMO', ru: 'ПУΦΕΜΟ', de: 'PUFEMO', fr: 'PUFEMO', it: 'PUFEMO' },
                'footer-desc-pufemo': { tr: 'Hayallerinizdeki konforu ve estetiği evinize taşıyoruz.', en: 'We bring the comfort and aesthetics of your dreams to your home.', el: 'Φέρνουμε την άνεση και την αισθητική των ονείρων σας στο σπίλε μου.', ru: 'Мы приносим комфорт и эстетику в ваш дом.', de: 'Wir bringen den Komfort und die Ästhetik Ihrer Träume in Ihr Zuhause.', fr: 'Nous apportons le confort et l\'esthétique de vos rêves à votre maison.', it: 'Portiamo il comfort e l\'estetica dei vostri sogni nella vostra casa.' },
                'footer-title-fast-links': { tr: 'Hızlı Bağlantılar', en: 'Quick Links', el: 'Γρήγοροι Σύνδεσμοι', ru: 'Быстрые ссылки', de: 'Schnelllinks', fr: 'Liens Rapides', it: 'Link Veloci' },
                'footer-link-about': { tr: 'Hakkımızda', en: 'About Us', el: 'Σχετικά με εμάς', ru: 'О нас', de: 'Über Uns', fr: 'À Propos', it: 'Chi Siamo' },
                'footer-link-contact': { tr: 'İletişim', en: 'Contact', el: 'Επικοινωνία', ru: 'Контакт', de: 'Kontakt', fr: 'Contact', it: 'Contatti' },
                'footer-link-privacy': { tr: 'Gizlilik Politikası', en: 'Privacy Policy', el: 'Πολιτική Απορρήτου', ru: 'Политика конфиденциальности', de: 'Datenschutzbestimmungen', fr: 'Politique de Confidentialité', it: 'Informativa sulla Privacy' },
                'footer-title-follow-us': { tr: 'Bizi Takip Edin', en: 'Follow Us', el: 'Ακολουθήστε μας', ru: 'Следите за нами', de: 'Folgen Sie Uns', fr: 'Suivez-nous', it: 'Seguici' },
                'footer-copyright': { tr: '&copy; 2025 PUFEMO.COM | Tüm Hakları Saklıdır.', en: '&copy; 2025 PUFEMO.COM | All Rights Reserved.', el: '&copy; 2025 PUFEMO.COM | Με την επιφύλαξη παντός δικαιώματος.', ru: '&copy; 2025 PUFEMO.COM | Все права защищены.', de: '&copy; 2025 PUFEMO.COM | Alle Rechte vorbehalten.', fr: '© 2025 PUFEMO.COM | Tous droits réservés.', it: '© 2025 PUFEMO.COM | Tutti i diritti riservati.' },
                'default_button_text': { tr: 'Alışverişe Başla', en: 'Shop Now', el: 'Αγοράστε τώρα', ru: 'Купить сейчас', de: 'Jetzt einkaufen', fr: 'Acheter maintenant', it: 'Acquista ora' },
                'free_shipping_text': { tr: 'Ücretsiz Kargo', en: 'Free Shipping', el: 'Δωρεάν Αποστολή', ru: 'Бесплатная доставка', de: 'Kostenloser Versand', fr: 'Livraison Gratuite', it: 'Spedizione Gratuita' },
                'free_shipping_promo': { tr: 'Ücretsiz Kargo İmkanı! Türkiye\'nin Her Yerine Mobilyalarınız Kapınızda!', en: 'Free Shipping Available! Furniture at Your Doorstep Anywhere in Turkey!', el: 'Διαθέσιμη δωρεάν αποστολή! Έπιπλα στην πόρτα σας οπουδήποτε στην Ελλάδα!', ru: 'Доступна бесплатная доставка! Мебель доставим до вашей двери в любую точку России!', de: 'Kostenloser Versand möglich! Möbel direkt vor Ihre Haustür in ganz Deutschland!', fr: 'Livraison Gratuite Disponible ! Vos meubles à votre porte partout en France !', it: 'Spedizione Gratuita Disponibile! I tuoi mobili a casa tua in tutta Italia!' },
                'country_selector_label': { tr: 'Ülke Seçimi:', en: 'Select Country:', el: 'Επιλέξτε Χώρα:', ru: 'Выбрать страну:', de: 'Land auswählen:', fr: 'Sélectionner le pays :', it: 'Seleziona Paese:' },
                'welcome_modal_title': { tr: 'Hoş Geldiniz!', en: 'Welcome!', el: 'Καλώς ήρθατε!', ru: 'Добро пожаловать!', de: 'Willkommen!', fr: 'Bienvenue !', it: 'Benvenuto!' },
                'welcome_modal_message': { tr: 'Lütfen ülkenizi seçin.', en: 'Please select your country below.', el: 'Παρακαλώ επιλέξτε τη χώρα σας παρακάτω.', ru: 'Пожалуйста, выберите свою страну ниже.', de: 'Bitte wählen Sie Ihr Land unten aus.', fr: 'Veuillez sélectionner votre pays ci-dessous.', it: 'Seleziona il tuo paese qui sotto.' },
                'welcome_modal_confirm_button': { tr: 'Devam Et', en: 'Continue', el: 'Συνέχεια', ru: 'Продолжить', de: 'Weiter', fr: 'Continuer', it: 'Continua' },
                'cart_page_link_title': { tr: 'Sepetim', en: 'My Cart', el: 'Το καλάθι μου', ru: 'Моя корзина', de: 'Mein Warenkorb', fr: 'Mon Panier', it: 'Il mio Carrello' },
                'untitled_product': { tr: 'İsimsiz Ürün', en: 'Untitled Product', el: 'Προϊόν χωρίς τίτλο', ru: 'Товар без названия', de: 'Unbenanntes Produkt', fr: 'Produit sans titre', it: 'Prodotto senza titolo' },
                'no_image': { tr: 'Resim Yok', en: 'No Image', el: 'Χωρίς Εικόνα', ru: 'Нет изображения', de: 'Kein Bild', fr: 'Pas d\'image', it: 'Nessuna immagine' },
                'sign_in_google': { tr: 'Google ile Giriş Yap', en: 'Sign in with Google', el: 'Σύνδεση με Google', ru: 'Войти через Google', de: 'Mit Google anmelden', fr: 'Se connecter avec Google', it: 'Accedi con Google' },
                'continue_as_guest': { tr: 'Misafir Olarak Devam Et', en: 'Continue as Guest', el: 'Συνέχιση ως Επισκέπτης', ru: 'Продолжить как гость', de: 'Als Gast fortfahren', fr: 'Continuer en tant qu\'invité', it: 'Continua come ospite' },
                'sign_out': { tr: 'Çıkış Yap', en: 'Sign Out', el: 'Αποσύνδεση', ru: 'Выйти', de: 'Abmelden', fr: 'Déconnexion', it: 'Esci' },
                'sign_in': { tr: 'Giriş Yap', en: 'Sign In', el: 'Σύνδεση', ru: 'Войти', de: 'Anmelden', fr: 'Connexion', it: 'Accedi' },
                // Cart page specific translations
                'cart_page_title': { tr: 'Sepetim', en: 'My Cart', el: 'Το καλάθι μου', ru: 'Моя корзина', de: 'Mein Warenkorb', fr: 'Mon Panier', it: 'Il mio Carrello' },
                'cart_summary_title': { tr: 'Sepet Özeti', en: 'Cart Summary', el: 'Σύνοψη Καλαθιού', ru: 'Итог Корзины', de: 'Warenkorb-Zusammenfassung', fr: 'Récapitulatif du panier', it: 'Riepilogo Carrello' },
                'summary_subtotal_label': { tr: 'Ara Toplam:', en: 'Subtotal:', el: 'Υποσύνολο:', ru: 'Промежуточная сумма:', de: 'Zwischensumme:', fr: 'Sous-total :', it: 'Subtotale:' },
                'summary_shipping_label': { tr: 'Kargo:', en: 'Shipping:', el: 'Αποστολή:', ru: 'Доставка:', de: 'Versand:', fr: 'Livraison :', it: 'Spedizione:' },
                'summary_total_label': { tr: 'Toplam:', en: 'Total:', el: 'Σύνολο:', ru: 'Итого:', de: 'Gesamt:', fr: 'Total :', it: 'Totale:' },
                'checkout_button': { tr: 'Siparişi Tamamla', en: 'Proceed to Checkout', el: 'Ολοκλήρωση παραγγελίας', ru: 'Перейти к оформлению заказа', de: 'Zur Kasse gehen', fr: 'Passer à la caisse', it: 'Procedi al Pagamento' },
                'empty_cart_text': { tr: 'Sepetinizde ürün bulunmamaktadır.', en: 'Your cart is empty.', el: 'Το καλάθι σας είναι άδειο.', ru: 'Ваша корзина пуста.', de: 'Ihr Warenkorb ist leer.', fr: 'Votre panier est vide.', it: 'Il tuo carrello è vuoto.' },
                'quantity_label': { tr: 'Adet:', en: 'Qty:', el: 'Ποσότητα:', ru: 'Кол-во:', de: 'Menge:', fr: 'Qté :', it: 'Quantità:' },
                'remove_item': { tr: 'Ürünü Kaldır', en: 'Remove Item', el: 'Αφαίρεση προϊόντος', ru: 'Удалить товар', de: 'Produkt entfernen', fr: 'Supprimer l\'article', it: 'Rimuovi Articolo' }
            };

            let siteData = {
                settings: {
                    languages: [],
                    general: { logo: {}, promoBar: {} },
                    countryPricing: {},
                    currencySymbols: {},
                    exchangeRates: {}
                },
                categories: { tree: [] },
                products: [] // All products for cart lookup
            };

            let currentLang = localStorage.getItem('pufemo-language') || 'en';
            let currentCurrency = localStorage.getItem('pufemo-currency') || 'USD';
            let currentCountryCode = localStorage.getItem('pufemo-country') || 'US'; // Default to US if not set

            // Cart specific elements
            const cartPageTitleEl = document.getElementById('cart-page-title');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartSummaryContainer = document.getElementById('cart-summary-container');
            const summarySubtotalSpan = document.getElementById('summary-subtotal');
            const summaryShippingSpan = document.getElementById('summary-shipping');
            const summaryTotalSpan = document.getElementById('summary-total');
            const checkoutButton = document.getElementById('checkout-button');
            const summarySubtotalLabel = document.getElementById('summary-subtotal-label');
            const summaryShippingLabel = document.getElementById('summary-shipping-label');
            const summaryTotalLabel = document.getElementById('summary-total-label');
            const cartSummaryTitle = document.getElementById('cart-summary-title');
            const emptyCartText = document.getElementById('empty-cart-text');

            // Authentication elements (copied from index.html)
            const userProfilePic = document.getElementById('user-profile-pic');
            const authToggleButton = document.getElementById('auth-toggle-button');
            const authDropdown = document.getElementById('auth-dropdown');
            const googleSignInDesktopButton = document.getElementById('google-sign-in-desktop-button');
            const anonymousSignInDesktopButton = document.getElementById('anonymous-sign-in-desktop-button');
            const signOutButton = document.getElementById('sign-out-button');


            const fetchData = async () => {
                try {
                    const [settingsDoc, categoriesDoc, allProductsSnap] = await Promise.all([
                        db.collection('pufemo').doc('settings').get(),
                        db.collection('pufemo').doc('categories').get(),
                        db.collection('pufemo-products').get() // Fetch ALL products for cart lookup
                    ]);

                    if (settingsDoc.exists) {
                        siteData.settings = { ...siteData.settings, ...settingsDoc.data() };
                    }
                    if (categoriesDoc.exists) {
                        siteData.categories = { ...siteData.categories, ...categoriesDoc.data() };
                    }
                    siteData.products = allProductsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Ensure currentCountryCode, currentLang, currentCurrency are set based on localStorage or defaults
                    const availableCountries = Object.keys(siteData.settings.countryPricing);
                    if (localStorage.getItem('pufemo-country') && availableCountries.includes(localStorage.getItem('pufemo-country'))) {
                        currentCountryCode = localStorage.getItem('pufemo-country');
                    } else if (availableCountries.length > 0) {
                        currentCountryCode = availableCountries[0];
                        localStorage.setItem('pufemo-country', currentCountryCode); // Save default if not set
                    } else {
                        currentCountryCode = 'US'; // Fallback
                        localStorage.setItem('pufemo-country', currentCountryCode);
                    }

                    const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                    if (selectedCountryData) {
                        if (selectedCountryData.defaultLanguage && typeof selectedCountryData.defaultLanguage === 'string' && selectedCountryData.defaultLanguage.length === 2) {
                            currentLang = selectedCountryData.defaultLanguage;
                        } else {
                            currentLang = 'en';
                        }
                        const selectedCountryCurrencySymbol = selectedCountryData.currencySymbol;
                        if (selectedCountryCurrencySymbol) {
                            const currencyCodeFromSymbol = Object.keys(siteData.settings.currencySymbols || {}).find(key => 
                                siteData.settings.currencySymbols[key] === selectedCountryCurrencySymbol
                            );
                            if (currencyCodeFromSymbol) {
                                currentCurrency = currencyCodeFromSymbol;
                            } else {
                                currentCurrency = 'USD';
                            }
                        } else {
                            currentCurrency = 'USD';
                        }
                        localStorage.setItem('pufemo-language', currentLang);
                        localStorage.setItem('pufemo-currency', currentCurrency);
                    } else {
                        currentLang = 'en';
                        currentCurrency = 'USD';
                        localStorage.setItem('pufemo-language', currentLang);
                        localStorage.setItem('pufemo-currency', currentCurrency);
                    }

                } catch (e) {
                    console.error("Veri okuma hatası! Varsayılan ayarlar kullanılıyor.", e);
                    currentLang = 'en';
                    currentCurrency = 'USD';
                    localStorage.setItem('pufemo-language', currentLang);
                    localStorage.setItem('pufemo-currency', currentCurrency);
                    if (!localStorage.getItem('pufemo-country')) {
                        localStorage.setItem('pufemo-country', 'US');
                        currentCountryCode = 'US';
                    }
                }
            };
            
            window.applyCountryAndRender = (countryCode) => {
                currentCountryCode = countryCode;
                localStorage.setItem('pufemo-country', currentCountryCode);

                const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                if (selectedCountryData) {
                    if (selectedCountryData.defaultLanguage && typeof selectedCountryData.defaultLanguage === 'string' && selectedCountryData.defaultLanguage.length === 2) {
                        currentLang = selectedCountryData.defaultLanguage;
                    } else {
                        currentLang = 'en';
                    }
                    const selectedCountryCurrencySymbol = selectedCountryData.currencySymbol;
                    if (selectedCountryCurrencySymbol) {
                        const currencyCodeFromSymbol = Object.keys(siteData.settings.currencySymbols || {}).find(key =>
                            siteData.settings.currencySymbols[key] === selectedCountryCurrencySymbol
                        );
                        if (currencyCodeFromSymbol) {
                            currentCurrency = currencyCodeFromSymbol;
                        } else {
                            currentCurrency = 'USD';
                        }
                    } else {
                        currentCurrency = 'USD';
                    }
                    localStorage.setItem('pufemo-language', currentLang);
                    localStorage.setItem('pufemo-currency', currentCurrency);
                } else {
                    currentLang = 'en';
                    currentCurrency = 'USD';
                    localStorage.setItem('pufemo-language', currentLang);
                    localStorage.setItem('pufemo-currency', currentCurrency);
                }
                renderAll();
                document.getElementById('language-selector').value = currentLang;
                document.getElementById('currency-selector').value = currentCurrency;
                document.getElementById('country-selector').value = currentCountryCode;
            };

            const renderAll = () => {
                renderStaticText();
                setupControls();
                renderCategories();
                renderGeneralSiteElements();
                renderCart(); // Render cart specific content
                updateAuthUI(auth.currentUser);
            };

            const renderStaticText = () => {
                document.documentElement.lang = currentLang;
                const translate = (key) => staticTranslations[key]?.[currentLang] || staticTranslations[key]?.['en'] || staticTranslations[key]?.['tr'] || '';

                if (document.getElementById('footer-title-pufemo')) document.getElementById('footer-title-pufemo').textContent = translate('footer-title-pufemo');
                if (document.getElementById('footer-desc-pufemo')) document.getElementById('footer-desc-pufemo').textContent = translate('footer-desc-pufemo');
                if (document.getElementById('footer-title-fast-links')) document.getElementById('footer-title-fast-links').textContent = translate('footer-title-fast-links');
                if (document.getElementById('footer-link-about')) document.getElementById('footer-link-about').textContent = translate('footer-link-about');
                if (document.getElementById('footer-link-contact')) document.getElementById('footer-link-contact').textContent = translate('footer-link-contact');
                if (document.getElementById('footer-link-privacy')) document.getElementById('footer-link-privacy').textContent = translate('footer-link-privacy');
                if (document.getElementById('footer-title-follow-us')) document.getElementById('footer-title-follow-us').textContent = translate('footer-title-follow-us');
                if (document.getElementById('footer-copyright')) document.getElementById('footer-copyright').innerHTML = translate('footer-copyright');
                if (document.getElementById('country-selector-label')) document.getElementById('country-selector-label').textContent = translate('country_selector_label');
                if (document.getElementById('cart-page-link')) document.getElementById('cart-page-link').title = translate('cart_page_link_title');

                // Cart page specific translations
                if (cartPageTitleEl) cartPageTitleEl.textContent = translate('cart_page_title');
                if (cartSummaryTitle) cartSummaryTitle.textContent = translate('cart_summary_title');
                if (summarySubtotalLabel) summarySubtotalLabel.textContent = translate('summary_subtotal_label');
                if (summaryShippingLabel) summaryShippingLabel.textContent = translate('summary_shipping_label');
                if (summaryTotalLabel) summaryTotalLabel.textContent = translate('summary_total_label');
                if (checkoutButton) checkoutButton.textContent = translate('checkout_button');
                if (emptyCartText) emptyCartText.textContent = translate('empty_cart_text');

                // Auth related translations
                if (googleSignInDesktopButton) googleSignInDesktopButton.textContent = translate('sign_in_google');
                if (anonymousSignInDesktopButton) anonymousSignInDesktopButton.textContent = translate('continue_as_guest');
                if (signOutButton) signOutButton.textContent = translate('sign_out');
                if (authToggleButton) authToggleButton.title = translate('sign_in');
            };

            const renderGeneralSiteElements = () => {
                const generalSettings = siteData.settings.general || {};
                const logoLink = document.getElementById('main-logo-link');

                if (logoLink) {
                    logoLink.innerHTML = '';
                    if (generalSettings.logo?.type === 'image' && generalSettings.logo.imageUrl) {
                        const img = document.createElement('img');
                        img.src = generalSettings.logo.imageUrl;
                        img.alt = generalSettings.logo.text || 'PUFEMO Logo';
                        if (generalSettings.logo.imageWidth) img.style.width = `${generalSettings.logo.imageWidth}px`;
                        if (generalSettings.logo.imageHeight) img.style.height = `${generalSettings.logo.imageHeight}px`;
                        logoLink.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = generalSettings.logo?.icon || 'fa-solid fa-couch';
                        icon.style.color = generalSettings.logo?.iconColor || 'var(--secondary-color)';
                        logoLink.appendChild(icon);

                        const textNode = document.createTextNode(generalSettings.logo?.text ? ` ${generalSettings.logo.text}` : ' PUFEMO');
                        logoLink.appendChild(textNode);
                        logoLink.style.color = generalSettings.logo?.textColor || 'var(--primary-color)';
                    }
                }

                const promoBar = document.querySelector('.promo-bar');
                const promoTextContent = document.getElementById('promo-text-content');
                if (promoBar && promoTextContent) {
                    promoBar.style.backgroundColor = generalSettings.promoBar?.bgColor || 'var(--secondary-color)';
                    promoBar.style.color = generalSettings.promoBar?.textColor || 'var(--light-text-color)';
                    promoBar.style.fontSize = generalSettings.promoBar?.fontSize || '0.95rem';

                    const scrollSpeed = generalSettings.promoBar?.scrollSpeed || '20s';
                    promoTextContent.style.animationDuration = scrollSpeed;
                    
                    const promoText = generalSettings.promoBar?.text?.[currentLang] || staticTranslations['free_shipping_promo'][currentLang] || staticTranslations['free_shipping_promo']['tr'];
                    promoTextContent.textContent = promoText;
                    promoBar.style.display = generalSettings.promoBar?.enabled ? 'block' : 'none';
                }
            };

            const renderCategories = () => {
                const desktopContainer = document.getElementById('category-menu-container');
                const mobileContainer = document.getElementById('mobile-nav');
                const categories = siteData.categories?.tree || [];
                
                desktopContainer.innerHTML = '';
                mobileContainer.innerHTML = '';
                
                if (categories.length === 0) return;

                const mobileMenuTitle = staticTranslations['mobile_menu_title']?.[currentLang] || staticTranslations['mobile_menu_title']?.['tr'];
                mobileContainer.innerHTML += `<div class="mobile-nav-header">${mobileMenuTitle}</div>`;
                
                const createMenu = (categoryArray) => {
                    const ul = document.createElement('ul');
                    categoryArray.forEach(cat => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="#">${cat.name[currentLang] || cat.name.tr}</a>`;
                        if (cat.children && cat.children.length > 0) li.appendChild(createMenu(cat.children));
                        ul.appendChild(li);
                    });
                    return ul;
                };
                
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#">${cat.name[currentLang] || cat.name.tr}</a>`;
                    desktopContainer.appendChild(li);
                });

                mobileContainer.appendChild(createMenu(categories));
            };
            
            const formatPrice = (basePrice, discountPrice = null) => {
                const symbols = siteData.settings?.currencySymbols || {};
                const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                let priceToFormat = discountPrice !== null ? discountPrice : basePrice;

                if (selectedCountryData && typeof selectedCountryData.adjustment === 'number') {
                    const adjustmentPercentage = selectedCountryData.adjustment / 100;
                    priceToFormat = priceToFormat * (1 + adjustmentPercentage);
                }

                const rates = siteData.settings?.exchangeRates || {};
                const rate = rates[currentCurrency] || 1;
                priceToFormat = priceToFormat * rate;

                const symbol = symbols[currentCurrency] || currentCurrency;

                const numberFormatOptions = currentCurrency === 'TRY'
                    ? { maximumFractionDigits: 0 }
                    : { minimumFractionDigits: 2, maximumFractionDigits: 2 };
                
                const formattedPrice = new Intl.NumberFormat(currentLang, numberFormatOptions).format(priceToFormat);
                
                return `${symbol} ${formattedPrice}`;
            };
            
            const setupControls = () => {
                const languageSelector = document.getElementById('language-selector');
                const currencySelector = document.getElementById('currency-selector');
                const countrySelector = document.getElementById('country-selector');
                const hamburgerBtn = document.getElementById('hamburger-menu-btn');
                const mobileNav = document.getElementById('mobile-nav');
                const mobileNavOverlay = document.getElementById('mobile-nav-overlay');

                const languagesFromDB = siteData.settings.languages || [];
                languageSelector.innerHTML = languagesFromDB.map(l => `<option value="${l.code}">${countryCodeToEmoji(l.flag)} ${l.name}</option>`).join('');
                if (languagesFromDB.length > 0) {
                    languageSelector.value = currentLang;
                    languageSelector.style.display = 'block';
                } else {
                    languageSelector.style.display = 'none';
                }
                
                const currencies = siteData.settings?.currencySymbols || {};
                const availableCurrencies = Object.keys(currencies);
                currencySelector.innerHTML = availableCurrencies.map(c => {
                    const symbol = currencies[c] || c;
                    return `<option value="${c}">${symbol} ${c}</option>`;
                }).join('');
                if (availableCurrencies.length > 0) {
                    currencySelector.value = currentCurrency;
                    currencySelector.style.display = 'block';
                } else {
                    currencySelector.style.display = 'none';
                }
                
                const countries = siteData.settings.countryPricing || {};
                const countryOptionsHtml = Object.entries(countries).map(([code, data]) => {
                    const countryName = data.name?.[currentLang] || data.name?.['tr'] || code.toUpperCase();
                    return `<option value="${code}">${countryCodeToEmoji(data.flag)} ${countryName}</option>`;
                }).join('');

                if (Object.keys(countries).length > 0) {
                    countrySelector.innerHTML = countryOptionsHtml;
                    countrySelector.value = currentCountryCode;
                    countrySelector.parentElement.style.display = 'block';
                } else {
                    countrySelector.parentElement.style.display = 'none';
                }

                languageSelector.onchange = (e) => {
                    currentLang = e.target.value;
                    localStorage.setItem('pufemo-language', currentLang);
                    renderAll();
                };
                
                currencySelector.onchange = (e) => {
                    currentCurrency = e.target.value;
                    localStorage.setItem('pufemo-currency', currentCurrency);
                    renderAll();
                };

                countrySelector.onchange = (e) => {
                    window.applyCountryAndRender(e.target.value);
                };
                
                const toggleMenu = () => {
                    hamburgerBtn.classList.toggle('open');
                    mobileNav.classList.toggle('open');
                    mobileNavOverlay.classList.toggle('open');
                    document.querySelector('body').classList.toggle('mobile-menu-open');
                };
                hamburgerBtn.onclick = toggleMenu;
                mobileNavOverlay.onclick = toggleMenu;
                mobileNav.onclick = (e) => { if (e.target.tagName === 'A') toggleMenu(); };

                // Authentication event listeners
                authToggleButton.onclick = () => {
                    authDropdown.classList.toggle('active');
                };

                googleSignInDesktopButton.onclick = signInWithGoogle;
                anonymousSignInDesktopButton.onclick = signInAnonymously;
                signOutButton.onclick = signOutUser;
            };

            // Firebase Authentication Functions (copied from index.html)
            const googleProvider = new firebase.auth.GoogleAuthProvider();

            async function signInWithGoogle() {
                try {
                    await auth.signInWithPopup(googleProvider);
                    authDropdown.classList.remove('active'); // Close dropdown after sign-in
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    alert(`Google Sign-In Failed: ${error.message}`);
                }
            }

            async function signInAnonymously() {
                try {
                    await auth.signInAnonymously();
                    authDropdown.classList.remove('active'); // Close dropdown after sign-in
                } catch (error) {
                    console.error("Anonymous Sign-In Error:", error);
                    alert(`Anonymous Sign-In Failed: ${error.message}`);
                }
            }

            async function signOutUser() {
                try {
                    await auth.signOut();
                    authDropdown.classList.remove('active'); // Close dropdown after sign-out
                } catch (error) {
                    console.error("Sign-Out Error:", error);
                    alert(`Sign-Out Failed: ${error.message}`);
                }
            }

            function updateAuthUI(user) {
                if (user) {
                    authToggleButton.style.display = 'none';
                    userProfilePic.style.display = 'block';
                    userProfilePic.src = user.photoURL || 'https://via.placeholder.com/35';
                    
                    googleSignInDesktopButton.style.display = 'none';
                    anonymousSignInDesktopButton.style.display = 'none';
                    signOutButton.style.display = 'block';
                } else {
                    authToggleButton.style.display = 'block';
                    userProfilePic.style.display = 'none';

                    googleSignInDesktopButton.style.display = 'block';
                    anonymousSignInDesktopButton.style.display = 'block';
                    signOutButton.style.display = 'none';
                }
            }

            auth.onAuthStateChanged((user) => {
                updateAuthUI(user);
            });


            // Cart Functionality
            let cart = JSON.parse(localStorage.getItem('pufemo-cart')) || [];

            function saveCart() {
                localStorage.setItem('pufemo-cart', JSON.stringify(cart));
                updateCartBadge(); // Update the badge on every save
            }

            function updateCartBadge() {
                const cartBadge = document.querySelector('.cart-badge');
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                if (cartBadge) {
                    cartBadge.textContent = totalItems;
                    cartBadge.style.display = totalItems > 0 ? 'block' : 'none';
                }
            }

            function addToCart(productId, variantId = null, quantity = 1) {
                const product = siteData.products.find(p => p.id === productId);
                if (!product) {
                    console.error("Ürün bulunamadı:", productId);
                    return;
                }

                const productPrice = product.baseDiscountedPriceTL !== null && typeof product.baseDiscountedPriceTL === 'number' && product.baseDiscountedPriceTL < product.basePriceTL 
                                    ? product.baseDiscountedPriceTL 
                                    : product.basePriceTL;
                const productName = product.content?.[currentLang]?.name || product.content?.tr?.name || staticTranslations['untitled_product'][currentLang] || staticTranslations['untitled_product']['tr'];
                const productImage = product.variants?.[0]?.media?.[0]?.url || `https://placehold.co/100x100/ccc/fff?text=${staticTranslations['no_image'][currentLang] || staticTranslations['no_image']['tr']}`;
                const isFreeShipping = product.isFreeShipping || false;

                const existingItemIndex = cart.findIndex(item => item.productId === productId && item.variantId === variantId);

                if (existingItemIndex > -1) {
                    cart[existingItemIndex].quantity += quantity;
                } else {
                    cart.push({ 
                        productId, 
                        variantId, 
                        quantity,
                        name: productName,
                        price: productPrice,
                        image: productImage,
                        isFreeShipping: isFreeShipping
                    });
                }
                saveCart();
                renderCart(); // Re-render cart on add
                alert(`${productName} sepete eklendi!`); // User feedback
            }

            function updateCartItemQuantity(productId, variantId, newQuantity) {
                const itemIndex = cart.findIndex(item => item.productId === productId && item.variantId === variantId);
                if (itemIndex > -1) {
                    if (newQuantity <= 0) {
                        cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                    } else {
                        cart[itemIndex].quantity = newQuantity;
                    }
                    saveCart();
                    renderCart();
                }
            }

            function removeItemFromCart(productId, variantId) {
                cart = cart.filter(item => !(item.productId === productId && item.variantId === variantId));
                saveCart();
                renderCart();
            }

            function calculateCartTotals() {
                let subtotal = 0;
                let shippingCost = 0; // You'll need logic for this

                const selectedCountryData = siteData.settings.countryPricing[currentCountryCode];
                const shippingRules = selectedCountryData?.shippingRules || {};
                let hasFreeShippingItem = false;
                let applyShipping = true; // Assume shipping applies unless overridden

                cart.forEach(item => {
                    subtotal += item.price * item.quantity;
                    if (item.isFreeShipping) {
                        hasFreeShippingItem = true;
                    }
                });

                // Apply shipping logic
                if (hasFreeShippingItem) {
                    shippingCost = 0;
                    applyShipping = false;
                } else if (shippingRules.flatRate && subtotal < shippingRules.freeShippingThreshold) {
                    shippingCost = shippingRules.flatRate;
                } else if (shippingRules.freeShippingThreshold && subtotal >= shippingRules.freeShippingThreshold) {
                    shippingCost = 0;
                }
                // You might need more complex shipping logic based on weight, zones, etc.

                let total = subtotal + shippingCost;

                // Apply country-specific adjustments
                if (selectedCountryData && typeof selectedCountryData.adjustment === 'number') {
                    const adjustmentPercentage = selectedCountryData.adjustment / 100;
                    subtotal = subtotal * (1 + adjustmentPercentage);
                    shippingCost = shippingCost * (1 + adjustmentPercentage); // Adjust shipping too
                    total = total * (1 + adjustmentPercentage);
                }

                // Apply currency exchange rates
                const rates = siteData.settings?.exchangeRates || {};
                const rate = rates[currentCurrency] || 1;
                subtotal = subtotal * rate;
                shippingCost = shippingCost * rate;
                total = total * rate;

                return {
                    subtotal: subtotal,
                    shipping: shippingCost,
                    total: total
                };
            }


            function renderCart() {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                    cartItemsContainer.style.display = 'none';
                    cartSummaryContainer.style.display = 'none';
                    return;
                }

                emptyCartMessage.style.display = 'none';
                cartItemsContainer.style.display = 'block';
                cartSummaryContainer.style.display = 'block';

                cart.forEach(item => {
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'cart-item';
                    cartItemEl.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">${item.name}</h3>
                            <p class="cart-item-price">${formatPrice(item.price)}</p>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="decrease-quantity" data-product-id="${item.productId}" data-variant-id="${item.variantId || ''}">-</button>
                            <input type="number" value="${item.quantity}" min="1" class="quantity-input" data-product-id="${item.productId}" data-variant-id="${item.variantId || ''}">
                            <button class="increase-quantity" data-product-id="${item.productId}" data-variant-id="${item.variantId || ''}">+</button>
                        </div>
                        <button class="remove-item-btn" data-product-id="${item.productId}" data-variant-id="${item.variantId || ''}" title="${staticTranslations['remove_item'][currentLang] || staticTranslations['remove_item']['tr']}"><i class="fa-solid fa-trash-can"></i></button>
                    `;
                    cartItemsContainer.appendChild(cartItemEl);
                });

                // Add event listeners for quantity changes and removal
                cartItemsContainer.querySelectorAll('.decrease-quantity').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const variantId = e.target.dataset.variantId || null;
                        const input = e.target.nextElementSibling;
                        let newQuantity = parseInt(input.value) - 1;
                        updateCartItemQuantity(productId, variantId, newQuantity);
                    });
                });

                cartItemsContainer.querySelectorAll('.increase-quantity').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const variantId = e.target.dataset.variantId || null;
                        const input = e.target.previousElementSibling;
                        let newQuantity = parseInt(input.value) + 1;
                        updateCartItemQuantity(productId, variantId, newQuantity);
                    });
                });

                cartItemsContainer.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const productId = e.target.dataset.productId;
                        const variantId = e.target.dataset.variantId || null;
                        let newQuantity = parseInt(e.target.value);
                        if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1; // Ensure valid quantity
                        updateCartItemQuantity(productId, variantId, newQuantity);
                    });
                });

                cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        const variantId = e.target.dataset.variantId || null;
                        removeItemFromCart(productId, variantId);
                    });
                });

                // Update summary
                const totals = calculateCartTotals();
                summarySubtotalSpan.textContent = formatPrice(totals.subtotal, 0); // Second arg dummy to use price format func
                summaryShippingSpan.textContent = formatPrice(totals.shipping, 0);
                summaryTotalSpan.textContent = formatPrice(totals.total, 0);
            }

            // Global function to add to cart (can be called from product pages)
            window.addToCart = addToCart;


            async function init() {
                await fetchData();
                renderAll();
                updateCartBadge(); // Initial badge update
            }
            
            init();
        } else {
            console.error("Firebase başlatılamadı. Sepet işlevleri devre dışı.");
        }
    </script>
</body>
</html>
